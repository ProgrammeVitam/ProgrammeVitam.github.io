

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>6.3. Troubleshooting &mdash; Documentation VITAM - Documentation d&#39;installation 3.0.1</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'3.0.1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="7. Montée de version" href="../upgrade/_toc.html" />
    <link rel="prev" title="6.2. Sauvegarde des éléments d’installation" href="20-ansible_backup.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'installation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_install/_toc.html">3. Prérequis à l’installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/_toc.html">4. Procédures d’installation / mise à jour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../update/_toc.html">5. Procédures de mise à jour de la configuration</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">6. Post installation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-validation_deploiement.html">6.1. Validation du déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-ansible_backup.html">6.2. Sauvegarde des éléments d’installation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.3. Troubleshooting</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#erreur-au-chargement-des-index-template-kibana">6.3.1. Erreur au chargement des <em>index template</em> kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="#erreur-au-chargement-des-tableaux-de-bord-kibana">6.3.2. Erreur au chargement des tableaux de bord Kibana</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#retour-d-experience-cas-rencontres">6.4. Retour d’expérience / cas rencontrés</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#crash-rsyslog-code-killed-signal-bus">6.4.1. Crash rsyslog, code killed, signal: BUS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mongo-express-ne-se-connecte-pas-a-la-base-de-donnees-associee">6.4.2. Mongo-express ne se connecte pas à la base de données associée</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elasticsearch-possede-des-shard-non-alloues-etat-unassigned">6.4.3. Elasticsearch possède des shard non alloués (état «&nbsp;UNASSIGNED&nbsp;»)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elasticsearch-possede-des-shards-non-initialises-etat-initializing">6.4.4. Elasticsearch possède des shards non initialisés (état «&nbsp;INITIALIZING&nbsp;»)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elasticsearch-est-dans-l-etat-read-only">6.4.5. Elasticsearch est dans l’état «&nbsp;<em>read-only</em>&nbsp;»</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mongodb-semble-lent">6.4.6. MongoDB semble lent</a></li>
<li class="toctree-l3"><a class="reference internal" href="#les-shards-de-mongodb-semblent-mal-equilibres">6.4.7. Les shards de MongoDB semblent mal équilibrés</a></li>
<li class="toctree-l3"><a class="reference internal" href="#l-importation-initiale-profil-de-securite-certificats-retourne-une-erreur">6.4.8. L’importation initiale (profil de sécurité, certificats) retourne une erreur</a></li>
<li class="toctree-l3"><a class="reference internal" href="#probleme-d-ingest-et-ou-d-access">6.4.9. Problème d’ingest et/ou d’access</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade/_toc.html">7. Montée de version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">8. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'installation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="_toc.html">6. Post installation</a> &raquo;</li>
        
      <li>6.3. Troubleshooting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/post_install/80-troubleshooting.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="troubleshooting">
<h1>6.3. Troubleshooting<a class="headerlink" href="#troubleshooting" title="Lien permanent vers ce titre">¶</a></h1>
<p>Cette section a pour but de recenser les problèmes déjà rencontrés et y apporter une solution associée.</p>
<div class="section" id="erreur-au-chargement-des-index-template-kibana">
<h2>6.3.1. Erreur au chargement des <em>index template</em> kibana<a class="headerlink" href="#erreur-au-chargement-des-index-template-kibana" title="Lien permanent vers ce titre">¶</a></h2>
<p>Cette erreur ne se produit qu’en cas de <em>filesystem</em> plein sur les partitions hébergeant un cluster elasticsearch. Par sécurité, kibana passe alors ses <em>index</em> en <code class="docutils literal notranslate"><span class="pre">READ</span> <span class="pre">ONLY</span></code>.</p>
<p>Pour fixer cela, il est d’abord nécessaire de déterminer la cause du <em>filesystem</em> plein,puis libérer ou agrandir l’espace disque.</p>
<p>Ensuite, comme indiqué sur <a class="reference external" href="https://discuss.elastic.co/t/forbidden-12-index-read-only-allow-delete-api/110282/2">ce fil de discussion</a>, vous devez désactiver le mode <code class="docutils literal notranslate"><span class="pre">READ</span> <span class="pre">ONLY</span></code> dans les <em>settings</em> de l’index <code class="docutils literal notranslate"><span class="pre">.kibana</span></code> du cluster elasticsearch.</p>
<p>Exemple:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="o">.</span><span class="n">kibana</span><span class="o">/</span><span class="n">_settings</span>
<span class="p">{</span>
    <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;blocks&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;read_only_allow_delete&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="first admonition-title">Indication</p>
<p class="last">Il est également possible de lancer cet appel via l”<a class="reference internal" href="../introduction.html#term-ihm"><span class="xref std std-term">IHM</span></a> du kibana associé, dans l’onglet <code class="docutils literal notranslate"><span class="pre">Dev</span> <span class="pre">Tools</span></code>.</p>
</div>
<p>A l’issue, vous pouvez relancer l’installation de la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>.</p>
</div>
<div class="section" id="erreur-au-chargement-des-tableaux-de-bord-kibana">
<h2>6.3.2. Erreur au chargement des tableaux de bord Kibana<a class="headerlink" href="#erreur-au-chargement-des-tableaux-de-bord-kibana" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cas de machines petitement taillées, il peut arriver que, durant le déploiement, la tâche <code class="docutils literal notranslate"><span class="pre">Wait</span> <span class="pre">for</span> <span class="pre">the</span> <span class="pre">kibana</span> <span class="pre">port</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">opened</span></code> prenne plus de temps que le <cite>timeout</cite> défini (<code class="docutils literal notranslate"><span class="pre">vitam_defaults.services.start_timeout</span></code>).
Pour fixer cela, il suffit de relancer le déploiement.</p>
</div>
</div>
<div class="section" id="retour-d-experience-cas-rencontres">
<h1>6.4. Retour d’expérience / cas rencontrés<a class="headerlink" href="#retour-d-experience-cas-rencontres" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="crash-rsyslog-code-killed-signal-bus">
<h2>6.4.1. Crash rsyslog, code killed, signal: BUS<a class="headerlink" href="#crash-rsyslog-code-killed-signal-bus" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il a été remarqué chez un partenaire du projet Vitam, que rsyslog se faisait <em>killer</em> peu après son démarrage par le signal SIGBUS.
Il s’agit très probablement d’un bug rsyslog &lt;= 8.24
<a class="reference external" href="https://github.com/rsyslog/rsyslog/issues/1404">https://github.com/rsyslog/rsyslog/issues/1404</a></p>
<p>Pour fixer ce problème, il est possible d’upgrader rsyslog sur une version plus à jour en suivant cette documentation:</p>
<ul class="simple">
<li><a class="reference external" href="https://www.rsyslog.com/rhelcentos-rpms/">Centos</a></li>
<li><a class="reference external" href="https://www.rsyslog.com/debian-repository/">Debian</a></li>
</ul>
</div>
<div class="section" id="mongo-express-ne-se-connecte-pas-a-la-base-de-donnees-associee">
<h2>6.4.2. Mongo-express ne se connecte pas à la base de données associée<a class="headerlink" href="#mongo-express-ne-se-connecte-pas-a-la-base-de-donnees-associee" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si mongoDB a été redémarré, il faut également redémarrer mongo-express.</p>
</div>
<div class="section" id="elasticsearch-possede-des-shard-non-alloues-etat-unassigned">
<h2>6.4.3. Elasticsearch possède des shard non alloués (état «&nbsp;UNASSIGNED&nbsp;»)<a class="headerlink" href="#elasticsearch-possede-des-shard-non-alloues-etat-unassigned" title="Lien permanent vers ce titre">¶</a></h2>
<p>Lors de la perte d’un noeud d’un cluster elasticseach, puis du retour de ce noeud, certains shards d’elasticseach peuvent rester dans l’état <code class="docutils literal notranslate"><span class="pre">UNASSIGNED</span></code> ; dans ce cas, cerebro affiche les shards correspondant en gris (au-dessus des noeuds) dans la vue «&nbsp;cluster&nbsp;», et l’état du cluster passe en «&nbsp;yellow&nbsp;».
Il est possible d’avoir plus d’informations sur la cause du problème via une requête <code class="docutils literal notranslate"><span class="pre">POST</span></code> sur l’API elasticsearch <code class="docutils literal notranslate"><span class="pre">_cluster/reroute?explain</span></code>. Si la cause de l’échec de l’assignation automatique a été résolue, il est possible de relancer les assignations automatiques en échec via une requête <code class="docutils literal notranslate"><span class="pre">POST</span></code> sur l’API <code class="docutils literal notranslate"><span class="pre">_cluster/reroute?retry_failed</span></code>.
Dans le cas où l’assignation automatique ne fonctionne pas, il est nécessaire de faire l’assignation à la main pour chaque shard incriminé (requête <code class="docutils literal notranslate"><span class="pre">POST</span></code> sur <code class="docutils literal notranslate"><span class="pre">_cluster/reroute</span></code>) :</p>
<div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                        <span class="s2">&quot;allocate&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;topbeat-2016.11.22&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;shard&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;vitam-iaas-dblog-01.int&quot;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Cependant, un shard primaire ne peut être réalloué de cette manière (il y a risque de perte de données). Si le défaut d’allocation provient effectivement de la perte puis de la récupération d’un noeud, et que TOUS les noeuds du cluster sont de nouveaux opérationnels et dans le cluster, alors il est possible de forcer la réallocation sans perte.</p>
<div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                        <span class="s2">&quot;allocate&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;topbeat-2016.11.22&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;shard&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;vitam-iaas-dblog-01.int&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;allow_primary&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sur tous ces sujets, Cf. la <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html">documentation officielle</a>.</p>
</div>
<div class="section" id="elasticsearch-possede-des-shards-non-initialises-etat-initializing">
<h2>6.4.4. Elasticsearch possède des shards non initialisés (état «&nbsp;INITIALIZING&nbsp;»)<a class="headerlink" href="#elasticsearch-possede-des-shards-non-initialises-etat-initializing" title="Lien permanent vers ce titre">¶</a></h2>
<p>Tout d’abord, il peut être difficile d’identifier les shards en questions dans cerebro ; une requête HTTP <code class="docutils literal notranslate"><span class="pre">GET</span></code> sur l’API <code class="docutils literal notranslate"><span class="pre">_cat/shards</span></code> permet d’avoir une liste plus compréhensible.
Un shard non initialisé correspond à un shard en cours de démarrage (Cf. <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/1.4/states.html">une ancienne page de documentation</a>. Si les shards non initialisés sont présents sur un seul noeud, il peut être utile de redémarrer le noeud en cause. Sinon, une investigation plus poussée doit être menée.</p>
</div>
<div class="section" id="elasticsearch-est-dans-l-etat-read-only">
<h2>6.4.5. Elasticsearch est dans l’état «&nbsp;<em>read-only</em>&nbsp;»<a class="headerlink" href="#elasticsearch-est-dans-l-etat-read-only" title="Lien permanent vers ce titre">¶</a></h2>
<p>Lorsque Elasticsearch répond par une erreur 403 et que le message suivant est observé dans les logs <code class="docutils literal notranslate"><span class="pre">ClusterBlockException[blocked</span> <span class="pre">by:</span> <span class="pre">[FORBIDDEN/xx/index</span> <span class="pre">read-only</span> <span class="pre">/</span> <span class="pre">allow</span> <span class="pre">delete</span> <span class="pre">(api)];</span></code>, cela est probablement consécutif à un remplissage à 100% de l’espace de stockage associé aux index Elasticsearch. Elasticsearch passe alors en lecture seule s’il ne peut plus indexer de documents et garantit ainsi la disponibilité des requêtes en lecture seule uniquement.</p>
<p>Afin de rétablir Elasticsearch dans un état de fonctionnement nominal, il vous faudra alors exécuter la requête suivante :</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="o">-</span><span class="n">H</span> <span class="s2">&quot;Content-Type: application/json&quot;</span> <span class="n">http</span><span class="p">:</span><span class="o">//&lt;</span><span class="n">es</span><span class="o">-</span><span class="n">host</span><span class="o">&gt;</span><span class="p">:</span><span class="o">&lt;</span><span class="n">es</span><span class="o">-</span><span class="n">port</span><span class="o">&gt;/</span><span class="n">_all</span><span class="o">/</span><span class="n">_settings</span> <span class="o">-</span><span class="n">d</span> <span class="s1">&#39;{&quot;index.blocks.read_only_allow_delete&quot;: null}&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="mongodb-semble-lent">
<h2>6.4.6. MongoDB semble lent<a class="headerlink" href="#mongodb-semble-lent" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour analyser la performance d’un cluster MongoDB, ce dernier fournit quelques outils permettant de faire une première analyse du comportement : <a class="reference external" href="https://docs.mongodb.com/manual/reference/program/mongostat/">mongostat</a>  et <a class="reference external" href="https://docs.mongodb.com/manual/reference/program/mongotop/">mongotop</a> .</p>
<p>Dans le cas de VITAM, le cluster MongoDB comporte plusieurs shards. Dans ce cas, l’usage de ces deux commandes peut se faire :</p>
<ul>
<li><p class="first">soit sur le cluster au global (en pointant sur les noeuds mongos) : cela permet d’analyser le comportement global du cluster au niveau de ses points d’entrées ;</p>
<blockquote>
<div><div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mongostat</span> <span class="o">--</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">ip_service</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">port</span> <span class="mi">27017</span> <span class="o">--</span><span class="n">username</span> <span class="n">vitamdb</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">password</span> <span class="o">&lt;</span><span class="n">password</span> <span class="p">;</span> <span class="n">défaut</span> <span class="p">:</span> <span class="n">azerty</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">authenticationDatabase</span> <span class="n">admin</span>
<span class="n">mongotop</span> <span class="o">--</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">ip_service</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">port</span> <span class="mi">27017</span> <span class="o">--</span><span class="n">username</span> <span class="n">vitamdb</span><span class="o">-</span><span class="n">admin</span> <span class="o">--</span><span class="n">password</span> <span class="o">&lt;</span><span class="n">password</span> <span class="p">;</span> <span class="n">défaut</span> <span class="p">:</span> <span class="n">azerty</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">authenticationDatabase</span> <span class="n">admin</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">soit directement sur les noeuds de stockage (mongod) : cela donne des résultats plus fins, et permet notamment de séparer l’analyse sur les noeuds primaires &amp; secondaires d’un même replicaset.</p>
<blockquote>
<div><div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mongotop</span> <span class="o">--</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">ip_service</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">port</span> <span class="mi">27019</span> <span class="o">--</span><span class="n">username</span> <span class="n">vitamdb</span><span class="o">-</span><span class="n">localadmin</span> <span class="o">--</span><span class="n">password</span> <span class="o">&lt;</span><span class="n">password</span> <span class="p">;</span> <span class="n">défaut</span> <span class="p">:</span> <span class="n">qwerty</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">authenticationDatabase</span> <span class="n">admin</span>
<span class="n">mongostat</span> <span class="o">--</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">ip_service</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">port</span> <span class="mi">27019</span> <span class="o">--</span><span class="n">username</span> <span class="n">vitamdb</span><span class="o">-</span><span class="n">localadmin</span> <span class="o">--</span><span class="n">password</span> <span class="o">&lt;</span><span class="n">password</span> <span class="p">;</span> <span class="n">défaut</span> <span class="p">:</span> <span class="n">qwerty</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">authenticationDatabase</span> <span class="n">admin</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>D’autres outils sont disponibles directement dans le client mongo, notamment pour troubleshooter <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/troubleshoot-replica-sets">les problèmes dûs à la réplication</a> :</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mongo</span> <span class="o">--</span><span class="n">host</span> <span class="o">&lt;</span><span class="n">ip_service</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">port</span> <span class="mi">27019</span> <span class="o">--</span><span class="n">username</span> <span class="n">vitamdb</span><span class="o">-</span><span class="n">localadmin</span> <span class="o">--</span><span class="n">password</span> <span class="o">&lt;</span><span class="n">password</span> <span class="p">;</span> <span class="n">défaut</span> <span class="p">:</span> <span class="n">qwerty</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">authenticationDatabase</span> <span class="n">admin</span>
<span class="o">&gt;</span> <span class="n">rs</span><span class="o">.</span><span class="n">printSlaveReplicationInfo</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="n">rs</span><span class="o">.</span><span class="n">printReplicationInfo</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span> <span class="p">{</span> <span class="n">serverStatus</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>D’autres commandes plus complètes existent et permettent d’avoir plus d’informations, mais leur analyse est plus complexe :</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># returns a variety of storage statistics for a given collection</span>
<span class="o">&gt;</span> <span class="n">use</span> <span class="n">metadata</span>
<span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">stats</span><span class="p">()</span>
<span class="o">&gt;</span> <span class="n">db</span><span class="o">.</span><span class="n">runCommand</span><span class="p">(</span> <span class="p">{</span> <span class="n">collStats</span><span class="p">:</span> <span class="s2">&quot;Unit&quot;</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>Enfin, un outil est disponible en standard afin de mesurer des performances des lecture/écritures avec des patterns proches de ceux utilisés par la base de données (<a class="reference external" href="https://docs.mongodb.com/manual/reference/program/mongoperf/">mongoperf</a> ):</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;{nThreads:16,fileSizeMB:10000,r:true,w:true}&quot;</span> <span class="o">|</span> <span class="n">mongoperf</span>
</pre></div>
</div>
</div>
<div class="section" id="les-shards-de-mongodb-semblent-mal-equilibres">
<h2>6.4.7. Les shards de MongoDB semblent mal équilibrés<a class="headerlink" href="#les-shards-de-mongodb-semblent-mal-equilibres" title="Lien permanent vers ce titre">¶</a></h2>
<p>Normalement, un processus interne à MongoDB (le <code class="docutils literal notranslate"><span class="pre">balancer</span></code>) s’occupe de déplacer les données entre les shards (par <code class="docutils literal notranslate"><span class="pre">chunk</span></code>) pour équilibrer la taille de ces derniers. Les commandes suivantes (à exécuter dans un shell mongo sur une instance mongos - attention, ces commandes ne fonctionnent pas directement sur les instances mongod) permettent de s’assurer du bon fonctionnement de ce processus :</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">sh.status()</span></code> : donne le status du sharding pour le cluster complet ; c’est un bon premier point d’entrée pour connaître l’état du balancer.</li>
<li><code class="docutils literal notranslate"><span class="pre">use</span> <span class="pre">&lt;dbname&gt;</span></code>, puis <code class="docutils literal notranslate"><span class="pre">db.&lt;collection&gt;.getShardDistribution()</span></code>, en indiquant le bon nom de base de données (ex: <code class="docutils literal notranslate"><span class="pre">metadata</span></code>) et de collection (ex: <code class="docutils literal notranslate"><span class="pre">Unit</span></code>) : donne les informations de répartition des chunks dans les différents shards pour cette collection.</li>
</ul>
</div>
<div class="section" id="l-importation-initiale-profil-de-securite-certificats-retourne-une-erreur">
<h2>6.4.8. L’importation initiale (profil de sécurité, certificats) retourne une erreur<a class="headerlink" href="#l-importation-initiale-profil-de-securite-certificats-retourne-une-erreur" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les playbooks d’initialisation importent des éléments d’administration du système (profils de sécurité, certificats) à travers des APIs de la solution VITAM. Cette importation peut être en échec, par exemple à l’étape <code class="docutils literal notranslate"><span class="pre">TASK</span> <span class="pre">[init_contexts_and_security_profiles</span> <span class="pre">:</span> <span class="pre">Import</span> <span class="pre">admin</span> <span class="pre">security</span> <span class="pre">profile</span> <span class="pre">to</span> <span class="pre">functionnal-admin]</span></code>, avec une erreur de type 400. Ce type d’erreur peut avoir plusieurs causes, et survient notamment lors de redéploiements après une première tentative non réussie de déploiement ; même si la cause de l’échec initial est résolue, le système peut se trouver dans un état instable. Dans ce cas, un déploiement complet sur environnement vide est nécessaire pour revenir à un état propre.</p>
<p>Une autre cause possible ici est une incohérence entre l’inventaire, qui décrit notamment les offres de stockage liées aux composants offer, et le paramétrage <code class="docutils literal notranslate"><span class="pre">vitam_strategy</span></code> porté par le fichier <code class="docutils literal notranslate"><span class="pre">offers_opts.yml</span></code>. Si une offre indiquée dans la stratégie n’existe nulle part dans l’inventaire, le déploiement sera en erreur. Dans ce cas, il faut remettre en cohérence ces paramètres et refaire un déploiement complet sur environnement vide.</p>
</div>
<div class="section" id="probleme-d-ingest-et-ou-d-access">
<h2>6.4.9. Problème d’ingest et/ou d’access<a class="headerlink" href="#probleme-d-ingest-et-ou-d-access" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si vous repérez un message de ce type dans les log <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>fr.gouv.vitam.common.security.filter.AuthorizationWrapper.checkTimestamp(AuthorizationWrapper.java:117) : [vitam-env-int8-app-04.vitam-env:storage:239079175] Timestamp check failed
</pre></div>
</div>
<p>Il faut vérifier / corriger l’heure des machines hébergeant la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ;  un <cite>delta</cite> de temps supérieur à 10s a été détecté entre les machines.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../upgrade/_toc.html" class="btn btn-neutral float-right" title="7. Montée de version" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="20-ansible_backup.html" class="btn btn-neutral float-left" title="6.2. Sauvegarde des éléments d’installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>