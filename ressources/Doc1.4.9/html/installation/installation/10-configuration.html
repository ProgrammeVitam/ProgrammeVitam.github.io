

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.2.2. Configuration du déploiement &mdash; Documentation VITAM - Documentation d&#39;installation 1.4.9</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="4.2.3. Gestion des certificats" href="20-certificats.html" />
    <link rel="prev" title="4.2.1. Multi-sites" href="05_multisite.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'installation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.4.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_install/_toc.html">3. Prérequis à l’installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">4. Procédures d’installation / mise à jour</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="_toc.html#verifications-prealables">4.1. Vérifications préalables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html#procedures">4.2. Procédures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="05_multisite.html">4.2.1. Multi-sites</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.2.2. Configuration du déploiement</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fichiers-de-deploiement">4.2.2.1. Fichiers de déploiement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#informations-plate-forme">4.2.2.2. Informations «&nbsp;plate-forme&nbsp;»</a></li>
<li class="toctree-l4"><a class="reference internal" href="#declaration-des-secrets">4.2.2.3. Déclaration des secrets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="20-certificats.html">4.2.3. Gestion des certificats</a></li>
<li class="toctree-l3"><a class="reference internal" href="21-addons.html">4.2.4. Paramétrages supplémentaires</a></li>
<li class="toctree-l3"><a class="reference internal" href="30-installation.html">4.2.5. Procédure de première installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="80-extras.html">4.2.6. Elements extras de l’installation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../update/_toc.html">5. Procédures de mise à jour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../post_install/_toc.html">6. Post installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">7. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'installation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="_toc.html">4. Procédures d’installation / mise à jour</a> &raquo;</li>
        
      <li>4.2.2. Configuration du déploiement</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/installation/10-configuration.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="configuration-du-deploiement">
<h1>4.2.2. Configuration du déploiement<a class="headerlink" href="#configuration-du-deploiement" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last">L’architecture de la solution logicielle, les éléments de dimensionnement ainsi que les principes de déploiement sont définis dans le <a class="reference internal" href="../introduction.html#term-dat"><span class="xref std std-term">DAT</span></a>.</p>
</div>
<div class="section" id="fichiers-de-deploiement">
<h2>4.2.2.1. Fichiers de déploiement<a class="headerlink" href="#fichiers-de-deploiement" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les fichiers de déploiement sont disponibles dans la version VITAM livrée dans le sous-répertoire <code class="docutils literal notranslate"><span class="pre">deployment</span></code> . Concernant l’installation, ils consistent en 2 parties&nbsp;:</p>
<blockquote>
<div><ul class="simple">
<li>les playbook ansible de déploiement, présents dans le sous-répertoire <code class="docutils literal notranslate"><span class="pre">ansible-vitam</span></code>, qui est indépendant de l’environnement à déployer ; ces fichiers ne sont normalement pas à modifier pour réaliser une installation.</li>
<li>l’arborescence d’inventaire&nbsp;; des fichiers d’exemple sont disponibles dans le sous-répertoire <code class="docutils literal notranslate"><span class="pre">environments</span></code>. Cette arborescence est valable pour le déploiement d’un environnement, et est à dupliquer lors de l’installation d’environnements ultérieurs. Les fichiers qui y sont contenus doivent être adaptés avant le déploiement, comme il est expliqué dans les paragraphes suivants.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="informations-plate-forme">
<span id="inventaire"></span><h2>4.2.2.2. Informations «&nbsp;plate-forme&nbsp;»<a class="headerlink" href="#informations-plate-forme" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="id1">
<h3>4.2.2.2.1. Inventaire<a class="headerlink" href="#id1" title="Lien permanent vers ce titre">¶</a></h3>
<p>Pour configurer le déploiement, il est nécessaire de créer dans le répertoire <code class="docutils literal notranslate"><span class="pre">environments</span></code> un nouveau fichier d’inventaire (dans la suite, ce fichier sera communément appelé  <code class="docutils literal notranslate"><span class="pre">hosts.&lt;environnement&gt;</span></code>). Ce fichier doit être basé sur la structure présente dans le fichier <code class="docutils literal notranslate"><span class="pre">hosts.example</span></code> (et notamment respecter scrupuleusement l’arborescence des groupes ansible) ; les commentaires dans ce fichier donnent les explications permettant l’adaptation à l’environnement cible :</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[hosts]</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[hosts:children]</span>
<span class="na">vitam</span>
<span class="na">reverse</span>
<span class="na">library</span>
<span class="na">hosts-dev-tools</span>
<span class="na">ldap</span>


<span class="c1">########### Tests environments specifics ###########</span>

<span class="c1"># EXTRA : Front reverse-proxy (test environments ONLY) ; add machine name after</span>
<span class="k">[reverse]</span>
<span class="c1"># optional : after machine, if this machine is different from VITAM machines, you can specify another become user</span>
<span class="c1"># Example</span>
<span class="c1"># vitam-centos-01.vitam ansible_ssh_user=centos</span>

<span class="c1">########### Extra VITAM applications ###########</span>

<span class="na">[ldap] # Extra : OpenLDAP server</span>
<span class="c1"># LDAP server !!! NOT FOR PRODUCTION !!! Test only</span>

<span class="k">[library]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : library</span>

<span class="k">[hosts-dev-tools]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : mongo-express, elasticsearch-head</span>

<span class="na">[elasticsearch:children] # EXTRA : elasticsearch</span>
<span class="na">hosts-elasticsearch-data</span>
<span class="na">hosts-elasticsearch-log</span>

<span class="c1">########### VITAM services ###########</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[vitam:children]</span>
<span class="na">zone-external</span>
<span class="na">zone-access</span>
<span class="na">zone-applicative</span>
<span class="na">zone-storage</span>
<span class="na">zone-data</span>
<span class="na">zone-admin</span>


<span class="c1">##### Zone externe</span>


<span class="k">[zone-external:children]</span>
<span class="na">hosts-ihm-demo</span>
<span class="na">hosts-cerebro</span>
<span class="na">hosts-ihm-recette</span>


<span class="k">[hosts-ihm-demo]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : ihm-demo</span>
<span class="c1"># If you don&#39;t need consul for ihm-demo, you can set this var after each hostname :</span>
<span class="c1"># consul_disabled=true</span>

<span class="k">[hosts-ihm-recette]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : ihm-recette (extra feature)</span>

<span class="k">[hosts-cerebro]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : vitam-elasticsearch-cerebro</span>


<span class="c1">##### Zone access</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[zone-access:children]</span>
<span class="na">hosts-ingest-external</span>
<span class="na">hosts-access-external</span>

<span class="k">[hosts-ingest-external]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : ingest-external</span>


<span class="k">[hosts-access-external]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : access-external</span>


<span class="c1">##### Zone applicative</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[zone-applicative:children]</span>
<span class="na">hosts-ingest-internal</span>
<span class="na">hosts-processing</span>
<span class="na">hosts-worker</span>
<span class="na">hosts-access-internal</span>
<span class="na">hosts-metadata</span>
<span class="na">hosts-functional-administration</span>
<span class="na">hosts-logbook</span>
<span class="na">hosts-workspace</span>
<span class="na">hosts-storage-engine</span>
<span class="na">hosts-security-internal</span>

<span class="k">[hosts-security-internal]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : security-internal</span>


<span class="k">[hosts-logbook]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : logbook</span>


<span class="k">[hosts-workspace]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : workspace</span>


<span class="k">[hosts-ingest-internal]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : ingest-internal</span>


<span class="k">[hosts-access-internal]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : access-internal</span>


<span class="k">[hosts-metadata]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : metadata</span>


<span class="k">[hosts-functional-administration]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : functional-administration</span>


<span class="k">[hosts-processing]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : processing</span>


<span class="k">[hosts-storage-engine]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : storage-engine</span>


<span class="k">[hosts-worker]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : worker</span>
<span class="c1"># Optional parameter after each host : vitam_worker_capacity=&lt;integer&gt; ; please refer to your infrastructure for defining this number ; default is ansible_processor_vcpus value (cpu number in /proc/cpuinfo file)</span>


<span class="c1">##### Zone storage</span>

<span class="na">[zone-storage:children] # DO NOT MODIFY</span>
<span class="na">hosts-storage-offer-default</span>
<span class="na">hosts-mongodb-offer</span>

<span class="k">[hosts-storage-offer-default]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : storage-offer-default</span>
<span class="c1"># LIMIT : only 1 offer per machine and 1 machine per offer</span>
<span class="c1"># Mandatory param for each offer is offer_conf and points to offer_opts.yml &amp; vault-vitam.yml (with same tree)</span>
<span class="c1"># hostname-offre-1.vitam offer_conf=offer-swift-1</span>
<span class="c1"># for filesystem</span>
<span class="c1"># hostname-offre-2.vitam offer_conf=offer-fs-1</span>

<span class="k">[hosts-mongodb-offer:children]</span>
<span class="na">hosts-mongos-offer</span>
<span class="na">hosts-mongoc-offer</span>
<span class="na">hosts-mongod-offer</span>

<span class="k">[hosts-mongos-offer]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongos-data]</span>
<span class="c1"># TODO: put here servers where this service will be deployed : mongos cluster for storage offers</span>
<span class="c1"># Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)</span>
<span class="c1"># Example (for a more complete one, see the one in the group hosts-mongos-data) :</span>
<span class="c1"># vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1</span>
<span class="c1"># vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1</span>
<span class="c1"># vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1</span>
<span class="c1"># vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1</span>

<span class="k">[hosts-mongoc-offer]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongoc-data]</span>
<span class="c1"># TODO: put here servers where this service will be deployed : mongoc cluster for storage offers</span>
<span class="c1"># Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)</span>
<span class="c1"># Optional param : mandatory for 1 node of the shard, some init commands will be executed on it</span>
<span class="c1"># Optional param : mongo_arbiter=true : the node will be only an arbiter ; do not add this paramter on a mongo_rs_bootstrap node</span>
<span class="c1"># Example :</span>
<span class="c1"># vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1                       mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1</span>
<span class="c1"># vitam-swift-offer            mongo_cluster_name=offer-swift-1                       mongo_arbiter=true</span>
<span class="c1"># vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1                          mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1</span>
<span class="c1"># vitam-fs-offer               mongo_cluster_name=offer-fs-1                          mongo_arbiter=true</span>

<span class="k">[hosts-mongod-offer]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongod-data]</span>
<span class="c1"># TODO: put here servers where this service will be deployed : mongod cluster for storage offers</span>
<span class="c1"># Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)</span>
<span class="c1"># Mandatory param : id of the current shard, increment by 1 from 0 to n</span>
<span class="c1"># Optional param : mandatory for 1 node of the shard, some init commands will be executed on it</span>
<span class="c1"># Optional param : mongo_arbiter=true : the node will be only an arbiter ; do not add this paramter on a mongo_rs_bootstrap node</span>
<span class="c1"># Example :</span>
<span class="c1"># vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1    mongo_shard_id=0                   mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1    mongo_shard_id=0</span>
<span class="c1"># vitam-swift-offer            mongo_cluster_name=offer-swift-1    mongo_shard_id=0                   mongo_arbiter=true</span>
<span class="c1"># vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1       mongo_shard_id=0                   mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1       mongo_shard_id=0</span>
<span class="c1"># vitam-fs-offer               mongo_cluster_name=offer-fs-1       mongo_shard_id=0                   mongo_arbiter=true</span>

<span class="c1">##### Zone data</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[zone-data:children]</span>
<span class="na">hosts-elasticsearch-data</span>
<span class="na">hosts-mongodb-data</span>

<span class="k">[hosts-elasticsearch-data]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : elasticsearch-data cluster</span>
<span class="c1"># 2 params available for huge environments (parameter to be declared after each server) :</span>
<span class="c1">#    is_data=true/false</span>
<span class="c1">#    is_master=true/false</span>
<span class="c1">#    other options are not handled yet</span>
<span class="c1"># defaults are set to true, if undefined. If defined, at least one server MUST be is_data=true</span>
<span class="c1"># Examples :</span>
<span class="c1"># server1 is_master=true is_data=false</span>
<span class="c1"># server2 is_master=false is_data=true</span>
<span class="c1"># More explanation here : https://www.elastic.co/guide/en/elasticsearch/reference/5.6/modules-node.html</span>


<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[hosts-mongodb-data:children]</span>
<span class="na">hosts-mongos-data</span>
<span class="na">hosts-mongoc-data</span>
<span class="na">hosts-mongod-data</span>

<span class="k">[hosts-mongos-data]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongos-offer]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : mongos cluster</span>
<span class="c1"># Mandatory param : mongo_cluster_name=mongo-data  (&quot;mongo-data&quot; is mandatory)</span>
<span class="c1"># Example :</span>
<span class="c1"># vitam-mdbs-01   mongo_cluster_name=mongo-data</span>
<span class="c1"># vitam-mdbs-01   mongo_cluster_name=mongo-data</span>
<span class="c1"># vitam-mdbs-01   mongo_cluster_name=mongo-data</span>

<span class="k">[hosts-mongoc-data]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongoc-offer]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : mongoc cluster</span>
<span class="c1"># Mandatory param : mongo_cluster_name=mongo-data  (&quot;mongo-data&quot; is mandatory)</span>
<span class="c1"># Optional param : mandatory for 1 node of the shard, some init commands will be executed on it</span>
<span class="c1"># Example :</span>
<span class="c1"># vitam-mdbc-01   mongo_cluster_name=mongo-data                     mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mdbc-01   mongo_cluster_name=mongo-data</span>
<span class="c1"># vitam-mdbc-01   mongo_cluster_name=mongo-data</span>

<span class="k">[hosts-mongod-data]</span>
<span class="c1"># WARNING : DO NOT COLLOCATE WITH [hosts-mongod-offer]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : mongod cluster</span>
<span class="c1"># Each replica_set should have an odd number of members (2n + 1)</span>
<span class="c1"># Reminder: For Vitam, one mongodb shard is using one replica_set</span>
<span class="c1"># Mandatory param : mongo_cluster_name=mongo-data (&quot;mongo-data&quot; is mandatory)</span>
<span class="c1"># Mandatory param : id of the current shard, increment by 1 from 0 to n</span>
<span class="c1"># Optional param : mandatory for 1 node of the shard, some init commands will be executed on it</span>
<span class="c1"># Example:</span>
<span class="c1"># vitam-mdbd-01  mongo_cluster_name=mongo-data   mongo_shard_id=0  mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mdbd-02  mongo_cluster_name=mongo-data   mongo_shard_id=0</span>
<span class="c1"># vitam-mdbd-03  mongo_cluster_name=mongo-data   mongo_shard_id=0</span>
<span class="c1"># vitam-mdbd-04  mongo_cluster_name=mongo-data   mongo_shard_id=1  mongo_rs_bootstrap=true</span>
<span class="c1"># vitam-mdbd-05  mongo_cluster_name=mongo-data   mongo_shard_id=1</span>
<span class="c1"># vitam-mdbd-06  mongo_cluster_name=mongo-data   mongo_shard_id=1</span>

<span class="c1">###### Zone admin</span>

<span class="c1"># Group definition ; DO NOT MODIFY</span>
<span class="k">[zone-admin:children]</span>
<span class="na">hosts-consul-server</span>
<span class="na">hosts-kibana-data</span>
<span class="na">log-servers</span>
<span class="na">hosts-elasticsearch-log</span>

<span class="k">[hosts-consul-server]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : consul</span>

<span class="k">[hosts-kibana-data]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : kibana (for data cluster)</span>

<span class="k">[log-servers:children]</span>
<span class="na">hosts-kibana-log</span>
<span class="na">hosts-logstash</span>


<span class="k">[hosts-kibana-log]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : kibana (for log cluster)</span>

<span class="k">[hosts-logstash]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : logstash</span>


<span class="k">[hosts-elasticsearch-log]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : elasticsearch-log cluster</span>

<span class="c1">########### Global vars ###########</span>

<span class="k">[hosts:vars]</span>

<span class="c1"># ===============================</span>
<span class="c1"># VITAM</span>
<span class="c1"># ===============================</span>

<span class="c1"># Declare user for ansible on target machines</span>
<span class="na">ansible_ssh_user</span><span class="o">=</span>
<span class="c1"># Can target user become as root ? ; true is required by VITAM (usage of a sudoer is mandatory)</span>
<span class="na">ansible_become</span><span class="o">=</span><span class="s">true</span>

<span class="c1"># Related to Consul ; apply in a table your DNS server(s)</span>
<span class="c1"># Example : dns_servers=[&quot;8.8.8.8&quot;,&quot;8.8.4.4&quot;]</span>
<span class="na">dns_servers</span><span class="o">=</span>

<span class="c1"># Vitam tenants to create</span>
<span class="na">vitam_tenant_ids</span><span class="o">=</span><span class="s">[0,1,2]</span>
<span class="na">vitam_tenant_admin</span><span class="o">=</span><span class="s">1</span>

<span class="c1">### Logback configuration ###</span>
<span class="c1"># Days before deleting logback log files (java &amp; access logs for vitam components)</span>
<span class="na">days_to_delete_logback_logfiles</span><span class="o">=</span>

<span class="c1"># Define local Consul datacenter name</span>
<span class="na">vitam_site_name</span><span class="o">=</span><span class="s">prod-dc1</span>
<span class="c1"># EXAMPLE : vitam_site_name = prod-dc1</span>
<span class="c1"># check whether on primary site (true) or secondary (false)</span>
<span class="na">primary_site</span><span class="o">=</span><span class="s">true</span>


<span class="c1"># ===============================</span>
<span class="c1"># EXTRA</span>
<span class="c1"># ===============================</span>
<span class="c1"># Environment (defines title in extra on reverse homepage). Variable is DEPRECATED !</span>
<span class="c1">#environnement=</span>

<span class="c1">### vitam-itest repository ###</span>
<span class="na">vitam_tests_branch</span><span class="o">=</span><span class="s">master</span>
<span class="na">vitam_tests_gitrepo_protocol</span><span class="o">=</span>
<span class="na">vitam_tests_gitrepo_baseurl</span><span class="o">=</span>
<span class="na">vitam_tests_gitrepo_url</span><span class="o">=</span>

<span class="c1"># Used when VITAM is behind a reverse proxy (provides configuration for reverse proxy &amp;&amp; displayed in header page)</span>
<span class="na">vitam_reverse_external_dns</span><span class="o">=</span>
<span class="c1"># For reverse proxy use</span>
<span class="na">reverse_proxy_port</span><span class="o">=</span><span class="s">80</span>
<span class="c1"># http_proxy env var to use ; has to be declared even if empty</span>
<span class="na">http_proxy_environnement</span><span class="o">=</span>
</pre></div>
</td></tr></table></div>
<p>Pour chaque type de «&nbsp;host&nbsp;», indiquer le(s) serveur(s) défini(s) pour chaque fonction. Une colocalisation de composants est possible (Cf. le paragraphe idoine du <a class="reference internal" href="../introduction.html#term-dat"><span class="xref std std-term">DAT</span></a>)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Concernant le groupe «&nbsp;hosts-consul-server&nbsp;», il est nécessaire de déclarer un minimum de 3 machines.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Il n’est pas possible de colocaliser les clusters MongoDB «&nbsp;data&nbsp;» et «&nbsp;offer&nbsp;».</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Il n’est pas possible de colocaliser «&nbsp;kibana-data&nbsp;» et «&nbsp;kibana-log&nbsp;».</p>
</div>
</div>
<div class="section" id="fichier-vitam-security-yml">
<h3>4.2.2.2.2. Fichier <code class="docutils literal notranslate"><span class="pre">vitam_security.yml</span></code><a class="headerlink" href="#fichier-vitam-security-yml" title="Lien permanent vers ce titre">¶</a></h3>
<p>La configuration des droits d’accès à VITAM est réalisée dans le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/vitam_security.yml</span></code>, comme suit :</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="c1"># Business vars</span>

<span class="c1">### Admin context name and tenants ###</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;admin-context&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_tenants</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{vitam_tenant_ids}}&quot;</span>
<span class="c1"># Indicate context certificates relative paths under {{inventory_dir}}/certs/client-external/clients</span>
<span class="c1"># vitam-admin-int is mandatory for internal use (PRONOM upload)</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_certs</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;ihm-demo/ihm-demo.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;ihm-recette/ihm-recette.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;reverse/reverse.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;vitam-admin-int/vitam-admin-int.crt&quot;</span> <span class="p p-Indicator">]</span>
<span class="c1"># Indicate here all the personal certificates relative paths under {{inventory_dir}}/certs/client-vitam-users/clients</span>
<span class="l l-Scalar l-Scalar-Plain">admin_personal_certs</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;userOK.crt&quot;</span> <span class="p p-Indicator">]</span>

<span class="c1"># Admin security profile name</span>
<span class="l l-Scalar l-Scalar-Plain">admin_security_profile</span><span class="p p-Indicator">:</span> <span class="s">&quot;admin-security-profile&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">admin_basic_auth_user</span><span class="p p-Indicator">:</span> <span class="s">&quot;adminUser&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="fichier-offers-opts-yml">
<h3>4.2.2.2.3. Fichier <code class="docutils literal notranslate"><span class="pre">offers_opts.yml</span></code><a class="headerlink" href="#fichier-offers-opts-yml" title="Lien permanent vers ce titre">¶</a></h3>
<p>Enfin, la déclaration des configuration des offres de stockage est réalisée dans le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/offers_opts.yml</span></code> :</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># This list is ordered. It can and has to be completed if more offers are necessary</span>
<span class="c1"># Strategy order (1st has to be the prefered one)</span>
<span class="l l-Scalar l-Scalar-Plain">vitam_strategy</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span>
    <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="c1">#    vitam_site_name: prod-dc2</span>
<span class="c1">#  - name: offer-swift-1</span>
<span class="c1"># Example :</span>
<span class="c1">#  - name: distant</span>
<span class="c1">#    referent: true</span>
<span class="c1">#    vitam_site_name: distant-dc2</span>

<span class="c1"># DON&#39;T forget to add associated passwords in vault-vitam.yml with same tree when using provider openstack-swift*</span>
<span class="c1"># ATTENTION !!! Each offer has to have a distinct name, except for clusters binding a same physical storage</span>
<span class="c1"># WARNING : for offer names, please only use [a-z][a-z0-9-]* pattern</span>
<span class="l l-Scalar l-Scalar-Plain">vitam_offers</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span><span class="p p-Indicator">:</span>
    <span class="c1"># param can be filesystem-hash (recomended) or filesystem (not recomended)</span>
    <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
  <span class="l l-Scalar l-Scalar-Plain">offer-swift-1</span><span class="p p-Indicator">:</span>
    <span class="c1"># provider : openstack-swift for v1 or openstack-swift-v3 for v3</span>
    <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openstack-swift-v3</span>
    <span class="c1"># swiftKeystoneAuthUrl : URL de connexion à keystone</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftKeystoneAuthUrl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://openstack-hostname:port/auth/1.0</span>
    <span class="c1"># swiftDomain : domaine OpenStack dans lequel l&#39;utilisateur est enregistré</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftDomain</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">domaine</span>
    <span class="c1"># swiftUser : identifiant de l&#39;utilisateur</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftUser</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utilisateur</span>
    <span class="c1"># swiftPassword: has to be set in vault-vitam.yml (encrypted) with same structure =&gt; DO NOT COMMENT OUT</span>
    <span class="c1"># swiftProjectName : nom du projet openstack</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftProjectName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">monTenant</span>
    <span class="c1"># swiftUrl: optional variable to force the swift URL</span>
    <span class="c1"># swiftUrl: https://swift-hostname:port/swift/v1</span>
    <span class="c1">#SSL TrustStore</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftTrustStore</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/chemin_vers_mon_fichier/monSwiftTrustStore.jks</span>
    <span class="c1">#Max connection (concurrent connections), per route, to keep in pool (if a pooling ConnectionManager is used) (by default 2 for Apache HttpClient)</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftMaxConnectionsPerRoute</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
    <span class="c1">#Max total connection (concurrent connections) to keep in pool (if a pooling ConnectionManager is used) (by default 20 for Apache HttpClient)</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftMaxConnections</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1000</span>
    <span class="c1">#Max time (in milliseconds) for waiting to establish connection</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftConnectionTimeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200000</span>
    <span class="c1">#Max time (in milliseconds) waiting for a data from the server (socket)</span>
    <span class="l l-Scalar l-Scalar-Plain">swiftReadTimeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2000</span>
  <span class="c1"># example_swift_v1:</span>
  <span class="c1">#    provider: openstack-swift</span>
  <span class="c1">#    swiftKeystoneAuthUrl: https://keystone/auth/1.0</span>
  <span class="c1">#    swiftDomain: domain</span>
  <span class="c1">#    swiftUser: user</span>
  <span class="c1">#    swiftPassword: has to be set in vault-vitam.yml (encrypted) with same structure =&gt; DO NOT COMMENT OUT</span>
  <span class="c1"># example_swift_v3:</span>
  <span class="c1">#    provider: openstack-swift-v3</span>
  <span class="c1">#    swiftKeystoneAuthUrl: https://keystone/v3</span>
  <span class="c1">#    swiftDomain: domaine</span>
  <span class="c1">#    swiftUser: user</span>
  <span class="c1">#    swiftPassword: has to be set in vault-vitam.yml (encrypted) with same structure =&gt; DO NOT COMMENT OUT</span>
  <span class="c1">#    swiftProjectName: monTenant</span>
  <span class="c1">#    projectName: monTenant</span>
  <span class="c1"># swiftTrustStore: /chemin_vers_mon_fichier/monSwiftTrustStore.jks</span>
  <span class="c1"># swiftMaxConnectionsPerRoute: 200</span>
  <span class="c1"># swiftMaxConnections: 1000</span>
  <span class="c1"># swiftConnectionTimeout: 200000</span>
  <span class="c1"># swiftReadTimeout: 2000</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p>Se référer aux commentaires dans le fichier pour le renseigner correctement.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dans le cas d’un déploiement multi-sites, dans la section <code class="docutils literal notranslate"><span class="pre">vitam_strategy</span></code>, la directive <code class="docutils literal notranslate"><span class="pre">vitam_site_name</span></code> définit pour l’offre associée le nom du datacenter consul. Par défaut, si non définie, c’est la valeur de la variable <code class="docutils literal notranslate"><span class="pre">vitam_site_name</span></code> définie dans l’inventaire.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">La cohérence entre l’inventaire et la section <code class="docutils literal notranslate"><span class="pre">vitam_strategy</span></code> est critique pour le bon déploiement et fonctionnement de la solution logicielle VITAM. En particulier, la liste d’offres de <code class="docutils literal notranslate"><span class="pre">vitam_strategy</span></code> doit correspondre <em>exactement</em> aux noms d’offre déclarés dans l’inventaire (ou les inventaires de chaque datacenter, en cas de fonctionnement multi-site).</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Ne pas oublier, en cas de connexion à un keystone en https, de répercuter dans la <a class="reference internal" href="../introduction.html#term-pki"><span class="xref std std-term">PKI</span></a> la clé publique de la CA du keystone.</p>
</div>
</div>
<div class="section" id="fichier-cots-vars-yml">
<h3>4.2.2.2.4. Fichier <code class="docutils literal notranslate"><span class="pre">cots_vars.yml</span></code><a class="headerlink" href="#fichier-cots-vars-yml" title="Lien permanent vers ce titre">¶</a></h3>
<p>Dans le cas du choix du <a class="reference internal" href="../introduction.html#term-cots"><span class="xref std std-term">COTS</span></a> d’envoi des messages syslog dans logastsh, il est possible de choisir entre <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code> et <code class="docutils literal notranslate"><span class="pre">rsyslog</span></code> dans le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/cots_vars.yml</span></code> :</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="l l-Scalar l-Scalar-Plain">consul</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">dns_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">53</span>

<span class="l l-Scalar l-Scalar-Plain">consul_remote_sites</span><span class="p p-Indicator">:</span>
    <span class="c1"># wan contains the wan addresses of the consul server instances of the external vitam sites</span>
    <span class="c1"># Exemple, if our local dc is dc1, we will need to set dc2 &amp; dc3 wan conf:</span>
    <span class="c1"># - dc2:</span>
    <span class="c1">#   wan: [&quot;10.10.10.10&quot;,&quot;1.1.1.1&quot;]</span>
    <span class="c1"># - dc3:</span>
    <span class="c1">#   wan: [&quot;10.10.10.11&quot;,&quot;1.1.1.1&quot;]</span>

<span class="l l-Scalar l-Scalar-Plain">elasticsearch</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">log</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-log.service.{{</span><span class="nv"> </span><span class="s">consul_domain</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port_http</span><span class="p p-Indicator">:</span> <span class="s">&quot;9201&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port_tcp</span><span class="p p-Indicator">:</span> <span class="s">&quot;9301&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">groupe</span><span class="p p-Indicator">:</span> <span class="s">&quot;log&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-log&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">cluster_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-log&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">https_enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-data.service.{{</span><span class="nv"> </span><span class="s">consul_domain</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port_http</span><span class="p p-Indicator">:</span> <span class="s">&quot;9200&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port_tcp</span><span class="p p-Indicator">:</span> <span class="s">&quot;9300&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">groupe</span><span class="p p-Indicator">:</span> <span class="s">&quot;data&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-data&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">cluster_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;elasticsearch-data&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">https_enabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>

<span class="l l-Scalar l-Scalar-Plain">mongodb</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">mongos_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">27017</span>
    <span class="l l-Scalar l-Scalar-Plain">mongoc_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">27018</span>
    <span class="l l-Scalar l-Scalar-Plain">mongod_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">27019</span>
    <span class="l l-Scalar l-Scalar-Plain">mongo_authentication</span><span class="p p-Indicator">:</span> <span class="s">&quot;true&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&quot;mongos.service.{{</span><span class="nv"> </span><span class="s">consul_domain</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">logstash</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">host</span><span class="p p-Indicator">:</span> <span class="s">&quot;logstash.service.{{</span><span class="nv"> </span><span class="s">consul_domain</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">logstash</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10514</span>
    <span class="l l-Scalar l-Scalar-Plain">rest_port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20514</span>

<span class="c1"># Curator units: days</span>
<span class="l l-Scalar l-Scalar-Plain">curator</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">log</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">metrics</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">close</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">delete</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
        <span class="l l-Scalar l-Scalar-Plain">logstash</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">close</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">delete</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
        <span class="l l-Scalar l-Scalar-Plain">metricbeat</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">close</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">delete</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
        <span class="l l-Scalar l-Scalar-Plain">packetbeat</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">close</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">delete</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>

<span class="l l-Scalar l-Scalar-Plain">kibana</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">log</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;kibana_log&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">api_call_timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">120</span>
        <span class="l l-Scalar l-Scalar-Plain">groupe</span><span class="p p-Indicator">:</span> <span class="s">&quot;log&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5601</span>
        <span class="c1"># pour index logstash-*</span>
        <span class="l l-Scalar l-Scalar-Plain">metrics</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">shards</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">replica</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="c1"># pour index metrics-vitam-*</span>
        <span class="l l-Scalar l-Scalar-Plain">logs</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">shards</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
            <span class="l l-Scalar l-Scalar-Plain">replica</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="c1"># KWA FIXME : changing port doesn&#39;t work, yet (not taken into account in kibana configuration)</span>
    <span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;kibana_data&quot;</span>
        <span class="c1"># OMA : bugdette : api_call_timeout is used for retries ; should ceate a separate variable rather than this one</span>
        <span class="l l-Scalar l-Scalar-Plain">api_call_timeout</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">120</span>
        <span class="l l-Scalar l-Scalar-Plain">groupe</span><span class="p p-Indicator">:</span> <span class="s">&quot;data&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">5601</span>
        <span class="l l-Scalar l-Scalar-Plain">shards</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
        <span class="l l-Scalar l-Scalar-Plain">replica</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>

<span class="l l-Scalar l-Scalar-Plain">syslog</span><span class="p p-Indicator">:</span>
    <span class="c1"># value can be syslog-ng or rsyslog</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;rsyslog&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">cerebro</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;cerebro&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">9000</span>

<span class="l l-Scalar l-Scalar-Plain">siegfried</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">19000</span>

<span class="l l-Scalar l-Scalar-Plain">clamav</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">3310</span>
    <span class="c1"># frequency freshclam for database update per day (from 0 to 24 - 24 meaning hourly check)</span>
    <span class="l l-Scalar l-Scalar-Plain">db_update_periodicity</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>

<span class="l l-Scalar l-Scalar-Plain">mongo_express</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">baseuri</span><span class="p p-Indicator">:</span> <span class="s">&quot;mongo-express&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">ldap_authentification</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_protocol</span><span class="p p-Indicator">:</span> <span class="s">&quot;ldap&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_server</span><span class="p p-Indicator">:</span> <span class="s">&quot;{%</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">groups[&#39;ldap&#39;]|length</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">0</span><span class="nv"> </span><span class="s">%}{{</span><span class="nv"> </span><span class="s">groups[&#39;ldap&#39;]|first</span><span class="nv"> </span><span class="s">}}{%</span><span class="nv"> </span><span class="s">endif</span><span class="nv"> </span><span class="s">%}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_port</span><span class="p p-Indicator">:</span> <span class="s">&quot;389&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_base</span><span class="p p-Indicator">:</span> <span class="s">&quot;dc=programmevitam,dc=fr&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_login</span><span class="p p-Indicator">:</span> <span class="s">&quot;cn=Manager,dc=programmevitam,dc=fr&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">uid_field</span><span class="p p-Indicator">:</span> <span class="s">&quot;uid&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_userDn_Template</span><span class="p p-Indicator">:</span> <span class="s">&quot;uid={0},ou=people,dc=programmevitam,dc=fr&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_group_request</span><span class="p p-Indicator">:</span> <span class="s">&quot;(&amp;(objectClass=groupOfNames)(member={0}))&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_admin_group</span><span class="p p-Indicator">:</span> <span class="s">&quot;cn=admin,ou=groups,dc=programmevitam,</span><span class="nv"> </span><span class="s">dc=fr&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_user_group</span><span class="p p-Indicator">:</span> <span class="s">&quot;cn=user,ou=groups,dc=programmevitam,</span><span class="nv"> </span><span class="s">dc=fr&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">ldap_guest_group</span><span class="p p-Indicator">:</span> <span class="s">&quot;cn=guest,ou=groups,dc=programmevitam,</span><span class="nv"> </span><span class="s">dc=fr&quot;</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p>Il faut alors modifier la valeur de la directive <code class="docutils literal notranslate"><span class="pre">syslog.name</span></code> ; la valur par défaut est <code class="docutils literal notranslate"><span class="pre">rsyslog</span></code>.</p>
</div>
</div>
<div class="section" id="declaration-des-secrets">
<span id="pkiconfsection"></span><h2>4.2.2.3. Déclaration des secrets<a class="headerlink" href="#declaration-des-secrets" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Cette section décrit des fichiers contenant des données sensibles ; il convient de sécuriser ces fichiers avec un mot de passe «&nbsp;fort&nbsp;». En cas d’usage d’un fichier de mot de passe («&nbsp;vault-password-file&nbsp;»), il faut renseigner ce mot de passe comme contenu du fichier et ne pas oublier de sécuriser ou supprimer ce fichier à l’issue de l’installation.</p>
</div>
<p>Les secrets utilisés par la solution logicielle (en-dehors des certificats qui sont abordés dans une section ultérieure) sont définis dans des fichiers chiffrés par ansible-vault.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Tous les vault présents dans l’arborescence d’inventaire doivent être tous protégés par le même mot de passe !</p>
</div>
<p>La première étape consiste à changer les mots de passe de tous les vault présents dans l’arborescence de déploiement (le mot de passe par défaut est contenu dans le fichier <code class="docutils literal notranslate"><span class="pre">vault_pass.txt</span></code>) à l’aide de la commande <code class="docutils literal notranslate"><span class="pre">ansible-vault</span> <span class="pre">rekey</span> <span class="pre">&lt;fichier</span> <span class="pre">vault&gt;</span></code>.</p>
<p>Voici la liste des vaults pour lesquels il est nécessaire de modifier le mot de passe:</p>
<ul class="simple">
<li>environments/group_vars/all/vault-vitam.yml</li>
<li>environments/group_vars/all/vault-keystores.yml</li>
<li>environments/group_vars/all/vault-extra.yml</li>
<li>environments/certs/vault-certs.yml</li>
</ul>
<p>2 vaults sont principalement utilisés dans le déploiement d’une version ; leur contenu est donc à modifier avant tout déploiement :</p>
<ul>
<li><p class="first">Le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/vault-vitam.yml</span></code> contient les secrets généraux :</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Vitam platform secret key</span>
<span class="na">plateforme_secret: vitamsecret</span>

<span class="c1"># Cerebro key</span>
<span class="na">cerebro_secret_key: tGz28hJkiW[p@a34G</span>

<span class="c1"># The consul key must be 16-bytes, Base64 encoded: https://www.consul.io/docs/agent/encryption.html</span>
<span class="c1"># You can generate it with the &quot;consul keygen&quot; command</span>
<span class="c1"># Or you can use this script: deployment/pki/scripts/generate_consul_key.sh</span>
<span class="na">consul_encrypt: Biz14ohqN4HtvZmrXp3N4A</span><span class="o">=</span><span class="s">=</span>

<span class="na">mongodb:</span>
  <span class="na">mongo-data:</span>
    <span class="na">passphrase: mongogo</span>
    <span class="na">admin:</span>
      <span class="na">user: vitamdb-admin</span>
      <span class="na">password: azerty</span>
    <span class="na">localadmin:</span>
      <span class="na">user: vitamdb-localadmin</span>
      <span class="na">password: qwerty</span>
    <span class="na">metadata:</span>
      <span class="na">user: metadata</span>
      <span class="na">password: azerty1</span>
    <span class="na">logbook:</span>
      <span class="na">user: logbook</span>
      <span class="na">password: azerty2</span>
    <span class="na">functionalAdmin:</span>
      <span class="na">user: functional-admin</span>
      <span class="na">password: azerty3</span>
    <span class="na">securityInternal:</span>
      <span class="na">user: security-internal</span>
      <span class="na">password: azerty4</span>
  <span class="na">offer-fs-1:</span>
    <span class="na">passphrase: mongogo</span>
    <span class="na">admin:</span>
      <span class="na">user: vitamdb-admin</span>
      <span class="na">password: azerty</span>
    <span class="na">localadmin:</span>
      <span class="na">user: vitamdb-localadmin</span>
      <span class="na">password: qwerty</span>
    <span class="na">offer:</span>
      <span class="na">user: offer</span>
      <span class="na">password: azerty5</span>
  <span class="na">offer-fs-2:</span>
    <span class="na">passphrase: mongogo</span>
    <span class="na">admin:</span>
      <span class="na">user: vitamdb-admin</span>
      <span class="na">password: azerty</span>
    <span class="na">localadmin:</span>
      <span class="na">user: vitamdb-localadmin</span>
      <span class="na">password: qwerty</span>
    <span class="na">offer:</span>
      <span class="na">user: offer</span>
      <span class="na">password: azerty5</span>
  <span class="na">offer-swift-1:</span>
    <span class="na">passphrase: mongogo</span>
    <span class="na">admin:</span>
      <span class="na">user: vitamdb-admin</span>
      <span class="na">password: azerty</span>
    <span class="na">localadmin:</span>
      <span class="na">user: vitamdb-localadmin</span>
      <span class="na">password: qwerty</span>
    <span class="na">offer:</span>
      <span class="na">user: offer</span>
      <span class="na">password: azerty5</span>

<span class="na">vitam_users:</span>
  <span class="na">- vitam_aadmin:</span>
    <span class="na">login: aadmin</span>
    <span class="na">password: aadmin1234</span>
    <span class="na">role: admin</span>
  <span class="na">- vitam_uuser:</span>
    <span class="na">login: uuser</span>
    <span class="na">password: uuser1234</span>
    <span class="na">role: user</span>
  <span class="na">- vitam_gguest:</span>
    <span class="na">login: gguest</span>
    <span class="na">password: gguest1234</span>
    <span class="na">role: guest</span>
  <span class="na">- techadmin:</span>
    <span class="na">login: techadmin</span>
    <span class="na">password: techadmin1234</span>
    <span class="na">role: admin</span>
<span class="na">ldap_authentification:</span>
    <span class="na">ldap_pwd: &quot;admin&quot;</span>

<span class="na">admin_basic_auth_password: adminPassword</span>

<span class="na">vitam_offers:</span>
    <span class="na">offer-swift-1:</span>
        <span class="na">swiftPassword: password</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dans le cadre d’une installation avec au moins une offre «&nbsp;swift&nbsp;», il faut déclarer, dans la section <code class="docutils literal notranslate"><span class="pre">vitam_offers</span></code>, le nom de chaque offre et le mot de passe de connexion «&nbsp;swift&nbsp;» associé, défini dans le fichier <code class="docutils literal notranslate"><span class="pre">offers_opts.yml</span></code>. L’exemple ci-dessus présente la déclaration du mot de passe pour l’offre swift «&nbsp;offer-swift-1&nbsp;».</p>
</div>
<ul>
<li><p class="first">Le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/vault-keystores.yml</span></code> contient les mots de passe des magasins de certificats utilisés dans VITAM :</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="na">keystores:</span>
  <span class="na">server:</span>
    <span class="na">offer: azerty1</span>
    <span class="na">access_external: azerty2</span>
    <span class="na">ingest_external: azerty3</span>
    <span class="na">ihm_recette: azerty16</span>
    <span class="na">ihm_demo: azerty17</span>
  <span class="na">client_external:</span>
    <span class="na">ihm_demo: azerty4</span>
    <span class="na">gatling: azerty4</span>
    <span class="na">ihm_recette: azerty5</span>
    <span class="na">reverse: azerty6</span>
  <span class="na">client_storage:</span>
    <span class="na">storage: azerty7</span>
  <span class="na">timestamping:</span>
    <span class="na">secure_logbook: azerty8</span>
<span class="na">truststores:</span>
  <span class="na">server: azerty9</span>
  <span class="na">client_external: azerty10</span>
  <span class="na">client_storage: azerty11</span>
<span class="na">grantedstores:</span>
  <span class="na">client_external: azerty12</span>
  <span class="na">client_storage: azerty13</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">il convient de sécuriser votre environnement en définissant des mots de passe «&nbsp;forts&nbsp;».</p>
</div>
<div class="section" id="cas-des-extra">
<h3>4.2.2.3.1. Cas des extra<a class="headerlink" href="#cas-des-extra" title="Lien permanent vers ce titre">¶</a></h3>
<ul>
<li><p class="first">Le fichier <code class="docutils literal notranslate"><span class="pre">environments</span></code> <code class="docutils literal notranslate"><span class="pre">/group_vars/all/vault-extra.yml</span></code> contient les mot de passe des magasins de certificats utilisés dans VITAM :</p>
<div class="highlight-ini notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Example for git lfs ; uncomment &amp; use if needed</span>
<span class="c1">#vitam_gitlab_itest_login: &quot;account&quot;</span>
<span class="c1">#vitam_gitlab_itest_password: &quot;password&quot;</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">le playbook <code class="docutils literal notranslate"><span class="pre">vitam.yml</span></code> comprend des étapes avec la mention <code class="docutils literal notranslate"><span class="pre">no_log</span></code> afin de ne pas afficher en clair des étapes comme les mots de passe des certificats. En cas d’erreur, il est possible de retirer la ligne dans le fichier pour une analyse plus fine d’un éventuel problème sur une de ces étapes.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="20-certificats.html" class="btn btn-neutral float-right" title="4.2.3. Gestion des certificats" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="05_multisite.html" class="btn btn-neutral" title="4.2.1. Multi-sites" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'1.4.9',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>