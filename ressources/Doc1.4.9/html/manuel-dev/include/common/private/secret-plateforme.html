

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Implémentation du secret de la plateforme &mdash; Documentation VITAM - Manuel de développement 1.4.9</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
    <link rel="next" title="Functional administration" href="../../functional-administration/_toc.html" />
    <link rel="prev" title="Implémentation de l’authentification" href="mongodb-securite.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> VITAM - Manuel de développement
          

          
            
            <img src="../../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.4.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../dev-environnement.html">Configuration de l’environnement de développement</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../access/_toc.html">Access</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../_toc.html">Common</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../GUID.html">Global Unique Identifier (GUID) pour Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Digest.html">Digest</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Logger.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../JunitHelper.html">JunitHelper</a></li>
<li class="toctree-l3"><a class="reference internal" href="../client.html">Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../graph.html">DirectedCycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../graph.html#graph">Graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../VitamCode.html">Code d’erreur Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="../format-identifier.html">Common format identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../stockage.html">Common-storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vitam-metrics.html">Métriques dans VITAM</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="_toc.html">Common-private</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="certs-auth.html">Génération de certificats et de keystore</a></li>
<li class="toctree-l4"><a class="reference internal" href="esapi-utilisation.html">esapi utilisation</a></li>
<li class="toctree-l4"><a class="reference internal" href="format-identifier.html">Format Identifiers</a></li>
<li class="toctree-l4"><a class="reference internal" href="graph-introduction.html">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="graph-dat.html">DAT : module Graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="parametres.html">Paramètres</a></li>
<li class="toctree-l4"><a class="reference internal" href="Uri.html">Uniform Resource Identifier (URI) (vitam)</a></li>
<li class="toctree-l4"><a class="reference internal" href="shiro.html">Configuration de apache shiro</a></li>
<li class="toctree-l4"><a class="reference internal" href="shiro.html#presentation-authentification-via-certificats">Présentation authentification via certificats</a></li>
<li class="toctree-l4"><a class="reference internal" href="shiro.html#decryptage-de-shiro-ini">Décryptage de shiro.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="shiro.html#utilisation-des-certificats">Utilisation des certificats</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-filter.html">Présentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-filter.html#classes-de-filtres">Classes de filtres</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-filter.html#implementer-des-filters">Implémenter des filters</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-filter.html#appliquer-le-filtre-pour-vitam">Appliquer le filtre pour Vitam</a></li>
<li class="toctree-l4"><a class="reference internal" href="tenant-filter.html">Présentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="tenant-filter.html#classe-de-filtre">Classe de filtre</a></li>
<li class="toctree-l4"><a class="reference internal" href="tenant-filter.html#ajout-du-filtre">Ajout du filtre</a></li>
<li class="toctree-l4"><a class="reference internal" href="tenant-filter.html#modules-vitam-impactes">Modules Vitam impactés</a></li>
<li class="toctree-l4"><a class="reference internal" href="sanity-checker.html">Présentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="DefaultVitamApplicationConfiguration.html">Présentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="Execution-request-dsl.html">Implémentation de l’éxécution des requêtes mono-query DSL</a></li>
<li class="toctree-l4"><a class="reference internal" href="mongodb-securite.html">Implémentation de l’authentification</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Implémentation du secret de la plateforme</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../functional-administration/_toc.html">Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ihm-demo/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ihm-recette/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ingest/_toc.html">Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internal-security/_toc.html">Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../logbook/_toc.html">Logbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../metadata/_toc.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../processing/_toc.html">Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../storage/_toc.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../technical-administration/_toc.html">Technical administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../worker/_toc.html">Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../workspace/_toc.html">Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devstack_vm.html">Création d’une machine de dev contenant swift</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VITAM - Manuel de développement</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../_toc.html">Détails par composant</a> &raquo;</li>
        
          <li><a href="../_toc.html">Common</a> &raquo;</li>
        
          <li><a href="_toc.html">Common-private</a> &raquo;</li>
        
      <li>Implémentation du secret de la plateforme</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/include/common/private/secret-plateforme.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implementation-du-secret-de-la-plateforme">
<h1>Implémentation du secret de la plateforme<a class="headerlink" href="#implementation-du-secret-de-la-plateforme" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="presentation">
<h2>Présentation<a class="headerlink" href="#presentation" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le secret de plateforme permet de se protéger contre des erreurs de manipulation et de configuration
en séparant les environnements de manière logique (secret partagé par l’ensemble de la plateforme mais différent entre plateforme).</p>
</div>
<div class="section" id="implementation">
<h2>Implémentation<a class="headerlink" href="#implementation" title="Lien permanent vers ce titre">¶</a></h2>
<ul>
<li><p class="first">Un Header X-Request-Timestamp contenant le timestamp de la requête sous forme epoch (secondes depuis 1970)</p>
</li>
<li><p class="first">Un Header X-Platform-ID qui est SHA256(«&nbsp;&lt;methode&gt;;&lt;URL&gt;;&lt;Valeur du header X-Request-Timestamp&gt;;&lt;Secret partagé de plateforme&gt;&nbsp;»).</p>
<blockquote>
<div><p>Par contre, mettre le secret de plateforme à la fin permet de limite les attaques par extension.</p>
</div></blockquote>
</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// add Authorization Headers (X_TIMESTAMP, X_PLATFORM_ID)</span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">authorizationHeaders</span> <span class="o">=</span> <span class="n">AuthorizationFilterHelper</span><span class="o">.</span><span class="na">getAuthorizationHeaders</span><span class="o">(</span><span class="n">httpMethod</span><span class="o">,</span><span class="n">baseUri</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">authorizationHeaders</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">2</span><span class="o">){</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">GlobalDataRest</span><span class="o">.</span><span class="na">X_TIMESTAMP</span><span class="o">,</span><span class="n">authorizationHeaders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">GlobalDataRest</span><span class="o">.</span><span class="na">X_TIMESTAMP</span><span class="o">));</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="n">GlobalDataRest</span><span class="o">.</span><span class="na">X_PLATFORM_ID</span><span class="o">,</span><span class="n">authorizationHeaders</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">GlobalDataRest</span><span class="o">.</span><span class="na">X_PLATFORM_ID</span><span class="o">));</span>
<span class="o">}</span>
<span class="o">.....................</span>
</pre></div>
</div>
<p>Si on veut assurer une sécurité additionnelle, il est possible de transmettre un hash des valeurs suivantes :</p>
<ul class="simple">
<li>URI + paramètres de l’URI</li>
<li>Header Timestamp</li>
<li>Secret de plateforme en clair non transmis (connus par les participants de la plateforme)</li>
</ul>
<p>=&gt; Hash (URI + paramètres (dans l’ordre alphabétique) + Header Timestamp + secret non transmis)
Ce Hash est transmis dans le Header : X-Platform-Id</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//encode URL using secret</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">encodeURL</span><span class="o">(</span><span class="n">String</span> <span class="n">httpMethod</span><span class="o">,</span> <span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">String</span> <span class="n">secret</span><span class="o">,</span>
    <span class="n">DigestType</span> <span class="n">digestType</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ParametersChecker</span><span class="o">.</span><span class="na">checkParameter</span><span class="o">(</span><span class="n">ARGUMENT_MUST_NOT_BE_NULL</span><span class="o">,</span> <span class="n">httpMethod</span><span class="o">,</span> <span class="n">url</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">secret</span><span class="o">,</span> <span class="n">digestType</span><span class="o">);</span>
    <span class="n">Digest</span> <span class="n">digest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Digest</span><span class="o">(</span><span class="n">digestType</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">digest</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">httpMethod</span> <span class="o">+</span> <span class="n">DELEMITER_SEPARATED_VALUES</span> <span class="o">+</span> <span class="n">url</span> <span class="o">+</span> <span class="n">DELEMITER_SEPARATED_VALUES</span> <span class="o">+</span> <span class="n">timestamp</span> <span class="o">+</span>
            <span class="n">DELEMITER_SEPARATED_VALUES</span> <span class="o">+</span> <span class="n">secret</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
<span class="o">.....................</span>
</pre></div>
</div>
<p>Le contrôle est alors le suivant :</p>
<ol class="arabic simple">
<li>Existance de X-Platform-Id et Timestamp</li>
<li>Vérification que Timestamp est distant de l’heure actuelle sur le serveur requêté de moins de 10 secondes ( Timestamp - temps local &lt; 10 s )</li>
<li>Calcul d’un Hash2 = Hash(URI+paramètres (dans l’ordre alphabétique) + Header Timestamp + secret non transmis) et vérification avec la valeur Hash transmise</li>
</ol>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">((</span><span class="n">Strings</span><span class="o">.</span><span class="na">isNullOrEmpty</span><span class="o">(</span><span class="n">platformId</span><span class="o">))</span> <span class="o">||</span> <span class="o">(</span><span class="n">Strings</span><span class="o">.</span><span class="na">isNullOrEmpty</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)))</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">checkTimestamp</span><span class="o">(</span><span class="n">timestamp</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">checkPlatformId</span><span class="o">(</span><span class="n">platformId</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">)));</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkTimestamp</span><span class="o">(</span><span class="n">String</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">ParametersChecker</span><span class="o">.</span><span class="na">checkParameter</span><span class="o">(</span><span class="n">ARGUMENT_MUST_NOT_BE_NULL</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">);</span>
     <span class="kt">long</span> <span class="n">currentEpoch</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
     <span class="kt">long</span> <span class="n">requestEpoch</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">timestamp</span><span class="o">).</span><span class="na">longValue</span><span class="o">();</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">currentEpoch</span> <span class="o">-</span> <span class="n">requestEpoch</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">VitamConfiguration</span><span class="o">.</span><span class="na">getAcceptableRequestTime</span><span class="o">())</span> <span class="o">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;Timestamp check failed&quot;</span><span class="o">);</span>
     <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">checkPlatformId</span><span class="o">(</span><span class="n">String</span> <span class="n">platformId</span><span class="o">,</span> <span class="n">String</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">ParametersChecker</span><span class="o">.</span><span class="na">checkParameter</span><span class="o">(</span><span class="n">ARGUMENT_MUST_NOT_BE_NULL</span><span class="o">,</span> <span class="n">platformId</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">);</span>
     <span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">getRequestURI</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">httpMethod</span> <span class="o">=</span> <span class="n">getMethod</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">URLCodec</span><span class="o">.</span><span class="na">encodeURL</span><span class="o">(</span><span class="n">httpMethod</span><span class="o">,</span> <span class="n">uri</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">VitamConfiguration</span><span class="o">.</span><span class="na">getSecret</span><span class="o">(),</span>
         <span class="n">VitamConfiguration</span><span class="o">.</span><span class="na">getSecurityDigestType</span><span class="o">());</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">code</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">platformId</span><span class="o">))</span> <span class="o">{</span>
         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&quot;PlatformId check failed&quot;</span><span class="o">);</span>
     <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../functional-administration/_toc.html" class="btn btn-neutral float-right" title="Functional administration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mongodb-securite.html" class="btn btn-neutral" title="Implémentation de l’authentification" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.4.9',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>