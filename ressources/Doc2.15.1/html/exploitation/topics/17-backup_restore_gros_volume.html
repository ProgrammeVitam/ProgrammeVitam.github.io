

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.7. Sauvegarde et restauration de mongodb gros volumes &mdash; Documentation VITAM - Documentation d&#39;exploitation 2.15.1-1</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'2.15.1-1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.8. Gestion des profils de sécurité" href="18-securityprofile.html" />
    <link rel="prev" title="5.6. Sauvegarde / restauration" href="16-backup_restore.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'exploitation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.15.1-1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Exploitation globale</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-accessgrants.html">5.1. Gestion des accès</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-adminportals.html">5.2. Portails d’administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-appconfig.html">5.3. Paramétrage &amp; configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-miseajour.html">5.4. Déploiement / mises à jour</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-maintenance.html">5.5. Interruption / maintenance</a></li>
<li class="toctree-l2"><a class="reference internal" href="16-backup_restore.html">5.6. Sauvegarde / restauration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.7. Sauvegarde et restauration de mongodb gros volumes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preconisation">5.7.1. Préconisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde-mongoc-et-mongod">5.7.2. Sauvegarde MongoC et MongoD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#information-sur-la-sauvegarde">5.7.2.1. Information sur la sauvegarde</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedure-de-sauvegarde">5.7.2.2. Procédure de sauvegarde</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#restaurer-mongoc-et-mongod">5.7.3. Restaurer MongoC et MongoD</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#procedure-de-restauration">5.7.3.1. Procédure de restauration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde-et-restauration-de-l-offre-froide">5.7.4. Sauvegarde et restauration de l’offre froide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sauvegarde">5.7.4.1. Sauvegarde</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restauration">5.7.4.2. Restauration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cas-de-la-base-mongo-certificates">5.7.5. Cas de la base mongo certificates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="18-securityprofile.html">5.8. Gestion des profils de sécurité</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-batchs.html">5.9. Batchs et traitements</a></li>
<li class="toctree-l2"><a class="reference internal" href="21-graphstorage.html">5.10. Sauvegarde des données graphe (Log shipping)</a></li>
<li class="toctree-l2"><a class="reference internal" href="22-graphcompute.html">5.11. Recalcul des données graphe</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-siegfried_signature.html">5.12. Montée de version du fichier de signature de Siegfried</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-griffins.html">5.13. Griffins</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-reconstruction.html">5.14. Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="31-pra.html">5.15. Plan de Reprise d’Activité (<code class="docutils literal notranslate"><span class="pre">PRA</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="40-resynchronisation.html">5.16. Resynchronisation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html">5.17. Procédure d’exploitation suite à la création ou la modification d’une ontologie</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-forcedpause.html">5.18. Procédure d’exploitation pour la mise en pause forcée d’une opération</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-reindexation.html">5.19. Réindexation</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-certificate-revocation.html">5.20. Procédure d’exploitation pour la révocation des certificats SIA et Personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="80-offer-activation.html">5.21. Activation/désactivation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-environment-cleaning.html">5.22. Nettoyage d’un environnement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composants/_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">12. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'exploitation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="_toc.html">5. Exploitation globale</a> &raquo;</li>
        
      <li>5.7. Sauvegarde et restauration de mongodb gros volumes</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/topics/17-backup_restore_gros_volume.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sauvegarde-et-restauration-de-mongodb-gros-volumes">
<h1>5.7. Sauvegarde et restauration de mongodb gros volumes<a class="headerlink" href="#sauvegarde-et-restauration-de-mongodb-gros-volumes" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="preconisation">
<h2>5.7.1. Préconisation<a class="headerlink" href="#preconisation" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il est fortement conseillé de faire une sauvegarde (<cite>backup</cite>) avant toute migration (montée de version <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>)</p>
</div>
<div class="section" id="sauvegarde-mongoc-et-mongod">
<h2>5.7.2. Sauvegarde MongoC et MongoD<a class="headerlink" href="#sauvegarde-mongoc-et-mongod" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="information-sur-la-sauvegarde">
<h3>5.7.2.1. Information sur la sauvegarde<a class="headerlink" href="#information-sur-la-sauvegarde" title="Lien permanent vers ce titre">¶</a></h3>
<dl class="docutils">
<dt>La documentation officielle de MongoDB parle déjà de différentes techniques de Sauvegarde:</dt>
<dd><ul class="first last simple">
<li>Sauvegarde en utilisant mongodump (Cf. la <a class="reference internal" href="16-backup_restore.html"><span class="doc">section dédiée</span></a>))</li>
<li>Sauvegarde en utilisant Filesystem snapshots</li>
<li>Sauvegarde par copie de disque.</li>
</ul>
</dd>
</dl>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last">Pour plus d’information, veuillez-vous référer à la documentation officielle :
<a class="reference external" href="https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/">Monog dump</a> et <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/backup-with-filesystem-snapshots/">Filesystem Snapshots</a>.</p>
</div>
<p>La technique choisie par <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> est celle de copie de disque pour plusieurs raisons:</p>
<blockquote>
<div><ul class="simple">
<li>La taille de chaque shard est suffisamment grande. L’outil mongodump n’est pas conseillé dans ce cas de figure.</li>
<li>La restauration prendra beaucoup de temps (restauration des données + création d’indexes)</li>
<li>L’usage de mongodump impacte les performances</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="procedure-de-sauvegarde">
<h3>5.7.2.2. Procédure de sauvegarde<a class="headerlink" href="#procedure-de-sauvegarde" title="Lien permanent vers ce titre">¶</a></h3>
<ol class="arabic simple">
<li>Repérer dans le replicaSet des instances mongo master (mongoc pour la conf ou mongod pour les shards)</li>
<li>Arrêter proprement mongo</li>
<li>Copie + zip du dossier db (avec le nommage qui permet d’identifier l’instance mongo) de chaque mongo master précédemment identifié</li>
<li>Stocker les zip dans un disque séparé et sécurisé</li>
</ol>
</div>
</div>
<div class="section" id="restaurer-mongoc-et-mongod">
<h2>5.7.3. Restaurer MongoC et MongoD<a class="headerlink" href="#restaurer-mongoc-et-mongod" title="Lien permanent vers ce titre">¶</a></h2>
<p>Comme la sauvegarde, la documentation officielle parle aussi de la restauration d’un cluster shard mongo.
Pour plus de détails, veuillez cliquer sur ce lien: <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/restore-sharded-cluster/">Restore sharded cluster</a>.</p>
<div class="section" id="procedure-de-restauration">
<h3>5.7.3.1. Procédure de restauration<a class="headerlink" href="#procedure-de-restauration" title="Lien permanent vers ce titre">¶</a></h3>
<ol class="arabic">
<li><p class="first">Déployer <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> qui va créer un cluster mongodb vide</p>
</li>
<li><p class="first">Arrêter le cluster mongodb</p>
</li>
<li><p class="first">Modifier la configuration de mongod et mongoc pour désactiver la replication et le sharding comme décrit dans la documentation officielle</p>
</li>
<li><p class="first">Si vos instances mongo sont dans une zone réseau privée et sécurisée, vous pouvez aussi désactiver l’authentification en commentant la partie sécurité dans le fichier de conf</p>
</li>
<li><p class="first">Copier et décompresser vers le dossier db de chaque instance mongo un fichier backup correspondant</p>
<blockquote>
<div><ul class="simple">
<li>Pour tous les mongoc, c’est le fichier zip backup mongoc qu’il faut mettre,</li>
<li>Pour chaque shard, il faut mettre le fichier zip du backup correspondant (pour chaque instance du replicaset du shard en question)</li>
<li>Le nom du zip doit mentionner l’instance mongo sur laquelle, on peut le restaurer</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Démarrer toutes les instances mongo (en appliquant la modification des fichiers de configuration) une fois avoir copié et décompressé tous les backup sur toutes les instances</p>
</li>
<li><p class="first">Dans chacune des instances</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Si l’authentification est activée, il faut créer un <code class="docutils literal notranslate"><span class="pre">systemUser</span></code> (pré-requis: il faut un utilisateur ayant un role «&nbsp;root&nbsp;»)</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">admin</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">root</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;rootUser&quot;</span><span class="p">,</span> <span class="s2">&quot;rootUserPassword&quot;</span><span class="p">)</span>
<span class="o">//</span> <span class="n">Create</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">createUser</span><span class="p">({</span><span class="n">user</span><span class="p">:</span> <span class="s2">&quot;systmUser&quot;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">:</span> <span class="s2">&quot;systemUserPassword&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;__system&quot;</span> <span class="p">]})</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;systmUser&quot;</span><span class="p">,</span> <span class="s2">&quot;systemUserPassword&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Supprimer la base de données <code class="docutils literal notranslate"><span class="pre">local</span></code></p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Drop</span> <span class="n">local</span> <span class="n">database</span>
<span class="n">use</span> <span class="n">local</span>
<span class="n">db</span><span class="o">.</span><span class="n">dropDatabase</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Pour les instances mongoc: Mettre à jour la collection <code class="docutils literal notranslate"><span class="pre">shards</span></code></p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span>use config
// spécifier les shards pour chaque mongoc
// Example
db.shards.updateOne({ &quot;_id&quot; : &quot;shard01&quot;},  { $set : { &quot;host&quot; : &quot;shard01/shard01a:28018,shard01b:28018&quot;}})
db.shards.updateOne({ &quot;_id&quot; : &quot;shard02&quot;},  { $set : { &quot;host&quot; : &quot;shard02/shard02a:28019,shard02b:28019&quot;}})
db.shards.updateOne({ &quot;_id&quot; : &quot;shard03&quot;},  { $set : { &quot;host&quot; : &quot;shard03/shard03a:28020,shard03b:28020&quot;}})
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Pour les instances mongod (les shards): Mettre à jour la collection <code class="docutils literal notranslate"><span class="pre">system.version</span></code></p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span>use admin
db.system.version.deleteOne( { &quot;_id&quot;: &quot;minOpTimeRecovery&quot; } )
// spécifier les mongoc pour chaque shard
// Example
db.system.version.updateOne({ &quot;_id&quot; : &quot;shardIdentity&quot; },{ $set :{ &quot;configsvrConnectionString&quot; : &quot;configserver/config01:28017,config02:28017,config03:28017&quot;}})
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Si vous avez crée un utilisateur ayant un role <code class="docutils literal notranslate"><span class="pre">__system</span></code> à l’étape (6.1), il faut donc le supprimer</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Remove</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">use</span> <span class="n">admin</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">root</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;rootUser&quot;</span><span class="p">,</span> <span class="s2">&quot;rootUserPassword&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">removeUser</span><span class="p">(</span><span class="s2">&quot;systmeUser&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Arrêter mongodb et réactiver la replication et le sharding (et l’authentification si désactivée) dans la conf de chacune des instances</p>
</li>
<li><p class="first">Démarrer Mongo</p>
</li>
<li><p class="first">Activer les <code class="docutils literal notranslate"><span class="pre">replicaSet</span></code> pour chacun des mongoc et mongod (shards)</p>
<blockquote>
<div><div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Sur</span> <span class="n">un</span> <span class="n">des</span> <span class="n">mongoc</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="o">--</span><span class="n">host</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}</span> <span class="o">--</span><span class="n">port</span> <span class="p">{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongoc_port</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongoc</span><span class="o">/</span><span class="n">init</span><span class="o">-</span><span class="n">replica</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>
<span class="o">//</span> <span class="n">Pour</span> <span class="n">chaque</span> <span class="n">shards</span> <span class="n">et</span> <span class="n">sur</span> <span class="n">un</span> <span class="n">des</span> <span class="n">shards</span> <span class="n">d</span><span class="s1">&#39;un replicaset</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="o">--</span><span class="n">host</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}</span> <span class="o">--</span><span class="n">port</span> <span class="p">{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongod_port</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongod</span><span class="o">/</span><span class="n">init</span><span class="o">-</span><span class="n">replica</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Test de la restauration</p>
<blockquote>
<div><ul class="simple">
<li>Un document accessible depuis un shards devrait être accessible depuis <code class="docutils literal notranslate"><span class="pre">mongos</span></code> (faire la requête de test sur chaque shard)</li>
<li>Tester aussi les collections non shardées</li>
<li>Il est conseillé de faire un <code class="docutils literal notranslate"><span class="pre">count</span></code> sur chacune des collections avant la sauvegarde pour vérifier lors de la restauration qu’on a bien les bons <code class="docutils literal notranslate"><span class="pre">count</span></code>.</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Si l’adresse ip et numéro de port de chacune des instances mongo du cluster recrée ne sont pas changés, alors les étapes 1, 2, 4, 8 et 10 sont suffisantes et le cluster mongodb devrait fonctionner sans problème.</p>
<p>Dans le cas ou la sécurité reste activée vous devez créer un utilisateur ayant un role «&nbsp;<code class="docutils literal notranslate"><span class="pre">__system</span></code>&nbsp;» et s’authentifier avec cet utilisateur pour pouvoir faire les modifications :</p>
<div class="last admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Le pré-requis dans ce cas est d’avoir un utilisateur ayant un role «&nbsp;<code class="docutils literal notranslate"><span class="pre">root</span></code>&nbsp;» pour pouvoir créer un utilisateur ayant un rôle «&nbsp;<code class="docutils literal notranslate"><span class="pre">__system</span></code>&nbsp;»</p>
</div>
</div>
<p>L’ansiblerie <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> déploie dans chacune des instances mongoc et mongod des scripts préparés restaure-mongoc.js et restaure-mongod.js respectivement</p>
<blockquote>
<div><ul class="simple">
<li>{{ vitam_defaults.folder.root_path }}/app/mongoc/restaure-mongoc.js</li>
<li>{{ vitam_defaults.folder.root_path }}/app/mongod/restaure-mongod.js</li>
</ul>
</div></blockquote>
<p>Toutes les informations sur les adresses ip et numéros de ports de toutes les instances du cluster mongodb sont automatiquement renseignés dans ces scripts</p>
<p>Pour exécuter ces deux scripts, il faut lancer la commande suivante que vous pouvez automatiser dans un playbook:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">//</span> <span class="n">Sur</span> <span class="n">mongoc</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}:{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongos_port</span> <span class="p">}}</span><span class="o">/</span><span class="n">admin</span> <span class="p">{{</span> <span class="n">mongo_credentials</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongoc</span><span class="o">/</span><span class="n">restaure</span><span class="o">-</span><span class="n">mongoc</span><span class="o">.</span><span class="n">js</span>
 <span class="o">//</span> <span class="n">Sur</span> <span class="n">mongod</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}:{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongos_port</span> <span class="p">}}</span><span class="o">/</span><span class="n">admin</span> <span class="p">{{</span> <span class="n">mongo_credentials</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongod</span><span class="o">/</span><span class="n">restaure</span><span class="o">-</span><span class="n">mongod</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sauvegarde-et-restauration-de-l-offre-froide">
<h2>5.7.4. Sauvegarde et restauration de l’offre froide<a class="headerlink" href="#sauvegarde-et-restauration-de-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h2>
<p>En plus de la procédure de backup et restauration décrite ci-dessus, pour <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ayant une offre de stockage froide, les fichiers backup zip sont stockés dans des bandes magnétiques.</p>
<div class="section" id="sauvegarde">
<h3>5.7.4.1. Sauvegarde<a class="headerlink" href="#sauvegarde" title="Lien permanent vers ce titre">¶</a></h3>
<p>La procédure de backup du mongo de l’offre froide est très importante, car, mongo joue le rôle d’un référentiel de tout ce qui est dans les bandes magnétiques.</p>
<p>Pour résumer, si on perd les données du cluster mongodb de l’offre froide, toutes les informations enregistrées sur les bandes magnétiques sont inutilisables.</p>
<p>C’est pour cette raison, que nous faisons, impérativement, au préalable:</p>
<blockquote>
<div><ul class="simple">
<li>La sauvegarde du cluster mongodb de l’offre froide</li>
<li>La sauvegarde est stockée sur bande magnétique.</li>
</ul>
</div></blockquote>
<div class="section" id="sauvegarde-cote-cluster-mongodb-de-l-offre-froide">
<h4>5.7.4.1.1. Sauvegarde côté cluster mongodb de l’offre froide<a class="headerlink" href="#sauvegarde-cote-cluster-mongodb-de-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Un playbook, ayant les tâches ci-dessous, a été mis en place pour faire un backup du mongodb de l’offre froide:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Détection des noeuds mongodb <code class="docutils literal notranslate"><span class="pre">master</span></code></li>
<li>Arrêt de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a></li>
<li>Copie + ajout d’un fichier ayant des informations sur l’instance en cours  + compression du dossier db de chaque instance <code class="docutils literal notranslate"><span class="pre">master</span></code></li>
<li>Démarrer <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a></li>
<li>Envoi des fichiers zip via CURL vers l’offre froide qui seront sauvegardés sur une bande magnétique</li>
</ol>
</div></blockquote>
<p>Pour exécuter le playbook :</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Le playbook ci-dessous est à exécuter uniquement sur un <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ayant une offre froide <code class="docutils literal notranslate"><span class="pre">**tapeLibrary**</span></code></p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="o">-</span><span class="n">i</span> <span class="n">environments</span><span class="o">/</span><span class="n">hosts</span><span class="o">.</span><span class="n">deployment</span> <span class="n">ansible</span><span class="o">-</span><span class="n">vitam</span><span class="o">-</span><span class="n">exploitation</span><span class="o">/</span><span class="n">backup_mongodb_tape_offer</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">vault</span><span class="o">-</span><span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="sauvegarde-cote-offre-froide">
<h4>5.7.4.1.2. Sauvegarde côté offre froide<a class="headerlink" href="#sauvegarde-cote-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Lors de l’envoi de fichier via une requête http vers l’offre froide, cette dernière va procéder comme suit:</p>
<ul class="simple">
<li>Réception du fichier zip dans une zone temporaire</li>
<li>Copie du fichier dans une zone d’écriture sur bande magnétique</li>
<li>Création d’un ordre spécifique pour écrire le fichier backup zip sur une bande magnétique ayant un tag <code class="docutils literal notranslate"><span class="pre">backup</span></code></li>
<li>Le worker qui va exécuter la tâche ayant l’ordre spécifique va écrire dans un fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> les informations : <code class="docutils literal notranslate"><span class="pre">code</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">bande</span> <span class="pre">magnétique</span></code>, <code class="docutils literal notranslate"><span class="pre">mongoc</span></code> ou <code class="docutils literal notranslate"><span class="pre">mongod</span> <span class="pre">(shard(i)</span></code>, <code class="docutils literal notranslate"><span class="pre">date</span></code>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lors de la lecture depuis une bande magnétique, on aura un fichier zip mais sans connaitre son nom et son type.
Si on perd le cluster mongodb, le fichier de log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> sera le seul moyen pour nous renseigner sur le nom du fichier sauvegardé et sur le code de la bande magnétique où il a été enregistré.
Le nom <code class="docutils literal notranslate"><span class="pre">DATE-disk-mongod-shard01_.zip</span></code> qu’on récupère depuis le fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> nous renseigne sur la date et le fait que ce soit un backup du <code class="docutils literal notranslate"><span class="pre">shard01</span></code>. Il ne peut donc être restauré que dans un <code class="docutils literal notranslate"><span class="pre">mongod</span></code> et non pas <code class="docutils literal notranslate"><span class="pre">mongoc</span></code></p>
</div>
</div>
</div>
<div class="section" id="restauration">
<h3>5.7.4.2. Restauration<a class="headerlink" href="#restauration" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="restaurer-cote-offre-froide">
<h4>5.7.4.2.1. Restaurer côté offre froide<a class="headerlink" href="#restaurer-cote-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Sur l’offre froide, toutes les écritures de fichiers zip dans le cas de backup de mongodb de l’offre, sont tracées dans un fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code></p>
<p>On peut facilement repérer des lignes de log ayant comme information:</p>
<blockquote>
<div><ul class="simple">
<li>Le code de la bande magnétique sur laquelle est écrit le fichier</li>
<li>Le nom du fichier de la forme <code class="docutils literal notranslate"><span class="pre">DATE-disk-mongod-shard01_.zip</span></code></li>
</ul>
</div></blockquote>
<p>On saura donc dans quelle bande magnétique lire le fichier en question.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Il est fortement conseillé de copier ce fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> dans un lieu sûr pour le besoin de restauration en cas de perte du site.
Dans le cas contraire, on doit lire toutes les bandes magnétiques pour espérer retrouver les fichiers de backup.</p>
</div>
<p>Pour restaurer une date donnée</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- On doit repérer dans le fichier log ``offer_tape_backup_DATE.log`` tous les fichiers backup ``(mongoc et mongod)`` zip correspondant à cette date ainsi que les bandes magnétiques sur lequelles on peut les lire
- Manuellement charger les bandes magnétiques sur une ``tape-library`` pour lire les fichiers en question
- Renommer chacun des fichiers avec le nom adéquat (le nom se retrouve aussi à l&#39;intérieur du fichier zip dans un fichier descriptif)
- Copier et décompresser chacun de ces fichiers dans l&#39;instance mongo correspondante : Un fichier ayant un nom ``DATE-disk-mongod-shard01_.zip`` est à copier et à décompresser dans toutes les instances mongo du shard ``shard01``
</pre></div>
</div>
</div>
<div class="section" id="restaurer-cote-cluster-mongo-de-l-offre-froide">
<h4>5.7.4.2.2. Restaurer côté cluster mongo de l’offre froide<a class="headerlink" href="#restaurer-cote-cluster-mongo-de-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Une fois tous les fichiers copiés et décompressés dans les instances mongo correspondantes, il faut suivre la procédure de restauration décrite ci-dessus paragraphe <strong>Restaurer MongoC et MongoD</strong>.</p>
</div>
</div>
</div>
<div class="section" id="cas-de-la-base-mongo-certificates">
<h2>5.7.5. Cas de la base mongo certificates<a class="headerlink" href="#cas-de-la-base-mongo-certificates" title="Lien permanent vers ce titre">¶</a></h2>
<p>Se référer à <a class="reference internal" href="16-backup_restore.html#backupidentity"><span class="std std-ref">Cas de la base mongo certificates</span></a></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="18-securityprofile.html" class="btn btn-neutral float-right" title="5.8. Gestion des profils de sécurité" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="16-backup_restore.html" class="btn btn-neutral float-left" title="5.6. Sauvegarde / restauration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>