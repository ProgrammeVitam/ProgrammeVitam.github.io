

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.2.1. Multi-sites &mdash; Documentation VITAM - Documentation d&#39;installation 1.10.3</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="4.2.2. Configuration du déploiement" href="10-configuration.html" />
    <link rel="prev" title="4. Procédures d’installation / mise à jour" href="_toc.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'installation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.10.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_install/_toc.html">3. Prérequis à l’installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">4. Procédures d’installation / mise à jour</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="_toc.html#verifications-prealables">4.1. Vérifications préalables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html#procedures">4.2. Procédures</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.2.1. Multi-sites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#procedure-d-installation">4.2.1.1. Procédure d’installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedure-de-reinstallation">4.2.1.2. Procédure de réinstallation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flux-entre-storage-et-offer">4.2.1.3. Flux entre Storage et offer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="10-configuration.html">4.2.2. Configuration du déploiement</a></li>
<li class="toctree-l3"><a class="reference internal" href="20-certificats.html">4.2.3. Gestion des certificats</a></li>
<li class="toctree-l3"><a class="reference internal" href="21-addons.html">4.2.4. Paramétrages supplémentaires</a></li>
<li class="toctree-l3"><a class="reference internal" href="30-installation.html">4.2.5. Procédure de première installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="80-extras.html">4.2.6. Elements extras de l’installation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../update/_toc.html">5. Procédures de mise à jour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../post_install/_toc.html">6. Post installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">7. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'installation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="_toc.html">4. Procédures d’installation / mise à jour</a> &raquo;</li>
        
      <li>4.2.1. Multi-sites</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/installation/05_multisite.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="multi-sites">
<h1>4.2.1. Multi-sites<a class="headerlink" href="#multi-sites" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="procedure-d-installation">
<h2>4.2.1.1. Procédure d’installation<a class="headerlink" href="#procedure-d-installation" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cadre d’une installation multi-sites, il est nécessaire de déployer la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sur le site secondaire dans un premier temps, puis déployer le site «&nbsp;production&nbsp;».</p>
<p>Il est nécessaire de paramétrer correctement un certain de variables ansible pour chaque site:</p>
<div class="section" id="vitam-site-name">
<h3>4.2.1.1.1. vitam_site_name<a class="headerlink" href="#vitam-site-name" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/hosts.my_env</span></code></p>
<p>Cette variable sert à définir le nom du site.
Elle doit être différente sur chaque site.</p>
</div>
<div class="section" id="primary-site">
<h3>4.2.1.1.2. primary_site<a class="headerlink" href="#primary-site" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/hosts.my_env</span></code></p>
<p>Cette variable sert à définir si le site est primaire ou non.
Sur un vitam installé en mode multi site, un seul des sites doit avoir la valeur à true.
Sur les sites secondaires (primary_site: false), certains composants ne seront pas démarrés et apparaitront donc en orange sur consul.
Certains timers systemd seront en revanche démarrés pour mettre en place la reconstruction au fil de l’eau par exemple.</p>
</div>
<div class="section" id="consul-remote-sites">
<h3>4.2.1.1.3. consul_remote_sites<a class="headerlink" href="#consul-remote-sites" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/cots_vars.yml</span></code></p>
<p>Cette variable sert à référencer la liste des consul server des sites distants à celui qu’on est en train de configurer.</p>
<p>Exemple de configuration pour une installation avec 3 sites.</p>
<p>Site 1:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>consul_remote_sites:
    - dc2:
      wan: [&quot;dc2-host-1&quot;,&quot;dc2-host-2&quot;,&quot;dc2-host-3&quot;]
    - dc3:
      wan: [&quot;dc3-host-1&quot;,&quot;dc3-host-2&quot;,&quot;dc3-host-3&quot;]
</pre></div>
</div>
<p>Site 2:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>consul_remote_sites:
    - dc1:
      wan: [&quot;dc1-host-1&quot;,&quot;dc1-host-2&quot;,&quot;dc1-host-3&quot;]
    - dc3:
      wan: [&quot;dc3-host-1&quot;,&quot;dc3-host-2&quot;,&quot;dc3-host-3&quot;]
</pre></div>
</div>
<p>Site 3:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>consul_remote_sites:
    - dc1:
      wan: [&quot;dc1-host-1&quot;,&quot;dc1-host-2&quot;,&quot;dc1-host-3&quot;]
    - dc2:
      wan: [&quot;dc2-host-1&quot;,&quot;dc2-host-2&quot;,&quot;dc2-host-3&quot;]
</pre></div>
</div>
</div>
<div class="section" id="vitam-offers">
<h3>4.2.1.1.4. vitam_offers<a class="headerlink" href="#vitam-offers" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code></p>
<p>Cette variable référence toutes les offres disponibles sur la totalité des sites vitam.</p>
<p>Exemple:</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vitam_offers:
    offer-fs-1:
        provider: filesystem-hash
    offer-fs-2:
        provider: filesystem-hash
    offer-fs-3:
        provider: filesystem-hash
</pre></div>
</div>
</div>
<div class="section" id="vitam-strategy">
<h3>4.2.1.1.5. vitam_strategy<a class="headerlink" href="#vitam-strategy" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code></p>
<p>Cette variable référence la stratégie de stockage sur le site courant.
Si l’offre se situe sur un site distant, il est nécessaire de préciser le nom du site sur lequel elle se trouve comme dans l’exemple ci-dessous.
Il est fortement conseiller de prendre comme offre référente une des offres locale au site.
Les sites secondaires doivent uniquement écrire sur leur(s) offre(s) locale(s).</p>
<p>Exemple pour le site 1 (site primaire):</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vitam_strategy:
    - name: offer-fs-1
      referent: true
    - name: offer-fs-2
      referent: false
      vitam_site_name: site2
    - name: offer-fs-3
      referent: false
      vitam_site_name: site3
</pre></div>
</div>
<p>Exemple pour le site 2 (site secondaire):</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vitam_strategy:
    - name: offer-fs-2
      referent: true
</pre></div>
</div>
<p>Exemple pour le site 3 (site secondaire):</p>
<div class="highlight-yml notranslate"><div class="highlight"><pre><span></span>vitam_strategy:
    - name: offer-fs-3
      referent: true
</pre></div>
</div>
</div>
<div class="section" id="plateforme-secret">
<h3>4.2.1.1.6. plateforme_secret<a class="headerlink" href="#plateforme-secret" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/vault-vitam.yml</span></code></p>
<p>Cette variable stocke le secret de plateforme qui doit être commun entre tous les composants vitam de tous les sites.
La valeur doit donc être la même entre chaque site.</p>
</div>
<div class="section" id="consul-encrypt">
<h3>4.2.1.1.7. consul_encrypt<a class="headerlink" href="#consul-encrypt" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/vault-vitam.yml</span></code></p>
<p>Cette variable stocke le secret de plateforme qui doit être commun entre tous les consul de tous les sites.
La valeur doit donc être la même entre chaque site.</p>
</div>
</div>
<div class="section" id="procedure-de-reinstallation">
<h2>4.2.1.2. Procédure de réinstallation<a class="headerlink" href="#procedure-de-reinstallation" title="Lien permanent vers ce titre">¶</a></h2>
<p>En prérequis, il est nécessaire d’attendre que tous les workflow et reconstructions (sites secondaires) en cours soient terminés.</p>
<p>Ensuite:</p>
<ul class="simple">
<li>Arrêter vitam sur le site primaire.</li>
<li>Arrêter les sites sites secondaires.</li>
<li>Redéployer vitam sur les sites secondaires.</li>
<li>Redéployer vitam sur le site primaire</li>
</ul>
</div>
<div class="section" id="flux-entre-storage-et-offer">
<h2>4.2.1.3. Flux entre Storage et offer<a class="headerlink" href="#flux-entre-storage-et-offer" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cas <strong>d’appel en https entre les composants Storage et Offer</strong>, il convient également de rajouter:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>Sur le site primaire</dt>
<dd><ul class="first last">
<li>Dans le truststore de Storage: la CA ayant signé le certificat de l’Offer du site secondaire</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Sur le site secondaire</dt>
<dd><ul class="first last">
<li>Dans le truststore de Offer: la CA ayant signé le certificat du Storage du site primaire</li>
<li>Dans le grantedstore de Offer: le certificat du storage du site primaire</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="figure align-center" id="id1">
<img alt="../_images/certificats-multisite.png" src="../_images/certificats-multisite.png" />
<p class="caption"><span class="caption-text">Vue détaillée des certificats entre le storage et l’offre en multi-site</span></p>
</div>
<p>Il est possible de procéder de 2 manières différentes:</p>
<div class="section" id="avant-la-generation-des-keystores">
<h3>4.2.1.3.1. Avant la génération des keystores<a class="headerlink" href="#avant-la-generation-des-keystores" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Pour toutes les copies de certificats indiquées ci-dessous, il est important de ne jamais en écraser, il faut donc renommer les fichiers si-nécessaire.</p>
</div>
<p>Déposer les CA du client storage du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/ca/*</span></code> dans le client storage du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/ca/</span></code>.</p>
<p>Déposer le certificat du client storage du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/clients/storage/*</span></code> dans le client storage du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/clients/storage/</span></code>.</p>
<p>Déposer les CA du serveur offer du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/server/ca/*</span></code> dans le répertoire des CA serveur du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/server/ca/*</span></code></p>
</div>
<div class="section" id="apres-la-generation-des-keystores">
<h3>4.2.1.3.2. Après la génération des keystores<a class="headerlink" href="#apres-la-generation-des-keystores" title="Lien permanent vers ce titre">¶</a></h3>
<p>Via le script deployment/generate_stores.sh, il convient donc de rajouter les CA et certificats indiqués sur le schéma ci-dessus.</p>
<p>Ajout d’un certificat:
<code class="docutils literal notranslate"><span class="pre">keytool</span> <span class="pre">-import</span> <span class="pre">-keystore</span> <span class="pre">-file</span> <span class="pre">&lt;certificat.crt&gt;</span> <span class="pre">-alias</span> <span class="pre">&lt;alias_certificat&gt;</span></code></p>
<p>Ajout d’une CA:
<code class="docutils literal notranslate"><span class="pre">keytool</span> <span class="pre">-import</span> <span class="pre">-trustcacerts</span> <span class="pre">-keystore</span> <span class="pre">-file</span> <span class="pre">&lt;ca.crt&gt;</span> <span class="pre">-alias</span> <span class="pre">&lt;alias_certificat&gt;</span></code></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="10-configuration.html" class="btn btn-neutral float-right" title="4.2.2. Configuration du déploiement" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="_toc.html" class="btn btn-neutral" title="4. Procédures d’installation / mise à jour" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'1.10.3',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>