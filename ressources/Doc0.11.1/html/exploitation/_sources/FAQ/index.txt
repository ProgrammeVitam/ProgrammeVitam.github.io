FAQ de la solution VITAM
==========================

Généralités
-------------

Cette section a vocation à répertorier les différents problèmes rencontrés et apporter la solution la plus appropriée ; elle est amenée à être régulièrement mise à jour pour répertorier les problèmes rencontrés.

Retour d'expérience / cas rencontrés
-------------------------------------

Mongo-express ne se connecte pas à la base de données associée
	Si mongoDB a été redémarré, il faut également redémarrer mongo-express.

Elasticsearch possède des shard non alloués (état "UNASSIGNED")
	Lors de la perte d'un noeud d'un cluster elasticseach, puis du retour de ce noeud, certains shards d'elasticseach peuvent rester dans l'état ``UNASSIGNED`` ; dans ce cas, le plugin Kopf affiche les shards correspondant en gris (au-dessus des noeuds) dans la vue "cluster", et l'état du cluster passe en "yellow".
	Il est possible d'avoir plus d'informations sur la cause du problème via une requête ``POST`` sur l'API elasticsearch ``_cluster/reroute?explain``. Si la cause de l'échec de l'assignation automatique a été résolue, il est possible de relancer les assignations automatiques en échec via une requête ``POST`` sur l'API ``_cluster/reroute?retry_failed``.
	Dans le cas où l'assignation automatique ne fonctionne pas, il est nécessaire de faire l'assignation à la main pour chaque shard incriminé (requête ``POST`` sur ``_cluster/reroute``) :

	.. code:: javascript

		{
		  "commands": [
		    {
		      "allocate": {
		        "index": "topbeat-2016.11.22",
		        "shard": 3,
		        "node": "vitam-iaas-dblog-01.int"
		      }
		    }
		  ]
		}

	Cependant, un shard primaire ne peut être réalloué de cette manière (il y a risque de perte de données). Si le défaut d'allocation provient effectivement de la perte puis de la récupération d'un noeud, et que TOUS les noeuds du cluster sont de nouveaux opérationnels et dans le cluster, alors il est possible de forcer la réallocation sans perte.

	.. code:: javascript

		{
		  "commands": [
		    {
		      "allocate": {
		        "index": "topbeat-2016.11.22",
		        "shard": 3,
		        "node": "vitam-iaas-dblog-01.int",
		        "allow_primary": "true"
		      }
		    }
		  ]
		}
	
	Sur tous ces sujets, Cf. la `documentation officielle <https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html>`_.

Elasticsearch possède des shards non initialisés (état "INITIALIZING")
	Tout d'abord, il peut être difficile d'identifier les shards en questions dans le plugin Kopf ; une requête HTTP ``GET`` sur l'API ``_cat/shards`` permet d'avoir une liste plus compréhensible.
	Un shard non initialisé correspond à un shard en cours de démarrage (Cf. `une ancienne page de documentation <https://www.elastic.co/guide/en/elasticsearch/reference/1.4/states.html>`_. Si les shards non initialisés sont présents sur un seul noeud, il peut être utile de redémarrer le noeud en cause. Sinon, une investigation plus poussée doit être menée.