Packaging
#########

Principes communs
=================

Tout package doit respecter les principes suivants : 

* Nom des packages : ``vitam-<id>`` du package 
* Version du package : Numéro de "release" du projet Vitam

Les dossiers (ainsi que les droits associés) compris dans les packages doivent respecter les principes dictés dans :doc:`la section dédiée <02-principles-users-rights>`.

.. note:: 
	Les limitations associés à un packaging RPM sont : 

	* L'instanciation d'une seule instance d'un même moteur par machine (il n'est ainsi pas possible d'installer 2 moteurs d'exécution sur le même OS) ;
	* La redondance de certains contenus dans les packages (ex: les librairies Java sont embarquées dans les packages, et non tirées dans les dépendances de package)

Les fichiers de configuration sont gérés par l'outil de déploiement de manière externe aux packages ; ils ne sont pas inclus dans les packages.


Packaging RPM
=============

Les composants de la solution VITAM sont tous disponibles sous forme de packages RPM compatibles CentOS 7 ; ceci inclut notamment : 

* L'usage des pré-requis (au sens Require) associés à Centos 7
* L'arborescence des répertoires OS de Centos
* L'usage du système de démarrage systemd

.. note:: Seuls les RPMs cibles sont disponibles ; les RPM Sources (SRPM) ne seront pas fournis. (les sources étant livrées sous un autre format)


Dépôts
------

.. note:: La typologique des dépôts présentée ci-dessous a notamment pour but de permettre l'installation de VITAM sur des environnements présentant un accès restreint à Internet (i.e. limité aux miroirs des dépôts d'update standard des distributions linux). Par conséquent, aucun dépôt externe autre que les dépôts natifs des distributions Linux n'est requis.


VITAM s'appuie sur les dépôts suivants :

* Concernant les dépôts externes nécessaires pour le bon fonctionnement du déploiement, il faut noter : 

	- Centos 7 (Base, Extras) : il s'agit des dépôts standard de la distribution
	- EPEL 7 (Extra Packages for Enterprise Linux) : il s'agit d'un dépôt maintenu par Fedora et fournissant un ensemble de packages complétant ceux de RHEL/Centos

* Concernant les dépôts internes de Vitam, 2 dépôts différents sont attendus et sont présents dans les livraisons :

    - ``vitam-produit`` : ce dépôt hégerge les packages des logiciels développés dans le cadre de VITAM ; ces packages sont maintenus par VITAM, et les licenses d'utilisations associées sont celles de VITAM.
    - ``vitam-externe`` : ce dépôt héberge les packages des logiciels requis par l'installation de VITAM mais non présents dans les dépôts natifs de la distribution. Ces packages sont fournis par VITAM, mais sont redistribués sans modifications de la part de VITAM. Ils ne sont en particulier pas maintenus par VITAM, et les licenses d'utilisation restent celles des packages originaux.


.. note:: La création, configuration et initialisation des dépôts internes à partir des packages livrés est un pré-requis à l'installation de VITAM.

..  
    Garde-t-on les dépôts ainsi définis ?
    
    * 1 dépôt RPM par version du produit. Lors d'un upgrade de version, la première action du déploiement sera de modifier le pointeur vers le dépôt cible : 
    
        + En version 1.0, il existera un dépôt vitam-1.0 et sur lequel chaque serveur Vitam pointera (via les fichiers dans /etc/yum.repos.d
        + Lors d'un upgrade la première étape de l'outil de déploiement sera de modifier la version du dépôt géré par yum
    
    * En Bêta, les dépôts RPM devront être hébergés par l'infrastructure sous-jacente (non gérés par l'outil de déploiement Vitam)
    * En V1, les dépôts RPM pour Vitam sont hébergés sur le serveur de déploiement et de configuration et est géré 


Configuration RPM
-----------------

Conformément aux usages RPM de Centos/RHEL, les packages ne contiennent pas dans les pré/post action d'arrêt/démarrage/redémarrage de services.

.. note:: La configuration de démarrage des services et leur démarrage (a minima initial) est de la responsabilité de l'outillage de déploiement.

Contrairement aux usages de RPM, les fichiers de configuration ne seront pas gérés dans RPM . En effet, les fichiers de configuration seront instanciés par l'outil de déploiement. Pour éviter la génération de fichier .rpmnew ou .rpmsave, il ne sera pas utilisé la directive %config.

.. caution:: A ce jour, les fichiers de configuration ne sont pas listés dans les fichiers de configuration des fichiers RPM ; par conséquent, ils n'apparaissent pas dans le résultats de commandes telles que ``rpm -ql``.

.. 
	A garder en tête : 
	* Présenter les fichiers de configuration dans les fichiers RPM sous forme de ghost. Cette fonctionnalité permet de gérer les fichiers "comme des coquilles vides" dans la base RPM (notamment pour rpm -ql) mais qui ne sont pas livrés en tant que tel dans le RPM . `(ghost_définition)`_


.. _`(ghost_définition)`: http://www.rpm.org/max-rpm-snapshot/s1-rpm-inside-files-list-directives.html#S3-RPM-INSIDE-FLIST-GHOST-DIRECTIVE
