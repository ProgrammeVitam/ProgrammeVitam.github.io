

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.2.2. Configuration du déploiement &mdash; documentation VITAM - Documentation d&#39;installation 1.0.0</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Recherche" href="../search.html"/>
    <link rel="top" title="documentation VITAM - Documentation d&#39;installation 1.0.0" href="../index.html"/>
        <link rel="up" title="4. Procédures d’installation / mise à jour" href="_toc.html"/>
        <link rel="next" title="4.2.3. Gestion des certificats" href="20-certificats.html"/>
        <link rel="prev" title="4.2.1. Multi-sites" href="05_multisite.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'installation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_install/_toc.html">3. Prérequis à l&#8217;installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">4. Procédures d&#8217;installation / mise à jour</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="_toc.html#verifications-prealables">4.1. Vérifications préalables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html#procedures">4.2. Procédures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="05_multisite.html">4.2.1. Multi-sites</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.2.2. Configuration du déploiement</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fichiers-de-deploiement">4.2.2.1. Fichiers de déploiement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#informations-plate-forme">4.2.2.2. Informations &#8220;plate-forme&#8221;</a></li>
<li class="toctree-l4"><a class="reference internal" href="#declaration-des-secrets">4.2.2.3. Déclaration des secrets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="20-certificats.html">4.2.3. Gestion des certificats</a></li>
<li class="toctree-l3"><a class="reference internal" href="21-addons.html">4.2.4. Paramétrages supplémentaires</a></li>
<li class="toctree-l3"><a class="reference internal" href="30-installation.html">4.2.5. Procédure de première installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="80-extras.html">4.2.6. Elements extras de l&#8217;installation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../update/_toc.html">5. Procédures de mise à jour</a></li>
<li class="toctree-l1"><a class="reference internal" href="../post_install/_toc.html">6. Post installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">7. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">VITAM - Documentation d'installation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="_toc.html">4. Procédures d&#8217;installation / mise à jour</a> &raquo;</li>
      
    <li>4.2.2. Configuration du déploiement</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/installation/10-configuration.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="configuration-du-deploiement">
<h1>4.2.2. Configuration du déploiement<a class="headerlink" href="#configuration-du-deploiement" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last">L&#8217;architecture de la solution logicielle, les éléments de dimensionnement ainsi que les principes de déploiement sont définis dans le <a class="reference internal" href="../introduction.html#term-dat"><span class="xref std std-term">DAT</span></a>.</p>
</div>
<div class="section" id="fichiers-de-deploiement">
<h2>4.2.2.1. Fichiers de déploiement<a class="headerlink" href="#fichiers-de-deploiement" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les fichiers de déploiement sont disponibles dans la version VITAM livrée dans le sous-répertoire <code class="docutils literal"><span class="pre">deployment</span></code> . Concernant l&#8217;installation, ils consistent en 2 parties&nbsp;:</p>
<blockquote>
<div><ul class="simple">
<li>les playbook ansible de déploiement, présents dans le sous-répertoire <code class="docutils literal"><span class="pre">ansible-vitam</span></code>, qui est indépendant de l&#8217;environnement à déployer ; ces fichiers ne sont normalement pas à modifier pour réaliser une installation.</li>
<li>l&#8217;arborescence d&#8217;inventaire&nbsp;; des fichiers d&#8217;exemple sont disponibles dans le sous-répertoire <code class="docutils literal"><span class="pre">environments</span></code>. Cette arborescence est valable pour le déploiement d&#8217;un environnement, et est à dupliquer lors de l&#8217;installation d&#8217;environnements ultérieurs. Les fichiers qui y sont contenus doivent être adaptés avant le déploiement, comme il est expliqué dans les paragraphes suivants.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="informations-plate-forme">
<span id="inventaire"></span><h2>4.2.2.2. Informations &#8220;plate-forme&#8221;<a class="headerlink" href="#informations-plate-forme" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour configurer le déploiement, il est nécessaire de créer dans le répertoire <code class="docutils literal"><span class="pre">environments</span></code> un nouveau fichier d&#8217;inventaire (dans la suite, ce fichier sera communément appelé  <code class="docutils literal"><span class="pre">hosts.&lt;environnement&gt;</span></code>). Ce fichier doit être basé sur la structure présente dans le fichier <code class="docutils literal"><span class="pre">hosts.example</span></code> (et notamment respecter scrupuleusement l&#8217;arborescence des groupes ansible) ; les commentaires dans ce fichier donnent les explications permettant l&#8217;adaptation à l&#8217;environnement cible :</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349</pre></div></td><td class="code"><div class="highlight"><pre><span></span># Group definition ; DO NOT MODIFY
[hosts]

# Group definition ; DO NOT MODIFY
[hosts:children]
vitam
reverse
library
hosts-dev-tools
ldap


########### Tests environments specifics ###########

# EXTRA : Front reverse-proxy (test environments ONLY) ; add machine name after
[reverse]
# optional : after machine, if this machine is different from VITAM machines, you can specify another become user
# Example
# vitam-centos-01.vitam ansible_ssh_user=centos

########### Extra VITAM applications ###########

[ldap] # Extra : OpenLDAP server
# LDAP server !!! NOT FOR PRODUCTION !!! Test only

[library]
# TODO: Put here servers where this service will be deployed : library

[hosts-dev-tools]
# TODO: Put here servers where this service will be deployed : mongo-express, elasticsearch-head

[elasticsearch:children] # EXTRA : elasticsearch
hosts-elasticsearch-data
hosts-elasticsearch-log

########### VITAM services ###########

# Group definition ; DO NOT MODIFY
[vitam:children]
zone-external
zone-access
zone-applicative
zone-storage
zone-data
zone-admin


##### Zone externe


[zone-external:children]
hosts-ihm-demo
hosts-cerebro
hosts-ihm-recette

[hosts-ihm-demo]
# TODO: Put here servers where this service will be deployed : ihm-demo

[hosts-ihm-recette]
# TODO: Put here servers where this service will be deployed : ihm-recette (extra feature)

[hosts-cerebro]
# TODO: Put here servers where this service will be deployed : vitam-elasticsearch-cerebro


##### Zone access

# Group definition ; DO NOT MODIFY
[zone-access:children]
hosts-ingest-external
hosts-access-external

[hosts-ingest-external]
# TODO: Put here servers where this service will be deployed : ingest-external


[hosts-access-external]
# TODO: Put here servers where this service will be deployed : access-external


##### Zone applicative

# Group definition ; DO NOT MODIFY
[zone-applicative:children]
hosts-ingest-internal
hosts-processing
hosts-worker
hosts-access-internal
hosts-metadata
hosts-functional-administration
hosts-logbook
hosts-workspace
hosts-storage-engine
hosts-security-internal

[hosts-security-internal]
# TODO: Put here servers where this service will be deployed : security-internal


[hosts-logbook]
# TODO: Put here servers where this service will be deployed : logbook


[hosts-workspace]
# TODO: Put here servers where this service will be deployed : workspace


[hosts-ingest-internal]
# TODO: Put here servers where this service will be deployed : ingest-internal


[hosts-access-internal]
# TODO: Put here servers where this service will be deployed : access-internal


[hosts-metadata]
# TODO: Put here servers where this service will be deployed : metadata


[hosts-functional-administration]
# TODO: Put here servers where this service will be deployed : functional-administration


[hosts-processing]
# TODO: Put here servers where this service will be deployed : processing


[hosts-storage-engine]
# TODO: Put here servers where this service will be deployed : storage-engine


[hosts-worker]
# TODO: Put here servers where this service will be deployed : worker
# Optional parameter after each host : vitam_worker_capacity=&lt;integer&gt; ; please refer to your infrastructure for defining this number ; default is 1


##### Zone storage

[zone-storage:children] # DO NOT MODIFY
hosts-storage-offer-default


[hosts-storage-offer-default]
# TODO: Put here servers where this service will be deployed : storage-offer-default
# LIMIT : only 1 offer per machine and 1 machine per offer
# Mandatory param for each offer is offer_conf and points to offer_opts.yml &amp; vault-vitam.yml (with same tree)
# hostname-offre-1.vitam offer_conf=offer-swift-1
# for filesystem
# hostname-offre-2.vitam offer_conf=offer-fs-1

[hosts-mongodb-offer:children]
hosts-mongos-data
hosts-mongoc-data
hosts-mongod-data

[hosts-mongos-offer]
# TODO: put here servers where this service will be deployed : mongos cluster for storage offers
# Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)
# Example (for a more complete one, see the one in the group hosts-mongos-data) :
# vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1
# vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1
# vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1
# vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1

[hosts-mongoc-offer]
# TODO: put here servers where this service will be deployed : mongoc cluster for storage offers
# Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)
# Optional param : mandatory for 1 node of the shard, some init commands will be executed on it
# Optional param : mongo_arbiter=true : the node will be only an arbiter ; do not add this paramter on a mongo_rs_bootstrap node
# Example :
# vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1                       mongo_rs_bootstrap=true
# vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1
# vitam-swift-offer            mongo_cluster_name=offer-swift-1                       mongo_arbiter=true
# vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1                          mongo_rs_bootstrap=true
# vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1
# vitam-fs-offer               mongo_cluster_name=offer-fs-1                          mongo_arbiter=true

[hosts-mongod-offer]
# TODO: put here servers where this service will be deployed : mongod cluster for storage offers
# Mandatory param : mongo_cluster_name : name of the cluster (should exist in the offer_conf configuration)
# Mandatory param : id of the current shard, increment by 1 from 0 to n
# Optional param : mandatory for 1 node of the shard, some init commands will be executed on it
# Optional param : mongo_arbiter=true : the node will be only an arbiter ; do not add this paramter on a mongo_rs_bootstrap node
# Example :
# vitam-mongo-swift-offer-01   mongo_cluster_name=offer-swift-1    mongo_shard_id=0                   mongo_rs_bootstrap=true
# vitam-mongo-swift-offer-02   mongo_cluster_name=offer-swift-1    mongo_shard_id=0
# vitam-swift-offer            mongo_cluster_name=offer-swift-1    mongo_shard_id=0                   mongo_arbiter=true
# vitam-mongo-fs-offer-01      mongo_cluster_name=offer-fs-1       mongo_shard_id=0                   mongo_rs_bootstrap=true
# vitam-mongo-fs-offer-02      mongo_cluster_name=offer-fs-1       mongo_shard_id=0
# vitam-fs-offer               mongo_cluster_name=offer-fs-1       mongo_shard_id=0                   mongo_arbiter=true

##### Zone data

# Group definition ; DO NOT MODIFY
[zone-data:children]
hosts-elasticsearch-data
hosts-mongodb-data

[hosts-elasticsearch-data]
# TODO: Put here servers where this service will be deployed : elasticsearch-data cluster
# 2 params available for huge environments (parameter to be declared after each server) :
#    is_data=true/false
#    is_master=true/false
#    other options are not handled yet
# defaults are set to true
# Examples :
# server1 is_master=true is_data=false
# server2 is_master=false is_data=true
# More explanation here : https://www.elastic.co/guide/en/elasticsearch/reference/5.6/modules-node.html


# Group definition ; DO NOT MODIFY
[hosts-mongodb-data:children]
hosts-mongos-data
hosts-mongoc-data
hosts-mongod-data

[hosts-mongos-data]
# TODO: Put here servers where this service will be deployed : mongos cluster
# Mandatory param : mongo_cluster_name=mongo-data  (&quot;mongo-data&quot; is mandatory)
# Example :
# vitam-mdbs-01   mongo_cluster_name=mongo-data
# vitam-mdbs-01   mongo_cluster_name=mongo-data
# vitam-mdbs-01   mongo_cluster_name=mongo-data

[hosts-mongoc-data]
# TODO: Put here servers where this service will be deployed : mongoc cluster
# Mandatory param : mongo_cluster_name=mongo-data  (&quot;mongo-data&quot; is mandatory)
# Optional param : mandatory for 1 node of the shard, some init commands will be executed on it
# Example :
# vitam-mdbc-01   mongo_cluster_name=mongo-data                     mongo_rs_bootstrap=true
# vitam-mdbc-01   mongo_cluster_name=mongo-data
# vitam-mdbc-01   mongo_cluster_name=mongo-data

[hosts-mongod-data]
# TODO: Put here servers where this service will be deployed : mongod cluster
# Each replica_set should have an odd number of members (2n + 1)
# Reminder: For Vitam, one mongodb shard is using one replica_set
# Mandatory param : mongo_cluster_name=mongo-data (&quot;mongo-data&quot; is mandatory)
# Mandatory param : id of the current shard, increment by 1 from 0 to n
# Optional param : mandatory for 1 node of the shard, some init commands will be executed on it
# Example:
# vitam-mdbd-01  mongo_cluster_name=mongo-data   mongo_shard_id=0  mongo_rs_bootstrap=true
# vitam-mdbd-02  mongo_cluster_name=mongo-data   mongo_shard_id=0
# vitam-mdbd-03  mongo_cluster_name=mongo-data   mongo_shard_id=0
# vitam-mdbd-04  mongo_cluster_name=mongo-data   mongo_shard_id=1  mongo_rs_bootstrap=true
# vitam-mdbd-05  mongo_cluster_name=mongo-data   mongo_shard_id=1
# vitam-mdbd-06  mongo_cluster_name=mongo-data   mongo_shard_id=1

###### Zone admin

# Group definition ; DO NOT MODIFY
[zone-admin:children]
hosts-consul-server
hosts-kibana-data
log-servers
hosts-elasticsearch-log

[hosts-consul-server]
# TODO: Put here servers where this service will be deployed : consul

[hosts-kibana-data]
# TODO: Put here servers where this service will be deployed : kibana (for data cluster)

[log-servers:children]
hosts-kibana-log
hosts-logstash


[hosts-kibana-log]
# TODO: Put here servers where this service will be deployed : kibana (for log cluster)

[hosts-logstash]
# TODO: Put here servers where this service will be deployed : logstash


[hosts-elasticsearch-log]
# TODO: Put here servers where this service will be deployed : elasticsearch-log cluster

########### Global vars ###########

[hosts:vars]

# ===============================
# VITAM
# ===============================

# Declare user for ansible on target machines
ansible_ssh_user=
# Can target user become as root ? ; true is required by VITAM (usage of a sudoer is mandatory)
ansible_become=true

# Related to Consul ; apply in a table your DNS server(s)
# Example : dns_servers=[&quot;8.8.8.8&quot;,&quot;8.8.4.4&quot;]
dns_servers=

# Vitam tenants to create
vitam_tenant_ids=[0,1,2]
vitam_tenant_admin=1

### Logback configuration ###
# Days before deleting logback log files (java &amp; access logs for vitam components)
days_to_delete_logback_logfiles=

# Configuration for Curator
#	Days before deletion on log management cluster; 365 for production environment
days_to_delete_logstash_indexes=
#	Days before closing &quot;old&quot; indexes on log management cluster; 30 for production environment
days_to_close_logstash_indexes=

# Define local Consul datacenter name
vitam_site_name=prod-dc1
# EXAMPLE : vitam_site_name = prod-dc1
# check whether on primary site (true) or secondary (false)
primary_site=true


# ===============================
# EXTRA
# ===============================
# Environment (defines title in extra on reverse homepage). Variable is DEPRECATED !
#environnement=

### vitam-itest repository ###
vitam_tests_branch=master
vitam_tests_gitrepo_protocol=
vitam_tests_gitrepo_baseurl=
vitam_tests_gitrepo_url=

# Curator configuration
#	Days before deletion for packetbeat index only on log management cluster
days_to_delete_packetbeat_indexes=5
#	Days before deletion for metricbeat index only on log management cluster; 30 for production environment
days_to_delete_metricbeat_indexes=30
# Days before closing metrics elasticsearch indexes
days_to_close_metrics_indexes=7
# Days before deleting metrics elasticsearch indexes
days_to_delete_metrics_indexes=30
days_to_delete_packetbeat_indexes=20
days_to_delete_metricbeat_indexes=20



# Used when VITAM is behind a reverse proxy (provides configuration for reverse proxy &amp;&amp; displayed in header page)
vitam_reverse_external_dns=
# For reverse proxy use
reverse_proxy_port=80
# http_proxy env var to use ; has to be declared even if empty
http_proxy_environnement=
</pre></div>
</td></tr></table></div>
<p>Pour chaque type de &#8220;host&#8221;, indiquer le(s) serveur(s) défini(s) pour chaque fonction. Une colocalisation de composants est possible (Cf. le paragraphe idoine du <a class="reference internal" href="../introduction.html#term-dat"><span class="xref std std-term">DAT</span></a>)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Concernant le groupe &#8220;hosts-consul-server&#8221;, il est nécessaire de déclarer un minimum de 3 machines.</p>
</div>
<p>La configuration des droits d&#8217;accès à VITAM est réalisée dans le fichier <code class="docutils literal"><span class="pre">environments</span></code> <code class="docutils literal"><span class="pre">/group_vars/all/vitam_security.yml</span></code>, comme suit :</p>
<div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nn">---</span>

<span class="c1"># Business vars</span>

<span class="c1">### Admin context name and tenants ###</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_name</span><span class="p p-Indicator">:</span> <span class="s">&quot;admin-context&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_tenants</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{vitam_tenant_ids}}&quot;</span>
<span class="c1"># Indicate context certificates relative paths under {{inventory_dir}}/certs/client-external/clients</span>
<span class="c1"># vitam-admin-int is mandatory for internal use (PRONOM upload)</span>
<span class="l l-Scalar l-Scalar-Plain">admin_context_certs</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;ihm-demo/ihm-demo.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;ihm-recette/ihm-recette.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;reverse/reverse.crt&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;vitam-admin-int/vitam-admin-int.crt&quot;</span> <span class="p p-Indicator">]</span>
<span class="c1"># Indicate here all the personal certificates relative paths under {{inventory_dir}}/certs/client-vitam-users/clients</span>
<span class="l l-Scalar l-Scalar-Plain">admin_personal_certs</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span> <span class="s">&quot;userOK.crt&quot;</span> <span class="p p-Indicator">]</span>

<span class="c1"># Admin security profile name</span>
<span class="l l-Scalar l-Scalar-Plain">admin_security_profile</span><span class="p p-Indicator">:</span> <span class="s">&quot;admin-security-profile&quot;</span>

<span class="l l-Scalar l-Scalar-Plain">admin_basic_auth_user</span><span class="p p-Indicator">:</span> <span class="s">&quot;adminUser&quot;</span>
</pre></div>
</td></tr></table></div>
<p>Enfin, la déclaration des configuration des offres de stockage est réalisée dans le fichier <code class="docutils literal"><span class="pre">environments</span></code> <code class="docutils literal"><span class="pre">/group_vars/all/offers_opts.yml</span></code> :</p>
<blockquote>
<div><div class="highlight-yaml"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># This list is ordered. It can and has to be completed if more offers are necessary</span>
<span class="c1"># Strategy order (1st has to be the prefered one)</span>
<span class="l l-Scalar l-Scalar-Plain">vitam_strategy</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span>
    <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="c1">#    vitam_site_name: prod-dc2</span>
<span class="c1">#  - name: offer_swift_1</span>
<span class="c1"># Example :</span>
<span class="c1">#  - name: distant</span>
<span class="c1">#    referent: true</span>
<span class="c1">#    vitam_site_name: distant-dc2</span>

<span class="c1"># DON&#39;T forget to add associated passwords in vault-vitam.yml with same tree when using provider openstack-swift*</span>
<span class="c1"># ATTENTION !!! Each offer has to have a distinct name, except for clusters binding a same physical storage</span>
<span class="c1"># WARNING : for offer names, please only use [a-z][a-z0-9-]* pattern</span>
<span class="l l-Scalar l-Scalar-Plain">vitam_offers</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span><span class="p p-Indicator">:</span>
    <span class="c1"># param can be filesystem or filesystem-hash</span>
    <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem</span>
  <span class="l l-Scalar l-Scalar-Plain">offer-swift-1</span><span class="p p-Indicator">:</span>
    <span class="c1"># provider : openstack-swift for v1 or openstack-swift-v3 for v3</span>
    <span class="l l-Scalar l-Scalar-Plain">provider</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openstack-swift</span>
    <span class="c1"># keystoneEndPoint : URL de connexion à keystone</span>
    <span class="l l-Scalar l-Scalar-Plain">keystoneEndPoint</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://hostname-rados-gw:port/auth/1.0</span>
    <span class="c1"># deprecated</span>
    <span class="l l-Scalar l-Scalar-Plain">keystone_auth_url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://hostname-rados-gw:port/auth/1.0</span>
    <span class="c1"># swiftUid : domaine OpenStack dans lequel l&#39;utilisateur est enregistré</span>
    <span class="l l-Scalar l-Scalar-Plain">swift_uid</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">domaine</span>
    <span class="c1"># swiftSubUser : identifiant de l&#39;utilisateur</span>
    <span class="l l-Scalar l-Scalar-Plain">swift_subuser</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">utilisateur</span>
    <span class="c1"># cephMode : doit être à false si offre v3 ; true si offre v1</span>
    <span class="l l-Scalar l-Scalar-Plain">cephMode</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="c1"># projectName : tenant openstack</span>
    <span class="l l-Scalar l-Scalar-Plain">projectName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">monTenant</span>


    
  <span class="c1"># example_swift_v1:</span>
  <span class="c1">#   provider: openstack-swift</span>
  <span class="c1">#   keystoneEndPoint: https://keystone/auth/1.0</span>
  <span class="c1">#   swift_uid: tenant$user # &lt;tenant&gt;$&lt;user&gt;</span>
  <span class="c1">#   swift_subuser: subuser</span>
  <span class="c1">#   cephMode: true</span>
  <span class="c1"># example_swift_v3:</span>
  <span class="c1">#   provider: openstack-swift-v3</span>
  <span class="c1">#   keystoneEndPoint: https://keystone/v3</span>
  <span class="c1">#   swift_uid: domaine</span>
  <span class="c1">#   swift_subuser: user</span>
  <span class="c1">#   cephMode: false</span>
  <span class="c1">#   projectName: monTenant</span>
</pre></div>
</td></tr></table></div>
</div></blockquote>
<p>Se référer aux commentaires dans le fichier pour le renseigner correctement.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">dans le cas d&#8217;un déploiement multi-sites, dans la section <code class="docutils literal"><span class="pre">vitam_strategy</span></code>, la directive <code class="docutils literal"><span class="pre">vitam_site_name</span></code> définit pour  l&#8217;offre associée le nom du datacenter consul.  Par défaut, si non défini, c&#8217;est la valeur de la variable <code class="docutils literal"><span class="pre">vitam_site_name</span></code> définie dans l&#8217;inventaire.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Ne pas oublier, en cas de connexion à un keystone en https, de répercuter dans la <a class="reference internal" href="../introduction.html#term-pki"><span class="xref std std-term">PKI</span></a> la clé publique de la CA du keystone.</p>
</div>
</div>
<div class="section" id="declaration-des-secrets">
<span id="pkiconfsection"></span><h2>4.2.2.3. Déclaration des secrets<a class="headerlink" href="#declaration-des-secrets" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Cette section décrit des fichiers contenant des données sensibles ; il convient de sécuriser ces fichiers avec un mot de passe &#8220;fort&#8221;. En cas d&#8217;usage d&#8217;un fichier de mot de passe (&#8220;vault-password-file&#8221;), il faut renseigner ce mot de passe comme contenu du fichier et ne pas oublier de sécuriser ou supprimer ce fichier à l&#8217;issue de l&#8217;installation.</p>
</div>
<p>Les secrets utilisés par la solution logicielle (en-dehors des certificats qui sont abordés dans une section ultérieure) sont définis dans des fichiers chiffrés par ansible-vault.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Tous les vault présents dans l&#8217;arborescence d&#8217;inventaire doivent être tous protégés par le même mot de passe !</p>
</div>
<p>La première étape consiste à changer les mots de passe de tous les vault présents dans l&#8217;arborescence de déploiement (le mot de passe par défaut est contenu dans le fichier <code class="docutils literal"><span class="pre">vault_pass.txt</span></code>) à l&#8217;aide de la commande <code class="docutils literal"><span class="pre">ansible-vault</span> <span class="pre">rekey</span> <span class="pre">&lt;fichier</span> <span class="pre">vault&gt;</span></code>.</p>
<p>2 vaults sont principalement utilisés dans le déploiement d&#8217;une version ; leur contenu est donc à modifier avant tout déploiement :</p>
<ul>
<li><p class="first">Le fichier <code class="docutils literal"><span class="pre">environments</span></code> <code class="docutils literal"><span class="pre">/group_vars/all/vault-vitam.yml</span></code> contient les secrets généraux :</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
# Vitam platform secret key
plateforme_secret: vitamsecret

# Cerebro key
cerebro_secret_key: tGz28hJkiW[p@a34G

# The consul key must be 16-bytes, Base64 encoded: https://www.consul.io/docs/agent/encryption.html
# You can generate it with the &quot;consul keygen&quot; command
# Or you can use this script: deployment/pki/scripts/generate_consul_key.sh
consul_encrypt: Biz14ohqN4HtvZmrXp3N4A==

mongodb:
  mongo-data:
    passphrase: mongogo
    admin:
      user: vitamdb-admin
      password: azerty
    localadmin:
      user: vitamdb-localadmin
      password: qwerty
    metadata:
      user: metadata
      password: azerty1
    logbook:
      user: logbook
      password: azerty2
    functionalAdmin:
      user: functional-admin
      password: azerty3
    securityInternal:
      user: security-internal
      password: azerty4
  offer-fs-1:
    passphrase: mongogo
    admin:
      user: vitamdb-admin
      password: azerty
    localadmin:
      user: vitamdb-localadmin
      password: qwerty
    offer:
      user: offer
      password: azerty5
  offer-fs-2:
    passphrase: mongogo
    admin:
      user: vitamdb-admin
      password: azerty
    localadmin:
      user: vitamdb-localadmin
      password: qwerty
    offer:
      user: offer
      password: azerty5
  offer-swift-1:
    passphrase: mongogo
    admin:
      user: vitamdb-admin
      password: azerty
    localadmin:
      user: vitamdb-localadmin
      password: qwerty
    offer:
      user: offer
      password: azerty5

vitam_users:
  - vitam_aadmin:
    login: aadmin
    password: aadmin1234
    role: admin
  - vitam_uuser:
    login: uuser
    password: uuser1234
    role: user
  - vitam_gguest:
    login: gguest
    password: gguest1234
    role: guest
  - techadmin:
    login: techadmin
    password: techadmin1234
    role: admin
ldap_authentification:
    ldap_pwd: &quot;admin&quot;

admin_basic_auth_password: adminPassword
</pre></div>
</td></tr></table></div>
</li>
<li><p class="first">Le fichier <code class="docutils literal"><span class="pre">environments</span></code> <code class="docutils literal"><span class="pre">/group_vars/all/vault-keystores.yml</span></code> contient les mots de passe des magasins de certificats utilisés dans VITAM :</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>keystores:
  server:
    offer: azerty1
    access_external: azerty2
    ingest_external: azerty3
    ihm_recette: azerty16
    ihm_demo: azerty17
  client_external:
    ihm_demo: azerty4
    gatling: azerty4
    ihm_recette: azerty5
    reverse: azerty6
  client_storage:
    storage: azerty7
  timestamping:
    secure_logbook: azerty8
truststores:
  server: azerty9
  client_external: azerty10
  client_storage: azerty11
grantedstores:
  client_external: azerty12
  client_storage: azerty13
</pre></div>
</td></tr></table></div>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">il convient de sécuriser votre environnement en définissant des mots de passe &#8220;forts&#8221;.</p>
</div>
<div class="section" id="cas-des-extra">
<h3>4.2.2.3.1. Cas des extra<a class="headerlink" href="#cas-des-extra" title="Lien permanent vers ce titre">¶</a></h3>
<ul>
<li><p class="first">Le fichier <code class="docutils literal"><span class="pre">environments</span></code> <code class="docutils literal"><span class="pre">/group_vars/all/vault-extra.yml</span></code> contient les mot de passe des magasins de certificats utilisés dans VITAM :</p>
<div class="highlight-ini"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># Example for git lfs ; uncomment &amp; use if needed</span>
<span class="c1">#vitam_gitlab_itest_login: &quot;account&quot;</span>
<span class="c1">#vitam_gitlab_itest_password: &quot;password&quot;</span>
</pre></div>
</td></tr></table></div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">le playbook <code class="docutils literal"><span class="pre">vitam.yml</span></code> comprend des étapes avec la mention <code class="docutils literal"><span class="pre">no_log</span></code> afin de ne pas afficher en clair des étapes comme les mots de passe des certificats. En cas d&#8217;erreur, il est possible de retirer la ligne dans le fichier pour une analyse plus fine d&#8217;un éventuel problème sur une de ces étapes.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="20-certificats.html" class="btn btn-neutral float-right" title="4.2.3. Gestion des certificats" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="05_multisite.html" class="btn btn-neutral" title="4.2.1. Multi-sites" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>