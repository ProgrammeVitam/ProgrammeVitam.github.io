<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.2.2. Cas particulier d’une installation multi-sites &mdash; Documentation VITAM - Documentation d&#39;installation 6.rc.1</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
      <script>
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'6.rc.1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="4.2.3. Configuration du déploiement" href="10-configuration.html" />
    <link rel="prev" title="4.2.1. Cinématique de déploiement" href="01_cinematique.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'installation<img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                6.rc.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_install/_toc.html">3. Prérequis à l’installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">4. Procédures d’installation / mise à jour</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="_toc.html#verifications-prealables">4.1. Vérifications préalables</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html#procedures">4.2. Procédures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="01_cinematique.html">4.2.1. Cinématique de déploiement</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.2.2. Cas particulier d’une installation multi-sites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#procedure-d-installation">4.2.2.1. Procédure d’installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedure-de-reinstallation">4.2.2.2. Procédure de réinstallation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#flux-entre-storage-et-offer">4.2.2.3. Flux entre Storage et Offer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="10-configuration.html">4.2.3. Configuration du déploiement</a></li>
<li class="toctree-l3"><a class="reference internal" href="20-certificats.html">4.2.4. Gestion des certificats</a></li>
<li class="toctree-l3"><a class="reference internal" href="21-addons.html">4.2.5. Paramétrages supplémentaires</a></li>
<li class="toctree-l3"><a class="reference internal" href="30-installation.html">4.2.6. Procédure de première installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="80-extras.html">4.2.7. Éléments <em>extras</em> de l’installation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../update/_toc.html">5. Procédures de mise à jour de la configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../post_install/_toc.html">6. Post installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade/_toc.html">7. Montée de version</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">8. Annexes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'installation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="_toc.html">4. Procédures d’installation / mise à jour</a></li>
      <li class="breadcrumb-item active">4.2.2. Cas particulier d’une installation multi-sites</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/installation/05_multisite.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="cas-particulier-d-une-installation-multi-sites">
<h1>4.2.2. Cas particulier d’une installation multi-sites<a class="headerlink" href="#cas-particulier-d-une-installation-multi-sites" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="procedure-d-installation">
<h2>4.2.2.1. Procédure d’installation<a class="headerlink" href="#procedure-d-installation" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cadre d’une installation multi-sites, il est nécessaire de déployer la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sur le site secondaire dans un premier temps, puis déployer le site <cite>production</cite>.</p>
<p>Il faut paramétrer correctement un certain nombre de variables ansible pour chaque site:</p>
<div class="section" id="vitam-site-name">
<h3>4.2.2.1.1. vitam_site_name<a class="headerlink" href="#vitam-site-name" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/hosts.&lt;environnement&gt;</span></code></p>
<p>Cette variable sert à définir le nom du site.
Elle doit être différente sur chaque site.</p>
</div>
<div class="section" id="primary-site">
<h3>4.2.2.1.2. primary_site<a class="headerlink" href="#primary-site" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/hosts.&lt;environnement&gt;</span></code></p>
<p>Cette variable sert à définir si le site est primaire ou non.
Sur VITAM installé en mode multi site, un seul des sites doit avoir la valeur <cite>primary_site</cite> à true.
Sur les sites secondaires (primary_site: false), certains composants ne seront pas démarrés et apparaitront donc en orange sur l”<a class="reference internal" href="../introduction.html#term-ihm"><span class="xref std std-term">IHM</span></a> de consul.
Certains timers systemd seront en revanche démarrés pour mettre en place la reconstruction au fil de l’eau, par exemple.</p>
</div>
<div class="section" id="consul-remote-sites">
<h3>4.2.2.1.3. consul_remote_sites<a class="headerlink" href="#consul-remote-sites" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/main.yml</span></code></p>
<p>Cette variable sert à référencer la liste des <cite>Consul Server</cite> des sites distants, à celui que l’on configure.</p>
<p>Exemple de configuration pour une installation avec 3 sites.</p>
<p>Site 1:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">consul_remote_sites</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc2</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc2-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc2-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc2-host-3&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc3</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc3-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc3-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc3-host-3&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Site 2:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">consul_remote_sites</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc1</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc1-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc1-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc1-host-3&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc3</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc3-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc3-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc3-host-3&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Site 3:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">consul_remote_sites</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc1</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc1-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc1-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc1-host-3&quot;</span><span class="p p-Indicator">]</span>
    <span class="p p-Indicator">-</span> <span class="nt">dc2</span><span class="p">:</span>
      <span class="nt">wan</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;dc2-host-1&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc2-host-2&quot;</span><span class="p p-Indicator">,</span><span class="s">&quot;dc2-host-3&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<p>Il faut également prévoir de déclarer, lors de l’installation de chaque site distant, la variable <code class="docutils literal notranslate"><span class="pre">ip_wan</span></code> pour les partitions hébergeant les serveurs Consul (groupe ansible <code class="docutils literal notranslate"><span class="pre">hosts_consul_server</span></code>) et les offres de stockage (groupe ansible <code class="docutils literal notranslate"><span class="pre">hosts_storage_offer_default</span></code>, considérées distantes par le site primaire).
Ces ajouts sont à faire dans <code class="docutils literal notranslate"><span class="pre">environments/host_vars/&lt;nom</span> <span class="pre">partition&gt;</span></code>.</p>
<p>Exemple:</p>
<blockquote>
<div>ip_service: 172.17.0.10
ip_admin: 172.19.0.10
ip_wan: 10.2.64.3</div></blockquote>
<p>Ainsi, à l’usage, le composant <code class="docutils literal notranslate"><span class="pre">storage</span></code> va appeler les services <code class="docutils literal notranslate"><span class="pre">offer</span></code>. Si le service est «&nbsp;hors domaine&nbsp;» (déclaration explicite <code class="docutils literal notranslate"><span class="pre">&lt;service&gt;.&lt;datacenterdistant&gt;.service.&lt;domaineconsul&gt;</span></code>), un échange d’information entre «&nbsp;datacenters&nbsp;» Consul est réalisé et la valeur de <code class="docutils literal notranslate"><span class="pre">ip_wan</span></code> est fournie pour l’appel au service distant.</p>
</div>
<div class="section" id="vitam-offers">
<h3>4.2.2.1.4. vitam_offers<a class="headerlink" href="#vitam-offers" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code></p>
<p>Cette variable référence toutes les offres disponibles sur la totalité des sites VITAM. Sur les sites secondaires, il suffit de référencer les offres disponible localement.</p>
<p>Exemple:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_offers</span><span class="p">:</span>
    <span class="nt">offer-fs-1</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
    <span class="nt">offer-fs-2</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
    <span class="nt">offer-fs-3</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
</pre></div>
</div>
</div>
<div class="section" id="vitam-strategy">
<h3>4.2.2.1.5. vitam_strategy<a class="headerlink" href="#vitam-strategy" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code></p>
<p>Cette variable référence la stratégie de stockage de plateforme <em>default</em> sur le site courant.</p>
<p>Si l’offre se situe sur un site distant, il est nécessaire de préciser le nom du site, via la variable <cite>vitam_site_name</cite>, sur lequel elle se trouve comme dans l’exemple ci-dessous.</p>
<p>Il est fortement conseillé de prendre comme offre référente une des offres locale au site. Les sites secondaires doivent uniquement écrire sur leur(s) offre(s) locale(s).</p>
<p>Exemple pour le site 1 (site primaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_strategy</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span>
      <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-2</span>
      <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site2</span>
      <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-3</span>
      <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site3</span>
      <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="c1"># Optional params for each offers in vitam_strategy. If not set, the default values are applied.</span>
<span class="c1">#    referent: false              # true / false (default), only one per site must be referent</span>
<span class="c1">#    status: ACTIVE               # ACTIVE (default) / INACTIVE</span>
<span class="c1">#    vitam_site_name: distant-dc2 # default is the value of vitam_site_name defined in your local inventory file, should be specified with the vitam_site_name defined for the distant offer</span>
<span class="c1">#    distant: false               # true / false (default). If set to true, it will not check if the provider for this offer is correctly set</span>
<span class="c1">#    id: idoffre                  # OPTIONAL, but IF ACTIVATED, MUST BE UNIQUE &amp; SAME if on another site</span>
<span class="c1">#    asyncRead: false             # true / false (default). Should be set to true for tape offer only</span>
<span class="c1">#    rank: 0                      # Integer that indicates in ascending order the priority of the offer in the strategy</span>
</pre></div>
</div>
<p>Exemple pour le site 2 (site secondaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_strategy</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-2</span>
      <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<p>Exemple pour le site 3 (site secondaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_strategy</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-3</span>
      <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</div>
<div class="section" id="other-strategies">
<h3>4.2.2.1.6. other_strategies<a class="headerlink" href="#other-strategies" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code></p>
<p>Cette variable référence les stratégies de stockage additionnelles sur le site courant. <strong>Elles ne sont déclarées et utilisées que dans le cas du multi-stratégies.</strong>
Si l’offre se situe sur un site distant, il est nécessaire de préciser le nom du site sur lequel elle se trouve comme dans l’exemple ci-dessous.
Les sites secondaires doivent uniquement écrire sur leur(s) offre(s) locale(s).</p>
<p>Les offres correspondant à l’exemple <code class="docutils literal notranslate"><span class="pre">other_strategies</span></code> sont les suivantes:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_offers</span><span class="p">:</span>
    <span class="nt">offer-fs-1</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
    <span class="nt">offer-fs-2</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
    <span class="nt">offer-fs-3</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem-hash</span>
    <span class="nt">offer-s3-1</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">amazon-s3-v1</span>
    <span class="nt">offer-s3-2</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">amazon-s3-v1</span>
    <span class="nt">offer-s3-3</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">amazon-s3-v1</span>
</pre></div>
</div>
<p>Exemple pour le site 1 (site primaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">other_strategies</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-1</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site2</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site3</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-1</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site2</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site3</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class="nt">binary</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-1</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site2</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">distant</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">vitam_site_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">site3</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>
</div>
<p>Exemple pour le site 2 (site secondaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">other_strategies</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">binary</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-2</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
<p>Exemple pour le site 3 (site secondaire):</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">other_strategies</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-fs-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">binary</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">offer-s3-3</span>
          <span class="nt">referent</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
          <span class="nt">rank</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
</pre></div>
</div>
</div>
<div class="section" id="plateforme-secret">
<h3>4.2.2.1.7. plateforme_secret<a class="headerlink" href="#plateforme-secret" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/vault-vitam.yml</span></code></p>
<p>Cette variable stocke le <cite>secret de plateforme</cite> qui doit être commun à tous les composants de la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> de tous les sites.
La valeur doit donc être identique pour chaque site.</p>
</div>
<div class="section" id="consul-encrypt">
<h3>4.2.2.1.8. consul_encrypt<a class="headerlink" href="#consul-encrypt" title="Lien permanent vers ce titre">¶</a></h3>
<p>Fichier: <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/vault-vitam.yml</span></code></p>
<p>Cette variable stocke le <cite>secret de plateforme</cite> qui doit être commun à tous les <cite>Consul</cite> de tous les sites.
La valeur doit donc être identique pour chaque site.</p>
</div>
</div>
<div class="section" id="procedure-de-reinstallation">
<h2>4.2.2.2. Procédure de réinstallation<a class="headerlink" href="#procedure-de-reinstallation" title="Lien permanent vers ce titre">¶</a></h2>
<p>En prérequis, il est nécessaire d’attendre que tous les <cite>workflows</cite> et reconstructions (sites secondaires) en cours soient terminés.</p>
<p>Ensuite:</p>
<ul class="simple">
<li>Arrêter vitam sur le site primaire.</li>
<li>Arrêter les sites secondaires.</li>
<li>Redéployer vitam sur les sites secondaires.</li>
<li>Redéployer vitam sur le site primaire</li>
</ul>
</div>
<div class="section" id="flux-entre-storage-et-offer">
<h2>4.2.2.3. Flux entre Storage et Offer<a class="headerlink" href="#flux-entre-storage-et-offer" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cas <strong>d’appel en https entre les composants Storage et Offer</strong>, il faut modifier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/advanced/vitam_vars.yml</span></code> et indiquer <code class="docutils literal notranslate"><span class="pre">https_enabled:</span> <span class="pre">true</span></code> dans <code class="docutils literal notranslate"><span class="pre">storageofferdefault</span></code>.</p>
<p>Il convient également également d’ajouter:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>Sur le site primaire</dt>
<dd><ul class="first last">
<li>Dans le truststore de Storage: la <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> ayant signé le certificat de l’Offer du site secondaire</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Sur le site secondaire</dt>
<dd><ul class="first last">
<li>Dans le truststore de Offer: la <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> ayant signé le certificat du Storage du site primaire</li>
<li>Dans le grantedstore de Offer: le certificat du storage du site primaire</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="figure align-center" id="id1">
<img alt="../_images/certificats-multisite.png" src="../_images/certificats-multisite.png" />
<p class="caption"><span class="caption-text">Vue détaillée des certificats entre le storage et l’offre en multi-site</span></p>
</div>
<p>Il est possible de procéder de 2 manières différentes:</p>
<div class="section" id="avant-la-generation-des-keystores">
<h3>4.2.2.3.1. Avant la génération des keystores<a class="headerlink" href="#avant-la-generation-des-keystores" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Pour toutes les copies de certificats indiquées ci-dessous, il est important de ne jamais les écraser, il faut donc renommer les fichiers si nécessaire.</p>
</div>
<p>Déposer les <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> du client storage du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/ca/*</span></code> dans le client storage du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/ca/</span></code>.</p>
<p>Déposer le certificat du client storage du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/clients/storage/*.crt</span></code> dans le client storage du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/client-storage/clients/storage/</span></code>.</p>
<p>Déposer les <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> du serveur offer du site 2 <code class="docutils literal notranslate"><span class="pre">environments/certs/server/ca/*</span></code> dans le répertoire des <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> serveur du site 1 <code class="docutils literal notranslate"><span class="pre">environments/certs/server/ca/*</span></code></p>
</div>
<div class="section" id="apres-la-generation-des-keystores">
<h3>4.2.2.3.2. Après la génération des keystores<a class="headerlink" href="#apres-la-generation-des-keystores" title="Lien permanent vers ce titre">¶</a></h3>
<p>Via le script <code class="docutils literal notranslate"><span class="pre">deployment/generate_stores.sh</span></code>, il convient donc d’ajouter les <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a> et certificats indiqués sur le schéma ci-dessus.</p>
<p>Ajout d’un certificat :
<code class="docutils literal notranslate"><span class="pre">keytool</span> <span class="pre">-import</span> <span class="pre">-keystore</span> <span class="pre">-file</span> <span class="pre">&lt;certificat.crt&gt;</span> <span class="pre">-alias</span> <span class="pre">&lt;alias_certificat&gt;</span></code></p>
<p>Ajout d’une <a class="reference internal" href="../introduction.html#term-ca"><span class="xref std std-term">CA</span></a>:
<code class="docutils literal notranslate"><span class="pre">keytool</span> <span class="pre">-import</span> <span class="pre">-trustcacerts</span> <span class="pre">-keystore</span> <span class="pre">-file</span> <span class="pre">&lt;ca.crt&gt;</span> <span class="pre">-alias</span> <span class="pre">&lt;alias_certificat&gt;</span></code></p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="01_cinematique.html" class="btn btn-neutral float-left" title="4.2.1. Cinématique de déploiement" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="10-configuration.html" class="btn btn-neutral float-right" title="4.2.3. Configuration du déploiement" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>