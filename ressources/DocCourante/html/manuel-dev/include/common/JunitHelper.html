

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>JunitHelper &mdash; Documentation VITAM - Manuel de développement 2.1.1</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="Client" href="client.html" />
    <link rel="prev" title="Logging" href="Logger.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> VITAM - Manuel de développement
          

          
            
            <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../dev-environnement.html">Configuration de l’environnement de développement</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../access/_toc.html">Access</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">Common</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="GUID.html">Global Unique Identifier (GUID) pour Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="Digest.html">Digest</a></li>
<li class="toctree-l3"><a class="reference internal" href="Logger.html">Logging</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">JunitHelper</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mongodb-or-web-server-junit-support">MongoDb or Web Server Junit Support</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="client.html">Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html">DirectedCycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html#graph">Graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="VitamCode.html">Code d’erreur Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="format-identifier.html">Common format identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="stockage.html">Common-storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="vitam-metrics.html">Métriques dans VITAM</a></li>
<li class="toctree-l3"><a class="reference internal" href="private/_toc.html">Common-private</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../functional-administration/_toc.html">Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-demo/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-recette/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest/_toc.html">Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-security/_toc.html">Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logbook/_toc.html">Logbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/_toc.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing/_toc.html">Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/_toc.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../technical-administration/_toc.html">Technical administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../worker/_toc.html">Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/_toc.html">Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devstack_vm.html">Création d’une machine de dev contenant swift</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Manuel de développement</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../_toc.html">Détails par composant</a> &raquo;</li>
        
          <li><a href="_toc.html">Common</a> &raquo;</li>
        
      <li>JunitHelper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/include/common/JunitHelper.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="junithelper">
<h1>JunitHelper<a class="headerlink" href="#junithelper" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="mongodb-or-web-server-junit-support">
<h2>MongoDb or Web Server Junit Support<a class="headerlink" href="#mongodb-or-web-server-junit-support" title="Lien permanent vers ce titre">¶</a></h2>
<p>Si dans un Web Server Junit, il est nécessaire d’activer un service utilisant un port, et ceci afin de favoriser un parallélisme maximal des tests unitaires, il est demandé de procéder comme suit :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span> <span class="kd">private</span> <span class="kd">static</span> <span class="n">JunitHelper</span> <span class="n">junitHelper</span><span class="o">;</span>
 <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">databasePort</span><span class="o">;</span>
 <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">serverPort</span><span class="o">;</span>

 <span class="c1">// dans le @BeforeClass</span>
 <span class="c1">// Créer un objet JunitHelper</span>
 <span class="n">junitHelper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JunitHelper</span><span class="o">();</span>

 <span class="c1">// Pour MongoDB (exemple)</span>
 <span class="n">databasePort</span> <span class="o">=</span> <span class="n">junitHelper</span><span class="o">.</span><span class="na">findAvailablePort</span><span class="o">();</span>
 <span class="kd">final</span> <span class="n">MongodStarter</span> <span class="n">starter</span> <span class="o">=</span> <span class="n">MongodStarter</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
 <span class="c1">// On utilise le port</span>
 <span class="n">mongodExecutable</span> <span class="o">=</span> <span class="n">starter</span><span class="o">.</span><span class="na">prepare</span><span class="o">(</span><span class="k">new</span> <span class="n">MongodConfigBuilder</span><span class="o">()</span>
     <span class="o">.</span><span class="na">version</span><span class="o">(</span><span class="n">Version</span><span class="o">.</span><span class="na">Main</span><span class="o">.</span><span class="na">PRODUCTION</span><span class="o">)</span>
     <span class="o">.</span><span class="na">net</span><span class="o">(</span><span class="k">new</span> <span class="n">Net</span><span class="o">(</span><span class="n">databasePort</span><span class="o">,</span> <span class="n">Network</span><span class="o">.</span><span class="na">localhostIsIPv6</span><span class="o">()))</span>
     <span class="o">.</span><span class="na">build</span><span class="o">());</span>
 <span class="n">mongod</span> <span class="o">=</span> <span class="n">mongodExecutable</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

 <span class="c1">// Pour le serveur web (ici Logbook)</span>
 <span class="c1">// On initialise le mongoDbAccess pour le service</span>
 <span class="n">mongoDbAccess</span> <span class="o">=</span>
     <span class="n">MongoDbAccessFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
         <span class="k">new</span> <span class="n">DbConfigurationImpl</span><span class="o">(</span><span class="n">DATABASE_HOST</span><span class="o">,</span> <span class="n">databasePort</span><span class="o">,</span>
             <span class="s">&quot;vitam-test&quot;</span><span class="o">));</span>
 <span class="c1">// On alloue un port pour le serveur Web</span>
 <span class="n">serverPort</span> <span class="o">=</span> <span class="n">junitHelper</span><span class="o">.</span><span class="na">findAvailablePort</span><span class="o">();</span>

 <span class="c1">// On lit le fichier de configuration par défaut présent dans le src/test/resources</span>
 <span class="n">File</span> <span class="n">logbook</span> <span class="o">=</span> <span class="n">PropertiesUtils</span><span class="o">.</span><span class="na">findFile</span><span class="o">(</span><span class="n">LOGBOOK_CONF</span><span class="o">);</span>
 <span class="c1">// On extraie la configuration</span>
 <span class="n">LogbookConfiguration</span> <span class="n">realLogbook</span> <span class="o">=</span> <span class="n">PropertiesUtils</span><span class="o">.</span><span class="na">readYaml</span><span class="o">(</span><span class="n">logbook</span><span class="o">,</span> <span class="n">LogbookConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 <span class="c1">// On change le port</span>
 <span class="n">realLogbook</span><span class="o">.</span><span class="na">setDbPort</span><span class="o">(</span><span class="n">databasePort</span><span class="o">);</span>
 <span class="c1">// On sauvegarde le fichier (dans un nouveau fichier différent) (static File)</span>
 <span class="n">newLogbookConf</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="n">LOGBOOK_CONF</span><span class="o">,</span> <span class="n">logbook</span><span class="o">.</span><span class="na">getParentFile</span><span class="o">());</span>
 <span class="n">PropertiesUtils</span><span class="o">.</span><span class="na">writeYaml</span><span class="o">(</span><span class="n">newLogbookConf</span><span class="o">,</span> <span class="n">realLogbook</span><span class="o">);</span>

 <span class="c1">// On utilise le port pour RestAssured</span>
 <span class="n">RestAssured</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">serverPort</span><span class="o">;</span>
 <span class="n">RestAssured</span><span class="o">.</span><span class="na">basePath</span> <span class="o">=</span> <span class="n">REST_URI</span><span class="o">;</span>

 <span class="c1">// On démarre le serveur</span>
 <span class="k">try</span> <span class="o">{</span>
    <span class="n">vitamServer</span> <span class="o">=</span> <span class="n">LogbookApplication</span><span class="o">.</span><span class="na">startApplication</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span>
       <span class="c1">// On utilise le fichier de configuration ainsi créé</span>
        <span class="n">newLogbookConf</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">(),</span>
        <span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">serverPort</span><span class="o">)});</span>
    <span class="o">((</span><span class="n">BasicVitamServer</span><span class="o">)</span> <span class="n">vitamServer</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="o">|</span> <span class="n">VitamApplicationServerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span>
        <span class="s">&quot;Cannot start the Logbook Application Server&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// Dans le @AfterClass</span>
<span class="c1">// On arrête le serveur</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="o">((</span><span class="n">BasicVitamServer</span><span class="o">)</span> <span class="n">vitamServer</span><span class="o">).</span><span class="na">stop</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="n">VitamApplicationServerException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">mongoDbAccess</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="n">junitHelper</span><span class="o">.</span><span class="na">releasePort</span><span class="o">(</span><span class="n">serverPort</span><span class="o">);</span>
<span class="c1">// On arrête MongoDb</span>
<span class="n">mongod</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="n">mongodExecutable</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
<span class="n">junitHelper</span><span class="o">.</span><span class="na">releasePort</span><span class="o">(</span><span class="n">databasePort</span><span class="o">);</span>
<span class="c1">// On efface le fichier temporaire</span>
<span class="n">newLogbookConf</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="client.html" class="btn btn-neutral float-right" title="Client" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Logger.html" class="btn btn-neutral" title="Logging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'2.1.1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>