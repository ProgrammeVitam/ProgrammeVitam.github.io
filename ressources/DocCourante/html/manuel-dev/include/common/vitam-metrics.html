<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3.12. Métriques dans VITAM &mdash; Documentation VITAM - Manuel de développement 9.0.0</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="3.13. Common-private" href="private/_toc.html" />
    <link rel="prev" title="3.11. Common-storage" href="stockage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Manuel de développement
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                9.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-environnement.html">Configuration de l’environnement de développement</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../access/_toc.html">1. Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collect/_toc.html">2. Collect</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">3. Common</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">3.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="GUID.html">3.2. Global Unique Identifier (GUID) pour Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="Digest.html">3.3. Digest</a></li>
<li class="toctree-l3"><a class="reference internal" href="Logger.html">3.4. Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="JunitHelper.html">3.5. JunitHelper</a></li>
<li class="toctree-l3"><a class="reference internal" href="client.html">3.6. Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html">3.7. DirectedCycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html#graph">3.8. Graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="VitamCode.html">3.9. Code d’erreur Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="format-identifier.html">3.10. Common format identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="stockage.html">3.11. Common-storage</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">3.12. Métriques dans VITAM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">3.12.1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fonctionnement-des-metriques-dropwizard">3.12.2. Fonctionnement des métriques dropwizard</a></li>
<li class="toctree-l4"><a class="reference internal" href="#prometeus">3.12.3. Prometeus</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="private/_toc.html">3.13. Common-private</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../functional-administration/_toc.html">4. Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-demo/_toc.html">5. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-recette/_toc.html">6. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest/_toc.html">7. Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-security/_toc.html">8. Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logbook/_toc.html">9. Logbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/_toc.html">10. Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing/_toc.html">11. Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scheduler/_toc.html">12. Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/_toc.html">13. Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../technical-administration/_toc.html">14. Technical administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../worker/_toc.html">15. Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/_toc.html">16. Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devstack_vm.html">Création d’une machine de dev contenant <em>Swift</em></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Manuel de développement</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">Détails par composant</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">3. Common</a></li>
      <li class="breadcrumb-item active">3.12. Métriques dans VITAM</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/include/common/vitam-metrics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="metriques-dans-vitam">
<h1>3.12. Métriques dans VITAM<a class="headerlink" href="#metriques-dans-vitam" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="introduction">
<h2>3.12.1. Introduction<a class="headerlink" href="#introduction" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les métriques dans <a class="reference internal" href="../../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sont développées en utilisant les libraries <strong>dropwizard</strong>.
Depuis la release R14, la solution logicielle <a class="reference internal" href="../../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> intègre <cite>Prometheus</cite> et permet d’exposer les métriques déjà existantes via une API d’administration <code class="docutils literal notranslate"><span class="pre">/admin/v1/metrics</span></code>. De nouvelles métriques techniques et métiers sont aussi développées et exposées via cette API.</p>
</div>
<div class="section" id="fonctionnement-des-metriques-dropwizard">
<h2>3.12.2. Fonctionnement des métriques dropwizard<a class="headerlink" href="#fonctionnement-des-metriques-dropwizard" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les métriques historiques dans <a class="reference internal" href="../../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sont développées en utilisant les libraries <strong>dropwizard</strong> et sont stockées dans le package :</p>
<p><strong>fr.gouv.common.metrics</strong></p>
<p>Les <cite>registres</cite> de métriques et les <cite>reporters</cite> de métriques sont tous les deux contenus dans une classe <em>VitamMetrics</em>. Cette classe doit être instanciée avec un <em>VitamMetricsType</em> qui peut être <strong>REST</strong>, <strong>JVM</strong> ou <strong>BUSINESS</strong>. Le type définira les métriques enregistrées dans le registre interne de la classe.</p>
<p>La classe <strong>CommonBusinessApplication</strong> contient une <em>Map</em> statique de <em>VitamMetrics</em> qui est vide et initialisée à chaque démarrage d’une application VITAM.
Cette <em>Map</em> contient obligatoirement un <em>VitamMetrics</em> de type BUSINESS et peut accessoirement contenir les <em>VitamMetrics</em> de types JVM et/ou REST.
Les métriques de types JVM et REST peuvent être activées/désactivées depuis le fichier de conf (Cf. Configuration).</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">clearAndconfigureMetrics</span><span class="p">()</span>
</pre></div>
</div>
<p>Cette fonction permet de vider et de recharger les métriques à chaque création d’une application VITAM.
Les <cite>reporters</cite> de métriques (elasticsearch ou logback) sont démarrés lors du démarrage d’un serveur VITAM.</p>
<p>La fonction suivante de la classe <em>CommonBusinessApplication</em> quant à elle s’occupe du démarrage des reporters:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">startMetrics</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les <em>VitamMetrics</em> de type REST ou JVM n’ont pas à être modifiés pendant l’execution d’une application VITAM.</p>
</div>
<div class="section" id="metriques-metier">
<h3>3.12.2.1. Métriques métier<a class="headerlink" href="#metriques-metier" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les métriques métiers permettent aux développeurs d’enregistrer des métriques n’importe où dans le code, pour par exemple suivre une variable ou bien chronométrer une fonction. Pour cela il suffit d’appeler la fonction statique <em>getBusinessMetricRegistry</em> dans la classe <em>CommonBusinessApplication</em>, puis d’enregistrer une métrique.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">CommonBusinessApplication</span><span class="p">.</span><span class="na">getBusinessMetricsRegistry</span><span class="p">().</span><span class="na">register</span><span class="p">(</span><span class="s">&quot;Running workflows&quot;</span><span class="p">,</span>
    <span class="k">new</span> <span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">getValue</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">runningWorkflows</span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Avec la fonction <em>register</em>, si une métrique avec un nom identique est déjà enregistrée, alors l’ancienne métrique sera ecrasée par la nouvelle avec un avertissement dans les logs. En revanche, avec les fonctions de création de métrique comme <em>timer</em>, <em>meter</em>…, une exception sera soulevée.</p>
</div>
</div>
<div class="section" id="reporters">
<h3>3.12.2.2. Reporters<a class="headerlink" href="#reporters" title="Lien permanent vers ce titre">¶</a></h3>
<p>2 reporters sont disponibles, un reporter Logback (toutes les métriques sont dumpées dans Logback) ou bien un reporter ElasticSearch (toutes les métriques sont dumpées dans la base ElasticSearch Log). Le reporter est configurable avec un interval de temps entre chaque reporting.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Les index ElasticSearch ne sont pas configurables pour les métriques. Ils se nomment respectivement :
* <code class="docutils literal notranslate"><span class="pre">metrics-vitam-rest-YYYY.MM.dd</span></code> pour les métriques REST
* <code class="docutils literal notranslate"><span class="pre">metrics-vitam-jvm-YYYY.MM.dd</span></code> pour les métriques JVM
* <code class="docutils literal notranslate"><span class="pre">metrics-vitam-business-YYYY.MM.dd</span></code> pour les métriques métier</p>
</div>
</div>
<div class="section" id="legacy">
<h3>3.12.2.3. Legacy<a class="headerlink" href="#legacy" title="Lien permanent vers ce titre">¶</a></h3>
<p>Pour celui ou celle qui souhaiterais continuer le développement du système de métriques au sein de VITAM, voici quelques points qui peuvent être intéressants à développer :</p>
<ul class="simple">
<li>Pour un reporter ElasticSearch, vérifier l’état de la connexion à chaque reporting et augmenter progressivement le temps de reporting si la base de données n’est pas accessible.</li>
<li>Permettre le chargement de reporters de manière générique, en se passant du <em>switch</em> dans <em>VitamMetrics</em> et abstraire tout ce qui concerne le reporting.</li>
</ul>
</div>
</div>
<div class="section" id="prometeus">
<h2>3.12.3. Prometeus<a class="headerlink" href="#prometeus" title="Lien permanent vers ce titre">¶</a></h2>
<p>Depuis la release R14, la solution logicielle <a class="reference internal" href="../../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> intègre <cite>Prometheus</cite>.
A la différence des reporters ci-dessus qui diffuse par un modèle <cite>push</cite>, prometheus serveur a besoin d’une API pour récupérer les métriques depuis les applications.
L’avatange du fonctionnement du <cite>Promtheus</cite> avec un modèle <cite>pull</cite> est multiple :</p>
<blockquote>
<div><ul class="simple">
<li>Faciliter de lancer la supervision sur un post de dev lors du développement de nouvelles métriques</li>
<li>L’inaccessiblé de l’API est une information important pour la supervision des composants VITAM (Composant tombé).</li>
<li>L’API peut être appelée depuis un navigateur.</li>
</ul>
</div></blockquote>
<p>Prometheus fonctionne aussi en mode <cite>push</cite> pour les traitement de type batch (Pour plus d’information voir Pushgateway).</p>
<div class="section" id="api">
<h3>3.12.3.1. API<a class="headerlink" href="#api" title="Lien permanent vers ce titre">¶</a></h3>
<p>La classe qui expose l’API est AdminStatusResource:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nd">@Path</span><span class="p">(</span><span class="s">&quot;/metrics&quot;</span><span class="p">)</span>
<span class="nd">@GET</span>
<span class="nd">@Produces</span><span class="p">(</span><span class="n">TextFormat</span><span class="p">.</span><span class="na">CONTENT_TYPE_004</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">Response</span> <span class="nf">prometheusMetrics</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="n">Response</span>
        <span class="p">.</span><span class="na">ok</span><span class="p">()</span>
        <span class="p">.</span><span class="na">type</span><span class="p">(</span><span class="n">TextFormat</span><span class="p">.</span><span class="na">CONTENT_TYPE_004</span><span class="p">)</span>
        <span class="p">.</span><span class="na">entity</span><span class="p">((</span><span class="n">StreamingOutput</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">-&gt;</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">(</span><span class="kd">final</span> <span class="n">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputStreamWriter</span><span class="p">(</span><span class="n">output</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">TextFormat</span><span class="p">.</span><span class="na">write004</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span>
                        <span class="n">CollectorRegistry</span><span class="p">.</span><span class="na">defaultRegistry</span><span class="p">.</span><span class="na">metricFamilySamples</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">})</span>
        <span class="p">.</span><span class="na">build</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">L’api ci-dessus est exposée sur l’interface d’admin uniquement (Ip admin et Port admin).</p>
</div>
</div>
<div class="section" id="configuration-du-serveur-promtheus">
<h3>3.12.3.2. Configuration du serveur promtheus<a class="headerlink" href="#configuration-du-serveur-promtheus" title="Lien permanent vers ce titre">¶</a></h3>
<p>Pour que le serveur prometheus récupère les métriques, il suffit de déclarer l’API ci-dessus dans sa configuration.
L’URL complète de cette API est <code class="docutils literal notranslate"><span class="pre">http(s)://ip-admin-composant-vitam:port-admin/admin/v1/metrics</span></code>.</p>
<p>Il est possible de configurer promtheus pour utiliser <cite>Consul</cite>.
Veillez-vous référer à la documentation officielle pour plus de détails sur la configuration d’un serveur <cite>Prometheus</cite></p>
</div>
<div class="section" id="implementation-des-metriques">
<h3>3.12.3.3. Implémentation des métriques<a class="headerlink" href="#implementation-des-metriques" title="Lien permanent vers ce titre">¶</a></h3>
<p>La solution prometheus met à disposition des libraries clientes, implémentés en différents langages, pour faciliter le développement de nouvelles métriques.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- Prometheus common --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.prometheus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>simpleclient_common<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${prometheus-version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- Prometheus the client --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.prometheus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>simpleclient<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${prometheus-version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- Prometheus hotspot JVM metrics--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.prometheus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>simpleclient_hotspot<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${prometheus-version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- Prometheus get dropwizard metrics--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.prometheus<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>simpleclient_dropwizard<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${prometheus-version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>
<div class="section" id="recuperation-des-metriques-deja-existante">
<h4>3.12.3.3.1. Récupération des métriques déjà existante<a class="headerlink" href="#recuperation-des-metriques-deja-existante" title="Lien permanent vers ce titre">¶</a></h4>
<dl class="docutils">
<dt>Dans la classe <strong>CommonBusinessApplication</strong>, les <em>VitamMetrics</em> sont enveloppées par des clients prometheus pour les exposer à son format.</dt>
<dd><ul class="first last simple">
<li>La dépendance <cite>simpleclient_dropwizard</cite> permet facilement d’envelopper les métriques dropwizard déjà existantes et de les exposer au format prometheus.</li>
<li>La dépendance <cite>simpleclient_hotspot</cite> vient avec des métriques <cite>jvm</cite> prêtes à utiliser</li>
</ul>
</dd>
</dl>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Wrap up dropwizard metrics */</span>
<span class="k">new</span> <span class="n">DropwizardExports</span><span class="p">(</span><span class="n">vitamMetrics</span><span class="p">.</span><span class="na">getRegistry</span><span class="p">()).</span><span class="na">register</span><span class="p">();</span>

<span class="cm">/* Initialize JVM prometheus metrics */</span>
<span class="n">DefaultExports</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span>
</pre></div>
</div>
<div class="section" id="developpement-de-nouvelles-metriques-prometheus">
<h5>3.12.3.3.1.1. Développement de nouvelles métriques prometheus<a class="headerlink" href="#developpement-de-nouvelles-metriques-prometheus" title="Lien permanent vers ce titre">¶</a></h5>
<p>Prometheus dispose d’une <em>CollectorRegistry</em> instanciée par défaut au démarrage d’une application. Il suffit par la suite de développer des métriques et de les enregistrer dans cette <em>CollectorRegistry.defaultRegistry</em>
Quatre type de métriques sont possible:</p>
<blockquote>
<div><ul class="simple">
<li>Counter : Les métriques dont la valeur s’incrémente uniquement dans le temps (Exemple: Nombre de requêtes sur une API donnée)</li>
<li>Gauge : Les métriques dont la valeur s’incrémente ou se décrémente dans le temps (Exemple: L’utilisation de la RAM)</li>
<li>Histogram: Permet de compter le nombre d’événements et la somme de la durée d’execution de ces événements. Des fonctions sont à appliquer sur ces métriques du côté prometheus serveur pour faire des aggregations, moyenne, quantile, …</li>
<li>Summary: A la différence de l’Histogramme, c’est l’application qui doit calculer des aggregation, moyenne, quantiles, …</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>Ce qu’il faut retenir :</dt>
<dd><ul class="first last simple">
<li>Pour chacune des types de métriques, on peut définir des <cite>label</cite>. Une métrique avec deux labels par exemple génère deux <cite>séries temporelles</cite></li>
<li>La métrique de type histogram, peut définir des buckets.</li>
<li>Le nom de toutes les nouvelles métriques prometheus ajoutées sont listées dans la classe: <strong>VitamMetricsNames</strong>,</li>
</ul>
</dd>
</dl>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Veuillez renseigner les nouvelles métriques dans la classe <strong>VitamMetricsNames</strong>
Afin de mieux développer des métriques et de respecter les bonnes pratiques, veuillez vous référer à la documentation officielle de prometheus <code class="docutils literal notranslate"><span class="pre">https://prometheus.io/docs/practices/</span></code></p>
</div>
<p>La classe liste sous forme de constantes toutes les métriques prometheus ajoutées. Voici le contenu de cette classe:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VitamMetricsNames</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="nf">VitamMetricsNames</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// This class is only for constants</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * =================================</span>
<span class="cm">     *            Common</span>
<span class="cm">     * ==================================</span>
<span class="cm">     */</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam requests size in bytes per tenant and method</span>
<span class="cm">     * Type: Summary</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;method&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_REQUESTS_SIZE_BYTES</span> <span class="o">=</span> <span class="s">&quot;vitam_requests_size_bytes&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam responses size in bytes per tenant and method</span>
<span class="cm">     * Type: Summary</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;method</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_RESPONSES_SIZE_BYTES</span> <span class="o">=</span> <span class="s">&quot;vitam_responses_size_bytes&quot;</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Vitam storage upload objects to offers size in bytes per tenant, strategy, offer_id, data_category, origin (normal, bulk, offer_sync), and per attempt</span>
<span class="cm">     * Type: Summary</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;strategy&quot;, &quot;offer_id&quot;, &quot;data_category&quot;, &quot;origin&quot;, &quot;attempt&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_STORAGE_UPLOAD_SIZE_BYTES</span> <span class="o">=</span> <span class="s">&quot;vitam_storage_upload_size_bytes&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam storage download objects from offers size in bytes per tenant, strategy, offer_id, origin of request  (normal, traceability, offer_sync) and data_category</span>
<span class="cm">     * Type: Summary</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;strategy&quot;, &quot;offer_id&quot;, &quot;origin&quot;, &quot;data_category&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_STORAGE_DOWNLOAD_SIZE_BYTES</span> <span class="o">=</span> <span class="s">&quot;vitam_storage_download_size_bytes&quot;</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Vitam alert service counter per log_level</span>
<span class="cm">     * Type: Counter</span>
<span class="cm">     * Labels: &quot;log_level&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_ALERT_COUNTER</span> <span class="o">=</span> <span class="s">&quot;vitam_alert_count&quot;</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Vitam consistency errors counter</span>
<span class="cm">     * Type: Counter</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;service&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_CONSISTENCY_ERRORS_COUNT</span> <span class="o">=</span> <span class="s">&quot;vitam_consistency_errors_count&quot;</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     * =================================</span>
<span class="cm">     *            Processing</span>
<span class="cm">     * ==================================</span>
<span class="cm">     */</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam operation count per state and status</span>
<span class="cm">     * Type: Gauge</span>
<span class="cm">     * Labels: &quot;workflow&quot;, &quot;state&quot;, &quot;status&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKFLOW_OPERATION_TOTAL</span> <span class="o">=</span> <span class="s">&quot;vitam_processing_workflow_operation_total&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Current number of worker tasks in the queue</span>
<span class="cm">     * Type: Gauge</span>
<span class="cm">     * Labels: &quot;worker_family&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKER_TASK_IN_QUEUE_TOTAL</span> <span class="o">=</span>
        <span class="s">&quot;vitam_processing_worker_task_in_queue_total&quot;</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * Current number of worker tasks instantiated by the distributor. In queue or waiting to be added to the queue</span>
<span class="cm">     * Type: Gauge</span>
<span class="cm">     * Labels: &quot;worker_family&quot;, &quot;workflow&quot;, &quot;step_name&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKER_CURRENT_TASK_TOTAL</span> <span class="o">=</span>
        <span class="s">&quot;vitam_processing_worker_current_task_total&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Current number of workers</span>
<span class="cm">     * Type : Gauge</span>
<span class="cm">     * Labels: &quot;worker_family&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKER_REGISTERED_TOTAL</span> <span class="o">=</span> <span class="s">&quot;vitam_processing_worker_registered_total&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Worker tasks execution duration. From call of worker until receiving the response. Task contains one or collection of elements to send to workers</span>
<span class="cm">     * Type: Histogram</span>
<span class="cm">     * Labels: &quot;worker_family&quot;, &quot;worker_name&quot;, &quot;workflow&quot;, &quot;step_name&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKER_TASK_EXECUTION_DURATION_SECONDS</span> <span class="o">=</span>
        <span class="s">&quot;vitam_processing_worker_task_execution_duration_seconds&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Worker tasks waiting time since task creation until task dequeue from the queue. Task contains one or collection of elements to send to workers</span>
<span class="cm">     * Type: Histogram</span>
<span class="cm">     * Labels: &quot;worker_family&quot;, &quot;workflow&quot;, &quot;step_name&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKER_TASK_IDLE_DURATION_IN_QUEUE_SECONDS</span> <span class="o">=</span>
        <span class="s">&quot;vitam_processing_worker_task_idle_duration_in_queue_seconds&quot;</span><span class="p">;</span>


    <span class="cm">/**</span>
<span class="cm">     * ProcessWorkflow step execution duration. From call of distributor until receiving the response</span>
<span class="cm">     * Type: Histogram</span>
<span class="cm">     * Labels: &quot;workflow&quot;, &quot;step_name&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_PROCESSING_WORKFLOW_STEP_EXECUTION_DURATION_SECONDS</span> <span class="o">=</span>
        <span class="s">&quot;vitam_processing_workflow_step_execution_duration_seconds&quot;</span><span class="p">;</span>


    <span class="cm">/*</span>
<span class="cm">     * =================================</span>
<span class="cm">     *            Metadata</span>
<span class="cm">     * ==================================</span>
<span class="cm">     */</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam metadata effective log shipping histogram duration metric</span>
<span class="cm">     * Type: Histogram</span>
<span class="cm">     * Labels: &quot;collection&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_METADATA_LOG_SHIPPING_DURATION</span> <span class="o">=</span> <span class="s">&quot;vitam_metadata_log_shipping_duration&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam metadata log shipping events counter for all events. Even for those with response already running</span>
<span class="cm">     * Type: Counter</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_METADATA_LOG_SHIPPING_TOTAL</span> <span class="o">=</span> <span class="s">&quot;vitam_metadata_log_shipping_total&quot;</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Vitam metadata reconstruction histogram metric</span>
<span class="cm">     * Type: Histogram</span>
<span class="cm">     * Labels: &quot;tenant&quot;, &quot;container&quot;</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">VITAM_RECONSTRUCTION_DURATION</span> <span class="o">=</span> <span class="s">&quot;vitam_reconstruction_duration&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Deux façons d’implémenter les métriques prometheus:</p>
<blockquote>
<div><ul class="simple">
<li>Soit en utilisant les classes déjà disponible. Ci-dessous des exemples de métriques développées pour le composant <cite>processing</cite></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Exemple d&#39;une gauge</span>
<span class="c1">// Il suffit partout dans le code d&#39;appeler WORKER_TASKS_IN_QUEUE.inc() et WORKER_TASKS_IN_QUEUE.dec()</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Gauge</span> <span class="n">WORKER_TASKS_IN_QUEUE</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="s">&quot;vitam_processing_worker_task_in_queue_total&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">labelNames</span><span class="p">(</span><span class="s">&quot;worker_family&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">help</span><span class="p">(</span><span class="s">&quot;Current number of worker tasks in the queue&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">register</span><span class="p">();</span>

<span class="c1">// Exemple d&#39;un Histogram</span>
<span class="c1">// Pour l&#39;histogramme on peut utiliser des buckets</span>
<span class="c1">// Pour chaque événement, si sa durée d&#39;execution est inférieure la valeur de la bucket, le compteur du nombre d&#39;événements pour cette bucket est incrémenté</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Histogram</span> <span class="n">PROCESS_WORKFLOW_STEP_EXECUTION_DURATION_HISTOGRAM</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="p">.</span><span class="na">name</span><span class="p">(</span><span class="s">&quot;vitam_processing_workflow_step_execution_duration_seconds&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">help</span><span class="p">(</span><span class="s">&quot;ProcessWorkflow step execution duration. From call of distributor until receiving the response&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">labelNames</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span> <span class="s">&quot;step_name&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="na">buckets</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">1800</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
<span class="p">.</span><span class="na">register</span><span class="p">();</span>

<span class="c1">// Exemple d&#39;utilisation d&#39;Histogram</span>
<span class="n">Histogram</span><span class="p">.</span><span class="na">Timer</span> <span class="n">timer</span> <span class="o">=</span>
        <span class="n">CommonProcessingMetrics</span><span class="p">.</span><span class="na">PROCESS_WORKFLOW_STEP_EXECUTION_DURATION_HISTOGRAM</span>
        <span class="p">.</span><span class="na">labels</span><span class="p">(</span><span class="n">workParams</span><span class="p">.</span><span class="na">getLogbookTypeProcess</span><span class="p">().</span><span class="na">name</span><span class="p">(),</span> <span class="n">step</span><span class="p">.</span><span class="na">getStepName</span><span class="p">())</span>
        <span class="p">.</span><span class="na">startTimer</span><span class="p">();</span>
<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// Process any action that we want to compute duration</span>
<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
    <span class="n">timer</span><span class="p">.</span><span class="na">observeDuration</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>Soit en étend la classe Collector</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Exemple d&#39;une métrique du composant `processing` ProcessWorkflowMetricsCollector.</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProcessWorkflowMetricsCollector</span> <span class="kd">extends</span> <span class="n">Collector</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ProcessWorkflowMetricsCollector</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessWorkflowMetricsCollector</span><span class="p">();</span>
    <span class="kd">private</span> <span class="nf">ProcessWorkflowMetricsCollector</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Private constructor for singleton</span>
        <span class="n">register</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">ProcessWorkflowMetricsCollector</span> <span class="nf">getInstance</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">MetricFamilySamples</span><span class="o">&gt;</span> <span class="nf">collect</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Collect</span>
        <span class="k">return</span> <span class="n">xxxx</span><span class="p">.</span><span class="na">collect</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="stockage.html" class="btn btn-neutral float-left" title="3.11. Common-storage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="private/_toc.html" class="btn btn-neutral float-right" title="3.13. Common-private" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>