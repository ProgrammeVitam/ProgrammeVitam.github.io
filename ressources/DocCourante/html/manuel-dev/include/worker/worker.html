

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>13.2. Worker &mdash; Documentation VITAM - Manuel de développement 2.15.1-1</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../',
              VERSION:'2.15.1-1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="13.3. Worker Client" href="worker-client.html" />
    <link rel="prev" title="13.1. Introduction" href="intro.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> VITAM - Manuel de développement
          

          
            
            <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.15.1-1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-environnement.html">Configuration de l’environnement de développement</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../access/_toc.html">1. Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../common/_toc.html">2. Common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../functional-administration/_toc.html">3. Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-demo/_toc.html">4. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-recette/_toc.html">5. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest/_toc.html">6. Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-security/_toc.html">7. Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logbook/_toc.html">8. Logbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/_toc.html">9. Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing/_toc.html">10. Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/_toc.html">11. Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../technical-administration/_toc.html">12. Technical administration</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">13. Worker</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="intro.html">13.1. Introduction</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">13.2. Worker</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#presentation">13.2.1. Présentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-server">13.2.2. Worker-server</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-core">13.2.3. Worker-core</a></li>
<li class="toctree-l4"><a class="reference internal" href="#details-des-handlers">13.2.4. Details des Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#logbook-lifecycle">13.2.5. logbook lifecycle</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">13.2.6. 4.8.1 description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">13.2.7. 4.9.1 description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">13.2.8. 4.10.1 Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">13.2.9. 4.10.2 Détail des différentes maps utilisées :</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">13.2.10. 4.10.3 exécution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#journalisation-logbook-operation-logbook-life-cycle">13.2.11. 4.10.4 journalisation : logbook operation? logbook life cycle?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id9">13.2.12. 4.10.5 modules utilisés</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">13.2.13. 4.10.6 cas d’erreur</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-common">13.2.14. Worker-common</a></li>
<li class="toctree-l4"><a class="reference internal" href="#worker-client">13.2.15. Worker-client</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="worker-client.html">13.3. Worker Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="plugin.html">13.4. Worker Plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="idempotent.html">13.5. Idempotence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/_toc.html">14. Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devstack_vm.html">Création d’une machine de dev contenant <em>Swift</em></a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Manuel de développement</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../_toc.html">Détails par composant</a> &raquo;</li>
        
          <li><a href="_toc.html">13. Worker</a> &raquo;</li>
        
      <li>13.2. Worker</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/include/worker/worker.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="worker">
<h1>13.2. Worker<a class="headerlink" href="#worker" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="presentation">
<h2>13.2.1. Présentation<a class="headerlink" href="#presentation" title="Lien permanent vers ce titre">¶</a></h2>
<div class="line-block">
<div class="line"><em>Parent package:</em> <strong>fr.gouv.vitam</strong></div>
<div class="line"><em>Package proposition:</em> <strong>fr.gouv.vitam.worker</strong></div>
</div>
<p>4 modules composent la partie worker :
- worker-common : incluant la partie common (Utilitaires…), notamment le SedaUtils.
- worker-core : contenant les différents handlers.
- worker-client : incluant le client permettant d’appeler le REST.
- worker-server : incluant la partie REST.</p>
</div>
<div class="section" id="worker-server">
<h2>13.2.2. Worker-server<a class="headerlink" href="#worker-server" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="rest-api">
<h3>13.2.2.1. Rest API<a class="headerlink" href="#rest-api" title="Lien permanent vers ce titre">¶</a></h3>
<p>Pour l’instant les uri suivantes sont déclarées :</p>
<div class="line-block">
<div class="line"><a class="reference external" href="http://server/worker/v1">http://server/worker/v1</a></div>
<div class="line">POST /tasks -&gt; <strong>POST Permet de lancer une étape à exécuter</strong></div>
</div>
</div>
<div class="section" id="registration">
<h3>13.2.2.2. Registration<a class="headerlink" href="#registration" title="Lien permanent vers ce titre">¶</a></h3>
<p>Une partie registration permet de gérer la registration du Worker.</p>
<p>La gestion de l’abonnement du <em>worker</em> auprès du serveur <em>processing</em> se fait à l’aide d’un ServletContextListener : <em>fr.gouv.vitam.worker.server.registration.WorkerRegistrationListener</em>.</p>
<p>Le WorkerRegistrationListener va lancer l’enregistrement du <em>worker</em> au démarrage du serveur worker, dans un autre Thread utilisant l’instance <em>Runnable</em> : <em>fr.gouv.vitam.worker.server.registration.WorkerRegister</em>.</p>
<p>L’execution du <em>WorkerRegister</em> essaie d’enregistrer le <em>worker</em> suivant un retry paramétrable dans la configuration du serveur avec :</p>
<ul class="simple">
<li>un délai (registerDelay en secondes)</li>
<li>un nombre d’essai (registerTry)</li>
</ul>
<p>Le lancement du serveur est indépendant de l’enregistrement du <em>worker</em> auprès du <em>processing</em> : le serveur <em>worker</em> ne s’arrêtera pas si l’enregistrement n’a pas réussi.</p>
</div>
<div class="section" id="configuration-de-worker">
<h3>13.2.2.3. Configuration de worker<a class="headerlink" href="#configuration-de-worker" title="Lien permanent vers ce titre">¶</a></h3>
<p>Cela présente la configuration pour un worker quand il est déployé. Deux paramètres importants quand le worker fonctionne en mode parallèle.</p>
<blockquote>
<div><ul>
<li><p class="first">WorkerCapacity :</p>
<blockquote>
<div><p>Cela présente la capacité d’un worker qui réponds au demande de parallélisation de la distribution de tâches du workflow.
Il est précisé par le paramètre capacity dans le WorkerConfiguration.</p>
</div></blockquote>
</li>
<li><p class="first">WorkerFamily :</p>
</li>
</ul>
<p>Chaque worker est configuré pour traiter groupe de tâches corresponsant à ses fonctions et on cela permetre de définir les familles de worker.
Il est précisé par workerFamily dans le WorkerConfigration.</p>
</div></blockquote>
</div>
<div class="section" id="workerbean">
<h3>13.2.2.4. WorkerBean<a class="headerlink" href="#workerbean" title="Lien permanent vers ce titre">¶</a></h3>
<p>présente l’information complète sur un worker pour la procédure d’enregistrement d’un worker. Il contient les information sur le nom,
la famille et la capacité … d’un worker et présente en mode json. Voici un example :</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;workername&quot;</span><span class="p">,</span> <span class="nt">&quot;family&quot;</span> <span class="p">:</span> <span class="s2">&quot;DefaultWorker&quot;</span><span class="p">,</span> <span class="nt">&quot;capacity&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nt">&quot;storage&quot;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
<span class="nt">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;Active&quot;</span><span class="p">,</span> <span class="nt">&quot;configuration&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="nt">&quot;serverHost&quot;</span> <span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="nt">&quot;serverPort&quot;</span> <span class="p">:</span> <span class="mi">12345</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="persistence-des-workers">
<h3>13.2.2.5. Persistence des workers<a class="headerlink" href="#persistence-des-workers" title="Lien permanent vers ce titre">¶</a></h3>
<blockquote>
<div>La lise de workers est persistée dans une base de données. Pour le moment, la base est un fichier de données qui contient une tableau de
workers en format ArrayNode et chaque worker est une élément JsonNode. Exemple ci-dessous est des données d’une liste de workers</div></blockquote>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span><span class="nt">&quot;workerId&quot;</span><span class="p">:</span> <span class="s2">&quot;workerId1&quot;</span><span class="p">,</span> <span class="nt">&quot;workerinfo&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;workername&quot;</span><span class="p">,</span> <span class="nt">&quot;family&quot;</span> <span class="p">:</span> <span class="s2">&quot;DefaultWorker&quot;</span><span class="p">,</span> <span class="nt">&quot;capacity&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nt">&quot;storage&quot;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
  <span class="nt">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;Active&quot;</span><span class="p">,</span> <span class="nt">&quot;configuration&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="nt">&quot;serverHost&quot;</span> <span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="nt">&quot;serverPort&quot;</span> <span class="p">:</span> <span class="mi">12345</span> <span class="p">}}},</span>
  <span class="p">{</span><span class="nt">&quot;workerId&quot;</span><span class="p">:</span> <span class="s2">&quot;workerId2&quot;</span><span class="p">,</span> <span class="nt">&quot;workerinfo&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;workername2&quot;</span><span class="p">,</span> <span class="nt">&quot;family&quot;</span> <span class="p">:</span> <span class="s2">&quot;BigWorker&quot;</span><span class="p">,</span> <span class="nt">&quot;capacity&quot;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nt">&quot;storage&quot;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
  <span class="nt">&quot;status&quot;</span> <span class="p">:</span> <span class="s2">&quot;Active&quot;</span><span class="p">,</span> <span class="nt">&quot;configuration&quot;</span> <span class="p">:</span> <span class="p">{</span><span class="nt">&quot;serverHost&quot;</span> <span class="p">:</span> <span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="nt">&quot;serverPort&quot;</span> <span class="p">:</span> <span class="mi">54321</span> <span class="p">}</span> <span class="p">}}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Le fichier nommé «&nbsp;worker.db&nbsp;» qui sera créé dans le répertoire <code class="docutils literal notranslate"><span class="pre">/vitam/data/processing</span></code>.</p>
<p>Chaque worker est identifié par workerId et l’information générale du champs workerInfo. L’ensemble des actions suivantes sont traitées :</p>
<ul class="simple">
<li>Lors du redémarrage du distributor, il recharge la liste des workers enregistrés. Ensuite, il vérifie le status de chaque worker de la liste,</li>
</ul>
<p>(serverPort:serverHost) en utilisant le WorkerClient. Si le worker qui n’est pas disponible, il sera supprimé de la liste des workers enregistrés et la base sera mise à jour.</p>
<ul class="simple">
<li>Lors de l’enregistrement/désenregistrement, la liste des workers enregistrés sera mis à jour (ajout/supression d’un worker).</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">checkStatusWorker</span><span class="p">(</span><span class="n">String</span> <span class="n">serverHost</span><span class="p">,</span> <span class="kt">int</span> <span class="n">serverPort</span><span class="p">)</span> <span class="c1">// vérifier le statut d&#39;un worker</span>
<span class="n">marshallToDB</span><span class="p">()</span>   <span class="c1">// mise à jour la base de la liste des workers enregistrés</span>
</pre></div>
</div>
</div>
<div class="section" id="desenregistrement-d-un-worker">
<h3>13.2.2.6. Désenregistrement d’un worker<a class="headerlink" href="#desenregistrement-d-un-worker" title="Lien permanent vers ce titre">¶</a></h3>
<p>Lorsque le worker s’arrête ou se plante, ce worker doit être désenregistré.</p>
<ul class="simple">
<li>Si le worker s’arrête, la demande de désenregistrement sera lancé pour le contexte «&nbsp;contextDestroyed&nbsp;» de la WorkerRegistrationListener  (implémenté de ServletContextListener) en utilisant le ProcessingManagementClient pour appeler le service de desenregistrement de distributeur.</li>
<li>Si le worker se plante, il ne réponse plus aux requêtes de WorkerClient dans la «&nbsp;run()&nbsp;» WorkerThread et dans le catch() des exceptions de de traitement,</li>
</ul>
<p>une demande de désenregistrement doit être appelé dans cette boucle.</p>
<ul class="simple">
<li>le distributeur essaie de faire une vérification de status de workers en appelant checkStatusWorker() en plusieurs fois définit dans GlobalDataRest.STATUS_CHECK_RETRY).</li>
<li>si après l’étape 1 le statut de worker est toujours indisponible, le distributeur va appeler la procédure de désenregistrement de ce worker de la liste de worker enregistrés.</li>
</ul>
</div>
</div>
<div class="section" id="worker-core">
<h2>13.2.3. Worker-core<a class="headerlink" href="#worker-core" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans la partie Core, sont présents les différents Handlers nécessaires pour exécuter les différentes actions.</p>
<ul class="simple">
<li>CheckConformityActionHandler</li>
<li>CheckObjectsNumberActionHandler</li>
<li>CheckObjectUnitConsistencyActionHandler</li>
<li>CheckSedaActionHandler</li>
<li>CheckStorageAvailabilityActionHandler</li>
<li>CheckVersionActionHandler</li>
<li>ExtractSedaActionHandler</li>
<li>CheckIngestContractActionHandler</li>
<li>IndexObjectGroupActionHandler</li>
<li>IndexUnitActionHandler</li>
<li>StoreObjectGroupActionHandler</li>
<li>FormatIdentificationActionHandler</li>
<li>AccessionRegisterActionHandler</li>
<li>TransferNotificationActionHandler</li>
<li>UnitsRulesCompteHandler</li>
<li>DummyHandler</li>
</ul>
<p>Plugins Worker : les plugins proposent des actions comme les Handler. Quand le service worker démarré, les plugins et leur fichier properties
sont chargés. Les actions sont cherché d’abord dans le plugin pour le traitement, si l’action ne trouve pas dans plugin, il sera appelé dans
le Handler correspondant.</p>
<ul class="simple">
<li>CheckConfirmityActionPlugin : pour la vérification de la conformité de document</li>
<li>FormatIdentificationActionPlugin : pour le vérification de formats de fichiers</li>
<li>StoreObjectGroupActionPlugin : pour le storage des groupes d’objets</li>
<li>UnitsRulesComputeActionPlugin :  pour la gestion de règles de gestion</li>
<li>IndexUnitActionPlugin : pour indexer des unités archivistes</li>
<li>IndexObjectGroupActionPlugin : pour indexer des groupes d’objets</li>
<li>ArchiveUnitRulesUpdateActionPlugin : mise à jour des unités archivisitiques</li>
<li>RunningIngestsUpdateActionPlugin : mise à jour des ingests en cours</li>
</ul>
<p>La classe WorkerImpl permet de lancer ces différents handlers.</p>
<div class="section" id="focus-sur-la-gestion-des-entrees-sorties-des-handlers">
<h3>13.2.3.1. Focus sur la gestion des entrées / sorties  des Handlers<a class="headerlink" href="#focus-sur-la-gestion-des-entrees-sorties-des-handlers" title="Lien permanent vers ce titre">¶</a></h3>
<p>Chaque Handler a un constructeur sans argument et est lancé avec la commande :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">CompositeItemStatus</span> <span class="nf">execute</span><span class="p">(</span><span class="n">WorkerParameters</span> <span class="n">params</span><span class="p">,</span> <span class="n">HandlerIO</span> <span class="n">ioParam</span><span class="p">).</span>
<span class="p">..</span>
</pre></div>
</div>
<p>Le HandlerIO a pour charge d’assurer la liaison avec le Workspace et la mémoire entre tous les handlers d’un step.</p>
<p>La structuration du HandlerIO est la suivante :</p>
<ul>
<li><p class="first">des paramètres d’entrées (in) :</p>
<blockquote>
<div><ul>
<li><p class="first">un nom (name) utilisé pour référencer cet élément entre différents handlers d’une même étape</p>
</li>
<li><p class="first">une cible (uri) comportant un schema (WORKSPACE, MEMORY, VALUE) et un path :</p>
<blockquote>
<div><ul class="simple">
<li>WORKSPACE:path indique le chemin relatif sur le workspace</li>
<li>MEMORY:path indique le nom de la clef de valeur</li>
<li>VALUE:path indique la valeur statique en entrée</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">chaque handler peut accéder à ces valeurs, définies dans l’ordre stricte, via le handlerIO</p>
<blockquote>
<div><ul class="simple">
<li>WORKSPACE : implicitement un File</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getInput</span><span class="p">(</span><span class="n">rank</span><span class="p">);</span>
<span class="p">..</span>


    <span class="o">-</span> <span class="n">MEMORY</span> <span class="p">:</span> <span class="n">implicitement</span> <span class="n">un</span> <span class="n">objet</span> <span class="n">mémoire</span> <span class="n">déjà</span> <span class="n">alloué</span> <span class="n">par</span> <span class="n">un</span> <span class="n">Handler</span> <span class="n">précédent</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Object could be whatever, Map, List, JsonNode or even File</span>
<span class="n">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getInput</span><span class="p">(</span><span class="n">rank</span><span class="p">);</span>
<span class="p">..</span>

    <span class="o">-</span> <span class="n">VALUE</span> <span class="p">:</span> <span class="n">implicitement</span> <span class="n">une</span> <span class="n">valeur</span> <span class="n">String</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">string</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getInput</span><span class="p">(</span><span class="n">rank</span><span class="p">);</span>
<span class="p">..</span>
</pre></div>
</div>
<ul>
<li><p class="first">des paramètres d’entrées (out) :</p>
<blockquote>
<div><ul>
<li><p class="first">un nom (name) utilisé pour référencer cet élément entre différents handlers d’une même étape</p>
</li>
<li><p class="first">une cible (uri) comportant un schema (WORKSPACE, MEMORY) et un path :</p>
<blockquote>
<div><ul class="simple">
<li>WORKSPACE:path indique le chemin relatif sur le workspace</li>
<li>MEMORY:path indique le nom de la clef de valeur</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">chaque handler peut stocker les valeurs finales, définies dans l’ordre stricte, via le handlerIO</p>
<blockquote>
<div><ul class="simple">
<li>WORKSPACE : implicitement un File local</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// To get the filename as specified by the workflow</span>
<span class="n">ProcessingUri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getOutput</span><span class="p">(</span><span class="n">rank</span><span class="p">);</span>
<span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">uri</span><span class="p">.</span><span class="na">getPath</span><span class="p">();</span>
<span class="c1">// Write your own file</span>
<span class="n">File</span> <span class="n">newFile</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getNewLocalFile</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="c1">// write it</span>
<span class="p">...</span>
<span class="c1">// Now give it back to handlerIO as ouput result,</span>
<span class="c1">// specifying if you want to delete it right after or not</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">newFile</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
<span class="c1">// or let the handlerIO delete it later on</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">newFile</span><span class="p">);</span>
<span class="p">..</span>

    <span class="o">-</span> <span class="n">MEMORY</span> <span class="p">:</span> <span class="n">implicitement</span> <span class="n">un</span> <span class="n">objet</span> <span class="n">mémoire</span>
</pre></div>
</div>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create your own Object</span>
<span class="n">MyClass</span> <span class="n">object</span> <span class="o">=</span> <span class="p">...</span>
<span class="c1">// Now give it back to handlerIO as ouput result</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
<span class="p">..</span>
</pre></div>
</div>
<p>Afin de vérifier la cohérence entre ce qu’attend le Handler et ce que contient le HandlerIO, la méthode suivante est à réaliser :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">clasz</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="c1">// add in order the Class type of each Input argument</span>
<span class="n">clasz</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="n">clasz</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="c1">// Then check the conformity passing the number of output parameters too</span>
<span class="kt">boolean</span> <span class="n">check</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">checkHandlerIO</span><span class="p">(</span><span class="n">outputNumber</span><span class="p">,</span> <span class="n">clasz</span><span class="p">);</span>
<span class="c1">// According to the check boolean, continue or raise an error</span>
<span class="p">..</span>
</pre></div>
</div>
</div>
<div class="section" id="cas-particulier-des-tests-unitaires">
<h3>13.2.3.2. Cas particulier des Tests unitaires<a class="headerlink" href="#cas-particulier-des-tests-unitaires" title="Lien permanent vers ce titre">¶</a></h3>
<p>Afin d’avoir un handlerIO correctement initialisé, il faut redéfinir le handlerIO manuellement comme l’attend le handler :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// In a common part (@Before for instance)</span>
<span class="n">HandlerIO</span> <span class="n">handlerIO</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HandlerIO</span><span class="p">(</span><span class="s">&quot;containerName&quot;</span><span class="p">,</span> <span class="s">&quot;workerid&quot;</span><span class="p">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">IOParameter</span><span class="o">&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;UnitsLevel/ingestLevelStack.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/DATA_OBJECT_TO_OBJECT_GROUP_ID_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/DATA_OBJECT_ID_TO_GUID_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/OBJECT_GROUP_ID_TO_GUID_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/OG_TO_ARCHIVE_ID_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/DATA_OBJECT_ID_TO_DATA_OBJECT_DETAIL_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;Maps/ARCHIVE_ID_TO_GUID_MAP.json&quot;</span><span class="p">)));</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;ATR/globalSEDAParameters.json&quot;</span><span class="p">)));</span>
<span class="c1">// Dans un bloc @After, afin de nettoyer les dossiers</span>
<span class="nd">@After</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">aftertest</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">handlerIO</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// Pour chaque test</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">handlerIO</span><span class="p">.</span><span class="na">addOutIOParameters</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Si nécessaire et si compatible, il est possible de passer par un mode MEMORY pour les paramètres «&nbsp;in&nbsp;» :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// In a common part (@Before for instance)</span>
<span class="n">HandlerIO</span> <span class="n">handlerIO</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HandlerIO</span><span class="p">(</span><span class="s">&quot;containerName&quot;</span><span class="p">,</span> <span class="s">&quot;workerid&quot;</span><span class="p">);</span>
<span class="c1">// Declare the signature in but instead of using WORKSPACE, use MEMORY</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">IOParameter</span><span class="o">&gt;</span> <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">in</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">MEMORY</span><span class="p">,</span> <span class="s">&quot;file1&quot;</span><span class="p">)));</span>
<span class="n">in</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">MEMORY</span><span class="p">,</span> <span class="s">&quot;file2&quot;</span><span class="p">)));</span>
<span class="n">in</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">MEMORY</span><span class="p">,</span> <span class="s">&quot;file3&quot;</span><span class="p">)));</span>
<span class="n">in</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">MEMORY</span><span class="p">,</span> <span class="s">&quot;file4&quot;</span><span class="p">)));</span>
<span class="c1">// Dans un bloc @After, afin de nettoyer les dossiers</span>
<span class="nd">@After</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">aftertest</span><span class="p">()</span> <span class="p">{</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// Pour chaque test</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="p">()</span> <span class="p">{</span>
<span class="c1">// Use it first as Out parameters</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOutIOParameters</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<span class="c1">// Initialize the real value in MEMORY using those out parameters from Resource Files</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PropertiesUtils</span><span class="p">.</span><span class="na">getResourceFile</span><span class="p">(</span><span class="n">ARCHIVE_ID_TO_GUID_MAP</span><span class="p">));</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">PropertiesUtils</span><span class="p">.</span><span class="na">getResourceFile</span><span class="p">(</span><span class="n">OBJECT_GROUP_ID_TO_GUID_MAP</span><span class="p">));</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">PropertiesUtils</span><span class="p">.</span><span class="na">getResourceFile</span><span class="p">(</span><span class="n">DO_TO_DO_INFO_MAP</span><span class="p">));</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOuputResult</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">PropertiesUtils</span><span class="p">.</span><span class="na">getResourceFile</span><span class="p">(</span><span class="n">ATR_GLOBAL_SEDA_PARAMETERS</span><span class="p">));</span>
<span class="c1">// Reset the handlerIo in order to remove all In and Out parameters</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">reset</span><span class="p">();</span>
<span class="c1">// And now declares the In parameter list, that will use the MEMORY default values</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addInIOParameters</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
<span class="c1">// If necessary, delcares real OUT parameters too there</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">IOParameter</span><span class="o">&gt;</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">out</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span> <span class="n">IOParameter</span><span class="p">().</span><span class="na">setUri</span><span class="p">(</span><span class="k">new</span> <span class="n">ProcessingUri</span><span class="p">(</span><span class="n">UriPrefix</span><span class="p">.</span><span class="na">WORKSPACE</span><span class="p">,</span> <span class="s">&quot;file5&quot;</span><span class="p">)));</span>
<span class="n">handlerIO</span><span class="p">.</span><span class="na">addOutIOParameters</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
<span class="c1">// Now handler will have access to in parameter as File as if they were coming from Workspace</span>
</pre></div>
</div>
</div>
<div class="section" id="creation-d-un-nouveau-handler">
<h3>13.2.3.3. Création d’un nouveau handler<a class="headerlink" href="#creation-d-un-nouveau-handler" title="Lien permanent vers ce titre">¶</a></h3>
<p>La création d’un nouveaux handler doit être motivée par certaines conditions nécessaires :</p>
<ul class="simple">
<li>lorsque qu’il n’y a pas de handler qui répond au besoin</li>
<li>lorsque rajouter la fonctionnalité dans un handler existant, le surcharge et le détourne de sa fonctionalité première</li>
<li>lorsque l’on veut refactorer un handler existant pour donner des fonctionalités “un peu” plus “élémentaires”</li>
</ul>
<p>Les handlers doivent étendrent la classe ActionHandler et implémenter la méthode execute.
Lors de la création d’un nouveau handler, il faut ajouter une nouvelle instance, dans WorkerImpl.init pour enregistrer le handler dans le worker et définir le handler id.
Celui-ci sert de clé pour :</p>
<ul class="simple">
<li>les messages dans logbook (vitam-logbook-messages_fr.properties) en fonction de la criticité</li>
<li>les fichiers json de définition des workflows json (exemple : DefaultIngestWorkflow.json)</li>
</ul>
<p>cf. workflow</p>
</div>
</div>
<div class="section" id="details-des-handlers">
<h2>13.2.4. Details des Handlers<a class="headerlink" href="#details-des-handlers" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="detail-du-handler-checkconformityactionhandler">
<h3>13.2.4.1. Détail du handler : CheckConformityActionHandler<a class="headerlink" href="#detail-du-handler-checkconformityactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="description">
<h4>13.2.4.1.1. Description<a class="headerlink" href="#description" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de contrôle de l’empreinte. Il comprend désormais 2 tâches :</p>
<p>– Vérification de l’empreinte par rapport à l’empreinte indiquée dans le manifeste (en utilisant algorithme déclaré dans manifeste)
– Calcul d’une empreinte en SHA-512 si l’empreinte du manifeste est calculée avec un algorithme différent</p>
</div>
<div class="section" id="execution">
<h4>13.2.4.1.2. Exécution<a class="headerlink" href="#execution" title="Lien permanent vers ce titre">¶</a></h4>
<p>CheckConformityActionHandler recupère l’algorithme de Vitam (SHA-512) par l’input dans workflow et le fichier en InputStream par le workspace.</p>
<p>Si l’algorithme est différent que celui dans le manifest, il calcul l’empreinte de fichier en SHA-512</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>      <span class="n">DigestType</span> <span class="n">digestTypeInput</span> <span class="o">=</span> <span class="n">DigestType</span><span class="p">.</span><span class="na">fromValue</span><span class="p">((</span><span class="n">String</span><span class="p">)</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getInput</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ALGO_RANK</span><span class="p">));</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">handlerIO</span><span class="p">.</span><span class="na">getInputStreamNoCachedFromWorkspace</span><span class="p">(</span>
<span class="n">IngestWorkflowConstants</span><span class="p">.</span><span class="na">SEDA_FOLDER</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">binaryObject</span><span class="p">.</span><span class="na">getUri</span><span class="p">());</span>
<span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="p">(</span><span class="n">InputStream</span><span class="p">)</span> <span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">();</span>
<span class="kd">final</span> <span class="n">Digest</span> <span class="n">vitamDigest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Digest</span><span class="p">(</span><span class="n">digestTypeInput</span><span class="p">);</span>
<span class="n">Digest</span> <span class="n">manifestDigest</span><span class="p">;</span>
<span class="kt">boolean</span> <span class="n">isVitamDigest</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">binaryObject</span><span class="p">.</span><span class="na">getAlgo</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">digestTypeInput</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">manifestDigest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Digest</span><span class="p">(</span><span class="n">binaryObject</span><span class="p">.</span><span class="na">getAlgo</span><span class="p">());</span>
    <span class="n">inputStream</span> <span class="o">=</span> <span class="n">manifestDigest</span><span class="p">.</span><span class="na">getDigestInputStream</span><span class="p">(</span><span class="n">inputStream</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">manifestDigest</span> <span class="o">=</span> <span class="n">vitamDigest</span><span class="p">;</span>
    <span class="n">isVitamDigest</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">......................</span>
</pre></div>
</div>
<p>Si les empreintes sont différents, c’est le cas KO.
Le message { «&nbsp;MessageDigest&nbsp;»: «&nbsp;value&nbsp;», «&nbsp;Algorithm&nbsp;»: «&nbsp;algo&nbsp;», «&nbsp;ComputedMessageDigest&nbsp;»: «&nbsp;value&nbsp;»} va être stocké dans le journal
Sinon le message { «&nbsp;MessageDigest&nbsp;»: «&nbsp;value&nbsp;», «&nbsp;Algorithm&nbsp;»: «&nbsp;algo&nbsp;», «&nbsp;SystemMessageDigest&nbsp;»: «&nbsp;value&nbsp;», «&nbsp;SystemAlgorithm&nbsp;»: «&nbsp;algo&nbsp;»} va être stocké dans le journal
Mais il y a encore deux cas à ce moment:</p>
<blockquote>
<div>si l’empreinte est avec l’algorithme SHA-512, c’est le cas OK.
sinon, c’est le cas WARNING. le nouveau empreint et son algorithme seront mis à jour dans la collection ObjectGroup.</div></blockquote>
<p>CheckConformityActionHandler compte aussi le nombre de OK, KO et WARNING.
Si nombre de KO est plus de 0, l’action est KO.</p>
</div>
<div class="section" id="journalisation">
<h4>13.2.4.1.3. 4.1.3 journalisation<a class="headerlink" href="#journalisation" title="Lien permanent vers ce titre">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="logbook-lifecycle">
<h2>13.2.5. logbook lifecycle<a class="headerlink" href="#logbook-lifecycle" title="Lien permanent vers ce titre">¶</a></h2>
<p>CA 1 : Vérification de la conformité de l’empreinte. (empreinte en SHA-512 dans le manifeste)</p>
<p>Dans le processus d’entrée, l’étape de vérification de la conformité de l’empreinte doit être appelée en position 450.
Lorsque l’étape débute, pour chaque objet du groupe d’objet technique, une vérification d’empreinte doit être effectuée (celle de l’objet avec celle inscrite dans le manifeste SEDA). Cette étape est déjà existante actuellement.
Le calcul d’empreinte en SHA-512 (CA 2) ne doit pas s’effectuer si l’empreinte renseigné dans le manifeste a été calculé en SHA-512. C’est cette empreinte qui sera indexée dans les bases Vitam.</p>
<p>CA 1.1 : Vérification de la conformité de l’empreinte. (empreinte en SHA-512 dans le manifeste) - OK</p>
<ul class="simple">
<li>Lorsque l’action est OK, elle inscrit une ligne dans les journaux du cycle de vie des GOT :</li>
</ul>
<ul class="simple">
<li>eventType EN – FR : « Digest Check», « Vérification de l’empreinte des objets»</li>
<li>outcome : «&nbsp;OK&nbsp;»</li>
<li>outcomeDetailMessage FR : « Succès de la vérification de l’empreinte »</li>
<li>eventDetailData FR : «&nbsp;Empreinte : &lt;MessageDigest&gt;, algorithme : &lt;MessageDigest attribut algorithm&gt;&nbsp;»</li>
<li>objectIdentifierIncome : MessageIdentifier du manifest</li>
</ul>
<p>Comportement du workflow décrit dans l’US #680</p>
<ul class="simple">
<li>La collection ObjectGroup est aussi mis à jour, en particulier le champs : Message Digest : {  empreinte, algorithme utlisé }</li>
</ul>
<p>CA 1.2 : Vérification de la conformité de l’empreinte. (empreinte en SHA-512 dans le manifeste) - KO</p>
<ul class="simple">
<li>Lorsque l’action est KO, elle inscrit une ligne dans les journaux du cycle de vie des GOT :</li>
</ul>
<ul class="simple">
<li>eventType EN – FR : « Digest Check», « Vérification de l’empreinte des objets»</li>
<li>outcome : «&nbsp;KO&nbsp;»</li>
<li>outcomeDetailMessage FR : « Échec de la vérification de l’empreinte »</li>
<li>eventDetailData FR : «&nbsp;Empreinte manifeste : &lt;MessageDigest&gt;, algorithme : &lt;MessageDigest attribut algorithm&gt; Empreinte calculée : &lt;Empreinte calculée par Vitam&gt;&nbsp;»</li>
<li>objectIdentifierIncome : MessageIdentifier du manifest</li>
</ul>
<p>Comportement du workflow décrit dans l’US #680</p>
<hr class="docutils" />
<p>CA 2 : Vérification de la conformité de l’empreinte. (empreinte différent de SHA-512 dans le manifeste)</p>
<p>Si l’empreinte proposé dans le manifeste SEDA n’est pas en SHA-512, alors le système doit calculer l’empreinte en SHA-512. C’est cette empreinte qui sera indexée dans les bases Vitam.
Lorsque l’action débute, pour chaque objet du groupe d’objet technique, un calcul d’empreinte au format SHA-512 doit être effectué. Cette action intervient juste apres le check de l’empreinte dans le manifeste (mais on est toujours dans l’étape du check conformité de l’empreinte).</p>
<p>CA 2.1 : Vérification de la conformité de l’empreinte. (empreinte différent de SHA-512 dans le manifeste) - OK</p>
<ul class="simple">
<li>Lorsque l’action est OK, elle inscrit une ligne dans les journaux du cycle de vie des GOT :</li>
</ul>
<ul class="simple">
<li>eventType EN – FR : « Digest Check», « Vérification de l’empreinte des objets»</li>
<li>outcome : «&nbsp;OK&nbsp;»</li>
<li>outcomeDetailMessage FR : « Succès de la vérification de l’empreinte »</li>
<li>eventDetailData FR : «&nbsp;Empreinte Manifeste : &lt;MessageDigest&gt;, algorithme : &lt;MessageDigest attribut algorithm&gt;&nbsp;» «&nbsp;Empreinte calculée (&lt;algorithme utilisé «&nbsp;XXX&nbsp;»&gt;): &lt;Empreinte calculée par Vitam&gt;&nbsp;»</li>
<li>objectIdentifierIncome : MessageIdentifier du manifest</li>
</ul>
<div class="section" id="modules-utilises">
<h3>13.2.5.1. modules utilisés<a class="headerlink" href="#modules-utilises" title="Lien permanent vers ce titre">¶</a></h3>
<p>processing, worker, workspace et logbook</p>
<div class="section" id="cas-d-erreur">
<h4>13.2.5.1.1. cas d’erreur<a class="headerlink" href="#cas-d-erreur" title="Lien permanent vers ce titre">¶</a></h4>
<p>XMLStreamException                          : problème de lecture SEDA
InvalidParseOperationException              : problème de parsing du SEDA
LogbookClientAlreadyExistsException         : un logbook client existe dans ce workflow
LogbookClientBadRequestException            : LogbookLifeCycleObjectGroupParameters est mal paramétré et le logbook client génère une mauvaise requete
LogbookClientException                      : Erreur générique de logbook. LogbookException classe mère des autres exceptions LogbookClient
LogbookClientNotFoundException              : un logbook client n’existe pas pour ce workflow
LogbookClientServerException                : logbook server a un internal error
ProcessingException                         : erreur générique du processing
ContentAddressableStorageException          : erreur de stockage</p>
</div>
</div>
<div class="section" id="detail-du-handler-checkobjectsnumberactionhandler">
<h3>13.2.5.2. Détail du handler : CheckObjectsNumberActionHandler<a class="headerlink" href="#detail-du-handler-checkobjectsnumberactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id1">
<h4>13.2.5.2.1. description<a class="headerlink" href="#id1" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de comparer le nombre d’objet stocké sur le workspace et le nombre d’objets déclaré dans le manifest.</p>
</div>
</div>
<div class="section" id="detail-du-handler-checkobjectunitconsistencyactionhandler">
<h3>13.2.5.3. Détail du handler : CheckObjectUnitConsistencyActionHandler<a class="headerlink" href="#detail-du-handler-checkobjectunitconsistencyactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<p>Ce handler permet de contrôler la cohérence entre l’object/object group et l’ArchiveUnit.</p>
<p>Pour ce but, on détecte les groupes d’object qui ne sont pas référé par au moins d’un ArchiveUnit.
Ce tache prend deux maps de données qui ont été crée dans l’étape précédente de workflow comme input :
objectGroupIdToUnitId
objectGroupIdToGuid
Le ouput de cette contrôle est une liste de groupe d’objects invalide. Si on trouve les groupe d’objects
invalide, le logbook lifecycles de group d’object sera mis à jour.</p>
<p>L’exécution de l’algorithme est présenté dans le code suivant :*</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span> <span class="p">{</span>
  <span class="kd">final</span> <span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">objectGroup</span> <span class="o">=</span> <span class="n">it</span><span class="p">.</span><span class="na">next</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">objectGroupToUnitStoredMap</span><span class="p">.</span><span class="na">containsKey</span><span class="p">(</span><span class="n">objectGroup</span><span class="p">.</span><span class="na">getKey</span><span class="p">()))</span> <span class="p">{</span>
    <span class="n">itemStatus</span><span class="p">.</span><span class="na">increment</span><span class="p">(</span><span class="n">StatusCode</span><span class="p">.</span><span class="na">KO</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="c1">// Update logbook OG lifecycle</span>
      <span class="kd">final</span> <span class="n">LogbookLifeCycleObjectGroupParameters</span> <span class="n">logbookLifecycleObjectGroupParameters</span> <span class="o">=</span>
          <span class="n">LogbookParametersFactory</span><span class="p">.</span><span class="na">newLogbookLifeCycleObjectGroupParameters</span><span class="p">();</span>
      <span class="n">LogbookLifecycleWorkerHelper</span><span class="p">.</span><span class="na">updateLifeCycleStartStep</span><span class="p">(</span><span class="n">handlerIO</span><span class="p">.</span><span class="na">getHelper</span><span class="p">(),</span>
          <span class="n">logbookLifecycleObjectGroupParameters</span><span class="p">,</span>
          <span class="n">params</span><span class="p">,</span> <span class="n">HANDLER_ID</span><span class="p">,</span> <span class="n">LogbookTypeProcess</span><span class="p">.</span><span class="na">INGEST</span><span class="p">,</span>
          <span class="n">objectGroupToGuidStoredMap</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">objectGroup</span><span class="p">.</span><span class="na">getKey</span><span class="p">()).</span><span class="na">toString</span><span class="p">());</span>
      <span class="n">logbookLifecycleObjectGroupParameters</span><span class="p">.</span><span class="na">setFinalStatus</span><span class="p">(</span><span class="n">HANDLER_ID</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="n">StatusCode</span><span class="p">.</span><span class="na">KO</span><span class="p">,</span>
          <span class="kc">null</span><span class="p">);</span>
      <span class="n">handlerIO</span><span class="p">.</span><span class="na">getHelper</span><span class="p">().</span><span class="na">updateDelegate</span><span class="p">(</span><span class="n">logbookLifecycleObjectGroupParameters</span><span class="p">);</span>
      <span class="kd">final</span> <span class="n">String</span> <span class="n">objectID</span> <span class="o">=</span>
          <span class="n">logbookLifecycleObjectGroupParameters</span><span class="p">.</span><span class="na">getParameterValue</span><span class="p">(</span><span class="n">LogbookParameterName</span><span class="p">.</span><span class="na">objectIdentifier</span><span class="p">);</span>
      <span class="n">handlerIO</span><span class="p">.</span><span class="na">getLifecyclesClient</span><span class="p">().</span><span class="na">bulkUpdateObjectGroup</span><span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="na">getContainerName</span><span class="p">(),</span>
          <span class="n">handlerIO</span><span class="p">.</span><span class="na">getHelper</span><span class="p">().</span><span class="na">removeUpdateDelegate</span><span class="p">(</span><span class="n">objectID</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">LogbookClientBadRequestException</span> <span class="o">|</span> <span class="n">LogbookClientNotFoundException</span> <span class="o">|</span>
      <span class="n">LogbookClientServerException</span> <span class="o">|</span> <span class="n">ProcessingException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LOGGER</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">&quot;Can not update logbook lifcycle&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ogList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">objectGroup</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">itemStatus</span><span class="p">.</span><span class="na">increment</span><span class="p">(</span><span class="n">StatusCode</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>
    <span class="c1">// Update logbook OG lifecycle</span>
    <span class="p">....</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="detail-du-handler-checksedaactionhandler">
<h3>13.2.5.4. Détail du handler : CheckSedaActionHandler<a class="headerlink" href="#detail-du-handler-checksedaactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<p>Ce handler permet de valider la validité du manifest par rapport à un schéma XSD.
Il permet aussi de vérifier que les informations remplies dans ce manifest sont correctes.</p>
<ul class="simple">
<li>Le schéma de validation du manifest : src/main/resources/seda-vitam-2.0-main.xsd.</li>
</ul>
</div>
<div class="section" id="detail-du-handler-checkstorageavailabilityactionhandler">
<h3>13.2.5.5. Détail du handler : CheckStorageAvailabilityActionHandler<a class="headerlink" href="#detail-du-handler-checkstorageavailabilityactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<p>TODO</p>
</div>
<div class="section" id="detail-du-handler-checkversionactionhandler">
<h3>13.2.5.6. Détail du handler : CheckVersionActionHandler<a class="headerlink" href="#detail-du-handler-checkversionactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<p>TODO</p>
</div>
<div class="section" id="detail-du-handler-extractsedaactionhandler">
<h3>13.2.5.7. Détail du handler : ExtractSedaActionHandler<a class="headerlink" href="#detail-du-handler-extractsedaactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id2">
<h4>13.2.5.7.1. description<a class="headerlink" href="#id2" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet d’extraire le contenu du SEDA. Il y a :</p>
<ul class="simple">
<li>extraction des BinaryDataObject et PhysicalDataObject</li>
<li>extraction des ArchiveUnit</li>
<li>création des lifes cycles des units</li>
<li>construction de l’arbre des units et sauvegarde sur le workspace</li>
<li>sauvegarde de la map des units sur le workspace</li>
<li>sauvegarde de la map des objets sur le workspace</li>
<li>sauvegarde de la map des objets groupes sur le workspace</li>
</ul>
</div>
<div class="section" id="detail-des-differentes-maps-utilisees">
<h4>13.2.5.7.2. Détail des différentes maps utilisées<a class="headerlink" href="#detail-des-differentes-maps-utilisees" title="Lien permanent vers ce titre">¶</a></h4>
<p>Map&lt;String, String&gt; dataObjectIdToGuid</p>
<blockquote>
<div>contenu         : cette map contient l’id du DO relié à son guid
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors de la lecture des BinaryDataObject et PhysicalDataObject
lecture, get    : saveObjectGroupsToWorkspace, getObjectGroupQualifiers,
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, String&gt; dataObjectIdToObjectGroupId :</p>
<blockquote>
<div>contenu         : cette map contient l’id du DO relié au groupe d’objet de la balise DataObjectGroupId ou DataObjectGroupReferenceId
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors de la lecture des BinaryDataObject et PhysicalDataObject
lecture, get    : lecture de la map dans mapNewTechnicalDataObjectGroupToDO, getNewGdoIdFromGdoByUnit, completeDataObjectToObjectGroupMap, checkArchiveUnitIdReference et writeDataObjectInLocal
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, GotObj&gt; dataObjectIdWithoutObjectGroupId :</p>
<blockquote>
<div>contenu         : cette map contient l’id du DO relié à un groupe d’objet technique instanciés lors du parcours des objets.
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des DO dans mapNewTechnicalDataObjectGroupToDO et extractArchiveUnitToLocalFile. Dans extractArchiveUnitToLocalFile, quand on découvre un DataObjectReferenceId et que cet Id se trouve dans dataObjectIdWithoutObjectGroupId alors on récupère l’objet et on change le statut isVisited à true.
lecture, get    : lecture de la map dans mapNewTechnicalDataObjectGroupToDO, extractArchiveUnitToLocalFile, getNewGdoIdFromGdoByUnit,
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Le groupe d’objet technique GotObj contient un guid et un boolean isVisited, initialisé à false lors de la création. Le set à true est fait lors du parcours des units.</p>
<p>Map&lt;String, String&gt; objectGroupIdToGuid</p>
<blockquote>
<div>contenu         : cette map contient l’id du groupe d’objet relié à son guid
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des DO dans writeDataObjectInLocal et mapNewTechnicalDataObjectGroupToDO lors de la création du groupe d’objet technique
lecture, get    : lecture de la map dans checkArchiveUnitIdReference, writeDataObjectInLocal, extractArchiveUnitToLocalFile, saveObjectGroupsToWorkspace
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, String&gt; objectGroupIdToGuidTmp</p>
<blockquote>
<div>contenu         : c’est la même map que objectGroupIdToGuid
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée dans writeDataObjectInLocal
lecture, get    : lecture de la map dans writeDataObjectInLocal
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, List&lt;String&gt;&gt; objectGroupIdToDataObjectId</p>
<blockquote>
<div>contenu         : cette map contient l’id du groupe d’objet relié à son ou ses DO
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des DO dans writeDataObjectInLocal quand il y a une balise DataObjectGroupId ou DataObjectGroupReferenceId et qu’il n’existe pas dans objectGroupIdToDataObjectId.
lecture, get    : lecture de la map dans le parcours des DO dans writeDataObjectInLocal.  La lecture est faite pour ajouter des DO dans la liste.
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, List&lt;String&gt;&gt; objectGroupIdToUnitId</p>
<blockquote>
<div>contenu         : cette map contient l’id du groupe d’objet relié à ses AU
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des units dans extractArchiveUnitToLocalFile quand il y a une balise DataObjectGroupId ou DataObjectGroupReferenceId et qu’il nexiste pas dans objectGroupIdToUnitId sinon on ajoute dans la liste des units de la liste
lecture, get    : lecture de la map dans le parcours des units. La lecture est faite pour ajouter des units dans la liste.
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, DataObjectInfo&gt; objectGuidToDataObject</p>
<blockquote>
<div>contenu         : cette map contient le guid du data object et DataObjectInfo
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populer lors de l’extraction des infos du data object vers le workspace
lecture, get    : elle permet de récupérer les infos binary data object pour sauver l’object group sur le worskapce
supression      : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, String&gt; unitIdToGuid</p>
<blockquote>
<div>contenu         : cette map contient l’id de l’unit relié à son guid
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des units dans extractArchiveUnitToLocalFile
lecture, get    : lecture de la map se fait lors de la création du graph/level des unit dans createIngestLevelStackFile et dans la sauvegarde des object groups vers le workspace
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, String&gt; unitIdToGroupId</p>
<blockquote>
<div>contenu         : cette map contient l’id de l’unit relié à son group id
création        : elle est créé lors de la création du handler
MAJ, put        : elle est populée lors du parcours des DO dans writeDataObjectInLocal quand il y a une balise DataObjectGroupId ou DataObjectGroupReferenceId
lecture, get    : lecture de la map se fait lors de l’extraction des unit dans extractArchiveUnitToLocalFile et permettant de lire dans objectGroupIdToGuid.
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>Map&lt;String, String&gt; objectGuidToUri</p>
<blockquote>
<div>contenu         : cette map contient le guid du BDO relié à son uri définis dans le manifest
création        : elle est créé lors de la création du handler
MAJ, put        : elle est poppulée lors du parcours des DO dans writeDataObjectInLocal quand il rencontre la balise uri
lecture, get    : lecture de la map se fait lors du save des objects groups dans le workspace
suppression     : c’est un clean en fin d’execution du handler</div></blockquote>
<p>sauvegarde des maps (dataObjectIdToObjectGroupId, objectGroupIdToGuid) dans le workspace</p>
</div>
<div class="section" id="verifier-les-archiveunit-du-sip">
<h4>13.2.5.7.3. Vérifier les ArchiveUnit du SIP<a class="headerlink" href="#verifier-les-archiveunit-du-sip" title="Lien permanent vers ce titre">¶</a></h4>
<p>Dans les cas où le SIP contient un objet numérique référencé par un groupe d’objet et qu’une unité archiviste
référence cet objet directement (au lieu de déclarer le GOT), le résultat attendu est un statut KO au niveau de
l’étape STP_INGEST_CONTROL_SIP dans l’action CHECK_MANIFEST. Ce contrôle est effectué dans la fonction
checkArchiveUnitIdReference de ExtractSedaHandler.</p>
<p>Pour ce cas, le map unitIdToGroupId contient une référence entre un unitId et groupId et ce groupId est l’id de l’objet numérique.
Dans le objectGroupIdToGuid, il n’existe pas de lien entre id de groupe d’objet et son guid (parce que c’est un id d’object
numérique).</p>
<p>On vérifie la valeur des groupIds récupérés dans dataObjectIdToObjectGroupId et unitIdToGroupId. Si ils sont différents,
il s’agit du cas abordé ci-dessus, sinon c’est celui des objects numériques sans groupe d’objet technique. Enfin, l’exception
ArchiveUnitContainDataObjectException est déclenchée pour ExtractSeda et dans cette étape, le status KO est mise à jour
pour l’exécution de l’étape.</p>
<p>L’exécution de l’algorithme est présenté dans le preudo-code ci-dessous:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Si (map unitIdToGroupId contient des valeurs)
  Pour (chaque élement ELEM du map unitIdToGroupId)
    Si (la valeur guid de groupe d&#39;object dans objectGroupIdToGuid associé à ELEM) // archiveUnit reference par DO
      Prendre (la valeur groupId dans le maps dataObjectIdToObjectGroupId associé à groupId d&#39;ELEM)
      Si (cette groupId est NULLE) // ArchiveUnit réferencé DO mais il n&#39;existe pas un lien DO à groupe d&#39;objet
        Délencher (exception ProcessingException)
      Autrement
        Si (cette groupId est différente grouId associé à ELEM)
          Délencher (exception ArchiveUnitContainDataObjectException)
        Fin Si
      Fin Si
    Fin Si
  Fin Pour
Fin Si
</pre></div>
</div>
</div>
<div class="section" id="details-du-data-dans-l-itemstatus-retourne">
<h4>13.2.5.7.4. Détails du data dans l’itemStatus retourné<a class="headerlink" href="#details-du-data-dans-l-itemstatus-retourne" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le itemStatus est mis à jour avec les objets du manifest.xml remontées pour mettre à jour evDetData.
Il contient dans data le json de evDetData en tant que String.
Les champs récupérés (s’ils existent dans le manifest) sont «&nbsp;evDetailReq&nbsp;», «&nbsp;evDateTimeReq&nbsp;», «&nbsp;ArchivalAgreement&nbsp;», «&nbsp;agIfTrans&nbsp;», «&nbsp;ServiceLevel&nbsp;».</p>
</div>
</div>
<div class="section" id="detail-du-handler-indexobjectgroupactionhandler">
<h3>13.2.5.8. Détail du handler : IndexObjectGroupActionHandler<a class="headerlink" href="#detail-du-handler-indexobjectgroupactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id3">
<h4>13.2.5.8.1. 4.7.1 description<a class="headerlink" href="#id3" title="Lien permanent vers ce titre">¶</a></h4>
<p>Indexation des objets groupes en récupérant les objets groupes du workspace. Il y a utilisation d’un client metadata.</p>
</div>
</div>
<div class="section" id="detail-du-handler-indexunitactionhandler">
<h3>13.2.5.9. 4.8 Détail du handler : IndexUnitActionHandler<a class="headerlink" href="#detail-du-handler-indexunitactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
</div>
</div>
<div class="section" id="id4">
<h2>13.2.6. 4.8.1 description<a class="headerlink" href="#id4" title="Lien permanent vers ce titre">¶</a></h2>
<p>Indexation des units en récupérant les units du workspace. Il y a utilisation d’un client metadata.</p>
<div class="section" id="detail-du-handler-storeobjectgroupactionhandler">
<h3>13.2.6.1. 4.9 Détail du handler : StoreObjectGroupActionHandler<a class="headerlink" href="#detail-du-handler-storeobjectgroupactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
</div>
</div>
<div class="section" id="id5">
<h2>13.2.7. 4.9.1 description<a class="headerlink" href="#id5" title="Lien permanent vers ce titre">¶</a></h2>
<p>Persistence des objets dans l’offre de stockage depuis le workspace.</p>
<div class="section" id="detail-du-handler-formatidentificationactionhandler">
<h3>13.2.7.1. 4.10 Détail du handler : FormatIdentificationActionHandler<a class="headerlink" href="#detail-du-handler-formatidentificationactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
</div>
</div>
<div class="section" id="id6">
<h2>13.2.8. 4.10.1 Description<a class="headerlink" href="#id6" title="Lien permanent vers ce titre">¶</a></h2>
<p>Ce handler permet d’identifier et contrôler automatiquement le format des objets versés.
Il s’exécute sur les différents ObjectGroups déclarés dans le manifest. Pour chaque objectGroup, voici ce qui est effectué :</p>
<ul class="simple">
<li>récupération du JSON de l’objectGroup présent sur le Workspace</li>
<li>transformation de ce Json en une map d’id d’objets / uri de l’objet associée</li>
<li>boucle sur les objets :</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>téléchargement de l’objet (File) depuis le Workspace</li>
<li>appel l’outil de vérification de format (actuellement Siegfried) en lui passant le path vers l’objet à identifier + récupération de la réponse.</li>
<li>appel de l’AdminManagement pour faire une recherche getFormats par rapport au PUID récupéré.</li>
<li>mise à jour du Json : le format récupéré par Siegfried est mis à jour dans le Json (pour indexation future).</li>
<li>construction d’une réponse.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>sauvegarde du JSON de l’objectGroup dans le Workspace.</li>
<li>aggrégation des retours pour générer un message + mise à jour du logbook.</li>
</ul>
</div>
<div class="section" id="id7">
<h2>13.2.9. 4.10.2 Détail des différentes maps utilisées :<a class="headerlink" href="#id7" title="Lien permanent vers ce titre">¶</a></h2>
<p>Map&lt;String, String&gt; objectIdToUri</p>
<blockquote>
<div>contenu         : cette map contient l’id du BDO associé à son uri.
création        : elle est créée dans le Handler après récupération du json listant les ObjectGroups
MAJ, put        : elle est populée lors de la lecture du json listant les ObjectGroups.
lecture, get    : lecture au fur et à mesure du traitement des BDO.
suppression     : elle n’est pas enregistrée sur le workspace et est présente en mémoire uniquement.</div></blockquote>
</div>
<div class="section" id="id8">
<h2>13.2.10. 4.10.3 exécution<a class="headerlink" href="#id8" title="Lien permanent vers ce titre">¶</a></h2>
<p>Ce Handler est exécuté dans l’étape «&nbsp;Contrôle et traitements des objets&nbsp;», juste après le Handler de vérification des empreintes.</p>
</div>
<div class="section" id="journalisation-logbook-operation-logbook-life-cycle">
<h2>13.2.11. 4.10.4 journalisation : logbook operation? logbook life cycle?<a class="headerlink" href="#journalisation-logbook-operation-logbook-life-cycle" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le traitement du Handler, sont mis à jour uniquement les journaux de cycle de vie des ObjectGroups.
Les Outcome pour les journaux de cycle de vie peuvent être les suivants :</p>
<ul class="simple">
<li>Le format PUID n’a pas été trouvé / ne correspond pas avec le référentiel des formats.</li>
<li>Le format du fichier n’a pas pu être trouvé.</li>
<li>Le format du fichier a été complété dans les métadonnées (un «&nbsp;diff&nbsp;» est généré et ajouté).</li>
<li>Le format est correct et correspond au référentiel des formats.</li>
</ul>
<p>(Note : les messages sont informatifs et ne correspondent aucunement à ce qui sera vraiment inséré en base)</p>
</div>
<div class="section" id="id9">
<h2>13.2.12. 4.10.5 modules utilisés<a class="headerlink" href="#id9" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le Handler utilise les modules suivants :</p>
<ul class="simple">
<li>Workspace (récupération / copie de fichiers)</li>
<li>Logbook (mise à jour des journaux de cycle de vie des ObjectGroups)</li>
<li>Common-format-identification (appel pour analyse des objets)</li>
<li>AdminManagement (comparaison format retourné par l’outil d’analyse par rapport au référentiel des formats de Vitam).</li>
</ul>
</div>
<div class="section" id="id10">
<h2>13.2.13. 4.10.6 cas d’erreur<a class="headerlink" href="#id10" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les différentes exceptions pouvant être rencontrées :</p>
<ul class="simple">
<li>ReferentialException : si un problème est rencontré lors de l’interrogation du référentiel des formats de Vitam</li>
<li>InvalidParseOperationException/InvalidCreateOperationException : si un problème est rencontré lors de la génération de la requête d’interrogation du référentiel des formats de Vitam</li>
<li>FormatIdentifier*Exception : si un problème est rencontré avec l’outil d’analyse des formats (Siegfried)</li>
<li>Logbook*Exception : si un problème est rencontré lors de l’interrogation du logbook</li>
<li>Logbook*Exception : si un problème est rencontré lors de l’interrogation du logbook</li>
<li>Content*Exception : si un problème est rencontré lors de l’interrogation du workspace</li>
<li>ProcessingException : si un problème plus général est rencontré dans le Handler</li>
</ul>
<div class="section" id="detail-du-handler-transfernotificationactionhandler">
<h3>13.2.13.1. Détail du handler : TransferNotificationActionHandler<a class="headerlink" href="#detail-du-handler-transfernotificationactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id11">
<h4>13.2.13.1.1. Description<a class="headerlink" href="#id11" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de finaliser le processus d’entrée d’un SIP. Cet Handler est un peu spécifique car il sera lancé même si une étape précédente tombe en erreur.</p>
<p>Il permet de générer un xml de notification qui sera :</p>
<ul class="simple">
<li>une notification KO si une étape du workflow est tombée en erreur.</li>
<li>une notification OK si le process est OK, et que le SIP a bien été intégré sans erreur.</li>
</ul>
<p>La première étape dans ce handler est de déterminer l’état du Workflow : OK ou KO.</p>
</div>
<div class="section" id="id12">
<h4>13.2.13.1.2. Détail des différentes maps utilisées<a class="headerlink" href="#id12" title="Lien permanent vers ce titre">¶</a></h4>
<p>Map&lt;String, Object&gt; archiveUnitSystemGuid</p>
<blockquote>
<div>contenu         : cette map contient la liste des archives units avec son identifiant tel que déclaré dans le manifest, associé à son GUID.</div></blockquote>
<p>Map&lt;String, Object&gt; dataObjectSystemGuid</p>
<blockquote>
<div>contenu         : cette map contient la liste Data Objects avec leur GUID généré associé à l’identifiant déclaré dans le manifest.</div></blockquote>
<p>Map&lt;String, Object&gt; bdoObjectGroupSystemGuid</p>
<blockquote>
<div>contenu         : cette map contient la liste groupes d’objets avec leur GUID généré associé à l’identifiant déclaré dans le manifest.</div></blockquote>
</div>
<div class="section" id="id13">
<h4>13.2.13.1.3. exécution<a class="headerlink" href="#id13" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce Handler est exécuté en dernière position. Il sera exécuté quoi qu’il se passe avant.
Même si le processus est KO avant, le Handler sera exécuté.</p>
<p><em>Cas OK :</em>
&#64;TODO&#64;</p>
<p><em>Cas KO :</em>
Pour l’opération d’ingest en cours, on va récupérer dans les logbooks plusieurs informations :</p>
<ul class="simple">
<li>récupération des logbooks operations générés par l’opération d’ingest.</li>
<li>récupération des logbooks lifecycles pour les archive units présentes dans le SIP.</li>
<li>récupération des logbooks lifecycles pour les groupes d’objets présents dans le SIP.</li>
</ul>
<p>Le Handler s’appuie sur des fichiers qui lui sont transmis. Ces fichiers peuvent ne pas être présents si jamais le process est en erreur avec la génération de ces derniers.</p>
<ul class="simple">
<li>un fichier globalSedaParameters.file contenant des informations sur le manifest (messageIdentifier).</li>
<li>un fichier mapsUnits.file : présentant une map d’archive unit</li>
<li>un fichier mapsDO.file : présentant la liste des data objects</li>
<li>un fichier mapsDOtoOG.file : mappant le data object à son object group</li>
</ul>
<p>A noter que ces fichiers ne sont pas obligatoires pour le bon déroulement du handler.</p>
<p>Le handler va alors procéder à la génération d’un XML à partir des informationss aggrégées.
Voici sa structure générale :</p>
<ul class="simple">
<li>MessageIdentifier est rempli avec le MessageIdentifier présent dans le fichier globalSedaParameters. Il est vide si le fichier n’existe pas.</li>
<li>dans la balise ReplyOutcome :<ul>
<li>dans Operation, on aura une liste d’events remplis par les différentes opérations KO et ou FATAL. La liste sera forcément remplie avec au moins un event. Cette liste est obtenue par l’interrogation de la collection LogbookOperations.</li>
<li>dans ArchiveUnitList, on aura une liste d’events en erreur. Cette liste est obtenue par l’interrogation de la collection LogbookLifecycleUnits.</li>
<li>dans DataObjectList, on aura une liste d’events en erreur. Cette liste est obtenue par l’interrogation de la collection LogbookLifecycleObjectGroups.</li>
</ul>
</li>
</ul>
<p>Le XML est alors enregistré sur le Workspace.</p>
</div>
<div class="section" id="id14">
<h4>13.2.13.1.4. journalisation : logbook operation? logbook life cycle?<a class="headerlink" href="#id14" title="Lien permanent vers ce titre">¶</a></h4>
<p>Dans le traitement du Handler, le logbook est interrogé : opérations et cycles de vie.
Cependant aucune mise à jour est effectuée lors de l’exécution de ce handler.</p>
</div>
<div class="section" id="id15">
<h4>13.2.13.1.5. modules utilisés<a class="headerlink" href="#id15" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le Handler utilise les modules suivants :</p>
<ul class="simple">
<li>Workspace (récupération / copie de fichiers)</li>
<li>Logbook (partie server) : pour le moment la partie server du logbook est utilisée pour récupérer les différents journaux (opérations et cycles de vie).</li>
<li>Storage : permettant de stocker l’ATR.</li>
</ul>
</div>
<div class="section" id="id16">
<h4>13.2.13.1.6. cas d’erreur<a class="headerlink" href="#id16" title="Lien permanent vers ce titre">¶</a></h4>
<p>Les différentes exceptions pouvant être rencontrées :</p>
<ul class="simple">
<li>Logbook*Exception : si un problème est rencontré lors de l’interrogation du logbook</li>
<li>Content*Exception : si un problème est rencontré lors de l’interrogation du workspace</li>
<li>XML*Exception : si un souci est rencontré sur la génération du XML</li>
<li>ProcessingException : si un problème plus général est rencontré dans le Handler</li>
</ul>
</div>
</div>
<div class="section" id="detail-du-handler-accessionregisteractionhandler">
<h3>13.2.13.2. Détail du handler : AccessionRegisterActionHandler<a class="headerlink" href="#detail-du-handler-accessionregisteractionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id17">
<h4>13.2.13.2.1. Description<a class="headerlink" href="#id17" title="Lien permanent vers ce titre">¶</a></h4>
<p>AccessionRegisterActionHandler permet de fournir une vue globale et dynamique des archives</p>
<p>sous la responsabilité du service d’archives, pour chaque tenant.</p>
</div>
<div class="section" id="detail-des-maps-utilisees">
<h4>13.2.13.2.2. Détail des maps utilisées<a class="headerlink" href="#detail-des-maps-utilisees" title="Lien permanent vers ce titre">¶</a></h4>
<p>Map&lt;String, String&gt; objectGroupIdToGuid</p>
<blockquote>
<div>contenu         : cette map contient l’id du groupe d’objet relié à son guid</div></blockquote>
<p>Map&lt;String, String&gt; archiveUnitIdToGuid</p>
<blockquote>
<div>contenu         : cette map contient l’id du groupe d’objet relié à son guid</div></blockquote>
<p>Map&lt;String, Object&gt; dataObjectIdToDetailDataObject</p>
<blockquote>
<div>contenu         : cette map contient l’id du data object relié à ses informations</div></blockquote>
</div>
<div class="section" id="id18">
<h4>13.2.13.2.3. Exécution<a class="headerlink" href="#id18" title="Lien permanent vers ce titre">¶</a></h4>
<p>L’alimentation du registre des fonds a lieu pendant la phase de finalisation de l’entrée,</p>
<p>une fois que les objets et les units sont rangés. («&nbsp;stepName&nbsp;»: «&nbsp;STP_INGEST_FINALISATION&nbsp;»)</p>
<p>Le Registre des Fonds est alimenté de la manière suivante:</p>
<blockquote>
<div><blockquote>
<div>– un identifiant unique
– des informations sur le service producteur (OriginatingAgency)
– des informations sur le service versant (SubmissionAgency), si différent du service producteur</div></blockquote>
<p class="attribution">&mdash;des informations sur le contrat (ArchivalAgreement)</p>
</div></blockquote>
<blockquote>
<div><blockquote>
<div>– date de début de l’enregistrement (Start Date)
– date de fin de l’enregistrement (End Date)
– date de dernière mise à jour de l’enregistrement (Last update)
– nombre d’units (Total Units)
– nombre de GOT (Total ObjectGroups)
– nombre d’Objets (Total Objects)
– volumétrie des objets (Object Size)
– id opération d’entrée associée [pour l’instant, ne comprend que l’evIdProc de l’opération d’entrée concerné]
– status (ItemStatus)</div></blockquote>
</div></blockquote>
</div>
</div>
<div class="section" id="detail-du-handler-checkingestcontractactionhandler">
<h3>13.2.13.3. Détail du handler : CheckIngestContractActionHandler<a class="headerlink" href="#detail-du-handler-checkingestcontractactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id19">
<h4>13.2.13.3.1. Description<a class="headerlink" href="#id19" title="Lien permanent vers ce titre">¶</a></h4>
<p>CheckIngestContractHandler permet de vérifier la présence et contrôler le contrat d’entrée
du SIP à télécharger.</p>
</div>
<div class="section" id="detail-des-donnees-utilisees">
<h4>13.2.13.3.2. Détail des données utilisées<a class="headerlink" href="#detail-des-donnees-utilisees" title="Lien permanent vers ce titre">¶</a></h4>
<blockquote>
<div>globalSEDAParameters.json
Ce handler prend ce fichier comme le parametre d’entrée. Le fichier contient des données gobales sur l’ensemble des
parametrès du bordereau et il a été généré à l’étape de l’ExtractSedeActionHandler (CHECK_MANIFEST).</div></blockquote>
</div>
<div class="section" id="id20">
<h4>13.2.13.3.3. Exécution<a class="headerlink" href="#id20" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le handler cherche d’abord dans globalSEDAParameters.json le nom du contrat déclaré dans le SIP associé au balise &lt;ArchivalAgreement&gt;.
Si il n’y as pas de déclaration de contrat d’entrée, le handler retourne le status OK. Si il y a un déclaration de contrat, une liste
des opérations suivantes sera effectué :</p>
<blockquote>
<div><ul>
<li><p class="first">recherche du contrat d’entrée déclaré dans la référentiel de contrat</p>
</li>
<li><p class="first">vérification de contrat :</p>
<blockquote>
<div><p>si le contrat non trouvé ou contrat trouvé mais en status INACTIVE, le handler retourne le status KO
si le contrat trouvé et en status ACTIVE, le handler retourne le status OK</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>L’exécution de l’algorithme est présenté dans le preudo-code ci-dessous:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Si (il y as pas de déclaration de contrat)
        handler retourne OK
Autrement
        recherche du contrat dans la base via le client AdminManagementClient
        Si (contrat nou trouvé OU contrat trouvé mais INACTIVE)
                 handler retourne KO
        Autrement
            handler retourne OK
        Fin Si
Fin Si
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-handler-checknoobjectsactionhandler">
<h3>13.2.13.4. Détail du handler : CheckNoObjectsActionHandler<a class="headerlink" href="#detail-du-handler-checknoobjectsactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id21">
<h4>13.2.13.4.1. Description<a class="headerlink" href="#id21" title="Lien permanent vers ce titre">¶</a></h4>
<p>CheckNoObjectsActionHandler permet de vérifier s’il y a des objects numériques dans le SIP à verser dans le système.</p>
</div>
<div class="section" id="id22">
<h4>13.2.13.4.2. Détail des données utilisées<a class="headerlink" href="#id22" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le handler prend ce fichier manifest extrait du WORKSPACE comme le parametre d’entrée.</p>
</div>
<div class="section" id="id23">
<h4>13.2.13.4.3. exécution<a class="headerlink" href="#id23" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le fichier manifest sera lu pour vérifier s’il y a des TAG «&nbsp;BinaryDataObject&nbsp;» ou «&nbsp;PhysicalDataObject&nbsp;».
S’il en y a, le handler retourne KO, sinon OK.</p>
</div>
</div>
<div class="section" id="detail-du-plugin-checkarchiveunitschema">
<h3>13.2.13.5. Détail du plugin : CheckArchiveUnitSchema<a class="headerlink" href="#detail-du-plugin-checkarchiveunitschema" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id24">
<h4>13.2.13.5.1. Description<a class="headerlink" href="#id24" title="Lien permanent vers ce titre">¶</a></h4>
<p>CheckArchiveUnitSchema permet d’exécuter un contrôle intelligent des archive unit en vérifiant la conformité du JSON généré dans le process pour chaque archive unit, par rapport à un schéma défini.</p>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937
938
939
940
941
942
943
944
945
946
947
948
949
950
951
952
953
954
955
956
957
958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
979
980
981
982
983
984
985
986
987
988
989
990
991
992
993
994
995
996
997
998
999</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft-04/schema#&quot;</span><span class="p">,</span>
  <span class="nt">&quot;definitions&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^([0-8][0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01]))$&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;date-time&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;date-time-vitam&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;date-time-opt&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time&quot;</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;string-array&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;token&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^[\\w_\u00C0-\uFFFF][\\w\\d_\\.\\-\u00C0-\uFFFF]*$&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;lang&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;pattern&quot;</span><span class="p">:</span> <span class="s2">&quot;^[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*$&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;non-empty-token&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;string&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;non-empty-token-array&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;array&quot;</span>
      <span class="p">],</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;agent-type&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type+signature+validation&quot;</span><span class="p">,</span>
      <span class="nt">&quot;not&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;SigningTime&quot;</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;ValidationTime&quot;</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;agent-type+signature+validation&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;FirstName&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;BirthName&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;FullName&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GivenName&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Gender&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;BirthDate&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;BirthPlace&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/location-group&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;DeathDate&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;DeathPlace&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/location-group&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Nationality&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span><span class="p">,</span>
          <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;Corpname&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span><span class="p">,</span>
          <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;Function&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Activity&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Position&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Role&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Mandate&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;SigningTime&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;ValidationTime&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;oneOf&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;FirstName&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;BirthName&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;FullName&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;GivenName&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Gender&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;BirthDate&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;BirthPlace&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;DeathDate&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;DeathPlace&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Nationality&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;not&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Corpname&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;Corpname&quot;</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;location-group&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Geogname&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Address&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;PostalCode&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;City&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Region&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Country&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;PreventInheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;PreventRulesId&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;not&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;PreventInheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="kc">true</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="nt">&quot;PreventRulesId&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;minItems&quot;</span><span class="p">:</span> <span class="mi">1</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;PreventInheritance&quot;</span><span class="p">,</span>
          <span class="s2">&quot;PreventRulesId&quot;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;data-object-or-archive-unit-reference-type-array&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;ArchiveUnitRefId&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;DataObjectReference&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;DataObjectReferenceId&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/id&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;DataObjectGroupReferenceId&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/id&quot;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;RepositoryArchiveUnitPID&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;RepositoryObjectPID&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;ExternalReference&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;oneOf&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;ArchiveUnitRefId&quot;</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;DataObjectReference&quot;</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;RepositoryArchiveUnitPID&quot;</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;RepositoryObjectPID&quot;</span>
            <span class="p">]</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;ExternalReference&quot;</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;event&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;evId&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;evTypeProc&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;evType&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;evDateTime&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;evTypeDetail&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;outcome&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;outDetail&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;outMessg&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;evDetData&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;evDateTime&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;ArchiveUnitProfile&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/token&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;_mgt&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;StorageRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;FinalAction&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;RestrictAccess&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Transfer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Copy&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;FinalAction&quot;</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;AppraisalRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;FinalAction&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Keep&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Destroy&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;FinalAction&quot;</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;AccessRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;DisseminationRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;ReuseRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;ClassificationRule&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Rules&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;Rule&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;Rule&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;ClassificationLevel&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;ClassificationOwner&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;ClassificationAudience&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;ClassificationReassessingDate&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;NeedReassessingAuthorization&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;Inheritance&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/inheritance&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;ClassificationLevel&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ClassificationOwner&quot;</span>
          <span class="p">]</span>
        <span class="p">},</span>
        <span class="nt">&quot;LogBook&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;Event&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
              <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/event&quot;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;NeedAuthorization&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;UpdateOperation&quot;</span><span class="p">:</span> <span class="p">{}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;DescriptionLevel&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Fonds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Subfonds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Class&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Collection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Series&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Subseries&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RecordGrp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SubGrp&quot;</span><span class="p">,</span>
        <span class="s2">&quot;File&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Item&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OtherLevel&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;Title&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;Title_&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;patternProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;^[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*$&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
          <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;FilePlanPosition&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;SystemId&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;OriginatingSystemId&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;ArchivalAgencyArchiveUnitIdentifier&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;OriginatingAgencyArchiveUnitIdentifier&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;TransferringAgencyArchiveUnitIdentifier&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Description&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
      <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="nt">&quot;Description_&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;patternProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;^[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*$&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
          <span class="nt">&quot;minLength&quot;</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;CustodialHistory&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;CustodialHistoryItem&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;CustodialHistoryFile&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
          <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;DataObjectReferenceId&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/id&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;DataObjectGroupReferenceId&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/id&quot;</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;oneOf&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;DataObjectReferenceId&quot;</span>
              <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;DataObjectGroupReferenceId&quot;</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;CustodialHistoryItem&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;Type&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;DocumentType&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Language&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/lang&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;DescriptionLanguage&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/lang&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Status&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Tag&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Keyword&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;KeywordContent&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;KeywordReference&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;KeywordType&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;enum&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;corpname&quot;</span><span class="p">,</span>
              <span class="s2">&quot;famname&quot;</span><span class="p">,</span>
              <span class="s2">&quot;geogname&quot;</span><span class="p">,</span>
              <span class="s2">&quot;name&quot;</span><span class="p">,</span>
              <span class="s2">&quot;occupation&quot;</span><span class="p">,</span>
              <span class="s2">&quot;persname&quot;</span><span class="p">,</span>
              <span class="s2">&quot;subject&quot;</span><span class="p">,</span>
              <span class="s2">&quot;genreform&quot;</span><span class="p">,</span>
              <span class="s2">&quot;function&quot;</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;KeywordContent&quot;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Coverage&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Spatial&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Temporal&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Juridictional&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/string-array&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;OriginatingAgency&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;OrganizationDescriptiveMetadata&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Identifier&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;SubmissionAgency&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;Identifier&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;OrganizationDescriptiveMetadata&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Identifier&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;AuthorizedAgent&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Writer&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Addressee&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Recipient&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Transmitter&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Sender&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Source&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;RelatedObjectReference&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;IsVersionOf&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/data-object-or-archive-unit-reference-type-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Replaces&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/data-object-or-archive-unit-reference-type-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;Requires&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/data-object-or-archive-unit-reference-type-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;IsPartOf&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/data-object-or-archive-unit-reference-type-array&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;References&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/data-object-or-archive-unit-reference-type-array&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;CreatedDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;TransactedDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;AcquiredDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;SentDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;ReceivedDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;RegisteredDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;StartDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;EndDate&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/date-time-opt&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;Event&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/event&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Signature&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
      <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;Signer&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type+signature+validation&quot;</span><span class="p">,</span>
              <span class="nt">&quot;not&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;ValidationTime&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;Validator&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/agent-type+signature+validation&quot;</span><span class="p">,</span>
            <span class="nt">&quot;not&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;SigningTime&quot;</span>
              <span class="p">]</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&quot;Masterdata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span>
          <span class="p">},</span>
          <span class="nt">&quot;ReferencedObject&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&quot;SignedObjectId&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
              <span class="p">},</span>
              <span class="nt">&quot;SignedObjectDigest&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                  <span class="nt">&quot;MessageDigest&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
                  <span class="p">},</span>
                  <span class="nt">&quot;Algorithm&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/non-empty-token&quot;</span>
                  <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
                  <span class="s2">&quot;MessageDigest&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;Algorithm&quot;</span>
                <span class="p">]</span>
              <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
              <span class="s2">&quot;SignedObjectId&quot;</span><span class="p">,</span>
              <span class="s2">&quot;SignedObjectDigest&quot;</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="s2">&quot;Signer&quot;</span><span class="p">,</span>
          <span class="s2">&quot;Validator&quot;</span><span class="p">,</span>
          <span class="s2">&quot;ReferencedObject&quot;</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;Gps&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
      <span class="nt">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nt">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;GpsVersionID&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsAltitude&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;integer&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsAltitudeRef&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsLatitude&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsLatitudeRef&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsLongitude&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsLongitudeRef&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;GpsDateStamp&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_mgt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;DescriptionLevel&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Title&quot;</span>
      <span class="p">]</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Title_&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id25">
<h4>13.2.13.5.2. Détail des données utilisées<a class="headerlink" href="#id25" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le plugin récupère l’id de l’Archive Unit à vérifier.</p>
</div>
<div class="section" id="id26">
<h4>13.2.13.5.3. exécution<a class="headerlink" href="#id26" title="Lien permanent vers ce titre">¶</a></h4>
<p>A partir de l’Id de l’id de l’Archive Unit à vérifier, le plugin va télécharger le fichier json associé dans le Workspace.
Par la suite, il va vérifier la validation de ce Json par rapport au schéma json de Vitam.</p>
</div>
<div class="section" id="detail-des-verifications">
<h4>13.2.13.5.4. détail des vérifications<a class="headerlink" href="#detail-des-verifications" title="Lien permanent vers ce titre">¶</a></h4>
<p>Dans le schéma Json Vitam défini, voici les spécificités qui ont été ajoutées pour différents champs :</p>
<ul class="simple">
<li>StartDate pour les Rules : une date contenant une année égale à ou au dessus de l’année 9000 sera refusée.</li>
<li>Content / Title : peut être de type String, Array ou number (on pourra avoir des titres traduits ainsi que des nombres si besoin)</li>
</ul>
</div>
</div>
<div class="section" id="detail-du-handler-checkarchiveprofileactionhandler">
<h3>13.2.13.6. Détail du handler : CheckArchiveProfileActionHandler<a class="headerlink" href="#detail-du-handler-checkarchiveprofileactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id27">
<h4>13.2.13.6.1. Description<a class="headerlink" href="#id27" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de vérifier le profil dans manifeste</p>
</div>
<div class="section" id="id28">
<h4>13.2.13.6.2. exécution<a class="headerlink" href="#id28" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le format du profil est XSD ou RNG.
L’exécution de l’algorithme est présenté dans le preudo-code ci-dessous:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Si le format du profil est équal à XSD
        retourne true si XSD valide le fichier manifest.xml
Fin Si
Si le format du profil est équal à RNG
        retourne true si RNG valide le fichier manifest.xml
Fin Si
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-handler-checkarchiveprofilerelationactionhandler">
<h3>13.2.13.7. Détail du handler : CheckArchiveProfileRelationActionHandler<a class="headerlink" href="#detail-du-handler-checkarchiveprofilerelationactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id29">
<h4>13.2.13.7.1. Description<a class="headerlink" href="#id29" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de vérifier la relation entre le contrat d’entrée et le profil dans manifeste</p>
</div>
<div class="section" id="id30">
<h4>13.2.13.7.2. exécution<a class="headerlink" href="#id30" title="Lien permanent vers ce titre">¶</a></h4>
<p>Si le champ «&nbsp;ArchiveProfiles&nbsp;» dans le contrat d’entrée
contient l’identifiant du profil, retourne true</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Select</span><span class="p">();</span>
<span class="n">select</span><span class="p">.</span><span class="na">setQuery</span><span class="p">(</span><span class="n">QueryHelper</span><span class="p">.</span><span class="na">eq</span><span class="p">(</span><span class="n">IngestContract</span><span class="p">.</span><span class="na">NAME</span><span class="p">,</span> <span class="n">contractName</span><span class="p">));</span>
<span class="n">JsonNode</span> <span class="n">queryDsl</span> <span class="o">=</span> <span class="n">select</span><span class="p">.</span><span class="na">getFinalSelect</span><span class="p">();</span>
<span class="n">RequestResponse</span><span class="o">&lt;</span><span class="n">IngestContractModel</span><span class="o">&gt;</span> <span class="n">referenceContracts</span> <span class="o">=</span> <span class="n">adminClient</span><span class="p">.</span><span class="na">findIngestContracts</span><span class="p">(</span><span class="n">queryDsl</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">referenceContracts</span><span class="p">.</span><span class="na">isOk</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">IngestContractModel</span> <span class="n">contract</span> <span class="o">=</span> <span class="p">((</span><span class="n">RequestResponseOK</span><span class="o">&lt;</span><span class="n">IngestContractModel</span><span class="o">&gt;</span> <span class="p">)</span> <span class="n">referenceContracts</span><span class="p">).</span><span class="na">getResults</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">isValid</span> <span class="o">=</span> <span class="n">contract</span><span class="p">.</span><span class="na">getArchiveProfiles</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="n">profileIdentifier</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-handler-listarchiveunitsactionhandler">
<h3>13.2.13.8. Détail du handler : ListArchiveUnitsActionHandler<a class="headerlink" href="#detail-du-handler-listarchiveunitsactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id31">
<h4>13.2.13.8.1. Description<a class="headerlink" href="#id31" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de lister les unités archivistiques qui devront être mises à jour.</p>
</div>
<div class="section" id="id32">
<h4>13.2.13.8.2. exécution<a class="headerlink" href="#id32" title="Lien permanent vers ce titre">¶</a></h4>
<p>Il prend en entrée un fichier json représentant la liste règles de gestion ayant été modifiés dans le référentiel.
Pour chaque règle mise à jour, une requête vers la collection units est effectuée.
Le but de cette recherche est de générer une liste d’units avec les règles de gestion associées ayant été modifiées.
En sortie, pour chaque unité archivistique, on aura un fichier GUID_AU.json (dans un sous répertoire GUIDOpération/UnitsWithoutLevel/) contenant un tableau des règles de gestion modifiées.</p>
</div>
</div>
<div class="section" id="detail-du-handler-listrunningingestsactionhandler">
<h3>13.2.13.9. Détail du handler : ListRunningIngestsActionHandler<a class="headerlink" href="#detail-du-handler-listrunningingestsactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id33">
<h4>13.2.13.9.1. Description<a class="headerlink" href="#id33" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de lister les ingests toujours en cours d’exécution (processState RUNNING ou PAUSE).</p>
</div>
<div class="section" id="id34">
<h4>13.2.13.9.2. exécution<a class="headerlink" href="#id34" title="Lien permanent vers ce titre">¶</a></h4>
<p>Une requête est effectuée sur ProcessManagement, pour récupérer la liste des ingests en cours.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">ProcessQuery</span> <span class="n">pq</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProcessQuery</span><span class="p">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">listStates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">listStates</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ProcessState</span><span class="p">.</span><span class="na">RUNNING</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
<span class="n">listStates</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">ProcessState</span><span class="p">.</span><span class="na">PAUSE</span><span class="p">.</span><span class="na">name</span><span class="p">());</span>
<span class="n">pq</span><span class="p">.</span><span class="na">setStates</span><span class="p">(</span><span class="n">listStates</span><span class="p">);</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">listProcessTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">listProcessTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">LogbookTypeProcess</span><span class="p">.</span><span class="na">INGEST</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">listProcessTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">LogbookTypeProcess</span><span class="p">.</span><span class="na">HOLDINGSCHEME</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">listProcessTypes</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">LogbookTypeProcess</span><span class="p">.</span><span class="na">FILINGSCHEME</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="n">pq</span><span class="p">.</span><span class="na">setListProcessTypes</span><span class="p">(</span><span class="n">listProcessTypes</span><span class="p">);</span>
<span class="n">RequestResponseOK</span><span class="o">&lt;</span><span class="n">ProcessDetail</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span>
             <span class="p">(</span><span class="n">RequestResponseOK</span><span class="o">&lt;</span><span class="n">ProcessDetail</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">processManagementClient</span><span class="p">.</span><span class="na">listOperationsDetails</span><span class="p">(</span><span class="n">pq</span><span class="p">);</span>
</pre></div>
</div>
<p>Suite à cette requête, la liste des opérations d’Ingest est enregistrée dans un fichier JSON : PROCESSING/runningIngests.json.</p>
</div>
</div>
<div class="section" id="detail-du-plugin-archiveunitrulesupdateactionplugin">
<h3>13.2.13.10. Détail du plugin : ArchiveUnitRulesUpdateActionPlugin<a class="headerlink" href="#detail-du-plugin-archiveunitrulesupdateactionplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id35">
<h4>13.2.13.10.1. Description<a class="headerlink" href="#id35" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de mettre à jour les règles de gestion d’une unité archivistique. Il s’agit ici de mettre à jour le champ endDate pour les règles de gestion impactées.
On se trouve ici en mode distribué, cela veut donc dire que l’on traite les mises à jour, unité par unité.</p>
</div>
<div class="section" id="id36">
<h4>13.2.13.10.2. exécution<a class="headerlink" href="#id36" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le fichier json pour l’unité archivistique, généré dans le Handler «&nbsp;ListArchiveUnitsActionHandler&nbsp;» est récupéré.
A partir de ce dernier, on va faire une première requète pour récupérer l’unité archivistique telle qu’enregistrée en base.</p>
<p>Ensuite, catégorie par catégorie, des requêtes de mises à jour vont être créées.
Une requête finale sera aggrégée, comprenant les différentes catégories mises à jour.
Enfin, l’update final de la base de données sera exécuté, tel que ci-dessous :</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">.</span><span class="na">addActions</span><span class="p">(</span><span class="n">UpdateActionHelper</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">VitamFieldsHelper</span><span class="p">.</span><span class="na">operations</span><span class="p">(),</span> <span class="n">params</span><span class="p">.</span><span class="na">getProcessId</span><span class="p">()));</span>
<span class="n">JsonNode</span> <span class="n">updateResultJson</span> <span class="o">=</span> <span class="n">metaDataClient</span><span class="p">.</span><span class="na">updateUnitbyId</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">getFinalUpdate</span><span class="p">(),</span> <span class="n">archiveUnitId</span><span class="p">);</span>
<span class="n">String</span> <span class="n">diffMessage</span> <span class="o">=</span> <span class="n">archiveUnitUpdateUtils</span><span class="p">.</span><span class="na">getDiffMessageFor</span><span class="p">(</span><span class="n">updateResultJson</span><span class="p">,</span> <span class="n">archiveUnitId</span><span class="p">);</span>
<span class="n">itemStatus</span><span class="p">.</span><span class="na">setEvDetailData</span><span class="p">(</span><span class="n">diffMessage</span><span class="p">);</span>
</pre></div>
</div>
<p>Le différentiel (résumant les champs modifiés, principalement les endDate des règles de gestion) sera enregistré également dans les cycles de vie de l’unité archivistique.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//do some things</span>
<span class="n">archiveUnitUpdateUtils</span><span class="p">.</span><span class="na">logLifecycle</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">archiveUnitId</span><span class="p">,</span> <span class="n">StatusCode</span><span class="p">.</span><span class="na">OK</span><span class="p">,</span> <span class="n">diffMessage</span><span class="p">,</span> <span class="n">logbookLifeCycleClient</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-plugin-runningingestsupdateactionplugin">
<h3>13.2.13.11. Détail du plugin : RunningIngestsUpdateActionPlugin<a class="headerlink" href="#detail-du-plugin-runningingestsupdateactionplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id37">
<h4>13.2.13.11.1. Description<a class="headerlink" href="#id37" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de mettre à jour les règles de gestion des unités archivistiques des ingests en cours.</p>
</div>
<div class="section" id="id38">
<h4>13.2.13.11.2. exécution<a class="headerlink" href="#id38" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le fichier json décrivant les ingests en cours, généré dans le Handler «&nbsp;ListRunningIngestsActionHandler&nbsp;» est récupéré.
Il va permettre, de traiter au fur et à mesure les ingests n’ayant pas été encore impactés par la mise à jour du référentiel des règles de gestion.</p>
<p>La manière de procéder est la suivante :</p>
<ul>
<li><p class="first">Une boucle while(true) va permettre de boucler continuellement sur une liste d’ingest.</p>
</li>
<li><p class="first">Une boucle interne sur un iterator obtenu à partir de la liste des ingests va permettre de traiter les différents processus.</p>
<blockquote>
<div><ul class="simple">
<li>Si l’ingest est finalisé (entre le moment de l’exécution du Handler ListRunningIngestsActionHandler, et l’exécution du plugin) alors on va vérifier la liste des règles de gestion pour chaque unité archivistique, puis procéder à des mises à jour (code commun avec le plugin ArchiveUnitRulesUpdateActionPlugin). L’ingest est alors, au final, supprimé de l’iterator.</li>
<li>Si l’ingest est toujours en cours, alors on passe au suivant.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Tant que l’iterator contient des éléments, la boucle continue. (une pause de 10 secondes est prévue avant de reboucler sur l’iterator)</p>
</li>
<li><p class="first">Enfin quand l’iterator est vide, le plugin, renverra un statut OK notifiant la gestion de tous les ingests.</p>
</li>
</ul>
<p>A l’heure actuelle, pour éviter un nombre d’essais illimité, une limite d’essais à été positionné (NB_TRY = 600).
A l’avenir, il conviendra certainement de ne pas avoir cette limite.</p>
<p>Il est aussi prévu d’améliorer les performances de l’exécution de ce plugin.
Il apparait pertinent de rendre parallélisable le traitement des ingests en cours.</p>
</div>
</div>
<div class="section" id="detail-du-handler-listlifecycletraceabilityactionhandler">
<h3>13.2.13.12. Détail du handler : ListLifecycleTraceabilityActionHandler<a class="headerlink" href="#detail-du-handler-listlifecycletraceabilityactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id39">
<h4>13.2.13.12.1. Description<a class="headerlink" href="#id39" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de préparer les listes de cycles de vie des groupes d’objets, et des unités archivistiques.
Il permet aussi la récupération des informations de la dernière opération de sécurisation des cycles de vie.</p>
</div>
<div class="section" id="id40">
<h4>13.2.13.12.2. exécution<a class="headerlink" href="#id40" title="Lien permanent vers ce titre">¶</a></h4>
<p>Une première requête permet de récupérer la dernière opération de sécurisation des cycles de vie.
S’il en existe une, on en tire les informations importantes (date d’exécution, etc.), l’opération sera exportée dans un fichier json.
S’il n’en existe pas, une date minimale (LocalDateTime.MIN) sera utilisée pour la suite du process.</p>
<p>A partir de cette date obtenue, on va interroger Mongo et récupérer 2 listes de cycles de vie (groupes d’objets et units) qui n’ont pas encore été sécurisés.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">Query</span> <span class="n">parentQuery</span> <span class="o">=</span> <span class="n">QueryHelper</span><span class="p">.</span><span class="na">gte</span><span class="p">(</span><span class="s">&quot;evDateTime&quot;</span><span class="p">,</span> <span class="n">startDate</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="kd">final</span> <span class="n">Query</span> <span class="n">sonQuery</span> <span class="o">=</span> <span class="n">QueryHelper</span><span class="p">.</span><span class="na">gte</span><span class="p">(</span><span class="n">LogbookDocument</span><span class="p">.</span><span class="na">EVENTS</span> <span class="o">+</span> <span class="s">&quot;.evDateTime&quot;</span><span class="p">,</span> <span class="n">startDate</span><span class="p">.</span><span class="na">toString</span><span class="p">());</span>
<span class="kd">final</span> <span class="n">Select</span> <span class="n">select</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Select</span><span class="p">();</span>
<span class="n">select</span><span class="p">.</span><span class="na">setQuery</span><span class="p">(</span><span class="n">QueryHelper</span><span class="p">.</span><span class="na">or</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="n">parentQuery</span><span class="p">,</span> <span class="n">sonQuery</span><span class="p">));</span>
<span class="n">select</span><span class="p">.</span><span class="na">addOrderByAscFilter</span><span class="p">(</span><span class="s">&quot;evDateTime&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>A partir de ces 2 listes, on va créer X (X étant le nombre de GoT ou d’units) fichiers dans les sous répertoires GUID/ObjectGroup et GUID/UnitsWithoutLevel.
Ces fichiers json seront utilisés plus tard dans le workflow, dans le cadre de la distribution.</p>
<p>En traitant les différents cycles de vie, on en conclut les informations suivantes :</p>
<ul class="simple">
<li>date maximum d’un cycle de vie traité</li>
<li>nombre de cycles de vie liés aux groupes d’objets traités</li>
<li>nombre de cycles de vie liés aux units traités</li>
</ul>
<p>Ces informations, combinées à la startDate obtenue précédemment, sont enregistrées dans un fichier json Operations/traceabilityInformation.json.</p>
<p>En résumé, voici les output de ce handler :</p>
<ul class="simple">
<li>GUID/Operations/lastOperation.json -&gt; informations sur la dernière opération de sécurisation des cycles de vie</li>
<li>GUID/Operations/traceabilityInformation.json -&gt; informations sur la sécurisation en cours</li>
<li>GUID/ObjectGroup/GUID_OG_n.json -&gt; n fichiers json représentant n cycles de vie des groupes d’objets</li>
<li>GUID/UnitsWithoutLevel/GUID_AU_n.json -&gt; n fichiers json représentant n cycles de vie des units.</li>
</ul>
</div>
</div>
<div class="section" id="detail-du-plugin-createobjectsecurefileactionplugin">
<h3>13.2.13.13. Détail du plugin : CreateObjectSecureFileActionPlugin<a class="headerlink" href="#detail-du-plugin-createobjectsecurefileactionplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id41">
<h4>13.2.13.13.1. Description<a class="headerlink" href="#id41" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de traiter, groupe d’objet par groupe d’objet, et de créer un fichier sécurisé.
Chaque fichier sécurisé créé, sera par la suite, dans l’étape de finalisation, traité et intégré dans un fichier global.</p>
</div>
<div class="section" id="id42">
<h4>13.2.13.13.2. exécution<a class="headerlink" href="#id42" title="Lien permanent vers ce titre">¶</a></h4>
<p>La première étape de ce plugin, consiste à récupérer le fichier json GUID/ObjectGroup/GUID_OG_n.json.
A partir de ce json, représentant le cycle de vie devant être traité, on va créer un fichier sécurisé.
Ce fichier sécurisé contient une ligne unique, organisée de la façon suivante :</p>
<dl class="docutils">
<dt>[ID de l’opération provoquant la création du cycle de vie] | [Type du process (INGEST / UPDATE)] | [Date de l’évenement] | [ID du cycle de vie]</dt>
<dd><div class="first last line-block">
<div class="line">[Statut final du cycle de vie] | [Hash global du cycle de vie] | [Hash du groupe d’objet associé] | [Liste des versions de l’objet]</div>
</div>
</dd>
</dl>
<p>Ce fichier généré est ensuite sauvegardé sur le workspace dans : LFCObjects.</p>
<p>Voici l’output de ce plugin :
- GUID/LFCObjects/GUID_OG.json</p>
</div>
</div>
<div class="section" id="detail-du-plugin-createunitsecurefileactionplugin">
<h3>13.2.13.14. Détail du plugin : CreateUnitSecureFileActionPlugin<a class="headerlink" href="#detail-du-plugin-createunitsecurefileactionplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id43">
<h4>13.2.13.14.1. Description<a class="headerlink" href="#id43" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de traiter, cycle de vie unit par cycle de vie unit, et de créer un fichier sécurisé.
Chaque fichier sécurisé créé, sera par la suite, dans l’étape de finalisation, traité et intégré dans un fichier global.</p>
</div>
<div class="section" id="id44">
<h4>13.2.13.14.2. exécution<a class="headerlink" href="#id44" title="Lien permanent vers ce titre">¶</a></h4>
<p>La première étape de ce plugin, consiste à récupérer le fichier json GUID/UnitsWithoutLevel/GUID_AU_n.json.
A partir de ce json, représentant le cycle de vie devant être traité, on va créer un fichier sécurisé.
Ce fichier sécurisé contient une ligne unique, organisée de la façon suivante :</p>
<dl class="docutils">
<dt>[ID de l’opération provoquant la création du cycle de vie] | [Type du process (INGEST / UPDATE)] | [Date de l’évenement] | [ID du cycle de vie]</dt>
<dd><div class="first last line-block">
<div class="line">[Statut final du cycle de vie] | [Hash global du cycle de vie] | [Hash de l’archive unit associé] |</div>
</div>
</dd>
</dl>
<p>Ce fichier généré est ensuite sauvegardé sur le workspace dans : LFCObjects.</p>
<p>Voici l’output de ce plugin :</p>
<ul class="simple">
<li>GUID/LFCUnits/GUID_AU.json</li>
</ul>
</div>
</div>
<div class="section" id="detail-du-plugin-checkclassificationlevelactionplugin">
<h3>13.2.13.15. Détail du plugin : CheckClassificationLevelActionPlugin<a class="headerlink" href="#detail-du-plugin-checkclassificationlevelactionplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id45">
<h4>13.2.13.15.1. Description<a class="headerlink" href="#id45" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de vérifier que le niveau de classification déclaré par les ArchiveUnit du manifeste est conforme à ceux attendus dans la configuration de la plate-forme</p>
</div>
<div class="section" id="id46">
<h4>13.2.13.15.2. exécution<a class="headerlink" href="#id46" title="Lien permanent vers ce titre">¶</a></h4>
<p>A partir de l’Id de l’id de l’Archive Unit à vérifier, le plugin va télécharger le fichier json associé dans le Workspace.
Par la suite, il va vérifier le champ ClassificationLevel par rapport au celui dans ClassificationLevelService</p>
</div>
</div>
<div class="section" id="detail-du-handler-finalizelifecycletraceabilityactionhandler">
<h3>13.2.13.16. Détail du handler : FinalizeLifecycleTraceabilityActionHandler<a class="headerlink" href="#detail-du-handler-finalizelifecycletraceabilityactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id47">
<h4>13.2.13.16.1. Description<a class="headerlink" href="#id47" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de finaliser la sécurisation des cycles de vie, en générant un fichier zip, et en le sauvegardant sur les offres de stockage.</p>
</div>
<div class="section" id="id48">
<h4>13.2.13.16.2. exécution<a class="headerlink" href="#id48" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le Handler va tout d’abord récupérer les fichiers json qui ont été générés dans l’étape 1 :</p>
<ul class="simple">
<li>le fichier json de la dernière opération de sécurisation</li>
<li>le fichier json contenant les informations de la sécurisation en cours</li>
</ul>
<p>Ensuite, un objet TraceabilityFile va être généré. Cet objet représente un ZipArchiveOutputStream contenant 4 fichiers :</p>
<ul class="simple">
<li>global_lifecycles.txt : contenant l’aggrégation des informations des cycles de vie sécurisés.</li>
<li>additional_information.txt : contenant des informations génériques (nombre de cycles de vie traités, startDate + endDate)</li>
<li>computing_information.txt : contenant les informations de hachage (hash actuel, hash de la dernière opération de sécurisation, hash d’il y a un mois, et d’il y a un an)</li>
<li>token.tsp : tampon d’horodatage du fichier de sécurisation</li>
</ul>
<p>Les informations nécessaires sont récupérées pour générer et remplir les 4 différents fichiers :</p>
<p><strong>global_lifecycles.txt :</strong>
Ce fichier va être obtenu de la manière suivante :</p>
<ul class="simple">
<li>On récupère la liste des fichiers présents dans les 2 sous-répertoires (GUID/LFCUnits/ et GUID/LFCObjects/).</li>
<li>Pour chaque fichier récupéré, on récupère son contenu et on ajoute une ligne au fichier global_lifecycles.txt</li>
<li>Le premier élément traité sera utilisé pour en conclure un hash, qui sera identifié étant comme le hashRoot du fichier.</li>
</ul>
<p><strong>additional_information.txt :</strong>
Le fichier json Operations/traceabilityInformation.json va être utilisé pour construire le fichier de la manière suivante :</p>
<ul class="simple">
<li>numberOfElements : nombre de cycles de vie traités</li>
<li>startDate : startDate (soit égale à LocalDateTime.MIN, soit à la plus petite date des cycles de vie traités)</li>
<li>endDate : plus grande date des cycles de vie traités.</li>
<li>securisationVersion : version du format du fichier de traçabilité</li>
</ul>
<p><strong>computing_information.txt :</strong>
Ce fichier va être rempli de la manière suivante :
- currentHash : le hash du cycle de vie traité en premier
- previousTimestampToken : le tampon d’horodatage de la dernière opération de sécurisation (sera obtenu en analysant le fichier json Operations/lastOperation.json) - peut être vide.
- previousTimestampTokenMinusOneMonth : le tampon d’horodatage de la dernière opération de sécurisation datant d’un mois. Une recherche dans la base LogbookOperations est effectuée.
- previousTimestampTokenMinusOneYear : le tampon d’horodatage de la dernière opération de sécurisation datant d’un an. Une recherche dans la base LogbookOperations est effectuée.</p>
<p><strong>token.tsp :</strong>
Le fichier token.tsp, contiendra simplement le tampon d’horodatage de l’opération de sécurisation en cours.
Le tampon d’horodatage est obtenu en utilisant le timestampGenerator de Vitam. Cela nécéssite d’avoir un certificat présent dans la configuration du worker (configuration via verify-timestamp.conf spécifiant le p12 + le password).
Les différents hash nécessaires sont :
- rootHash : hash du premier cycle de vie traité dans l’opération en cours
- hash1 : hash de la dernière opération de sécurisation
- hash2 : hash de la dernière opération de sécurisation datant d’un mois
- hash3 : hash de la dernière opération de sécurisation datant d’un an
(hash1, hash2 et hash3 peuvent être null, si aucune opération n’a été effectué dans le passé)</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">joiner</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="n">rootHash</span><span class="p">,</span> <span class="n">hash1</span><span class="p">,</span> <span class="n">hash2</span><span class="p">,</span> <span class="n">hash3</span><span class="p">);</span>
<span class="kd">final</span> <span class="n">DigestType</span> <span class="n">digestType</span> <span class="o">=</span> <span class="n">VitamConfiguration</span><span class="p">.</span><span class="na">getDefaultTimestampDigestType</span><span class="p">();</span>
<span class="kd">final</span> <span class="n">Digest</span> <span class="n">digest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Digest</span><span class="p">(</span><span class="n">digestType</span><span class="p">);</span>
<span class="n">digest</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">hashDigest</span> <span class="o">=</span> <span class="n">digest</span><span class="p">.</span><span class="na">digest</span><span class="p">();</span>
<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">timeStampToken</span> <span class="o">=</span> <span class="n">timestampGenerator</span><span class="p">.</span><span class="na">generateToken</span><span class="p">(</span><span class="n">hashDigest</span><span class="p">,</span> <span class="n">digestType</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</pre></div>
</div>
<p>Le fichier zip est finalement créé et sauvegardé sur le Workspace. Ensuite, il sera sauvegardé sur les offres de stockage.</p>
<p>Bien évidemment l’opération est enregistré dans le logbook. Les informations de Traceability sont enregistrés dans le champ evDetData.
Elles seront utilisés par la suite, pour les sécurisations futures.</p>
</div>
</div>
<div class="section" id="detail-du-handler-generateauditreportactionhandler">
<h3>13.2.13.17. Détail du handler : GenerateAuditReportActionHandler<a class="headerlink" href="#detail-du-handler-generateauditreportactionhandler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id49">
<h4>13.2.13.17.1. Description<a class="headerlink" href="#id49" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce handler permet de générer le rapport d’audit</p>
</div>
<div class="section" id="id50">
<h4>13.2.13.17.2. exécution<a class="headerlink" href="#id50" title="Lien permanent vers ce titre">¶</a></h4>
<p>La rapport commence par une partie généraliste contenant :
* Le GUID de l’opération d’audit à l’origine de ce rapport
* Le tenant sur lequel s’est exécuté l’audit
* Le message (outMessg) du JDO de l’opération de la dernière étape (succès ou échec de l’audit)
* Le statut final (outcome) de l’opération
* La date et l’heure du début de la génération du rapport (evDateTime de l’evénement)
* L’identifiant de ce sur quoi porte l’audit (tenant/SP/opération)</p>
<p>Deuxièmement, la rapport contient les cas OK, KO, Warning et Fatal de toutes les actions d’audit sur les objets</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">//le cas OK</span>
<span class="n">source</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">JsonHandler</span><span class="p">.</span><span class="na">createObjectNode</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="n">_TENANT</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">_TENANT</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ORIGINATING_AGENCY</span><span class="p">,</span> <span class="n">agIdExtNode</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;originatingAgency&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">EV_ID_PROC</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">EV_ID_PROC</span><span class="p">).</span><span class="na">asText</span><span class="p">()));</span>

<span class="c1">//le cas KO</span>
<span class="n">reportKO</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">JsonHandler</span><span class="p">.</span><span class="na">createObjectNode</span><span class="p">().</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;IdOp&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">EV_ID_PROC</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ID_GOT</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;obId&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ID_OBJ</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">ID_OBJ</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">USAGE</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">USAGE</span><span class="p">).</span><span class="na">asText</span><span class="p">())</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">ORIGINATING_AGENCY</span><span class="p">,</span> <span class="n">originatingAgency</span><span class="p">)</span>
<span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">OUT_DETAIL</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;outDetail&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">()));</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-plugin-auditcheckobjectplugin">
<h3>13.2.13.18. Détail du plugin : AuditCheckObjectPlugin<a class="headerlink" href="#detail-du-plugin-auditcheckobjectplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id51">
<h4>13.2.13.18.1. Description<a class="headerlink" href="#id51" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de contrôler les objets dans le cadre d’un audit consultatif</p>
</div>
<div class="section" id="id52">
<h4>13.2.13.18.2. exécution<a class="headerlink" href="#id52" title="Lien permanent vers ce titre">¶</a></h4>
<p>Selon le parametre auditActions, il va appeler le plugin,
soit CheckExistenceObjectPlugin, soit CheckIntegrityObjectPlugin</p>
</div>
</div>
<div class="section" id="detail-du-plugin-checkexistenceobjectplugin">
<h3>13.2.13.19. Détail du plugin : CheckExistenceObjectPlugin<a class="headerlink" href="#detail-du-plugin-checkexistenceobjectplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id53">
<h4>13.2.13.19.1. Description<a class="headerlink" href="#id53" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de contrôler l’existence d’un objet dans le cadre d’un audit</p>
</div>
<div class="section" id="id54">
<h4>13.2.13.19.2. exécution<a class="headerlink" href="#id54" title="Lien permanent vers ce titre">¶</a></h4>
<p>Le plugin va tester l’existence de la cohérence entre les offres de stockages déclarées dans un GOT
et les offres de stockages relatives à la stratégie de stockage connue du moteur de stockage</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="n">JsonNode</span> <span class="n">storageInformation</span> <span class="o">=</span> <span class="n">version</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;_storage&quot;</span><span class="p">);</span>
<span class="kd">final</span> <span class="n">String</span> <span class="n">strategy</span> <span class="o">=</span> <span class="n">storageInformation</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;strategyId&quot;</span><span class="p">).</span><span class="na">textValue</span><span class="p">();</span>
<span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">offerIds</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="n">JsonNode</span> <span class="n">offerId</span> <span class="p">:</span> <span class="n">storageInformation</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;offerIds&quot;</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">offerIds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">offerId</span><span class="p">.</span><span class="na">textValue</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">storageClient</span><span class="p">.</span><span class="na">exists</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">StorageCollectionType</span><span class="p">.</span><span class="na">OBJECTS</span><span class="p">,</span>
    <span class="n">version</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">(),</span> <span class="n">offerIds</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">nbObjectKO</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">nbObjectOK</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="detail-du-plugin-checkintegrityobjectplugin">
<h3>13.2.13.20. Détail du plugin : CheckIntegrityObjectPlugin<a class="headerlink" href="#detail-du-plugin-checkintegrityobjectplugin" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="id55">
<h4>13.2.13.20.1. Description<a class="headerlink" href="#id55" title="Lien permanent vers ce titre">¶</a></h4>
<p>Ce plugin permet de contrôler l’intégrité d’un objet archivé dans le cadre d’un audit</p>
</div>
<div class="section" id="id56">
<h4>13.2.13.20.2. exécution<a class="headerlink" href="#id56" title="Lien permanent vers ce titre">¶</a></h4>
<p>Dans le cadre de l’audit, on va vérifier une empreinte d’un objet est bien celle de l’objet audité,
en fonction de son offre de stockage.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="n">JsonNode</span> <span class="n">offerToMetadata</span> <span class="o">=</span> <span class="n">storageClient</span><span class="p">.</span><span class="na">getObjectInformation</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">version</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;_id&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">(),</span> <span class="n">offerIds</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">offerId</span> <span class="p">:</span> <span class="n">offerIds</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">digest</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="n">JsonNode</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">offerToMetadata</span><span class="p">.</span><span class="na">findValue</span><span class="p">(</span><span class="n">offerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">metadata</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">){</span>
            <span class="n">digest</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;digest&quot;</span><span class="p">).</span><span class="na">asText</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">checkDigest</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">messageDigest</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">digest</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">checkDigest</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">checkDigest</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="worker-common">
<h2>13.2.14. Worker-common<a class="headerlink" href="#worker-common" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le worker-common contient majoritairement des classes utilitaires.
A terme, il faudra que SedaUtils notamment soit «&nbsp;retravaillé&nbsp;» pour que les différentes méthodes soit déplacées dans les bons Handlers.</p>
</div>
<div class="section" id="worker-client">
<h2>13.2.15. Worker-client<a class="headerlink" href="#worker-client" title="Lien permanent vers ce titre">¶</a></h2>
<p>Le worker client contient le code permettant l’appel vers les API Rest offert par le worker.
Pour le moment une seule méthode est offerte : submitStep. Pour plus de détail, voir la partie worker-client.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="worker-client.html" class="btn btn-neutral float-right" title="13.3. Worker Client" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="intro.html" class="btn btn-neutral float-left" title="13.1. Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>