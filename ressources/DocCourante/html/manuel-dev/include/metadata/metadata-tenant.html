<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10.5. Métadata-tenant &mdash; Documentation VITAM - Manuel de développement 8.0.0</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="10.6. Métadata" href="metadata-inherited-rule.html" />
    <link rel="prev" title="10.4. Métadata : API REST Raml" href="metadata-api-rest-raml.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Manuel de développement
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-environnement.html">Configuration de l’environnement de développement</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../access/_toc.html">1. Access</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collect/_toc.html">2. Collect</a></li>
<li class="toctree-l2"><a class="reference internal" href="../common/_toc.html">3. Common</a></li>
<li class="toctree-l2"><a class="reference internal" href="../functional-administration/_toc.html">4. Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-demo/_toc.html">5. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-recette/_toc.html">6. IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest/_toc.html">7. Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-security/_toc.html">8. Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logbook/_toc.html">9. Logbook</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">10. Metadata</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="metadata-introduction.html">10.1. Métadata - Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-dat.html">10.2. DAT : module metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-user-client.html">10.3. Métadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-api-rest-raml.html">10.4. Métadata : API REST Raml</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">10.5. Métadata-tenant</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-inherited-rule.html">10.6. Métadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-sync.html">10.7. Désynchronisation des bases de données</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../processing/_toc.html">11. Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scheduler/_toc.html">12. Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/_toc.html">13. Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../technical-administration/_toc.html">14. Technical administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../worker/_toc.html">15. Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/_toc.html">16. Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devstack_vm.html">Création d’une machine de dev contenant <em>Swift</em></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Manuel de développement</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">Détails par composant</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">10. Metadata</a></li>
      <li class="breadcrumb-item active">10.5. Métadata-tenant</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/include/metadata/metadata-tenant.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="metadata-tenant">
<h1>10.5. Métadata-tenant<a class="headerlink" href="#metadata-tenant" title="Lien permanent vers ce titre">¶</a></h1>
<p>Les indices elasticsearch des unités archives et les groupes d’objets technique doivent être séparées par
les tenants. Ces indices doivent être créées lors de démarrage du serveur grâce au fichier de configuration.
Par exemple, pour metadata.conf on ajourte d’une ligne suivante :</p>
<ul>
<li><p class="first">tenants : [0, 1, 2]</p>
<blockquote>
<div><p>indiqué que le serveur va travailler sur différents tenants 0, 1 et 2.</p>
</div></blockquote>
</li>
</ul>
<ol class="arabic simple">
<li>Valeur du tenant</li>
</ol>
<p>La valeur de tenant est sauvegardé dans VitamSession et cette valeur sera récupérée par la fonction suivante.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">VitamThreadUtils</span><span class="p">.</span><span class="na">getVitamSession</span><span class="p">().</span><span class="na">getTenantId</span><span class="p">()</span>
</pre></div>
</div>
<p>Les indices sont créées basé sur les tenant pour chaque collection correspondante.</p>
<ul class="simple">
<li>Pour collection des unités archives, les indices sont : unit_0, unit_1, … pour la liste de tenant 0, 1 …</li>
<li>Pour la collection des groupes d’objets technique, les indices sont objectgroups_0, objectgroups_1…</li>
</ul>
<ol class="arabic simple" start="2">
<li>Refactor</li>
</ol>
<p>Pour permettre de réaliser les opérations sur les collections de métadata via l’elastichsearch par le tenant,
nous faisons un refactor sur les classe DbRequest et ElasticsearchAccessMetadata.</p>
<p>2.1. ElasticsearchAccessMetadata</p>
<p>Les fonctions d’ajout des indices pour la collection, mise à jour des indices ou delete des indices sont fait par le paramètre tenantId.</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">deleteIndex</span><span class="p">(</span><span class="kd">final</span> <span class="n">MetadataCollections</span> <span class="n">collection</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">tenantId</span><span class="p">)</span>
<span class="n">addIndex</span><span class="p">(</span><span class="kd">final</span> <span class="n">MetadataCollections</span> <span class="n">collection</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">tenantId</span><span class="p">)</span>
<span class="n">refreshIndex</span><span class="p">(</span><span class="kd">final</span> <span class="n">MetadataCollections</span> <span class="n">collection</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">tenantId</span><span class="p">)</span>
<span class="n">addEntryIndexesBlocking</span><span class="p">(</span><span class="kd">final</span> <span class="n">MetadataCollections</span> <span class="n">collection</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Integer</span> <span class="n">tenantId</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">mapIdJson</span><span class="p">)</span>
<span class="n">addEntryIndex</span><span class="p">(</span><span class="kd">final</span> <span class="n">MetadataDocument</span><span class="o">&lt;?&gt;</span> <span class="n">document</span><span class="p">,</span> <span class="n">Integer</span> <span class="n">tenantId</span><span class="p">)</span>
<span class="p">...</span>
</pre></div>
</div>
<p>2.2. DbRequest</p>
<ul class="simple">
<li>Le tenantId est récupéré dans la session par VitamThreadUtils.getVitamSession().getTenantId() pour appliquer au executeQuery() pour exécuter une requête.</li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span>    <span class="n">Result</span> <span class="nf">executeQuery</span><span class="p">(</span><span class="kd">final</span> <span class="n">RequestToAbstract</span> <span class="n">requestToMongodb</span><span class="p">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="kd">final</span> <span class="n">Result</span> <span class="n">previous</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Integer</span> <span class="n">tenantId</span> <span class="o">=</span> <span class="n">ParameterHelper</span><span class="p">.</span><span class="na">getTenantParameter</span><span class="p">();</span>

    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="metadata-api-rest-raml.html" class="btn btn-neutral float-left" title="10.4. Métadata : API REST Raml" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="metadata-inherited-rule.html" class="btn btn-neutral float-right" title="10.6. Métadata" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>