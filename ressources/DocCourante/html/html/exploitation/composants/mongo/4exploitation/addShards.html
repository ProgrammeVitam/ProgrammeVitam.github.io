

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="fr" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="fr" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.2.8.5.1. Extension du cluster : ajouter un ou n Shards &mdash; Documentation VITAM - Documentation d&#39;exploitation 3.0.1</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'3.0.1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
    <link rel="next" title="7.2.9. Siegfried" href="../../siegfried/_toc.html" />
    <link rel="prev" title="7.2.8.5. Exploitation d’un cluster MongoDB" href="_toc.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> VITAM - Documentation d'exploitation
          

          
            
            <img src="../../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                3.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/_toc.html">5. Exploitation globale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../_toc.html#generalites">7.1. Généralités</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../_toc.html#cots">7.2. COTS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../cerebro/_toc.html">7.2.1. Cerebro</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../consul/_toc.html">7.2.2. Consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_interceptor/_toc.html">7.2.3. Kibana interceptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_log/_toc.html">7.2.4. Elasticsearch chaîne de log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_vitam/_toc.html">7.2.5. Elasticsearch Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kibana/_toc.html">7.2.6. Kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../log_server/_toc.html">7.2.7. Log server</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../_toc.html">7.2.8. MongoDB</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../0mongos/_toc.html">7.2.8.1. Service vitam-mongos</a></li>
<li class="toctree-l4"><a class="reference internal" href="../1mongoc/_toc.html">7.2.8.2. Service vitam-mongoc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../2mongod/_toc.html">7.2.8.3. Service vitam-mongod</a></li>
<li class="toctree-l4"><a class="reference internal" href="../3deployment/_toc.html">7.2.8.4. Topologies de déploiement et tolérance aux pannes</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="_toc.html">7.2.8.5. Exploitation d’un cluster MongoDB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../siegfried/_toc.html">7.2.9. Siegfried</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../annexes/_toc.html">12. Annexes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VITAM - Documentation d'exploitation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a> &raquo;</li>
        
          <li><a href="../_toc.html">7.2.8. MongoDB</a> &raquo;</li>
        
          <li><a href="_toc.html">7.2.8.5. Exploitation d’un cluster MongoDB</a> &raquo;</li>
        
      <li>7.2.8.5.1. Extension du cluster : ajouter un ou n <code class="docutils literal notranslate"><span class="pre">Shards</span></code></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/composants/mongo/4exploitation/addShards.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="extension-du-cluster-ajouter-un-ou-n-shards">
<h1>7.2.8.5.1. Extension du cluster : ajouter un ou n <code class="docutils literal notranslate"><span class="pre">Shards</span></code><a class="headerlink" href="#extension-du-cluster-ajouter-un-ou-n-shards" title="Lien permanent vers ce titre">¶</a></h1>
<p>Lorsque la volumétrie des données gérées par un seul <code class="docutils literal notranslate"><span class="pre">Shard</span></code> devient trop importante, il faut ajouter de nouveaux <code class="docutils literal notranslate"><span class="pre">Shards</span></code> dans le cluster. Des lors que les nouveaux <code class="docutils literal notranslate"><span class="pre">Shards</span></code> sont opérationnels, une opération de migration des données (voir <code class="docutils literal notranslate"><span class="pre">balancing</span></code>) est réalisée en tâche de fond afin d’équilibrer l’ensemble des <code class="docutils literal notranslate"><span class="pre">Shards</span></code>.</p>
<p>Les éléments déplacés entre <code class="docutils literal notranslate"><span class="pre">Shard</span></code> sont des regroupements de données par collection. Ce regroupement est nommé <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> et le composant MongoDB qui réalise ce déplacement est nommé <code class="docutils literal notranslate"><span class="pre">balancer</span></code>.</p>
<p>Le mécanisme interne du <code class="docutils literal notranslate"><span class="pre">balancer</span></code> n’est pas paramétrable. Une opération de transfert de <code class="docutils literal notranslate"><span class="pre">Chunk</span></code> est réalisée exclusivement entre un <code class="docutils literal notranslate"><span class="pre">Shard</span></code> et un autre <code class="docutils literal notranslate"><span class="pre">Shard</span></code>. Si le cluster contient 4 <code class="docutils literal notranslate"><span class="pre">Shards</span></code>, 2 opérations, au maximum, pourront être réalisées en parallèle à un instant donné.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">il est recommandé de favoriser un grand nombre de <code class="docutils literal notranslate"><span class="pre">Shards</span></code> (avec un nombre pair), déployés sur des “petites” machines, afin de favoriser le re-équilibrages des <code class="docutils literal notranslate"><span class="pre">Shards</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Dans Vitam, les clés de <code class="docutils literal notranslate"><span class="pre">Sharding</span></code> implémentées permettent une répartition uniforme des données. En régime de croisière, les <code class="docutils literal notranslate"><span class="pre">Shards</span></code> n’ont donc pas besoin d’être équilibrés et l’opération de <code class="docutils literal notranslate"><span class="pre">balancing</span></code> ne devrait pas logué une activité.</p>
</div>
<p>Pour ajouter un nouveau <code class="docutils literal notranslate"><span class="pre">Shard</span></code> au cluster, il faut exécuter les opérations suivantes :</p>
<ul>
<li><p class="first">Créer les machines qui seront utilisées comme membre des nouveaux shards.</p>
</li>
<li><p class="first">Ajouter ces machines dans le fichier d’inventaire ansible.</p>
</li>
<li><p class="first">se connecter à un service <code class="docutils literal notranslate"><span class="pre">vitam-mongos</span></code> :</p>
<p>Depuis une machine ou l’utilitaire mongo est installé et pour laquelle le flux réseau vers le service est ouvert. Le cas échéant, se connecter en ssh sur la machine pour utiliser l’utilitaire mongo en spécifiant le hostname de la machine (pas localhost) :</p>
</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mongo --host &lt;hostname&gt; --port <span class="m">27017</span> --username vitamdb-admin --password &lt;password&gt; --authenticationDatabase admin
</pre></div>
</div>
<ul class="simple">
<li>Vérifier l’état du sharding dans le cluster en tappant la commande suivante :</li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div>La commande retourne un ensemble d’informations dont 2 sont importantes pour cette opération d’exploitation. La première détaille la composition des shards opérationnels, dont voici un exemple :</div></blockquote>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">shards</span><span class="o">:</span>
    <span class="p">{</span>  <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;shard0&quot;</span><span class="p">,</span>  <span class="s2">&quot;host&quot;</span> <span class="o">:</span> <span class="s2">&quot;shard0/&lt;ipMember1&gt;:27019,&lt;ipMember2&gt;:27019,&lt;ipMember3&gt;:27019&quot;</span><span class="p">,</span>  <span class="s2">&quot;state&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
    <span class="p">{</span>  <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="s2">&quot;shard1&quot;</span><span class="p">,</span>  <span class="s2">&quot;host&quot;</span> <span class="o">:</span> <span class="s2">&quot;shard1/&lt;ipMember1&gt;:27019,&lt;ipMember2&gt;:27019,&lt;ipMember3&gt;:27019&quot;</span><span class="p">,</span>  <span class="s2">&quot;state&quot;</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div>La seconde détaille les activités de balancing des <code class="docutils literal notranslate"><span class="pre">Chunks</span></code>, dont voici un exemple :</div></blockquote>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">balancer</span><span class="o">:</span>
      <span class="nx">Currently</span> <span class="nx">enabled</span><span class="o">:</span>  <span class="nx">yes</span>
      <span class="nx">Currently</span> <span class="nx">running</span><span class="o">:</span>  <span class="nx">no</span>
      <span class="nx">Failed</span> <span class="nx">balancer</span> <span class="nx">rounds</span> <span class="k">in</span> <span class="nx">last</span> <span class="mi">5</span> <span class="nx">attempts</span><span class="o">:</span>  <span class="mi">0</span>
      <span class="nx">Last</span> <span class="nx">reported</span> <span class="nx">error</span><span class="o">:</span>
      <span class="nx">Time</span> <span class="k">of</span> <span class="nx">Reported</span> <span class="nx">error</span><span class="o">:</span>  <span class="nx">Tue</span> <span class="nx">Jul</span> <span class="mi">30</span> <span class="mi">2019</span> <span class="mi">09</span><span class="o">:</span><span class="mi">05</span><span class="o">:</span><span class="mi">45</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0000</span> <span class="p">(</span><span class="nx">UTC</span><span class="p">)</span>
      <span class="nx">Migration</span> <span class="nx">Results</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">last</span> <span class="mi">24</span> <span class="nx">hours</span><span class="o">:</span>
              <span class="nx">No</span> <span class="nx">recent</span> <span class="nx">migrations</span>
</pre></div>
</div>
<blockquote>
<div>Dans ces informations, on constate que le service de <code class="docutils literal notranslate"><span class="pre">balancing</span></code> est actif et qu’aucune migration n’est en cours. De plus, aucune migration n’a été réalisée au cours des dernières 24 heures.</div></blockquote>
<ul class="simple">
<li>Ajouter les shards en récupérant les adresses Ip de chacun des membres, en conservant le regroupement qui a été configuré dans l’ansiblerie Vitam, et en executant la commande suivante pour chaque shard :</li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sh</span><span class="p">.</span><span class="nx">addShard</span><span class="p">(</span><span class="s2">&quot;shard2/&lt;ipMember1&gt;:27019,&lt;ipMember2&gt;:27019,&lt;ipMember3&gt;:27019&quot;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Vérifier que le balancing a démarré en récupérant l’état du sharding via la commande :</li>
</ul>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span>
</pre></div>
</div>
<blockquote>
<div>Voici un exemple d’information que l’on peut récupérer :</div></blockquote>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">balancer</span><span class="o">:</span>
      <span class="nx">Currently</span> <span class="nx">enabled</span><span class="o">:</span>  <span class="nx">yes</span>
      <span class="nx">Currently</span> <span class="nx">running</span><span class="o">:</span>  <span class="nx">yes</span>
      <span class="nx">Collections</span> <span class="kd">with</span> <span class="nx">active</span> <span class="nx">migrations</span><span class="o">:</span>
              <span class="nx">logbook</span><span class="p">.</span><span class="nx">LogbookLifeCycleObjectGroup</span> <span class="nx">started</span> <span class="nx">at</span> <span class="nx">Wed</span> <span class="nx">Jul</span> <span class="mi">31</span> <span class="mi">2019</span> <span class="mi">12</span><span class="o">:</span><span class="mi">43</span><span class="o">:</span><span class="mi">19</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0000</span> <span class="p">(</span><span class="nx">UTC</span><span class="p">)</span>
      <span class="nx">Failed</span> <span class="nx">balancer</span> <span class="nx">rounds</span> <span class="k">in</span> <span class="nx">last</span> <span class="mi">5</span> <span class="nx">attempts</span><span class="o">:</span>  <span class="mi">0</span>
      <span class="nx">Migration</span> <span class="nx">Results</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">last</span> <span class="mi">24</span> <span class="nx">hours</span><span class="o">:</span>
              <span class="mi">22</span> <span class="o">:</span> <span class="nx">Success</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">cette opération a été testée dans l’environnement de performance Vitam, qui contenait environ 200 millions d’AU. Le temps de migration des <code class="docutils literal notranslate"><span class="pre">Chunks</span></code> depuis les 2 <code class="docutils literal notranslate"><span class="pre">Shards</span></code> existants vers les 2 nouveaux <code class="docutils literal notranslate"><span class="pre">Shards</span></code> a été d’une trentaine de jours.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../siegfried/_toc.html" class="btn btn-neutral float-right" title="7.2.9. Siegfried" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="_toc.html" class="btn btn-neutral float-left" title="7.2.8.5. Exploitation d’un cluster MongoDB" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>