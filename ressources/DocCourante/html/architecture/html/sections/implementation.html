<!DOCTYPE html>
<html class="writer-html5" lang="fr" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. Implémentation &mdash; Vitam-UI documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5. Gestion du système" href="gestion.html" />
    <link rel="prev" title="3. Architecture" href="architecture.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="../index.html">
            <img src="../_static/Vitam_Logo-CMJN.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Rechercher docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro_objectifs.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="orientations_techniques.html">2. Orientations techniques</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">3. Architecture</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Implémentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#technologies">4.1. Technologies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#briques-techniques">4.1.1. Briques techniques</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cots">4.1.2. COTS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#services">4.2. Services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#identification-des-services">4.2.1. Identification des services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#communications-inter-services">4.2.2. Communications inter-services</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cloisonnement-des-services">4.2.3. Cloisonnement des services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#les-differentes-zones">4.2.3.1. Les différentes zones</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#integration-systeme">4.3. Intégration système</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#utilisateurs-et-groupes-dexecution">4.3.1. Utilisateurs et groupes d’exécution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#utilisateurs">4.3.1.1. Utilisateurs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#groupes">4.3.1.2. Groupes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#arborescence-de-fichiers">4.3.2. Arborescence de fichiers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#integration-au-service-d-initialisation-systemd">4.3.3. Intégration au service d’initialisation Systemd</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#securisation">4.4. Sécurisation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#securisation-des-acces-aux-services-externes">4.4.1. Sécurisation des accès aux services externes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#securisation-des-communications-internes">4.4.2. Sécurisation des communications internes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#securisation-des-acces-aux-bases-de-donnees">4.4.3. Sécurisation des accès aux bases de données</a></li>
<li class="toctree-l3"><a class="reference internal" href="#securisation-des-secrets-de-deploiement">4.4.4. Sécurisation des secrets de déploiement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#liste-des-secrets">4.4.5. Liste des secrets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentification-du-compte-ssh">4.4.6. Authentification du compte SSH</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentification-des-hotes">4.4.7. Authentification des hôtes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#elevation-de-privileges">4.4.8. Élévation de privilèges</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#certificats-et-pki">4.5. Certificats et PKI</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#principes-de-fonctionnement-pki-de-vitamui">4.5.1. Principes de fonctionnement PKI de VITAMUI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#explication-avancee-du-fonctionnement">4.5.2. Explication avancée du fonctionnement</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generation-des-certificats">4.5.3. Génération des certificats</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cas-pratiques">4.5.4. Cas pratiques</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pki-de-test">4.5.5. PKI de test</a></li>
<li class="toctree-l3"><a class="reference internal" href="#liste-des-certificats-utilises">4.5.6. Liste des certificats utilisés</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure-dajout-dun-certificat-client-externe">4.5.7. Procédure d’ajout d’un certificat client externe</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#clusterisation">4.6. Clusterisation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multi-instanciation-du-service-iam-internal">4.6.1. Multi-instanciation du service iam-internal</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detail-des-services">4.7. Détail des services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#service-1">4.7.1. Service 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#service-2">4.7.2. Service 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#detail-des-cots">4.8. Détail des COTS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cas">4.8.1. CAS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#annuaire-de-services-consul">4.8.2. Annuaire de services Consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="#base-nosql-mongodb">4.8.3. Base NOSQL MongoDB</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#multi-instanciation-des-micro-services">4.9. Multi instanciation des micro services</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#multi-instanciation">4.9.1. Multi instanciation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mono-instanciation">4.9.2. Mono instanciation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gestion.html">5. Gestion du système</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Vitam-UI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">4. </span>Implémentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/sections/implementation.md.txt" rel="nofollow"> Afficher la source de la page</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="implementation">
<h1><span class="section-number">4. </span>Implémentation<a class="headerlink" href="#implementation" title="Lien permanent vers ce titre"></a></h1>
<section id="technologies">
<h2><span class="section-number">4.1. </span>Technologies<a class="headerlink" href="#technologies" title="Lien permanent vers ce titre"></a></h2>
<section id="briques-techniques">
<h3><span class="section-number">4.1.1. </span>Briques techniques<a class="headerlink" href="#briques-techniques" title="Lien permanent vers ce titre"></a></h3>
<p>La solution est développée principalement avec les briques technologies suivantes :</p>
<ul class="simple">
<li><p>Java 1.8+ (Java 11)</p></li>
<li><p>Angular 8 : framework front</p></li>
<li><p>Spring Boot 2 : framework applicatif</p></li>
<li><p>MongoDB : base de données NoSQL</p></li>
<li><p>Swagger : documentation API</p></li>
</ul>
</section>
<section id="cots">
<h3><span class="section-number">4.1.2. </span>COTS<a class="headerlink" href="#cots" title="Lien permanent vers ce titre"></a></h3>
<p>Les composants suivant sont utilisés dans la solution :</p>
<ul class="simple">
<li><p>CAS : gestionnaire d’authentification centralisé (IAM)</p></li>
<li><p>VITAM : socle d’archivage développé par le programme VITAM</p></li>
<li><p>MongoDB : base de données orientée documents</p></li>
<li><p>Curator : maintenance des index d’elasticsearch</p></li>
<li><p>ELK : agrégation et traitement des logs et dashboards et recherche des logs techniques</p></li>
<li><p>Consul : annuaire de services</p></li>
</ul>
<p>Les solutions CAS et VITAM sont également développées en Java dans des technologies proches ou similaires.</p>
<p>En fonction du choix de l’implémentation de la solution, il est possible de partager des dépendances logicielles avec la solution VITAM.</p>
</section>
</section>
<hr class="docutils" />
<section id="services">
<h2><span class="section-number">4.2. </span>Services<a class="headerlink" href="#services" title="Lien permanent vers ce titre"></a></h2>
<p>La solution est bâtie selon une architecture de type micro-services. Ces services communiquent entre eux en HTTPS via des API REST.</p>
<ul class="simple">
<li><p>Les services externes exposés publiquement sont sécurisés par la mise en oeuvre d’un protocole M2M nécessitant l’utilisation de certificats X509 client et serveur reconnus mutuellement lors de la connexion.</p></li>
<li><p>Les services internes, ne sont jamais exposés publiquement. Ils sont accessibles uniquement en HTTPS par les services externes ou par d’autres services internes.</p></li>
<li><p>Les accès aux bases de données MongoDb ou aux socles techniques externes (ie. VITAM) se font uniquement via les services internes.</p></li>
<li><p>Les utilisateurs sont authentifiés via CAS et disposent d’un token, validé à chaque appel, qui les identifient durant toute la chaîne de traitement des requêtes.</p></li>
</ul>
<section id="identification-des-services">
<h3><span class="section-number">4.2.1. </span>Identification des services<a class="headerlink" href="#identification-des-services" title="Lien permanent vers ce titre"></a></h3>
<p>Il est primordial que chaque service de la solution puisse être identifié de manière unique sur le système. À cet effet, les services disposent des différents identifiants suivant :</p>
<ul class="simple">
<li><p>ID de service (ou service_id) : c’est une chaîne de caractères qui nomme de manière unique un service. Cette chaîne de caractère doit respecter l’expression régulière suivante : <code class="docutils literal notranslate"><span class="pre">[a-z][a-z-]*</span></code>. Chaque cluster de service possède un ID unique de service.</p></li>
<li><p>ID d’instance (ou instance_id) : c’est l’ID d’un service instancié dans un environnement ; ainsi, pour un même service, il peut exister plusieurs instances de manière concurrente dans un environnement donné. Cet ID a la forme suivante : <code class="docutils literal notranslate"><span class="pre">&lt;service_id&gt;-&lt;instance_number&gt;</span></code>, avec <code class="docutils literal notranslate"><span class="pre">&lt;instance_number&gt;</span></code> respectant l’expression régulière suivante : <code class="docutils literal notranslate"><span class="pre">[0-9]{2}</span></code>. Chaque instance dans ce cluster possède un id d’instance (instance_id).</p></li>
<li><p>ID de package (ou package_id) : il est de la forme <code class="docutils literal notranslate"><span class="pre">vitamui-&lt;service_id&gt;</span></code>. C’est le nom du package à déployer.</p></li>
</ul>
</section>
<section id="communications-inter-services">
<h3><span class="section-number">4.2.2. </span>Communications inter-services<a class="headerlink" href="#communications-inter-services" title="Lien permanent vers ce titre"></a></h3>
<p>Les services VITAMUI suivent les principes suivants lors d’un appel entre deux composants :</p>
<ol class="arabic simple">
<li><p>Le composant amont effectue un appel (de type DNS) à l’annuaire de service en indiquant le service_id du service qu’il souhaite appeler</p></li>
<li><p>L’annuaire de service lui retourne une liste ordonnée d’instance_id. C’est de la responsabilité de l’annuaire de service de trier cette liste dans l’ordre préférentiel d’appel (en fonction de l’état des différents services, et avec un algorithme d’équilibrage dont il a la charge)</p></li>
<li><p>Le composant amont appelle la première instance présente dans la liste. En cas d’échec de cet appel, il recommence depuis le point 1. La communication vers une instance cible de type Service API utilise nécessairement le protocole sécurisé HTTPS.</p></li>
</ol>
<p>Ces principes ont pour but de garantir les trois points suivants :</p>
<ul class="simple">
<li><p>Les clients des services doivent être agnostiques de la topologie de déploiement, et notamment du nombre d’instances de chaque service dans chaque cluster. La connaissance de cette topologie est déléguée à l’annuaire de service.</p></li>
<li><p>Le choix de l’instance cible d’un appel doit être décorrélé de l’appel effectif afin d’optimiser les performances et la résilience.</p></li>
<li><p>La garantie de la confidentialité des informations transmises entre les services (hors COTS)</p></li>
</ul>
<p>Dans le cas des COTS, la gestion de l’équilibrage de charge et de la haute disponibilité doit être intégrée de manière native dans le COTS utilisé. D’autre part, la sécurisation de la transmission dépend du COTS. Dans le cas où le chiffrement des données transmises n’est pas assuré, il est alors recommandé d’isoler le COTS dans une zone réseau spécifique.</p>
</section>
<section id="cloisonnement-des-services">
<h3><span class="section-number">4.2.3. </span>Cloisonnement des services<a class="headerlink" href="#cloisonnement-des-services" title="Lien permanent vers ce titre"></a></h3>
<p>Le cloisonnement applicatif permet de séparer les services de manière physique (subnet/port) et ainsi  limiter la portée d’une attaque en cas d’intrusion dans une des zones. Ce cloisonnement applique le principe de défense en profondeur préconisé par l’ANSI.</p>
<p>Chaque zone héberge des clusters de services. Un cluster doit être présent en entier dans une zone, et ne peut par conséquent pas être réparti dans deux zones différentes. Chaque noeud d’un cluster applicatif doit être installé sur un hôte (OS) distinct (la colocalisation de deux instances d’un même service n’étant pas supporté). La mise en oeuvre d’une infrastructure virtualisée impose de placer deux noeuds d’un même cluster applicatif sur deux serveurs physiques différents.</p>
<p>Un exemple de découpage en zones applicative est fourni ci-dessous. Ce découpage repose sur une logique assez classique adapté à une infrastructure de type VmWare ESX. Pour une architecture reposant sur  une technologie de type Docker, il serait envisageable de découper plus finement les zones jusqu’à envisager une zone pour chaque cluster de service.</p>
<p>Dans cet exemple, il est prévu pour respecter les contraintes de flux inter-zones suivants :</p>
<ul class="simple">
<li><p>les utilisateurs de la zone USERS communiquent avec les services de la zone IHM</p></li>
<li><p>les administrateurs de la zone ADMIN communiquent avec les services de la zone IHM ADMIN</p></li>
<li><p>les services de la zone IHM et IHM-ADMIN communiquent avec les services de la zone API-EXTERNAL</p></li>
<li><p>les services de la zone API-EXTERNAL communiquent avec les services de la zone API-INTERNAL</p></li>
<li><p>les services de la zone API-INTERNAL communiquent avec les services de la zone DATA</p></li>
<li><p>les services de toutes les zones communiquent avec les services déployés dans la zone INFRA</p></li>
<li><p>les exploitants techniques accédent aux services de la zone EXPLOITATION puis intervenir dans toutes les zones</p></li>
</ul>
<section id="les-differentes-zones">
<h4><span class="section-number">4.2.3.1. </span>Les différentes zones<a class="headerlink" href="#les-differentes-zones" title="Lien permanent vers ce titre"></a></h4>
<section id="zone-ihm">
<h5><span class="section-number">4.2.3.1.1. </span>zone IHM<a class="headerlink" href="#zone-ihm" title="Lien permanent vers ce titre"></a></h5>
<p>La zone IHM se compose de plusieurs services:</p>
<ul class="simple">
<li><p>UI Identity</p></li>
<li><p>UI Portal</p></li>
<li><p>UI Referential</p></li>
<li><p>UI Ingest</p></li>
<li><p>UI Archive Search</p></li>
</ul>
</section>
<section id="zone-api-external">
<h5><span class="section-number">4.2.3.1.2. </span>zone API-EXTERNAL<a class="headerlink" href="#zone-api-external" title="Lien permanent vers ce titre"></a></h5>
<p>La zone API-EXTERNAL se compose de plusieurs services:</p>
<ul class="simple">
<li><p>IAM EXTERNAL</p></li>
<li><p>REFERENTIAL EXTERNAL</p></li>
<li><p>INGEST EXTERNAL</p></li>
<li><p>ARCHIVE SEARCH EXTERNAL</p></li>
</ul>
</section>
<section id="zone-api-internal">
<h5><span class="section-number">4.2.3.1.3. </span>zone API-INTERNAL<a class="headerlink" href="#zone-api-internal" title="Lien permanent vers ce titre"></a></h5>
<p>La zone API-INTERNAL se compose de plusieurs services:</p>
<ul class="simple">
<li><p>IAM INTERNAL</p></li>
<li><p>REFERENTIAL INTERNAL</p></li>
<li><p>INGEST INTERNAL</p></li>
<li><p>ARCHIVE SEARCH INTERNAL</p></li>
</ul>
</section>
<section id="zone-data">
<h5><span class="section-number">4.2.3.1.4. </span>zone DATA<a class="headerlink" href="#zone-data" title="Lien permanent vers ce titre"></a></h5>
<p>La zone stockage: MongoDB</p>
</section>
<section id="zone-infra">
<h5><span class="section-number">4.2.3.1.5. </span>zone INFRA<a class="headerlink" href="#zone-infra" title="Lien permanent vers ce titre"></a></h5>
<p>Les services consul, kibana, elk etc..</p>
<p>Tous les serveurs cibles doivent avoir accès aux dépôts de binaires contenant les paquets des logiciels VITAMUI et des composants externes requis pour l’installation. Les autres éléments d’installation (playbook ansible, …) doivent être disponibles sur la machine ansible orchestrant le déploiement de la solution dans la zone INFRA.</p>
<p>Schéma de zoning :</p>
<p><img alt="Architecture IAM CAS" src="../_images/dat_zoning.png" /></p>
</section>
</section>
</section>
</section>
<hr class="docutils" />
<section id="integration-systeme">
<h2><span class="section-number">4.3. </span>Intégration système<a class="headerlink" href="#integration-systeme" title="Lien permanent vers ce titre"></a></h2>
<section id="utilisateurs-et-groupes-dexecution">
<h3><span class="section-number">4.3.1. </span>Utilisateurs et groupes d’exécution<a class="headerlink" href="#utilisateurs-et-groupes-dexecution" title="Lien permanent vers ce titre"></a></h3>
<p>La segmentation des droits utilisateurs permet de respecter les contraintes suivantes :</p>
<ul class="simple">
<li><p>Assurer une séparation des utilisateurs humains du système et des utilisateurs système sous lesquels tournent les processus</p></li>
<li><p>Séparer les droits des rôles d’exploitation différents suivants :</p>
<ul>
<li><p>Les administrateurs système (OS) ;</p></li>
<li><p>Les administrateurs techniques des logiciels VITAMUI;</p></li>
<li><p>Les administrateurs des bases de données VITAMUI</p></li>
</ul>
</li>
</ul>
<p>Les utilisateurs et groupes décrits dans les paragraphes suivants doivent être ajoutés par les scripts d’installation de la solution VITAMUI. En outre, les règles de sudoer associées aux groupes vitamui*-admin doivent également être mis en place par les scripts d’installation.</p>
<p>Les sudoers sont paramétrés en mode NOPASSWD, c’est à dire qu’aucun mot de passe n’est demandé à l’utilisateur faisant partie du groupe vitamui*-admin pour lancer les commandes d’arrêt relance des applicatifs vitamui.</p>
<p>Les fichiers de règles sudoers des groupes vitamui-admin et vitamuidb-admin sont systématiquement écrasés à chaque installation des paquets (rpm) déclarant les utilisateurs VITAMUI. (Un backup de l’ancien fichier est cependant effectué).</p>
<section id="utilisateurs">
<h4><span class="section-number">4.3.1.1. </span>Utilisateurs<a class="headerlink" href="#utilisateurs" title="Lien permanent vers ce titre"></a></h4>
<p>Les utilisateurs suivant sont définis :</p>
<ul class="simple">
<li><p>vitamui(UID : 4000) : user pour les services ne stockant pas les données</p></li>
<li><p>vitamuidb (UID : 4001) : user pour les services stockant des données (Ex : MongoDB)</p></li>
</ul>
<p>Les processus VITAMUI tournent sous ces utilisateurs. Leurs logins sont désactivés.</p>
</section>
<section id="groupes">
<h4><span class="section-number">4.3.1.2. </span>Groupes<a class="headerlink" href="#groupes" title="Lien permanent vers ce titre"></a></h4>
<p>Les groupes suivant sont définis :</p>
<ul class="simple">
<li><p>vitamui(GID : 4000) : groupe primaire des utilisateurs de service</p></li>
<li><p>vitamui-admin (GID : 5000) : groupe d’utilisateurs ayant les droits “sudo” permettant le lancement des services VITAMUI</p></li>
<li><p>vitamuidb-admin (GID : 5001) : groupe d’utilisateurs ayant les droits “sudo” permettant le lancement des services VITAMUI stockant de la donnée.</p></li>
</ul>
</section>
</section>
<section id="arborescence-de-fichiers">
<h3><span class="section-number">4.3.2. </span>Arborescence de fichiers<a class="headerlink" href="#arborescence-de-fichiers" title="Lien permanent vers ce titre"></a></h3>
<p>L’arborescence /vitamui héberge les fichiers propres aux différents services. Elle est normalisée selon le pattern suivant : /vitamui/&lt;folder_type&gt;/&lt;service_id&gt; où :</p>
<p>Pour un service d’id service_id, les fichiers et dossiers impactés par VITAMUI sont les suivants.</p>
<ul class="simple">
<li><p>service_id est l’id du service auquel appartient les fichiers</p></li>
<li><p>folder-type est le type de fichiers contenu par le dossier :</p>
<ul>
<li><p>app : fichiers de ressources (non-jar) requis pour l’application (ex: .war)</p></li>
<li><p>bin : binaires (le cas échéant)</p></li>
<li><p>script : Répertoire des scripts d’exploitation du module (start/stop/status/backup)</p></li>
<li><p>conf : Fichiers de configuration</p></li>
<li><p>lib : Fichiers binaires (ex: jar)</p></li>
<li><p>log : Logs du composant</p></li>
<li><p>data : Données sauvegardes du composant</p></li>
<li><p>tmp : Données temporaires produites par l’application</p></li>
</ul>
</li>
</ul>
<p>Les dossiers /vitamui et /vitamui/&lt;folder_type&gt; ont les droits suivants :</p>
<ul class="simple">
<li><p>Owner : root</p></li>
<li><p>Group owner : root</p></li>
<li><p>Droits : 0555</p></li>
</ul>
<p>À l’intérieur de ces dossiers, les droits par défaut sont les suivants :</p>
<ul class="simple">
<li><p>Fichiers standards :</p>
<ul>
<li><p>Owner : vitamui (ou vitamuidb)</p></li>
<li><p>Group owner : vitamui</p></li>
<li><p>Droits : 0440</p></li>
</ul>
</li>
<li><p>Fichiers exécutables et répertoires :</p>
<ul>
<li><p>Owner : vitamui (ou vitamuidb)</p></li>
<li><p>Group owner : vitamui</p></li>
<li><p>Droits : 0750</p></li>
</ul>
</li>
</ul>
<p>Cette arborescence ne doit pas contenir de caractère spécial. Les éléments du chemin (notamment le service_id) doivent respecter l’expression régulière suivante : <code class="docutils literal notranslate"><span class="pre">[0-9A-Za-z-_]+</span></code></p>
<p>Le système de déploiement et de gestion de configuration de la solution est responsable de la bonne définition de cette arborescence (tant dans sa structure que dans les droits utilisateurs associés).</p>
</section>
<section id="integration-au-service-d-initialisation-systemd">
<h3><span class="section-number">4.3.3. </span>Intégration au service d’initialisation Systemd<a class="headerlink" href="#integration-au-service-d-initialisation-systemd" title="Lien permanent vers ce titre"></a></h3>
<p>L’intégration est réalisée par l’utilisation du système d’initialisation systemd. La configuration se fait de la manière suivante :</p>
<ul class="simple">
<li><p>/usr/lib/systemd/system/ : répertoire racine des définitions de units systemd de type “service”</p></li>
<li><p>&lt;service_id&gt;.service : fichier de définition du service systemd associé au service VITAMUI</p></li>
</ul>
<p>Les COTS utilisent la même nomenclature de répertoires et utilisateurs que les services VITAMUI, à l’exception des fichiers binaires et bibliothèques qui utilisent les dossiers de l’installation du paquet natif.</p>
</section>
</section>
<hr class="docutils" />
<section id="securisation">
<h2><span class="section-number">4.4. </span>Sécurisation<a class="headerlink" href="#securisation" title="Lien permanent vers ce titre"></a></h2>
<section id="securisation-des-acces-aux-services-externes">
<h3><span class="section-number">4.4.1. </span>Sécurisation des accès aux services externes<a class="headerlink" href="#securisation-des-acces-aux-services-externes" title="Lien permanent vers ce titre"></a></h3>
<p>Les services exposants publiquement des API REST implémentent les mesures de sécurité suivantes :</p>
<ul class="simple">
<li><p>mise en place de filtres dans les applications IHM pour contrer les attaques de type CSRF et XSS</p></li>
<li><p>utilisation du protocole HTTPS. Par défaut, la configuration suivante est appliquée (Protocoles exclus : TLS 1.0, TLS 1.1, SSLv2, SSLv3 &amp; Ciphers exclus : .<em>NULL.</em>, .<em>RC4.</em>, .<em>MD5.</em>, .<em>DES.</em>, .<em>DSS.</em>)</p></li>
<li><p>authentification par certificat X509 requise des applications externes (authentification M2M) basée sur une liste blanche de certificats valides</p></li>
<li><p>mise à jour des droits utilisateurs grâce aux contextes applicatifs, associés certificats clients, stockés dans la collections XXX de base MongoDB gérée par le service SECURITY INTERNAL.</p></li>
<li><p>un service batch contrôle régulièrement l’expiration des certificats stockés dans le truststore des services et dans le référentiel de certificats clients (MongoDB) géré par le service SECURITY INTERNAL.</p></li>
</ul>
</section>
<section id="securisation-des-communications-internes">
<h3><span class="section-number">4.4.2. </span>Sécurisation des communications internes<a class="headerlink" href="#securisation-des-communications-internes" title="Lien permanent vers ce titre"></a></h3>
<p>Les communications internes sont sécurisées par le protocole HTTPS. D’autre part, dans chaque requête, le header X-Auth-Token est positionné. Il contient le token initialisé par CAS à la connexion de l’utilisateur.</p>
<p>A chaque requête le service VITAMUI internal procède aux contrôles suivants :</p>
<ul class="simple">
<li><p>vérification de l’existence du header X-Auth-Token</p></li>
<li><p>vérification de la validité (non expiré) du token extrait du header</p></li>
</ul>
<p>En cas d’échec, la requête est refusée et la connexion est fermée.</p>
</section>
<section id="securisation-des-acces-aux-bases-de-donnees">
<h3><span class="section-number">4.4.3. </span>Sécurisation des accès aux bases de données<a class="headerlink" href="#securisation-des-acces-aux-bases-de-donnees" title="Lien permanent vers ce titre"></a></h3>
<p>Les bases de données de MongoDB sont sécurisées via un cloisonnement physique (réseau) et/ou logique (compte utilisateur) des différentes bases de données qui les constituent.</p>
</section>
<section id="securisation-des-secrets-de-deploiement">
<h3><span class="section-number">4.4.4. </span>Sécurisation des secrets de déploiement<a class="headerlink" href="#securisation-des-secrets-de-deploiement" title="Lien permanent vers ce titre"></a></h3>
<p>Les secrets de l’intégralité de la solution VITAM déployée sont tous présents sur le serveur de déploiement ; par conséquent, ils doivent y être stockés de manière sécurisée, avec les principes suivants :</p>
<ul class="simple">
<li><p>Les mot de passe et token utilisés par ansible doivent être stockés dans des fichiers d’inventaire chiffrés par ansible-vault ;</p></li>
<li><p>Les clés privées des certificats doivent être protégées par des mot de passe complexes et doivent suivre la règle précédente.</p></li>
</ul>
</section>
<section id="liste-des-secrets">
<h3><span class="section-number">4.4.5. </span>Liste des secrets<a class="headerlink" href="#liste-des-secrets" title="Lien permanent vers ce titre"></a></h3>
<p>Les secrets nécessaires au bon déploiement de VITAMUI sont les suivants :</p>
<ul class="simple">
<li><p>Certificat ou mot de passe de connexion SSH à un compte sudoers sur les serveurs cibles (pour le déploiement)</p></li>
<li><p>Certificats x509 serveur (comprenant la clé privée) pour les modules de la zone d’accès (services *-external), ainsi que les CA (finales et intermédiaires) et CRL associées. Ces certificats seront déployés dans des keystores java en tant qu’élément de configuration de ces services</p></li>
<li><p>Certificats x509 client pour les clients du SAE (ex: les applications métier, le service ihm-admin), ainsi que les CA (finales et intermédiaires) et CRL associées. Ces certificats seront déployés dans des keystores java en tant qu’élément de configuration de ces services</p></li>
</ul>
<p>Les secrets définis lors de l’installation de VITAM sont les suivants :</p>
<ul class="simple">
<li><p>Mots de passe des keystores ;</p></li>
<li><p>Mots de passe des administrateurs fonctionnels de l’application VITAMUI</p></li>
<li><p>Mots de passe d’administration de base de données MongoDB ;</p></li>
<li><p>Mots de passe des comptes d’accès aux bases de données MongoDB.</p></li>
</ul>
<p>Note. Les secrets de VITAMUI sont différents de ceux VITAM</p>
</section>
<section id="authentification-du-compte-ssh">
<h3><span class="section-number">4.4.6. </span>Authentification du compte SSH<a class="headerlink" href="#authentification-du-compte-ssh" title="Lien permanent vers ce titre"></a></h3>
<p>Il existe plusieurs méthodes envisageables pour authentifier le compte utilisateur utilisé pour la connexion SSH :</p>
<ul class="simple">
<li><p>par clé SSH avec passphrase</p></li>
<li><p>par login/mot de passe</p></li>
<li><p>par clé SSH sans passphrase</p></li>
</ul>
<p>La méthode d’authentification retenue dépend de plusieurs paramètres :</p>
<ul class="simple">
<li><p>criticité des serveurs (services)</p></li>
<li><p>zone de confiance</p></li>
<li><p>technologie de déploiement</p></li>
</ul>
<p>Dans un contexte sensible, il est fortement recommandé d’utiliser un bastion logiciel (par ex. <a class="reference external" href="https://www.wallix.com/bastion-privileged-access-management/">https://www.wallix.com/bastion-privileged-access-management/</a>) pour authentifier et tracer les actions des administrateurs du système.</p>
</section>
<section id="authentification-des-hotes">
<h3><span class="section-number">4.4.7. </span>Authentification des hôtes<a class="headerlink" href="#authentification-des-hotes" title="Lien permanent vers ce titre"></a></h3>
<p>Pour éviter les attaques de type MitM, le client SSH cherche à authentifier le serveur sur lequel il se connecte. Ceci se base généralement sur le stockage des clés publiques des serveurs auxquels il faut faire confiance (~/.ssh/known_hosts).</p>
<p>Il existe différentes méthodes pour remplir ce fichier (vérification humaine à la première connexion, gestion centralisée, DNSSEC). La gestion du fichier known_hosts est un pré-requis pour le lancement d’ansible.</p>
</section>
<section id="elevation-de-privileges">
<h3><span class="section-number">4.4.8. </span>Élévation de privilèges<a class="headerlink" href="#elevation-de-privileges" title="Lien permanent vers ce titre"></a></h3>
<p>Plusieurs solutions sont envisageables :</p>
<ul class="simple">
<li><p>par sudo avec mot de passe</p>
<ul>
<li><p>Au lancement de la commande ansible, le mot de passe sera demandé par sudo</p></li>
</ul>
</li>
<li><p>par su</p>
<ul>
<li><p>Au lancement de la commande ansible, le mot de passe root sera demandé</p></li>
<li><p>par sudo sans mot de passe</p></li>
</ul>
</li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="certificats-et-pki">
<h2><span class="section-number">4.5. </span>Certificats et PKI<a class="headerlink" href="#certificats-et-pki" title="Lien permanent vers ce titre"></a></h2>
<p>La PKI permet de gérer de manière robuste les certificats de la solution VITAMUI. Une PKI est une architecture de confiance constituée d’un ensemble de systèmes fournissant des services permettant la gestion des cycles de vie des certificats numériques :</p>
<ul class="simple">
<li><p>émission de certificats à des entités préalablement authentifiées</p></li>
<li><p>déploiement des certificats</p></li>
<li><p>révocation des certificats</p></li>
<li><p>établir, publier et respecter des pratiques de certification de confiance pour établir un espace de confiance</p></li>
</ul>
<section id="principes-de-fonctionnement-pki-de-vitamui">
<h3><span class="section-number">4.5.1. </span>Principes de fonctionnement PKI de VITAMUI<a class="headerlink" href="#principes-de-fonctionnement-pki-de-vitamui" title="Lien permanent vers ce titre"></a></h3>
<p>La PKI VITAMUI gère les certificats nécessaires à l’authentification des services VITAMUI et des entités extérieurs. La logique de fonctionnement de la PKI VITAMUI est similaire à celle utilisée par la solution VITAM.</p>
<p>Les principes de fonctionnement de la PKI sont les suivants :</p>
<ul>
<li><p>Émission des certificats VITAMUI (les dates de création et de fin de validité des CA sont générées dans cette phase).</p></li>
<li><p>Gestion du cycle de vie (révocation) des certificats</p></li>
<li><p>Publication des certificats et des clés (.crt et .key)</p></li>
<li><p>Déploiement :</p>
<ul>
<li><p>Génération des magasins de certificats VITAMUI (les certificats .crt et .key sont utilisés pour construire un
magasin de certificats qui contient des certificats .p12 et .jks)</p></li>
<li><p>Déploiement dans VITAMUI des certificats .p12 et .jks par Ansible</p>
<p>Schéma de la PKI :</p>
</li>
</ul>
</li>
</ul>
<p><img alt="PKI" src="../_images/dat_pki_1.png" /></p>
</section>
<section id="explication-avancee-du-fonctionnement">
<h3><span class="section-number">4.5.2. </span>Explication avancée du fonctionnement<a class="headerlink" href="#explication-avancee-du-fonctionnement" title="Lien permanent vers ce titre"></a></h3>
<p>Le fonctionnement de la PKI de la solution VITAMUI est basé sur la même logique d’architecture que celle de Vitam.</p>
<p>Lien des documentations existantes :</p>
<ul class="simple">
<li><p>PKI VITAM : <a class="reference external" href="http://www.programmevitam.fr/ressources/DocCourante/html/installation/annexes/10-overview_certificats.html">http://www.programmevitam.fr/ressources/DocCourante/html/installation/annexes/10-overview_certificats.html</a> &amp; <a class="reference external" href="https://www.programmevitam.fr/ressources/DocCourante/html/installation/annexes/15-certificates.html">https://www.programmevitam.fr/ressources/DocCourante/html/installation/annexes/15-certificates.html</a></p></li>
</ul>
<p>La PKI voit ses fichiers répartis à deux emplacements:</p>
<ul>
<li><p>deployment/pki</p>
<p>À cet emplacement se trouve les scripts et fichiers de configuration associés à la génération des assets (certificats, clés privées …)</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Fichier</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>pki/ca</p></td>
<td><p>Répertoire dans lequel sont stockés les CA de chaque zone</p></td>
</tr>
<tr class="row-odd"><td><p>pki/config</p></td>
<td><p>Répertoire dans lequel sont stockées les configurations pour la génération des CA/certificats</p></td>
</tr>
<tr class="row-even"><td><p>pki/config/scripts</p></td>
<td><p>Répertoire dans lequel sont stockées les scripts de génération de la PKI.</p></td>
</tr>
</tbody>
</table>
</li>
</ul>
</section>
<section id="generation-des-certificats">
<h3><span class="section-number">4.5.3. </span>Génération des certificats<a class="headerlink" href="#generation-des-certificats" title="Lien permanent vers ce titre"></a></h3>
<p>Revenons en détails sur les scripts de génération des différents éléments de la PKI:</p>
<ul class="simple">
<li><p>generate_ca*.sh:</p>
<ul>
<li><p>Paramètre(s):</p>
<ul>
<li><p>ERASE [Facultatif]: Booléen indiquant si les CA et fichiers associés existants doivent être supprimés avant génération - Valeur par défaut: <strong>false</strong></p></li>
</ul>
</li>
<li><p>Description:
Permet de générer les certificats d’autorité mentionnées dans le script de génération. Attention, toute autorité existante n’est pas regénérée, l’utilisation du paramètre <strong>ERASE</strong> sera recommandée lors de la première génération de la PKI.</p></li>
</ul>
</li>
<li><p>generate_certs*.sh</p>
<ul>
<li><p>Paramètre(s):</p>
<ul>
<li><p>ENVIRONNEMENT_FILE [Obligatoire]: Chemin vers le fichier d’environnement pour lequel les certificats vont être générés</p></li>
<li><p>ERASE [Facultatif]: Booléen indiquant si les certificats et fichiers associés existants doivent être supprimés avant génération - Valeur par défaut: <strong>false</strong></p></li>
</ul>
</li>
<li><p>Description:
Permet de générer les certificats (serveur, client) mentionnés dans le script de génération. Attention, tout certificat existant n’est pas regénéré, l’utilisation du paramètre <strong>ERASE</strong> sera recommandée lors de la première génération de la PKI. Deux types de fichiers seront modifiés lors de cette exécution:</p>
<ul>
<li><p>les fichiers de configuration des CA (serial, index.txt …)</p></li>
<li><p>les fichiers générés (<code class="docutils literal notranslate"><span class="pre">deployment/environment/certs</span></code>)</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Les scripts suffixés par <strong>_dev</strong> concernent le matériel SSL utilisé pour le lancement de l’application en local sur l’environnement de développement. L’ensemble des fichiers générés se trouveront dans l’arborescence <strong>dev-deployment</strong> du projet. Il faudra par la suite copier les fichiers générés associés à chaque module dans le répertoire /resources/dev du projet associé.</p>
<ul class="simple">
<li><p>deployment/environment/certs</p></li>
</ul>
<p>À cet emplacement figure l’ensemble de la PKI de la solution. Par défaut, on retrouvera trois zones (une par autorité):</p>
<ul class="simple">
<li><p>server: l’ensemble du certificats permettant la communication HTTPS entre les différentes applications de la solution</p></li>
<li><p>client-vitam: certificats utilisés par l’application pour communiquer avec Vitam. Avec le script <strong>generate_certs.sh</strong> fournis par la PKI, un certificat sera généré pour s’interfacer avec Vitam.</p></li>
<li><p>client-external: certificats des clients autorisés à solliciter les API externes</p></li>
</ul>
</section>
<section id="cas-pratiques">
<h3><span class="section-number">4.5.4. </span>Cas pratiques<a class="headerlink" href="#cas-pratiques" title="Lien permanent vers ce titre"></a></h3>
<ul>
<li><p>Instaurer la communication entre la solution VitamUI &lt;-&gt; Vitam</p>
<p>Quelques rappels:</p>
<ul class="simple">
<li><p>au sein de la solution VitamUI, vous avez:</p>
<ul>
<li><p>un client Vitam Java (access-external, ingest-external) permettant de réaliser des requêtes aurpès de Vitam.
Ce client se base sur un fichier de configuration dans lesquels sont référencés un <strong>keystore</strong> (concenant le certificat utilisé pour chiffrer la requête) et un <strong>trustore</strong> (contenant le(s) CA(s) utilisé(s) pour les échanges avec les applications à l’extérieur de VitamUI)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/environement/certs/client-vitam/ca</span></code>: certificat d’autorité intervenant dans la communication VitamUI &lt;-&gt; Vitam.
/!\ L’ensemble des CA présents dans ce répertoire seront embarqués dans le truststore exploité par le client Vitam Java lors de l’exécution du script <em>generate_keystores.sh</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment/environement/certs/client-vitam/clients/vitamui</span></code>: certificat utilisé pour la communication VitamUI &lt;-&gt; Vitam.
/!\ Le certificat sera embarqué dans le keystore utilisé par le client Vitam Java lors de l’exécution du script <em>generate_keystores.sh</em>.</p></li>
</ul>
</li>
<li><p>au sein de la solution Vitam, vous avez:</p>
<ul>
<li><p>au sein du modèle de données, un certificat est associé à un contexte de sécurité (restriction d’actions par tenant à travers des contrats), lui-même associé à un profile de sécurité (permission sur les API externes).
Cette association s’effectue dans le fichier <code class="docutils literal notranslate"><span class="pre">environment/group_vars/all/postinstall_param.yml</span></code></p></li>
<li><p>la structure de la PKI VitamUI étant identique à celle de Vitam, le comportement est le suivant:</p>
<ul>
<li><p>tout CA utilisé par un client pour solliciter les API externes et nécessaire à la chaîne de vérification de son certificat doit se trouver dans le répertoire <code class="docutils literal notranslate"><span class="pre">envionment/certs/client-external/ca</span></code>
/!\ L’ensemble des CA présents dans ce répertoire seront embarqués dans le truststore exploités par les API externes lors de l’exécution du script <em>generate_keystores.sh</em>.</p></li>
<li><p>le certificat d’un client accédant aux API externes doit figurer à l’emplacement <code class="docutils literal notranslate"><span class="pre">envionment/certs/client-external/clients/external</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>De ce fait, vous devez synchroniser vos PKI et vos solutions pour assurer une bonne communication:</p>
<ul>
<li><p>VitamUI -&gt; Vitam</p>
<ul>
<li><p>Copier le CA du certificat VitamUI <code class="docutils literal notranslate"><span class="pre">{vitamui_inventory_dir}/certs/client-vitam/ca/ca-*.crt</span></code> dans <code class="docutils literal notranslate"><span class="pre">{vitam_inventory_dir}/certs/client-external/ca</span></code></p></li>
<li><p>Copier le certificat VitamUI <code class="docutils literal notranslate"><span class="pre">{vitamui_inventory_dir}/certs/client-vitam/clients/vitamui/vitamui.crt</span></code> dans <code class="docutils literal notranslate"><span class="pre">{vitam_inventory_dir}/certs/client-external/clients/external</span></code></p></li>
<li><p>Mise à jour de la PKI Vitam:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">./generate_stores.sh</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible-playbook</span> <span class="pre">ansible-vitam/vitam.yml</span> <span class="pre">${ANSIBLE_OPTS}</span> <span class="pre">--tags</span> <span class="pre">update_vitam_certificates</span></code></p></li>
</ul>
</li>
<li><p>Création du contexte VitamUI:</p>
<ul>
<li><p>Population du fichier postinstall_param.yml:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="nt">vitam_additional_securityprofiles</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vitamui-security-profile</span><span class="w"></span>
<span class="w">    </span><span class="nt">identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vitamui-security-profile</span><span class="w"></span>
<span class="w">    </span><span class="nt">hasFullAccess</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">    </span><span class="nt">permissions</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">contexts</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vitamui-context</span><span class="w"></span>
<span class="w">        </span><span class="nt">identifier</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">vitamui-context</span><span class="w"></span>
<span class="w">        </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ACTIVE</span><span class="w"></span>
<span class="w">        </span><span class="nt">enable_control</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">        </span><span class="c1"># No control, idc about permissions, VitamUI will do it :)</span><span class="w"></span>
<span class="w">        </span><span class="nt">permissions</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;[</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">\&quot;tenant\&quot;:</span><span class="nv"> </span><span class="s">0,</span><span class="nv"> </span><span class="s">\&quot;AccessContracts\&quot;:</span><span class="nv"> </span><span class="s">[],</span><span class="nv"> </span><span class="s">\&quot;IngestContracts\&quot;:</span><span class="nv"> </span><span class="s">[]</span><span class="nv"> </span><span class="s">},</span><span class="nv"> </span><span class="s">{</span><span class="nv"> </span><span class="s">\&quot;tenant\&quot;:</span><span class="nv"> </span><span class="s">1,</span><span class="nv"> </span><span class="s">\&quot;AccessContracts\&quot;:</span><span class="nv"> </span><span class="s">[],</span><span class="nv"> </span><span class="s">\&quot;IngestContracts\&quot;:</span><span class="nv"> </span><span class="s">[]</span><span class="nv"> </span><span class="s">}]&quot;</span><span class="w"></span>
<span class="w">        </span><span class="nt">certificates</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;external/vitamui.crt&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Exécution du playbook de mise à jour : <code class="docutils literal notranslate"><span class="pre">ansible-playbook</span> <span class="pre">ansible-vitam-exploitation/add_contexts.yml</span></code></p></li>
</ul>
</li>
</ul>
</li>
<li><p>Vitam -&gt; VitamUI</p>
<ul class="simple">
<li><p>Copier le(s) CA(s) de Vitam <code class="docutils literal notranslate"><span class="pre">{vitam_inventory_dir}/certs/client-vitam/ca</span></code> dans <code class="docutils literal notranslate"><span class="pre">{vitamui_inventory_dir}/certs/client-vitam/ca/</span></code></p></li>
<li><p>Mise à jour de la PKI VitamUI :</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">./generate_stores.sh</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ansible-playbook</span> <span class="pre">vitamui_apps.yml</span> <span class="pre">--tags</span> <span class="pre">update_vitamui_certificates</span></code></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Instaurer la communication entre la solution VitamUI &lt;-&gt; <em>Le monde extérieur</em>
TODO (le process n’est pas encore industrialisé)</p></li>
</ul>
</section>
<section id="pki-de-test">
<h3><span class="section-number">4.5.5. </span>PKI de test<a class="headerlink" href="#pki-de-test" title="Lien permanent vers ce titre"></a></h3>
<p>VITAMUI propose de générer à partir d’une PKI de tests les autorités de certification root et intermédiaires pour les clients et les serveurs. Cette PKI de test permet de connaître facilement l’ensemble des certificats nécessaires au bon fonctionnement de la solution. Attention, la PKI de test ne doit être utilisée que pour faire des tests, et ne doit surtout pas être utilisée en environnement de production.</p>
</section>
<section id="liste-des-certificats-utilises">
<h3><span class="section-number">4.5.6. </span>Liste des certificats utilisés<a class="headerlink" href="#liste-des-certificats-utilises" title="Lien permanent vers ce titre"></a></h3>
<p>Le tableau ci-dessous détail l’ensemble du contenu des keystores et truststores par service.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Composants</p></th>
<th class="head"><p>Keystores</p></th>
<th class="head"><p>Truststores</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>ui-portal</strong></p></td>
<td><p>ui-portal.crt, ui-portal.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>ui-identity</strong></p></td>
<td><p>ui-identity.crt, ui-identity.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>ui-identity-admin</strong></p></td>
<td><p>ui-identity-admin.crt, ui-identity-admin.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>ui-referential</strong></p></td>
<td><p>ui-referential.crt, ui-referential.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>ui-ingest</strong></p></td>
<td><p>ui-ingest.crt, ui-ingest.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>ui-archive-search</strong></p></td>
<td><p>ui-archive-search.crt, ui-archive-search.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>cas-server</strong></p></td>
<td><p>cas-server.crt, cas-server.key</p></td>
<td><p>ca-root.crt, ca-intermediate.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>iam-external</strong></p></td>
<td><p>iam-external.crt, iam-external.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>iam-internal</strong></p></td>
<td><p>iam-internal.crt, iam-internal.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>referential-external</strong></p></td>
<td><p>referential-external.crt, referential-external.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>referential-internal</strong></p></td>
<td><p>referential-internal.crt, referential-internal.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>ingest-external</strong></p></td>
<td><p>ingest-external.crt, ingest-external.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>ingest-internal</strong></p></td>
<td><p>ingest-internal.crt, ingest-internal.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>archive-search-external</strong></p></td>
<td><p>archive-search-external.crt, archive-external.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-even"><td><p><strong>archive-search-internal</strong></p></td>
<td><p>archive-search-internal.crt, archive-internal.key</p></td>
<td><p>ca-root.crt</p></td>
</tr>
<tr class="row-odd"><td><p><strong>security-server</strong></p></td>
<td><p>security-server.crt, security-server</p></td>
<td><p>ca-root.crt</p></td>
</tr>
</tbody>
</table>
<p>La liste des certificats utilisées par VITAM est décrite à cette adresse : <a class="reference external" href="http://www.programmevitam.fr/ressources/DocCourante/html/archi/securite/20-certificates.html">http://www.programmevitam.fr/ressources/DocCourante/html/archi/securite/20-certificates.html</a></p>
</section>
<section id="procedure-dajout-dun-certificat-client-externe">
<h3><span class="section-number">4.5.7. </span>Procédure d’ajout d’un certificat client externe<a class="headerlink" href="#procedure-dajout-dun-certificat-client-externe" title="Lien permanent vers ce titre"></a></h3>
<p>Le certificat ou l’autorité de certification doit présent dans les truststores des APIs external VITAMUI. La procédure d’ajout d’un certificat client externe aux truststores des services de VITAMUI est la suivante :</p>
<ul class="simple">
<li><p>Déposer le(s) CA(s) du client dans le répertoire deployment/environment/certs/client-external/ca</p></li>
<li><p>Déposer le certificat du client dans le répertoire deployment/environment/certs/client-external/clients/external/</p></li>
<li><p>Régénérer les keystores à l’aide du script deployment/generate_stores.sh</p></li>
<li><p>Exécuter le playbook pour redéployer les keystores sur la solution VITAMUI :</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ansible-playbook vitamui_apps.yml -i environments/hosts --vault-password-file vault_pass.txt --tags update_vitamui_certificates
</pre></div>
</div>
<p>L’utilisation d’un certificat client sur les environnements VITAMUI nécessite également de vérifier que le certificat soit présent dans la base de données VITAMUI et rattaché à un contexte de sécurité du client.</p>
</section>
</section>
<hr class="docutils" />
<section id="clusterisation">
<h2><span class="section-number">4.6. </span>Clusterisation<a class="headerlink" href="#clusterisation" title="Lien permanent vers ce titre"></a></h2>
<section id="multi-instanciation-du-service-iam-internal">
<h3><span class="section-number">4.6.1. </span>Multi-instanciation du service iam-internal<a class="headerlink" href="#multi-instanciation-du-service-iam-internal" title="Lien permanent vers ce titre"></a></h3>
<p>Si le service <code class="docutils literal notranslate"><span class="pre">iam-internal</span></code> est déployé sur plusieurs machines, les timers permettant la journalisation des évènements métiers de Vitam-UI seront lancés sur la première instance du groupe <code class="docutils literal notranslate"><span class="pre">[hosts_vitamui_iam_internal]</span></code>. Seul une machine doit être déclarée primaire afin d’éviter la duplication des actions de journalisation.</p>
<p>Pour plus d’informations, se référer au DEX.</p>
</section>
</section>
<hr class="docutils" />
<section id="detail-des-services">
<h2><span class="section-number">4.7. </span>Détail des services<a class="headerlink" href="#detail-des-services" title="Lien permanent vers ce titre"></a></h2>
<section id="service-1">
<h3><span class="section-number">4.7.1. </span>Service 1<a class="headerlink" href="#service-1" title="Lien permanent vers ce titre"></a></h3>
<ul class="simple">
<li><p>Description</p></li>
<li><p>Contraintes</p></li>
</ul>
</section>
<section id="service-2">
<h3><span class="section-number">4.7.2. </span>Service 2<a class="headerlink" href="#service-2" title="Lien permanent vers ce titre"></a></h3>
<ul class="simple">
<li><p>Description</p></li>
<li><p>Contraintes</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="detail-des-cots">
<h2><span class="section-number">4.8. </span>Détail des COTS<a class="headerlink" href="#detail-des-cots" title="Lien permanent vers ce titre"></a></h2>
<section id="cas">
<h3><span class="section-number">4.8.1. </span>CAS<a class="headerlink" href="#cas" title="Lien permanent vers ce titre"></a></h3>
<ul class="simple">
<li><p>Description</p></li>
<li><p>Contraintes</p></li>
</ul>
</section>
<section id="annuaire-de-services-consul">
<h3><span class="section-number">4.8.2. </span>Annuaire de services Consul<a class="headerlink" href="#annuaire-de-services-consul" title="Lien permanent vers ce titre"></a></h3>
<ul class="simple">
<li><p>Description</p></li>
<li><p>Contraintes</p></li>
</ul>
<p>La découverte des services est réalisée avec Consul via l’utilisation du protocole DNS. Le service DNS configuré lors du déploiement doit pouvoir résoudre les noms DNS associés à la fois aux service_id et aux instance_id. Tout hôte portant un service VITAMUI doit utiliser ce service DNS par défaut. L’installation et la configuration du service DNS applicatif sont intégrées à VITAMUI.</p>
<p>La résilience est assurée par l’annuaire de service Consul. Il est partagé avec VITAM.</p>
<ul class="simple">
<li><p>Les services sont enregistrés au démarrage dans Consul</p></li>
<li><p>Les clients utilisent Consul (mode DNS) pour localiser les services</p></li>
<li><p>Consul effectue régulièrement des health checks sur les services enregistrés. Ces informations sont utilisées pour router les demandes des clients sur les services actifs</p></li>
</ul>
<p>La solution de DNS applicatif intégrée à VITAMUI et VITAM est présentée plus en détails dans la section dédiée à Consul dans la documentation VITAM.</p>
</section>
<section id="base-nosql-mongodb">
<h3><span class="section-number">4.8.3. </span>Base NOSQL MongoDB<a class="headerlink" href="#base-nosql-mongodb" title="Lien permanent vers ce titre"></a></h3>
<ul class="simple">
<li><p>Description</p></li>
<li><p>Contraintes</p></li>
</ul>
</section>
</section>
<hr class="docutils" />
<section id="multi-instanciation-des-micro-services">
<h2><span class="section-number">4.9. </span>Multi instanciation des micro services<a class="headerlink" href="#multi-instanciation-des-micro-services" title="Lien permanent vers ce titre"></a></h2>
<section id="multi-instanciation">
<h3><span class="section-number">4.9.1. </span>Multi instanciation<a class="headerlink" href="#multi-instanciation" title="Lien permanent vers ce titre"></a></h3>
<p>Les services vitamui multi instanciable à ce jour sont :</p>
<ul class="simple">
<li><p>Service IAM Internal</p></li>
<li><p>Service IAM External</p></li>
<li><p>Service UI Identity</p></li>
<li><p>Service Portal</p></li>
<li><p>Service Referential Internal</p></li>
<li><p>Service Referential External</p></li>
<li><p>Service UI Referential</p></li>
<li><p>Service Ingest Internal</p></li>
<li><p>Service Ingest External</p></li>
<li><p>Service UI Ingest</p></li>
<li><p>Service Archive Search Internal</p></li>
<li><p>Service Archive Search External</p></li>
<li><p>Service UI Archive Search</p></li>
<li><p>Service Mongod (en cours de mise à niveau/!\)</p></li>
</ul>
<p>Un load balancer/reverse proxy (à défaut Consul) est installé et configuré pour la répartition de charge entre différentes instances (cette configurtion est en cours de réalisation).</p>
<p>La configuration de la mémoire des services est par défaut:</p>
<div class="highlight-conf notranslate"><div class="highlight"><pre><span></span>Xms=512m et Xmx=512m
</pre></div>
</div>
<p>Cette configuration est modifiable dans les jvm_opts de l’ansiblerie, pour plus d’informations (cf: DEX).</p>
</section>
<section id="mono-instanciation">
<h3><span class="section-number">4.9.2. </span>Mono instanciation<a class="headerlink" href="#mono-instanciation" title="Lien permanent vers ce titre"></a></h3>
<p>Le service CAS est actuellement mono-instanciable.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Pied de page">
        <a href="architecture.html" class="btn btn-neutral float-left" title="3. Architecture" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Précédent</a>
        <a href="gestion.html" class="btn btn-neutral float-right" title="5. Gestion du système" accesskey="n" rel="next">Suivant <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Programme Vitam.</p>
  </div>

  Compilé avec <a href="https://www.sphinx-doc.org/">Sphinx</a> en utilisant un
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">thème</a>
    fourni par <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>