

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Plugin Worker &mdash; documentation VITAM - Architecture 0.26.1</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Recherche" href="../../../search.html"/>
    <link rel="top" title="documentation VITAM - Architecture 0.26.1" href="../../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> VITAM - Architecture
          

          
            
            <img src="../../../_static/LogoVitamGrand2.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                0.26.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/_toc.html">3. Vue d&#8217;ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../archi-applicative/_toc.html">4. Architecture applicative</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../archi-exploit-infra/_toc.html">5. Architecture technique / exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../securite/_toc.html">6. Securite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_toc.html">7. Architecture détaillée</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">VITAM - Architecture</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
    <li>Plugin Worker</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/include/worker/technique/worker-plugin.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="plugin-worker">
<h1>Plugin Worker<a class="headerlink" href="#plugin-worker" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="but-de-cette-documentation">
<h2>But de cette documentation<a class="headerlink" href="#but-de-cette-documentation" title="Lien permanent vers ce titre">¶</a></h2>
<p>L&#8217;objectif de cette documentation est d&#8217;expliquer l&#8217;architecture technique des plugins de worker.</p>
<ol class="arabic simple">
<li>Introduction</li>
</ol>
<p>Le plugin worker est une classe java qui réaslise des actions dans le workflow comme les Handler.
Dans le workflow, si l&#8217;action traite une action qui a besoin un enregistrement JCV, le plugin sera remplacé
le Handler.</p>
<p>Le plugin prends en entrée une interface HandlerIO pour charger les fichier de vitam, les paramètres du worker
En sortie, il retourne les status des traitements et chaque status contient un code de traitement
(définit dans le fichier properties du plugin, si ce n’est pas définit on utilise le code par défaut)</p>
<p>D&#8217;une façon synthétique, le plugin worker est décrit de cette façon :</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../../../_images/plugin.png"><img alt="../../../_images/plugin.png" src="../../../_images/plugin.png" style="height: 25cm;" /></a>
</div>
<ol class="arabic simple" start="2">
<li>Appel du plugin&nbsp;:</li>
</ol>
<p>Au démarrage du service, le serveur worker charger tous les  plugins et leurs fichier de properties.
Les référentiels de plugin sont déclaré dans un fichier de configuration&nbsp;:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;NOM_DE_PLUGIN_1&quot;</span><span class="p">:</span> <span class="p">{</span>
     <span class="nt">&quot;className&quot;</span><span class="p">:</span> <span class="s2">&quot;package.plugin.class_1&quot;</span><span class="p">,</span>
     <span class="nt">&quot;propertyFile&quot;</span><span class="p">:</span> <span class="s2">&quot;le_fichier_de_properties_1&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;NOM_DE_PLUGIN_2&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;className&quot;</span><span class="p">:</span> <span class="s2">&quot;package.plugin.class_2&quot;</span><span class="p">,</span>
    <span class="nt">&quot;propertyFile&quot;</span><span class="p">:</span> <span class="s2">&quot;le_fichier_de_properties_2&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Au démarrage de chaque worker, la liste des plugins va être analysé. Puis le serveur va tenter d&#8217;instancier chaque plugin de la liste.
Si un des plugins ne se lance pas pour une raison quelconque (nom de classe incorrect, impossible d&#8217;instancier la classe, ...), alors le serveur ne démarrera pas.</p>
<p>Les plugins ne sont pas pour l&#8217;instant thread safe dans Vitam, ce qui signifie que un plugin est réinstancié pour chaque appel au serveur worker.</p>
<ol class="arabic simple" start="3">
<li>Résultat du plugin</li>
</ol>
<p>Après ses traitements, Plugin doit retourner au Worker un ItemStatus. Quand le Worker reçoit le résultat&nbsp;:</p>
<ul class="simple">
<li>Il doit le traduire en utilisant par défaut le fichier de properties VITAM (vitam-logbook-messages_fr.properties)</li>
</ul>
<p>si les clés ne sont pas définies dans ce fichier alors il va chercher la valeur du label dans le fichier properties
du plug-in puis envoit à Engine pour écrire dans les journaux des opération.</p>
<ul class="simple">
<li>Construire et écrire LogbookLifeCycle.</li>
</ul>
<ol class="arabic simple" start="4">
<li>Implémentation</li>
</ol>
<p>4.1. Worker
- getActionHandler: pour chaque action, le worker vérifie si l’action est dans la liste des plugins, il va le charger, si non on utilise les handlers prédéfinis dans Vitam
- writeLogbookLifeCycle&nbsp;: traduire le code d’action d’un ItemStatus du Plugin en LogbookLifeCycleParameters puis en fonction du type d’élément dans la distribution (Unit ou ObjectGroup), il écrit dans la base de données correspondante</p>
<p>Exemple: Le plugin CHECK_DIGEST fait un traitement CALC_CHECK qui donne un status OK.</p>
<p>Le résultat retourné du plugin contiendra</p>
<div class="highlight-json"><div class="highlight"><pre><span></span>{
      «globalStatus » : OK ,
      « itemsStatus » : [ {« CALC_CHECK » :  { «globalStatus » : OK  }}]
}
</pre></div>
</div>
<p>Alors le Worker va écrire ces événements ci-dessous dans LFC&nbsp;:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span>{
    {
         &quot;evType&quot; : &quot;LFC.CHECK_DIGEST &quot;,
         &quot;outcome&quot; : &quot;OK&quot;,
         &quot;outDetail&quot; : &quot;LFC.CHECK_DIGEST..OK&quot;,
    }
    {
         &quot;evType&quot; : &quot;LFC.CHECK_DIGEST.CALC_CHECK &quot;,
         &quot;outcome&quot; : &quot;OK&quot;,
         &quot;outDetail&quot; : &quot;LFC.CHECK_DIGEST.CALC_CHECK.OK&quot;,
    }
}
</pre></div>
</div>
<p>L’écriture des journaux des opérations garde son implémentation.</p>
<p>4.2. PluginPropertiesLoader
c&#8217;est un service pour charger les définitions du code dans le fichier de properties du plugin</p>
<p>4.3 Intégration</p>
<p>Cela définit comment Worker appelle les plugins.</p>
<p><code class="docutils literal"><span class="pre">java</span> <span class="pre">-cp</span> <span class="pre">&quot;/vitam/lib/${unix.name}/*&quot;</span> <span class="pre">fr.gouv.vitam.worker.server.rest.WorkerApplication</span></code>
au lieu de
<code class="docutils literal"><span class="pre">java</span> <span class="pre">-jar</span> <span class="pre">&quot;/vitam/lib/${unix.name}/${project.build.finalName}.jar&quot;</span></code></p>
<p>Donc les JAR du plugin doit être placé dans /vitam/lib/worker/</p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0.26.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>