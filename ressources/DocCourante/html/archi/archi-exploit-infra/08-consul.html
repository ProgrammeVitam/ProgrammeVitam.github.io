<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.9. Service registry &mdash; Documentation VITAM - Architecture 8.1.0</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.10. Dépendances aux services d’infrastructures" href="10-it-services.html" />
    <link rel="prev" title="5.8. Outillage de déploiement" href="07-deployment-tooling.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VITAM - Architecture
              <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/_toc.html">3. Vue d’ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../archi-applicative/_toc.html">4. Architecture applicative</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Architecture technique / exploitation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="principes/_toc.html">5.1. Principes d’architecture technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="01-services-techniques.html">5.2. Services techniques fournis par la solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-dependencies.html">5.3. Composants logiciels utilisés</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-technical-architecture.html">5.4. Architecture technique détaillée</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-data-storage.html">5.5. Stockage des données</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-logs-architecture.html">5.6. Concentration et exploitation des logs applicatifs</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-metrics-architecture.html">5.7. Métriques applicatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="07-deployment-tooling.html">5.8. Outillage de déploiement</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.9. Service registry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#architecture">5.9.1. Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resolution-dns">5.9.2. Résolution DNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multi-site">5.9.3. Multi-site</a></li>
<li class="toctree-l3"><a class="reference internal" href="#packaging">5.9.4. Packaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">5.9.5. Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="10-it-services.html">5.10. Dépendances aux services d’infrastructures</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-services.html">5.11. Composants déployés</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-deployment-guidelines.html">5.12. Guidelines de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="25-resources.html">5.13. Eléments de dimensionnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-flux-all.html">5.14. Matrice des flux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../securite/_toc.html">6. Sécurité</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">7. Architecture détaillée</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Architecture</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="_toc.html">5. Architecture technique / exploitation</a></li>
      <li class="breadcrumb-item active">5.9. Service registry</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/archi-exploit-infra/08-consul.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="service-registry">
<h1>5.9. Service registry<a class="headerlink" href="#service-registry" title="Lien permanent vers ce titre">¶</a></h1>
<p>Le <em>service registry</em> est le composant permettant à chaque service de localiser les services dont il dépend ; par conséquent, son bon fonctionnement est particulièrement critique pour le bon fonctionnement de la solution logicielle  <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>.
L’outil de <em>service registry</em> utilisé par <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> est <a class="reference external" href="https://www.consul.io">Consul</a>.</p>
<div class="section" id="architecture">
<h2>5.9.1. Architecture<a class="headerlink" href="#architecture" title="Lien permanent vers ce titre">¶</a></h2>
<p>Un déploiement Consul est composé de 2 types de noeuds différents :</p>
<ul class="simple">
<li>Les noeuds serveurs : ils persistent l’état des données stockées dans Consul ; les données sont répliquées entre eux, et eux seuls participent à l’élection du maître (ils forment un cluster Raft). Un quorum de ces noeuds doit toujours être déclaré ; dans le cas contraire, on entre dans un cas de désastre de cluster (Cf. <a class="reference external" href="https://www.consul.io/docs/guides/outage.html">la documentation sur l“«&nbsp;outage recovery&nbsp;»</a> ) ; le nombre de serveurs doit être impair, avec un minimum conseillé de 3 noeuds (pour des problématiques de maintien de quorum).</li>
<li>Les noeuds client : ils exposent les <a class="reference internal" href="../introduction.html#term-api"><span class="xref std std-term">API</span></a> d’accès aux structures de données Consul, et réalisent les <em>healthchecks</em> des services dont ils ont la définition. Ils communiquent avec les serveurs.</li>
</ul>
<p>Un noeud Consul est également appelé un agent.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les noeuds serveurs sont en fait des noeuds clients réifiés, i.e. ils ont également les capacités des clients.</p>
</div>
<p>Dans le cadre de  <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>, le déploiement des noeuds Consul doit correspondre aux principes suivants :</p>
<ul class="simple">
<li>Un cluster de serveurs Consul sur un nombre impair de noeuds dédiés, chacun d’entre eux étant configuré pour exposer l”<a class="reference internal" href="../introduction.html#term-ihm"><span class="xref std std-term">IHM</span></a> de suivi ;</li>
<li>1 client par serveur hébergeant un service <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>.</li>
</ul>
<div class="admonition hint">
<p class="first admonition-title">Indication</p>
<p class="last">Préconisation : Le fonctionnement de Consul via trois noeuds <em>master</em> au minimum nous prémunit de la perte d’un de ces noeuds sans perturbation du service. Un seul noeud Consul est vivement déconseillé.</p>
</div>
</div>
<div class="section" id="resolution-dns">
<h2>5.9.2. Résolution DNS<a class="headerlink" href="#resolution-dns" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les résolutions de noms de service se font via l”<a class="reference internal" href="../introduction.html#term-api"><span class="xref std std-term">API</span></a> <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> de Consul ; un <em>resolver</em> externe doit être configuré pour les requêtes externes.</p>
<p>Chaque client agit comme serveur <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> local ; il écoute sur le port udp 53 (sur la boucle locale - <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code>), et est configuré comme serveur <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> de l”<a class="reference internal" href="../introduction.html#term-os"><span class="xref std std-term">OS</span></a> (typiquement dans le fichier <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>).</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cela rend Consul incompatible avec d’autres implémentations de serveur <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> qui seraient lancées sur l”<a class="reference internal" href="../introduction.html#term-os"><span class="xref std std-term">OS</span></a>, et en particulier les caches <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> installés par défaut dans certaines distributions linux (ex: dnsmasq). En outre, il faut prendre garde à l’écrasement de la configuration du <code class="docutils literal notranslate"><span class="pre">resolv.conf</span></code>, qui doit garder <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> comme premier serveur <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pour pouvoir écouter sur le port 53, Consul nécessite la capacité <code class="docutils literal notranslate"><span class="pre">CAP_NET_BIND_SERVICE</span></code> (Cf. la section suivante).</p>
</div>
<p>Lorsque le système fait une requête <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a>, cette dernière arrive à l’agent Consul local et la séquence suivante est exécutée :</p>
<ul class="simple">
<li>Si le nom à résoudre appartient au domaine réservé pour Consul (par défaut <code class="docutils literal notranslate"><span class="pre">consul</span></code>), il est résolu en tant que nom de service ou de noeud (Cf. <a class="reference external" href="https://www.consul.io/docs/agent/dns.html">la documentation officielle concernant l’interface DNS</a>) ;</li>
<li>Dans le cas contraire, la requête est transmise aux serveurs <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> configurés dans la liste des <a class="reference external" href="https://www.consul.io/docs/agent/options.html#recursors">recursors</a>).</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Consul a pour l’instant été configuré en mode <code class="docutils literal notranslate"><span class="pre">allow_stale</span> <span class="pre">=</span> <span class="pre">false</span></code> (cf. <a class="reference external" href="https://www.consul.io/docs/agent/options.html#allow_stale">la directive de configuration</a>), ce qui signifie que chaque requête DNS se traduit par un appel RPC au noeud <em>leader</em> des serveurs Consul. Cela permet d’assurer la consistance des réponses DNS, mais peut potentiellement poser des problèmes de performance sur des larges déploiements. Il est possible de changer ce comportement (clés de configuration <code class="docutils literal notranslate"><span class="pre">allow_stale</span></code> et <code class="docutils literal notranslate"><span class="pre">max_stale</span></code> - qui permettent de préciser la durée maximum pendant laquelle le noeud répond aux requêtes DNS sans interroger le <em>leader</em>), et également de changer le <a class="reference internal" href="../introduction.html#term-ttl"><span class="xref std std-term">TTL</span></a> des réponses DNS (qui est par défaut gardé à 0).</p>
</div>
</div>
<div class="section" id="multi-site">
<h2>5.9.3. Multi-site<a class="headerlink" href="#multi-site" title="Lien permanent vers ce titre">¶</a></h2>
<p>En multi-site, la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> exploite les <em>datacenters</em> consul. Un <em>datacenter</em> consul est créé par site.</p>
<p>Chaque site doit posséder au moins 3 serveurs consul, qui ne supervisent que les services dans le datacenter auquel ils sont rattachés.</p>
</div>
<div class="section" id="packaging">
<h2>5.9.4. Packaging<a class="headerlink" href="#packaging" title="Lien permanent vers ce titre">¶</a></h2>
<p>La solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> intègre des packages <a class="reference internal" href="../introduction.html#term-os"><span class="xref std std-term">OS</span></a> (rpm &amp; deb) dédiés pour Consul ; ces packages permettent essentiellement :</p>
<ul class="simple">
<li>De configurer Consul en tant que service systemd ;</li>
<li>De permettre le lancement de Consul sous l’utilisateur <code class="docutils literal notranslate"><span class="pre">vitam</span></code> ;</li>
<li>Enfin, ils intègrent une directive <code class="docutils literal notranslate"><span class="pre">setcap</span></code> de post-install pour attribuer la capacité <code class="docutils literal notranslate"><span class="pre">CAP_NET_BIND_SERVICE</span></code> au binaire <code class="docutils literal notranslate"><span class="pre">/vitam/bin/consul/consul</span></code> afin de permettre à ce dernier d’exposer une interface <a class="reference internal" href="../introduction.html#term-dns"><span class="xref std std-term">DNS</span></a> sur le port 53 sans pour autant nécessiter les droits <em>root</em>.</li>
</ul>
</div>
<div class="section" id="monitoring">
<h2>5.9.5. Monitoring<a class="headerlink" href="#monitoring" title="Lien permanent vers ce titre">¶</a></h2>
<p>Chaque instance de service doit être déclarée dans Consul ; cette déclaration se fait en déposant un fichier de configuration dans le répertoire de configuration de Consul. Ce fichier contient notamment l’identifiant du service ainsi que son port d’écoute, ainsi qu’une liste de <em>healthchecks</em> qui permettent à Consul de connaître l’état du service. Pour les services <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>, ces <em>healthchecks</em> s’appuient sur les <a class="reference internal" href="../introduction.html#term-api"><span class="xref std std-term">API</span></a> de supervision qui ont été décrites dans <a class="reference internal" href="principes/40-principles-monitoring.html"><span class="doc">la section dédiée</span></a>.</p>
<p>Consul permet d’exposer une <a class="reference internal" href="../introduction.html#term-ihm"><span class="xref std std-term">IHM</span></a> Web permettant d’accéder à la topologie des services déployés (i.e. quel service sur quel noeud) et à leur état instantané.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="07-deployment-tooling.html" class="btn btn-neutral float-left" title="5.8. Outillage de déploiement" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="10-it-services.html" class="btn btn-neutral float-right" title="5.10. Dépendances aux services d’infrastructures" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>