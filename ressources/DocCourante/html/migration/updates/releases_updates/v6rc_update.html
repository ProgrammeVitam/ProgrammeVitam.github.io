<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.3.5. Notes et procédures spécifiques V6RC &mdash; Documentation VITAM - Documentation de montées de version 8.1.0</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="4.3.6. Notes et procédures spécifiques V6" href="v6_update.html" />
    <link rel="prev" title="4.3.4. Notes et procédures spécifiques V5" href="v5_update.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Documentation de montées de version
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generalites.html">3. Généralités sur les versions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">4. Montées de version</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../principles.html">4.1. Principes généraux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bugfixes_updates/_toc.html">4.2. Montées de version <em>bugfix</em></a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">4.3. Montées de version majeures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="r13_update.html">4.3.1. Notes et procédures spécifiques R13</a></li>
<li class="toctree-l3"><a class="reference internal" href="r16_update.html">4.3.2. Notes et procédures spécifiques R16</a></li>
<li class="toctree-l3"><a class="reference internal" href="v5rc_update.html">4.3.3. Notes et procédures spécifiques V5RC</a></li>
<li class="toctree-l3"><a class="reference internal" href="v5_update.html">4.3.4. Notes et procédures spécifiques V5</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.3.5. Notes et procédures spécifiques V6RC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adaptation-des-sources-de-deploiement-ansible">4.3.5.1. Adaptation des sources de déploiement ansible</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-avant-la-montee-de-version">4.3.5.2. Procédures à exécuter AVANT la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-de-la-montee-de-version">4.3.5.3. Application de la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-apres-la-montee-de-version">4.3.5.4. Procédures à exécuter APRÈS la montée de version</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="v6_update.html">4.3.6. Notes et procédures spécifiques V6</a></li>
<li class="toctree-l3"><a class="reference internal" href="v7_0_update.html">4.3.7. Notes et procédures spécifiques V7</a></li>
<li class="toctree-l3"><a class="reference internal" href="v7_1_update.html">4.3.8. Notes et procédures spécifiques V7.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="v8_0_update.html">4.3.9. Notes et procédures spécifiques V8.0</a></li>
<li class="toctree-l3"><a class="reference internal" href="v8_1_update.html">4.3.10. Notes et procédures spécifiques V8.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration_container.html">4.3.11. Migration d’un vitam legacy vers un vitam conteneurisé</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Documentation de montées de version</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">4. Montées de version</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">4.3. Montées de version majeures</a></li>
      <li class="breadcrumb-item active">4.3.5. Notes et procédures spécifiques V6RC</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/updates/releases_updates/v6rc_update.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="notes-et-procedures-specifiques-v6rc">
<h1>4.3.5. Notes et procédures spécifiques V6RC<a class="headerlink" href="#notes-et-procedures-specifiques-v6rc" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Pour une montée de version depuis la version R16 de Vitam, veuillez appliquer les procédures spécifiques de la V5RC et de la V5 en complément des procédures suivantes. Pour une montée de version depuis la version V5RC de Vitam, veuillez appliquer les procédures spécifiques de la V5 en complément des procédures suivantes. Pour une montée de version depuis la V5, vous pouvez appliquer la procédure suivante directement.</p>
</div>
<div class="section" id="adaptation-des-sources-de-deploiement-ansible">
<h2>4.3.5.1. Adaptation des sources de déploiement ansible<a class="headerlink" href="#adaptation-des-sources-de-deploiement-ansible" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="reorganisation-des-variables">
<h3>4.3.5.1.1. Réorganisation des variables<a class="headerlink" href="#reorganisation-des-variables" title="Lien permanent vers ce titre">¶</a></h3>
<p>Afin de simplifier la préparation des sources de déploiement, les fichiers ont étés répartis dans 2 sous répertoires <code class="docutils literal notranslate"><span class="pre">main</span></code> et <code class="docutils literal notranslate"><span class="pre">advanced</span></code>.
Le répertoire <code class="docutils literal notranslate"><span class="pre">main</span></code> est le répertoire principal qui nécessite une attention particulière à la préparation des sources de déploiement.</p>
<p>Afin de vous adapter à cette nouvelle organisation, vous devez redispatcher les fichiers de configuration initialement sous <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/</span></code> dans les 2 sous répertoires <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/{main,advanced}/</span></code>.</p>
</div>
<div class="section" id="ajout-du-nouveau-composant-scheduler">
<h3>4.3.5.1.2. Ajout du nouveau composant scheduler<a class="headerlink" href="#ajout-du-nouveau-composant-scheduler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">À préparer dans les sources de déploiement AVANT le déploiement de la V6RC. Ce nouveau module est obligatoire et vient en remplacement des timers systemd pour l’ordonnancement des tâches planifiées dans Vitam.</p>
</div>
<ul>
<li><p class="first">Ajout du groupe <code class="docutils literal notranslate"><span class="pre">[hosts_scheduler]</span></code> à votre fichier d’inventaire (cf. fichier d’inventaire d’exemple: <code class="docutils literal notranslate"><span class="pre">environments/hosts.example</span></code>).</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[zone_applicative:children]</span>
<span class="na">hosts_scheduler</span>

<span class="k">[hosts_scheduler]</span>
<span class="c1"># TODO: Put here servers where this service will be deployed : scheduler</span>
<span class="c1"># Optional parameter after each host : vitam_scheduler_thread_count=&lt;integer&gt; ; This is the number of threads that are available for concurrent execution of jobs. ; default is 3 thread</span>
</pre></div>
</div>
</li>
<li><p class="first">Ajout des bases mongo pour le scheduler dans le fichier <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/vault-vitam.yml</span></code>:</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Pensez à éditer les password avec des passwords sécurisés.</p>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mongodb</span><span class="p">:</span>
  <span class="nt">mongo-data</span><span class="p">:</span>
    <span class="nt">scheduler</span><span class="p">:</span>
      <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">scheduler</span>
      <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">change_it_xyz</span>
</pre></div>
</div>
</li>
<li><p class="first">Personnaliser les paramètres jvm pour le scheduler dans le fichier de configuration <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/jvm_opts.yml</span></code>.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="procedures-a-executer-avant-la-montee-de-version">
<h2>4.3.5.2. Procédures à exécuter AVANT la montée de version<a class="headerlink" href="#procedures-a-executer-avant-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="arret-des-timers-et-des-acces-externes-a-vitam">
<h3>4.3.5.2.1. Arrêt des timers et des accès externes à Vitam<a class="headerlink" href="#arret-des-timers-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6RC</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée avec les sources de déploiements de l’ancienne version.</p>
</div>
<p>Les timers et les externals de Vitam doivent être arrêtés sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_timers.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="mise-a-jour-des-depots-yum-apt">
<h3>4.3.5.2.2. Mise à jour des dépôts (YUM/APT)<a class="headerlink" href="#mise-a-jour-des-depots-yum-apt" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version</p>
</div>
<p>Afin de pouvoir déployer la nouvelle version, vous devez mettre à jour la variable <code class="docutils literal notranslate"><span class="pre">vitam_repositories</span></code> sous <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/repositories.yml</span></code> afin de renseigner les dépôts à la version cible.</p>
<p>Puis exécutez le playbook suivant <strong>sur tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-extra/bootstrap.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="montee-de-version-vers-mongo-4-4">
<h3>4.3.5.2.3. Montée de version vers mongo 4.4<a class="headerlink" href="#montee-de-version-vers-mongo-4-4" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6RC</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Sans cette opération, la montée de version d’une version existante vers une V6RC sera bloquée au démarrage des instances mongod par une incompatibilité.</p>
</div>
<p>Exécutez le playbook suivant:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_mongodb_44.yml --ask-vault-pass
</pre></div>
</div>
<p>Ce playbook effectue la montée de version de mongodb d’une version 4.2 vers une version 4.4 selon la procédure indiquée dans la documentation Mongodb. Cette procédure n’a pas été testée avec une version mongodb inférieure à 4.2.</p>
</div>
<div class="section" id="montee-de-version-vers-mongo-5-0">
<h3>4.3.5.2.4. Montée de version vers mongo 5.0<a class="headerlink" href="#montee-de-version-vers-mongo-5-0" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette montée de version doit être effectuée AVANT la montée de version V6RC de vitam et après la montée de version en mongodb 4.4 ci-dessus.</p>
</div>
<p>Exécutez le playbook suivant:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_mongodb_50.yml --ask-vault-pass
</pre></div>
</div>
<p>Ce playbook change le «&nbsp;Read and write Concern&nbsp;» des replicaset par reconfiguration, il désinstalle et réinstalle les binaires et il change également le paramètre «&nbsp;SetFeatureCompatibility&nbsp;» à 5.0.</p>
<p>Une fois ces montées de version de Mongodb réalisées la montée de version Vitam classique peut être réalisée.</p>
</div>
<div class="section" id="reinitialisation-de-la-reconstruction-des-registres-de-fond-des-sites-secondaires">
<h3>4.3.5.2.5. Réinitialisation de la reconstruction des registres de fond des sites secondaires<a class="headerlink" href="#reinitialisation-de-la-reconstruction-des-registres-de-fond-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p>Cette procédure doit être exécutée uniquement en cas de :</p>
<ul class="last simple">
<li>migration majeure depuis une version R16.6- (4.0.6 ou inférieure)</li>
<li>migration majeure depuis une version v5.rc.3- (v5.rc.3 ou inférieure)</li>
<li>migration majeure depuis une version v5.0.</li>
</ul>
</div>
<p>Cette procédure permet la réinitialisation de la reconstruction des registre de fonds sur les sites secondaires.</p>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam AVANT l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que les timers de Vitam aient bien été préalablement arrêtés (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam_timers.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_accession_register_reconstruction.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="controle-et-nettoyage-de-journaux-du-storage-engine-des-sites-secondaires">
<h3>4.3.5.2.6. Contrôle et nettoyage de journaux du storage engine des sites secondaires<a class="headerlink" href="#controle-et-nettoyage-de-journaux-du-storage-engine-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p>Cette procédure doit être exécutée uniquement en cas de :</p>
<ul class="last simple">
<li>migration majeure depuis une version R16.6- (4.0.6 ou inférieure)</li>
<li>migration majeure depuis une version v5.rc.3- (v5.rc.3 ou inférieure)</li>
<li>migration majeure depuis une version v5.0.</li>
</ul>
</div>
<p>Cette procédure permet le contrôle et la purge des journaux d’accès et des journaux d’écriture du storage engine des sites secondaires.</p>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam AVANT l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que Vitam soit bien préalablement arrêté (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_purge_storage_logs_secondary_sites.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="arret-complet-de-vitam">
<h3>4.3.5.2.7. Arrêt complet de Vitam<a class="headerlink" href="#arret-complet-de-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6RC</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée avec les sources de déploiements de l’ancienne version.</p>
</div>
<p>Vitam doit être arrêté sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="nettoyage-des-fichiers-timers-services-et-conf-suite-a-la-migration-vers-le-scheduler">
<h3>4.3.5.2.8. Nettoyage des fichiers timers, services et conf suite à la migration vers le scheduler<a class="headerlink" href="#nettoyage-des-fichiers-timers-services-et-conf-suite-a-la-migration-vers-le-scheduler" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette étape doit être effectuée AVANT la montée de version V6RC et sur un Vitam éteint.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée avec les sources de déploiement de la nouvelle version.</p>
</div>
<p>Executez le playbook suivant :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/remove_old_files_for_scheduler_migration.yml --ask-vault-pass
</pre></div>
</div>
<p>Ce playbook supprime les fichiers .service, .sh, .timers et .conf suite au passage vers le scheduler Quartz sur les hosts concernés.</p>
</div>
</div>
<div class="section" id="application-de-la-montee-de-version">
<h2>4.3.5.3. Application de la montée de version<a class="headerlink" href="#application-de-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">L’application de la montée de version s’effectue d’abord sur les sites secondaires puis sur le site primaire.</p>
</div>
<div class="section" id="lancement-du-master-playbook-vitam">
<h3>4.3.5.3.1. Lancement du master playbook vitam<a class="headerlink" href="#lancement-du-master-playbook-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam/vitam.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="lancement-du-master-playbook-extra">
<h3>4.3.5.3.2. Lancement du master playbook extra<a class="headerlink" href="#lancement-du-master-playbook-extra" title="Lien permanent vers ce titre">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-extra/extra.yml --ask-vault-pass
</pre></div>
</div>
</div>
</div>
<div class="section" id="procedures-a-executer-apres-la-montee-de-version">
<h2>4.3.5.4. Procédures à exécuter APRÈS la montée de version<a class="headerlink" href="#procedures-a-executer-apres-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="arret-des-jobs-vitam-et-des-acces-externes-a-vitam">
<h3>4.3.5.4.1. Arrêt des jobs Vitam et des accès externes à Vitam<a class="headerlink" href="#arret-des-jobs-vitam-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée IMMÉDIATEMENT APRÈS la montée de version vers la V6RC</p>
</div>
<p>Les jobs Vitam et les services externals de Vitam doivent être arrêtés sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_scheduling.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_scheduler.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="migration-des-groupes-d-objets">
<h3>4.3.5.4.2. Migration des groupes d’objets<a class="headerlink" href="#migration-des-groupes-d-objets" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette migration doit être effectuée APRÈS la montée de version V6RC mais avant la réouverture du service aux utilisateurs.</p>
</div>
<p>Cette migration de données consiste à ajouter les champs <code class="docutils literal notranslate"><span class="pre">_acd</span></code> (date de création approximative) et <code class="docutils literal notranslate"><span class="pre">_aud</span></code> (date de modification approximative) dans la collection ObjectGroup.</p>
<p>Elle est réalisée en exécutant la procédure suivante sur <strong>tous les sites</strong> (primaire et secondaire(s)) :</p>
<ul class="simple">
<li>Migration des unités archivistiques sur mongo-data (le playbook va stopper les externals avant de procéder à la migration) :</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_v6rc.yml --ask-vault-pass
</pre></div>
</div>
<p>Après le passage du script de migration, il faut procéder à la réindexation de toutes les groupes d’objets :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>  ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/reindex_es_data.yml --tags objectgroup --ask-vault-pass

..
</pre></div>
</div>
</div>
<div class="section" id="recalcul-du-graph-des-metadonnees-des-sites-secondaires">
<h3>4.3.5.4.3. Recalcul du graph des métadonnées des sites secondaires<a class="headerlink" href="#recalcul-du-graph-des-metadonnees-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p>Cette procédure doit être exécutée uniquement en cas de :</p>
<ul class="last simple">
<li>migration majeure depuis une version R16.6- (4.0.6 ou inférieure)</li>
<li>migration majeure depuis une version v5.rc.3- (v5.rc.3 ou inférieure)</li>
<li>migration majeure depuis une version v5.0.</li>
</ul>
</div>
<p>Cette procédure permet le recalcul du graphe des métadonnées sur les sites secondaires</p>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam APRÈS l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que Vitam soit bien préalablement arrêté (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam_timers.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_metadata_graph_reconstruction.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="reindexation-des-referentiels-sur-elasticsearch">
<h3>4.3.5.4.4. Réindexation des référentiels sur elasticsearch<a class="headerlink" href="#reindexation-des-referentiels-sur-elasticsearch" title="Lien permanent vers ce titre">¶</a></h3>
<p>Cette migration de données consiste à mettre à jour le modèle d’indexation des référentiels sur elasticsearch-data.</p>
<p>Elle est réalisée en exécutant la procédure suivante sur <strong>tous les sites</strong> (primaire et secondaire(s)) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/reindex_es_data.yml --ask-vault-pass --tags <span class="s2">&quot;securityprofile, context, ontology, ingestcontract, agencies, accessionregisterdetail, archiveunitprofile, accessionregistersummary, accesscontract, fileformat, filerules, profile, griffin, preservationscenario, managementcontract&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="migration-des-mappings-elasticsearch-pour-les-metadonnees">
<h3>4.3.5.4.5. Migration des mappings elasticsearch pour les métadonnées<a class="headerlink" href="#migration-des-mappings-elasticsearch-pour-les-metadonnees" title="Lien permanent vers ce titre">¶</a></h3>
<p>Cette migration de données consiste à mettre à jour le modèle d’indexation des métadonnées sur elasticsearch-data.</p>
<p>Elle est réalisée en exécutant la procédure suivante sur <strong>tous les sites</strong> (primaire et secondaire(s)) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_elasticsearch_mapping.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="redemarrage-des-jobs-vitam-et-des-acces-externes-a-vitam">
<h3>4.3.5.4.6. Redémarrage des Jobs Vitam et des accès externes à Vitam<a class="headerlink" href="#redemarrage-des-jobs-vitam-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<p>La montée de version est maintenant terminée, vous pouvez réactiver les services externals ainsi que les jobs Vitam sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_vitam_scheduler.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_vitam_scheduling.yml --ask-vault-pass
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="v5_update.html" class="btn btn-neutral float-left" title="4.3.4. Notes et procédures spécifiques V5" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="v6_update.html" class="btn btn-neutral float-right" title="4.3.6. Notes et procédures spécifiques V6" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>