<h1 id="procedure-dexploitation">Procedure d’exploitation</h1>
<h2 id="démarrage-de-la-solution">Démarrage de la solution</h2>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml start_vitamui.yml</code></pre>
<h2 id="arrêt-de-la-solution">Arrêt de la solution</h2>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml stop_vitamui.yml</code></pre>
<h2 id="upgrade-de-la-solution">Upgrade de la solution</h2>
<p>Actuellement, un upgrade de solution s’apparente à une installation de la solution.</p>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml vitamui.yml</code></pre>
<p>Les services VitamUI sont stateless et vont être remplacés par une nouvelle version lors de l’opération précédente.</p>
<p>Les scripts de base de données MongoDb sont versionnés via un changelog interne. Un même script ne peut pas être joué 2 fois. Les nouveaux scripts vont être intégrés et les anciens scripts ou doublons de scripts ne vont pas être pris en compte.</p>
<h2 id="sauvegarde-de-la-solution">Sauvegarde de la solution</h2>
<p>La base de données Mongodb utilisée par VitamUI peut être sauvegardée de 2 manières:</p>
<ol type="1">
<li>via un playbook de sauvegarde (mongo_backup.yml)</li>
<li>via un dump (commande mongodump)</li>
</ol>
<h3 id="sauvegarde-via-playbook-1">Sauvegarde via playbook (1)</h3>
<p>Au préalable il est nécessaire de valoriser correctement les variables:</p>
<pre class="console"><code>mongo_dump_folder: /backup/mongod/
mongo_backup_reinstall:
  - db: &quot;iam&quot;
    collections: [&quot;customers&quot;,&quot;externalParameters&quot;,&quot;groups&quot;,&quot;owners&quot;,&quot;profiles&quot;,
    &quot;sequences&quot;,&quot;subrogations&quot;,&quot;tenants&quot;,&quot;users&quot;,&quot;providers&quot;]
  - db: &quot;admin&quot;
    collections: []</code></pre>
<p>La structure mongo_backup_reinstall va permettre de sauvegarder la base entière si elle est renseignée de la sorte:</p>
<pre class="console"><code>- db: &quot;admin&quot;
    collections: []</code></pre>
<p>Et les collections uniquement lorsque mentionné comme suit:</p>
<pre class="console"><code>  - db: &quot;iam&quot;
    collections: [&quot;customers&quot;,&quot;externalParameters&quot;,&quot;groups&quot;,&quot;owners&quot;,&quot;profiles&quot;,
    &quot;sequences&quot;,&quot;subrogations&quot;,&quot;tenants&quot;,&quot;users&quot;,&quot;providers&quot;]</code></pre>
<p>Le résultat du backup pourra se retrouver dans</p>
<pre class="console"><code>mongo_dump_folder: /backup/mongod/</code></pre>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml mongo_backup.yml</code></pre>
<h3 id="sauvegarde-via-la-commande-mongodump-2">Sauvegarde via la commande mongodump (2)</h3>
<p>Se rendre sur la machine (vm) hébergeant l’instance mongodb de VitamUI et exécuter la commande suivante:</p>
<pre class="console"><code>mongodump --host &quot;ip_machine:27017&quot; -u [user] -p [mdp] -v --gzip 
--out=&quot;/backup/mongod/`date \+\%Y\%m\%d_\%s`&quot;</code></pre>
<h2 id="restoration-de-la-solution">Restoration de la solution</h2>
<p>De la même manière, la base de données Mongodb utilisée par VitamUI peut être sauvegardée de 2 manières:</p>
<ol type="1">
<li>via un playbook de sauvegarde (mongo_backup.yml)</li>
<li>via un dump (commande mongodump)</li>
</ol>
<h3 id="restoration-via-playbook-1">Restoration via playbook (1)</h3>
<p>La restoration va chercher le backup présent dans le dossier que renseigne la variable “mongo_dump_folder”.</p>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml 
--extra-vars \&quot;keep_mongodb_conf=True\&quot; mongo_backup.yml</code></pre>
<h3 id="restoration-via-la-commande-mongodump-2">Restoration via la commande mongodump (2)</h3>
<p>Se rendre sur la machine (vm) hébergeant l’instance mongodb de VitamUI et exécuter la commande suivante:</p>
<pre class="console"><code>mongorestore --host [ip machinie] --port 27017 --username [user] 
--password [mdp] &quot;/backup/mongod/[nom_backup] --drop --gzip --maintainInsertionOrder</code></pre>
<blockquote>
<p>Attention ! Certaines informations Vitam sont sauvegardées dans VitamUI.</p>
</blockquote>
<h2 id="changement-de-pki.">Changement de PKI.</h2>
<p>Les certificats utilisés par Vitam et VitamUI peuvent être amenés à être changés en raison de sécurité ou simplement de par leur expiration.</p>
<h3 id="certificat-vitamui-client-expiré-dans-vitam">Certificat Vitamui client expiré dans Vitam</h3>
<p>Le certificat client VitamUI.crt est utilisé par Vitam afin que l’application VitamUi accède aux informations de Vitam. Son échange se fait par les playbooks Vitam remove_context.yml et add_context.yml dans les sources de Vitam.</p>
<p>Renseigner le fichier postinstall_param.yml avec les informations du certificat actuel et lancer la commande suppression suivante:</p>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml remove_context.yml</code></pre>
<p>Se connecter à l’Ihm_demo de Vitam pour vérifier la bonne suppression du context vitamui_context dans les contextes applicatifs Vitam.</p>
<p>Une fois cette opération réalisée, il faut : _Régénérer ou échanger le certificat vitamui.crt afin qu’il soit valide. _Modifier les informations du fichier postinstall_param.yml avec le nom du nouveau certificat et lancer la commande suivante:</p>
<pre class="console"><code>ansible-playbook  -i environments/&lt;hostfile environnement&gt; --vault-password-file
vault_pass.txt --extra-vars=@./environments/vitamui_extra_vars.yml add_context.yml</code></pre>
<p>Vérifier alors dans les contextes applicatifs Vitam que le contexte vitamui_context est de nouveau présent (rattaché de manière transparente au nouveau certificat).</p>
<h3 id="certificats-expirés-dans-les-services-vitamui">Certificats expirés dans les services VitamUI</h3>
<p>Regénérer la PKI complète VitamUI et Vitamui.</p>
<p>Rédéployer la PKI pour les 2 solutions.</p>
<p>Les commandes sont précisées dans le dossier d’installation VitamUI.</p>
<h2 id="analyse-des-problèmes-vitamui">Analyse des problèmes VitamUI</h2>
<h3 id="logs">Logs</h3>
<p>Les traces applicatives ou techniques de VitamUI se trouvent sur les machines hébergeant l’application dans /vitamui/log/nom_service/ pour le service considéré.</p>
<p>Les logs sont écrits via le service rsyslog installé sur toutes les machines de la solution.</p>
<h3 id="mongodb">MongoDb</h3>
<p>Se connecter à la vm où est hébergé l’instance mongo.</p>
<p>Se connecter à la base de données via l’utilitaire mongo.</p>
<p>Exemple de commande:</p>
<pre class="console"><code>mongo --host &lt;ip machine&gt; --port 27017 admin --username=&lt;user&gt; --password=&lt;password&gt;</code></pre>
<h3 id="configuration-des-profils-de-mot-de-passe">Configuration des profils de mot de passe:</h3>
<h4 id="profil-anssi">Profil ANSSI:</h4>
<p>Le profil par défaut chargé au démarrage de CAS, la configuration de ce profil sur une plateforme déjà installé se fait sur la machine hénergeante le serveur CAS, la configuration se situe dans <code>/vitamui/conf/cas-server/application.yml</code>, dans la section <code>password:</code></p>
<p>L’exploitant peut changer quelques contraintes de la complexité du mot de passe, sans violer les standards de l’ANSSI.</p>
<h5 id="exemple-de-changement-de-la-taille-du-mot-de-passe">Exemple de changement de la taille du mot de passe:</h5>
<p>dans la section <code>password:</code>, l’attribut <code>length</code> est par défaut à 12, le changement de la taille du mot de passe revient à changer cet attribut <code>length</code>, cette valeur sera automatiquement portée par l’attribut <code>cas.authn.pm.policyPattern:</code> qui contient l’expression <code>${password.length}$</code>. l’attribut <code>cas.authn.pm.policyPattern:</code> contient l’expression régulière de validation du mot de passe et qui se trouve dans le meme fichier de configuration.</p>
<blockquote>
<p>Cette valeur ne devra pas etre inférieur à la valeur par défaut, avec le profil anssi.</p>
</blockquote>
<h5 id="exemple-de-désactivation-du-contrainte-de-vérification-dexistence-dune-occurrence-dun-nom-dutilisateur-dans-les-mots-de-passe">Exemple de désactivation du contrainte de vérification d’existence d’une occurrence d’un nom d’utilisateur dans les mots de passe:</h5>
<p>Cette contrainte est traduite par l’attribut: <code>check-occurrence</code>, qui est un boolean par défaut égal à <code>true</code>,</p>
<p>Donc <code>check-occurrence: false</code> désactivera cette vérification.</p>
<h5 id="exemple-de-changement-du-nombre-de-caractères-tolérables-du-nom-dutilisateur-à-utiliser-dans-le-mot-de-passe">Exemple de changement du nombre de caractères tolérables du nom d’utilisateur à utiliser dans le mot de passe:</h5>
<p>Cette contraintes pourra etre changée avec l’attribut <code>occurrences-chars-number:</code>, par défault la valeur est égal à <code>3</code>,</p>
<p>Donc <code>occurrences-chars-number: 5</code>, augmentera le nombre de caractère tolérable issues du nom de l’utilisateur à utiliser dans un mot de passe.</p>
<blockquote>
<p>Cette valeur ne devra pas etre inférieur à la valeur par défaut.</p>
</blockquote>
<p>Si la taille du nom de l’utilisateur est inférieur à cette valeur, la contrainte est tolérable.</p>
<h5 id="exemple-de-changement-du-nombre-des-anciens-mots-de-passe-à-ne-pas-réutiliser">Exemple de changement du nombre des anciens mots de passe à ne pas réutiliser</h5>
<p>Cette contraintes pourra etre changée avec l’attribut <code>max-old-password:</code>, par défault la valeur est égal à <code>12</code> dans le profil anssi, et <code>3</code> dans le profil custom,</p>
<p>Donc <code>max-old-password: 13</code>, augmentera le nombre d’anciens mots de passe à ne pas réutiliser’</p>
<p>Ce changement devra etre fait aussi sur le composant <code>iam-internal</code>, dans le fichier <code>/vitamui/conf/iam-internal/application.yml</code>, dans la section <code>password</code>.</p>
<blockquote>
<p>Cette valeur ne devra pas etre inférieur à la valeur par défaut, avec le profil anssi. Le redémarrage du composant iam-internal est nécessaire avec ce changement.</p>
</blockquote>
<h5 id="exemple-de-personnalisation-des-messages-redues-à-lutilisateur">Exemple de personnalisation des messages redues à l’utilisateur:</h5>
<p>Les messages peuvent etre personnalisés par l’exploitant dans le bloc, par langue</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode yml"><code class="sourceCode yaml"><a class="sourceLine" id="cb15-1" title="1"><span class="fu">constraints:</span></a>
<a class="sourceLine" id="cb15-2" title="2">    <span class="fu">defaults:</span></a>
<a class="sourceLine" id="cb15-3" title="3">      <span class="fu">fr:</span></a>
<a class="sourceLine" id="cb15-4" title="4">            <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-5" title="5">                <span class="kw">-</span> message 1</a>
<a class="sourceLine" id="cb15-6" title="6">                <span class="kw">-</span> message 2</a>
<a class="sourceLine" id="cb15-7" title="7">                <span class="kw">-</span> ...</a>
<a class="sourceLine" id="cb15-8" title="8">            <span class="fu">special-chars:</span></a>
<a class="sourceLine" id="cb15-9" title="9">                <span class="fu">title:</span><span class="at"> </span><span class="st">&#39;message 3&#39;</span></a>
<a class="sourceLine" id="cb15-10" title="10">                <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-11" title="11">                    <span class="kw">-</span> message 4</a>
<a class="sourceLine" id="cb15-12" title="12">                    <span class="kw">-</span> message 5</a>
<a class="sourceLine" id="cb15-13" title="13">        <span class="fu">en:</span></a>
<a class="sourceLine" id="cb15-14" title="14">            <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-15" title="15">                <span class="kw">-</span> message 1</a>
<a class="sourceLine" id="cb15-16" title="16">                <span class="kw">-</span> message 2</a>
<a class="sourceLine" id="cb15-17" title="17">                <span class="kw">-</span> ...</a>
<a class="sourceLine" id="cb15-18" title="18">            <span class="fu">special-chars:</span></a>
<a class="sourceLine" id="cb15-19" title="19">                <span class="fu">title:</span><span class="at"> </span><span class="st">&#39;message 3&#39;</span></a>
<a class="sourceLine" id="cb15-20" title="20">                <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-21" title="21">                    <span class="kw">-</span> message 4</a>
<a class="sourceLine" id="cb15-22" title="22">                    <span class="kw">-</span> message 5</a>
<a class="sourceLine" id="cb15-23" title="23">        <span class="fu">de:</span></a>
<a class="sourceLine" id="cb15-24" title="24">            <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-25" title="25">                <span class="kw">-</span> message 1</a>
<a class="sourceLine" id="cb15-26" title="26">                <span class="kw">-</span> message 2</a>
<a class="sourceLine" id="cb15-27" title="27">                <span class="kw">-</span> ...</a>
<a class="sourceLine" id="cb15-28" title="28">            <span class="fu">special-chars:</span></a>
<a class="sourceLine" id="cb15-29" title="29">                <span class="fu">title:</span><span class="at"> </span><span class="st">&#39;message 3&#39;</span></a>
<a class="sourceLine" id="cb15-30" title="30">                <span class="fu">messages:</span></a>
<a class="sourceLine" id="cb15-31" title="31">                    <span class="kw">-</span> message 4</a>
<a class="sourceLine" id="cb15-32" title="32">                    <span class="kw">-</span> message 5</a>
<a class="sourceLine" id="cb15-33" title="33">      ...</a></code></pre></div>
<blockquote>
<p>C’est à charge de l’exploitant de respecter les contraintes traduites, qui devront etre en cohérence avec les blocs / attributs de son profil anssi, et qui devront pas violer les standards préconisés par l’ANSSI et la PSSI du ministère de la culture.</p>
</blockquote>
<blockquote>
<p>A chaque modification</p>
</blockquote>
<h4 id="profil-personnalisé">Profil personnalisé:</h4>
<h5 id="exemple-de-changement-de-la-taille-du-mot-de-passe-1">Exemple de changement de la taille du mot de passe:</h5>
<p>dans la section <code>password:</code>, l’attribut <code>length</code> est par défaut à 12, le changement de la taille du mot de passe revient à changer cet attribut <code>length</code>, cette valeur sera automatiquement portée par l’attribut <code>cas.authn.pm.policyPattern:</code> qui contient l’expression <code>${password.length}$</code> , à la fin de l’expression régulière. l’attribut <code>cas.authn.pm.policyPattern:</code> contient l’expression régulière globale de validation du mot de passe et qui se trouve dans le meme fichier de configuration.</p>
<blockquote>
<p>Cette valeur est par défaut égal à 8 pour le profil custom.</p>
</blockquote>
<h5 id="exemple-de-changement-du-nombre-des-anciens-mots-de-passe-à-ne-pas-réutiliser-1">Exemple de changement du nombre des anciens mots de passe à ne pas réutiliser</h5>
<p>Les memes configurations que pour le profil anssi.</p>
<blockquote>
<p>Veillez à redémarrer le serveur CAS, et le composant iam-internal pour appliquer ces changements.</p>
</blockquote>
<h4 id="configuration-avant-installation-de-vitamui">Configuration avant installation de VITAMUI:</h4>
<p>Cette section est détaillée dans le document d’installation de VITAMUI.</p>
