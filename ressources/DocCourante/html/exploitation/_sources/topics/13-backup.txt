Sauvegarde / restauration
#########################

Sauvegarde
==========

.. caution:: Cette procédure de sauvegarde s'applique "à froid".


Cette procédure devrait être effectuée durant la nuit.
Les horaires indicatifs de cette procédure sont compris entre 20h et 8h.

.. KWA : paragraphe à revoir, voir même à supprimer ????????

20h : arrêt des services, dans l'ordre suivant :

- ingest-internal
- ingest-external
- access-internal
- access-external

Minuit: cron logbook (sécurisation des ...)
En parallèle, check du nombre de workflow sur le processing.
Quand il n'y a plus de workflow actif, arrêt dans l'ordre des composants suivants :

- worker
- workspace

Quand le cron logbook est terminé ET quand les services (worker et workspace) sont arrêtés, arrêt des services :

- functional-administration
- logbook
- metadata
- storage
- storage-default-offer

Ensuite, arêt des clusters ElasticSearch et MongoDB.


Sauvegarde MongoDB de base dite "Shardée"
-----------------------------------------

#. Désactiver la répartition de charge **mongos**.
#. S'assurer que les répartiteurs ont terminé leurs transactions.
#. Pour chaque nœud ("Shard") constitué d'un lot de réplicats **mongod** DB.
#. #. Déterminer le service de donnée **mongod** *élu principal* du lot.
   #. Stopper ce service.
#. **Continuer lorsque tous les serveurs principaux de tous les nœuds ont été arrêtés.**
#. Déterminer le service de configuration **mongoc** *élu principal* du lot.
#. Stopper ce service.
#. Lancer les sauvegardes les données sur chaque service **mongod** précédemment arrêtés.
#. Lancer la sauvegarde des données du service **mongoc** arrêté.
#. **Continuer lorsque toutes les sauvegardes se sont terminées.**
#. Relancer chaque service de donnée **mongod**.
#. Relancer le service de configuration **mongoc**.
#. Ré-activer la répartition de charge **mongos**.
#. S'assurer que la répartition de charge est bien active.

.. BRE comment s'assure-t-on que le LB est actif ?

A 8h du matin, redémarrage de tous les services.

.. figure:: images/backup-vitam-full-process.*
    :align: center
    :height: 20 cm

    Procédure de sauvegarde complète

.. KWA TODO : revoir le script en intégrant le playbook VITAM de démarrage notamment (ça simplifierait la procédure)

.. BRE : corriger les status (ça n'est pas "failed", mais "inactive")


Ci-dessous un script shell reprenant la procédure de sauvegarde décrite ci-dessus.
Ce dernier peut servir de démonstration dans un environnement Vitam "tout-en-un".

Ce script est disponible sous ``deployment/demo_backup_vitam.sh``

.. literalinclude:: ../../../../deployment/demo_backup_vitam.sh
  :language: shell
  :linenos:

Restauration
============

.. caution:: Cette procédure de restauration s'applique "à froid".


#. S'assurer que le système VITAM est à l'arret complet :

   #. Arrêter les services résiduels
   #. Arreter tous les serveurs MongoDB

#. Décomprésser les archives vitam/conf et vitam/data :

   #. Restaurer vitam/data dans tous les serveur MongoDB

#. Démarrer Vitam suivant l'ordre de démarrage

.. figure:: images/vitam-restore-manual-process.*
    :align: center
    :height: 20 cm

    Procédure de restauration Vitam complète

.. BRE : corriger les status (ça n'est pas "true", mais "active")
