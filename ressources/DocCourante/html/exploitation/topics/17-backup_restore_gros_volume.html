<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.9. Sauvegarde et restauration de mongodb gros volumes &mdash; Documentation VITAM - Documentation d&#39;exploitation 8.1.0</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.10. Gestion des profils de sécurité" href="18-securityprofile.html" />
    <link rel="prev" title="5.8. Sauvegarde / restauration" href="16-backup_restore.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VITAM - Documentation d'exploitation
              <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Exploitation globale</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-accessgrants.html">5.1. Gestion des accès</a></li>
<li class="toctree-l2"><a class="reference internal" href="100-auditDataConsistency.html">5.2. Audit de cohérence de données entre MongoDb et Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="101-objectGroup-blackList-fields-in-search.html">5.3. Configuration des champs ObjectGroup devant être exclus de la recherche</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-adminportals.html">5.4. Portails d’administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-appconfig.html">5.5. Paramétrage &amp; configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-miseajour.html">5.6. Déploiement / mises à jour</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-maintenance.html">5.7. Interruption / maintenance</a></li>
<li class="toctree-l2"><a class="reference internal" href="16-backup_restore.html">5.8. Sauvegarde / restauration</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.9. Sauvegarde et restauration de mongodb gros volumes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preconisation">5.9.1. Préconisation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde-d-un-cluster-mongo-sharde">5.9.2. Sauvegarde d’un cluster Mongo shardé</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restauration-d-un-cluster-mongo-sharde">5.9.3. Restauration d’un cluster Mongo shardé</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cas-particulier-de-l-offre-froide">5.9.4. Cas particulier de l’offre froide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sauvegarde">5.9.4.1. Sauvegarde</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restauration">5.9.4.2. Restauration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="18-securityprofile.html">5.10. Gestion des profils de sécurité</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-certificatpersonae.html">5.11. Certificats personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-grouped_tenants.html">5.12. Gestion des indexes Elasticseach dans un contexte massivement multi-tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-batchs.html">5.13. Batchs et traitements</a></li>
<li class="toctree-l2"><a class="reference internal" href="21-graphstorage.html">5.14. Sauvegarde des données graphe (Log shipping)</a></li>
<li class="toctree-l2"><a class="reference internal" href="22-graphcompute.html">5.15. Recalcul des données graphe</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-siegfried_signature.html">5.16. Montée de version du fichier de signature de Siegfried</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-griffins.html">5.17. Griffins</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-reconstruction.html">5.18. Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="31-pra.html">5.19. Plan de Reprise d’Activité (<code class="docutils literal notranslate"><span class="pre">PRA</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="40-resynchronisation.html">5.20. Resynchronisation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="45-offerdiff.html">5.21. Audit comparatif entre 2 offres de stockage miroirs</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html">5.22. Procédure d’exploitation suite à la création ou la modification d’une ontologie</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html#l-ontologie-externe-suite-a-la-montee-de-version-de-vitam">5.23. L’ontologie externe suite à la montée de version de <code class="docutils literal notranslate"><span class="pre">VITAM</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="60-forcedpause.html">5.24. Procédure d’exploitation pour la mise en pause forcée d’une opération</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-reindexation.html">5.25. Réindexation</a></li>
<li class="toctree-l2"><a class="reference internal" href="61-installation_nouveau_analyseur_elasticsearch.html">5.26. Recherche exacte sur des champs texte</a></li>
<li class="toctree-l2"><a class="reference internal" href="65-ingest-cleanup.html">5.27. Nettoyage des ingests incomplets</a></li>
<li class="toctree-l2"><a class="reference internal" href="66-dip-cleanup.html">5.28. Suppression des DIP et des fichiers de transfert</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-certificate-revocation.html">5.29. Procédure d’exploitation pour la révocation des certificats SIA et Personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="80-offer-activation.html">5.30. Activation/désactivation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-environment-cleaning.html">5.31. Nettoyage d’un environnement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composants/_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">12. Annexes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'exploitation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="_toc.html">5. Exploitation globale</a></li>
      <li class="breadcrumb-item active">5.9. Sauvegarde et restauration de mongodb gros volumes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/topics/17-backup_restore_gros_volume.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="sauvegarde-et-restauration-de-mongodb-gros-volumes">
<h1>5.9. Sauvegarde et restauration de mongodb gros volumes<a class="headerlink" href="#sauvegarde-et-restauration-de-mongodb-gros-volumes" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="preconisation">
<h2>5.9.1. Préconisation<a class="headerlink" href="#preconisation" title="Lien permanent vers ce titre">¶</a></h2>
<dl class="docutils">
<dt>La documentation officielle de MongoDB présente différentes techniques de sauvegarde et restauration:</dt>
<dd><ul class="first last simple">
<li>utilisation des outils mongodump/mongorestore (Cf. la <a class="reference internal" href="16-backup_restore.html"><span class="doc">section dédiée</span></a>))</li>
<li>utilisation de Filesystem snapshots</li>
<li>réalisation de copies de disque.</li>
</ul>
</dd>
</dl>
<p>La technique sélectionnée par <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> est la troisième pour les raisons suivantes:</p>
<blockquote>
<div><ul class="simple">
<li>Le volume de donnée en production est important. Les outils mongodump et mongorestore ne sont pas conseillés dans ce cas de figure car ils necessitent un temps d’exécution trop important (sauvegarde / restauration des données et création d’indexes).</li>
<li>La technique des snapshots des disques dépend fortement des outils disponibles de l’environnement matériel.</li>
</ul>
</div></blockquote>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last">Pour plus d’information, veuillez-vous référer à la documentation officielle :
<a class="reference external" href="https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/">mongodump</a> et <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/backup-with-filesystem-snapshots/">Filesystem Snapshots</a>.</p>
</div>
<dl class="docutils">
<dt>La sauvegarde et la restauration d’une base de forte volumétrie doit être anticipée lors du déploiement:</dt>
<dd><ul class="first last simple">
<li>en limitant le volume de donnée, géré par un shard, à une taille raisonnable;</li>
<li>en prévoyant un espace disque de taille identique au volume géré ou au moyen d’ajouter un disque supplémentaire.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="sauvegarde-d-un-cluster-mongo-sharde">
<h2>5.9.2. Sauvegarde d’un cluster Mongo shardé<a class="headerlink" href="#sauvegarde-d-un-cluster-mongo-sharde" title="Lien permanent vers ce titre">¶</a></h2>
<ol class="arabic simple">
<li>Identifier dans chaque replicaSet les instances mongo Primary (le replicaset configserver, géré par les composants vitam-mongoc, et le replicaset de chaque shard, géré par le composant vitam-mongod)</li>
<li>Arrêter proprement les services mongo</li>
<li>Réaliser la copie compressée (tar.gz, zip, …) du dossier /vitam/data/mongoc/db (pour l’instance Primary du configserver) ou du dossier /vitam/data/mongod/db (pour l’instance Primary d’un shard), pour chaque replicaset identifié précédemment, en veillant à respecter le nommage des sauvegardes : configsrv, shard0, shard1, …</li>
<li>Stocker les copies sur un disque séparé et sécurisé</li>
</ol>
</div>
<div class="section" id="restauration-d-un-cluster-mongo-sharde">
<h2>5.9.3. Restauration d’un cluster Mongo shardé<a class="headerlink" href="#restauration-d-un-cluster-mongo-sharde" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">La documentation officielle est consultable ici: <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/restore-sharded-cluster/">Restore sharded cluster</a>.</p>
</div>
<ol class="arabic">
<li><p class="first">Si le cluster existant n’est pas utilisé pour restaurer la sauvegarde, déployer un nouveau cluster mongo vide, avec les mêmes caractéristiques que l’existant (configuration et nombre de shards). Il est conseillé d’utiliser l’ansiblerie <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>, en modifiant l’inventaire, et en exécutant le playbook d’initialisation du cluster Mongo (<code class="docutils literal notranslate"><span class="pre">ansible-vitam/mongodb_data.yml</span></code>)</p>
</li>
<li><p class="first">Arrêter le cluster mongodb</p>
</li>
<li><p class="first">Modifier la configuration des services vitam-mongoc (chaque membre du replicaset configserver) pour désactiver la replication et le sharding, en commentant dans le fichier /vitam/conf/mongoc/mongoc.conf les lignes suivantes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">replication</span><span class="p">:</span>
  <span class="n">replSetName</span><span class="p">:</span> <span class="n">configsvr</span> <span class="c1"># name of the replica set</span>
  <span class="n">enableMajorityReadConcern</span><span class="p">:</span> <span class="n">true</span>

<span class="n">sharding</span><span class="p">:</span>
  <span class="n">clusterRole</span><span class="p">:</span> <span class="n">configsvr</span> <span class="c1"># role du shard</span>
</pre></div>
</div>
</li>
<li><p class="first">Modifier la configuration des services vitam-mongod (chaque membre du replicaset de chaque shard), en commentant dans le fichier /vitam/conf/mongod/mongod.conf les lignes suivantes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">replication</span><span class="p">:</span>
  <span class="n">replSetName</span><span class="p">:</span> <span class="n">shardX</span> <span class="c1"># name of the replica set</span>
  <span class="n">enableMajorityReadConcern</span><span class="p">:</span> <span class="n">true</span>

<span class="n">sharding</span><span class="p">:</span>
  <span class="n">clusterRole</span><span class="p">:</span> <span class="n">shardsvr</span> <span class="c1"># role du shard</span>
</pre></div>
</div>
</li>
<li><p class="first">Si les services vitam-mongoc et vitam-mongod sont dans une zone réseau privée et sécurisée, il est plus simple de désactiver l’authentification en commentant la partie sécurité dans les fichiers de configuration modifiés précédemment. Sinon, dans la suite de la procédure, un chapitre permet de tenir compte de cette contrainte. Pour désactiver la sécurité, commenter les lignes suivantes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">security</span><span class="p">:</span>
  <span class="n">authorization</span><span class="p">:</span> <span class="n">enabled</span>
  <span class="n">clusterAuthMode</span><span class="p">:</span> <span class="n">keyFile</span>
  <span class="n">keyFile</span><span class="p">:</span> <span class="s2">&quot;/vitam/conf/mongoc/keyfile&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Copier et décompresser les sauvegardes, en respectant chaque nom de fichier vers la machine destinataire (configsrv, shard0, shard1, …), dans le dossier /vitam/data/mongoX de chaque instance mongo, c’est à dire de l’ensemble des membres de chaque replicaset</p>
</li>
<li><p class="first">Démarrer tous les services mongo en commençant par les services vitam-mongoc puis les services vitam-mongod, ou réutiliser le playbook ansible (start_mongo.yml) en limitant aux machines des groupes hosts_mongoc_data et hosts_mongod_data (paramètre –limit)</p>
</li>
<li><p class="first">Pour chacune des instances mongoc et mongod, se connecter au serveur avec le client mongo, et exécuter les opérations suivantes :</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Si l’authentification est activée, il faut créer un <code class="docutils literal notranslate"><span class="pre">systemUser</span></code> (pré-requis: il faut un utilisateur ayant un role «&nbsp;root&nbsp;») de manière à disposer des droits pour exécuter les prochaines opérations. Pour cela exécuter les commandes suivantes :</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">use</span> <span class="n">admin</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">root</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;rootUser&quot;</span><span class="p">,</span> <span class="s2">&quot;rootUserPassword&quot;</span><span class="p">)</span>
<span class="o">//</span> <span class="n">Create</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">createUser</span><span class="p">({</span><span class="n">user</span><span class="p">:</span> <span class="s2">&quot;systmUser&quot;</span><span class="p">,</span> <span class="n">pwd</span><span class="p">:</span> <span class="s2">&quot;systemUserPassword&quot;</span><span class="p">,</span> <span class="n">roles</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;__system&quot;</span> <span class="p">]})</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;systmUser&quot;</span><span class="p">,</span> <span class="s2">&quot;systemUserPassword&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Supprimer la base de données <code class="docutils literal notranslate"><span class="pre">local</span></code></p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Drop</span> <span class="n">local</span> <span class="n">database</span>
<span class="n">use</span> <span class="n">local</span>
<span class="n">db</span><span class="o">.</span><span class="n">dropDatabase</span><span class="p">()</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Pour les machines mongoc uniquement, et si la restauration est réalisée sur des nouvelles machines hébergeant les services vitam-mongod, modifier la configuration des instances mongoc (configserver): mettre à jour la collection <code class="docutils literal notranslate"><span class="pre">shards</span></code> en spécifiant les nouvelles ips des machines :</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span>use config
// spécifier les shards pour chaque mongoc
// Example
db.shards.updateOne({ &quot;_id&quot; : &quot;shard0&quot;},  { $set : { &quot;host&quot; : &quot;shard0/ip_member0-1:27019,ip-member0-2:27019,ip-member0-3:27019&quot;}})
db.shards.updateOne({ &quot;_id&quot; : &quot;shard1&quot;},  { $set : { &quot;host&quot; : &quot;shard1/ip_member1-1:27019,ip-member1-2:27019,ip-member1-3:27019&quot;}})
db.shards.updateOne({ &quot;_id&quot; : &quot;shard2&quot;},  { $set : { &quot;host&quot; : &quot;shard2/ip_member2-1:27019,ip_member2-2:27019,ip_member2-3:27019&quot;}})
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Pour les machines mongod uniquement, et si la restauration est réalisée sur des nouvelles machines hébergeant les services vitam-mongoc, modifier la configuration des instances mongod (les shards): mettre à jour la collection <code class="docutils literal notranslate"><span class="pre">system.version</span></code> en spécifiant les nouvelles ips des machines :</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span>use admin
db.system.version.deleteOne( { &quot;_id&quot;: &quot;minOpTimeRecovery&quot; } )
// spécifier les mongoc pour chaque shard
// Example
db.system.version.updateOne({ &quot;_id&quot; : &quot;shardIdentity&quot; },{ $set :{ &quot;configsvrConnectionString&quot; : &quot;configserver/ip_member_1:27018,ip_member_2:27018,ip_member_3:27018&quot;}})
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Si un utilisateur ayant un role <code class="docutils literal notranslate"><span class="pre">__system</span></code> a été créé à l’étape (6.1), il faut le supprimer</p>
<blockquote>
<div><div class="code javascript highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Remove</span> <span class="n">system</span> <span class="n">user</span>
<span class="n">use</span> <span class="n">admin</span>
<span class="o">//</span> <span class="n">Authenticate</span> <span class="k">as</span> <span class="n">root</span> <span class="n">user</span>
<span class="n">db</span><span class="o">.</span><span class="n">auth</span><span class="p">(</span><span class="s2">&quot;rootUser&quot;</span><span class="p">,</span> <span class="s2">&quot;rootUserPassword&quot;</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">removeUser</span><span class="p">(</span><span class="s2">&quot;systmeUser&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p class="first">Arrêter l’ensemble des services mongo et réactiver la replication et le sharding (et l’authentification si désactivée) dans les fichiers de configuration de chacune des instances</p>
</li>
<li><p class="first">Démarrer l’ensemble des services mongoc et mongod (en respectant l’ordre déjà spécifié précédemment)</p>
</li>
<li><p class="first">Activer les <code class="docutils literal notranslate"><span class="pre">replicaSet</span></code> pour chacun des mongoc et mongod (shards) en exécutant, avec le client mongo, le script init-replica-config.js disponible sur chacune des machines dont le paramètre mongo_rs_bootstrap est spécifié dans l’inventaire ansible. Aussi depuis chacune de ces machines, il faut exécuter le script en modifiant le paramètre host de manière à l’exécuter sur chaque membre du replicaSet</p>
<blockquote>
<div><div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Sur</span> <span class="n">un</span> <span class="n">des</span> <span class="n">mongoc</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="o">--</span><span class="n">host</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}</span> <span class="o">--</span><span class="n">port</span> <span class="p">{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongoc_port</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongoc</span><span class="o">/</span><span class="n">init</span><span class="o">-</span><span class="n">replica</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>
<span class="o">//</span> <span class="n">Pour</span> <span class="n">chaque</span> <span class="n">shards</span> <span class="n">et</span> <span class="n">sur</span> <span class="n">un</span> <span class="n">des</span> <span class="n">shards</span> <span class="n">d</span><span class="s1">&#39;un replicaset</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="o">--</span><span class="n">host</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}</span> <span class="o">--</span><span class="n">port</span> <span class="p">{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongod_port</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongod</span><span class="o">/</span><span class="n">init</span><span class="o">-</span><span class="n">replica</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Chaque membre Secondary activé effectue une synchronisation initiale pour reprendre l’ensemble des commandes opérées sur le membre Primary. En fonction du volume de données géré par shard, ainsi que des performances des machines et du réseau, cette opération peut s’exécuter en un temps important, durant lequel les performances du cluster seront affaiblies.</p>
</div>
<ol class="arabic">
<li><p class="first">Démarrer les services vitam-mongos</p>
</li>
<li><p class="first">Test de la restauration</p>
<blockquote>
<div><ul class="simple">
<li>Un document accessible depuis un shards devrait être accessible depuis <code class="docutils literal notranslate"><span class="pre">mongos</span></code> (faire la requête de test sur chaque shard)</li>
<li>Tester aussi les collections non shardées</li>
<li>Il est conseillé d’exécuter une requête <code class="docutils literal notranslate"><span class="pre">count</span></code> sur chacune des collections avant la sauvegarde pour vérifier lors de la restauration le bon compte.</li>
</ul>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>L’ansiblerie <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> déploie dans chacune des instances mongoc et mongod des scripts préparés restore-mongoc.js et restore-mongod.js respectivement</p>
<blockquote class="last">
<div><ul class="simple">
<li>{{ vitam_defaults.folder.root_path }}/app/mongoc/restaure-mongoc.js</li>
<li>{{ vitam_defaults.folder.root_path }}/app/mongod/restaure-mongod.js</li>
</ul>
</div></blockquote>
</div>
<p>Toutes les informations sur les adresses ip et numéros de ports de toutes les instances du cluster mongodb sont automatiquement renseignés dans ces scripts</p>
<p>Pour exécuter ces deux scripts, il faut lancer la commande suivante que vous pouvez automatiser dans un playbook:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span> <span class="o">//</span> <span class="n">Sur</span> <span class="n">mongoc</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}:{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongos_port</span> <span class="p">}}</span><span class="o">/</span><span class="n">admin</span> <span class="p">{{</span> <span class="n">mongo_credentials</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongoc</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">mongoc</span><span class="o">.</span><span class="n">js</span>
 <span class="o">//</span> <span class="n">Sur</span> <span class="n">mongod</span>
<span class="o">&gt;</span> <span class="n">mongo</span> <span class="p">{{</span> <span class="n">ip_service</span> <span class="p">}}:{{</span> <span class="n">mongodb</span><span class="o">.</span><span class="n">mongos_port</span> <span class="p">}}</span><span class="o">/</span><span class="n">admin</span> <span class="p">{{</span> <span class="n">mongo_credentials</span> <span class="p">}}</span> <span class="p">{{</span> <span class="n">vitam_defaults</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">root_path</span> <span class="p">}}</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">mongod</span><span class="o">/</span><span class="n">restore</span><span class="o">-</span><span class="n">mongod</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
</div>
<div class="section" id="cas-particulier-de-l-offre-froide">
<h2>5.9.4. Cas particulier de l’offre froide<a class="headerlink" href="#cas-particulier-de-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h2>
<p>Dans le cas particulier d’une offre de stockage froide, les fichiers backup zip sont stockés dans des bandes magnétiques.</p>
<p>La procédure de backup du mongo de l’offre froide est très importante, car, la base de donnée est l’unique référentiel de l’ensemble des fichiers écris dans les bandes magnétiques.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Si les données du cluster mongodb de l’offre froide sont perdues, toutes les informations enregistrées sur les bandes magnétiques sont inutilisables. Pour cette raison, il est impératif de stocker les sauvegardes du cluster mongo de l’offre froide dans une bande magnétique.</p>
</div>
<div class="section" id="sauvegarde">
<h3>5.9.4.1. Sauvegarde<a class="headerlink" href="#sauvegarde" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="script-de-sauvegarde-du-cluster-mongodb">
<h4>5.9.4.1.1. Script de sauvegarde du cluster mongodb<a class="headerlink" href="#script-de-sauvegarde-du-cluster-mongodb" title="Lien permanent vers ce titre">¶</a></h4>
<p>Un playbook, ayant les tâches ci-dessous, a été mis en place pour faire un backup du mongodb de l’offre froide:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Détection des noeuds mongodb <code class="docutils literal notranslate"><span class="pre">Primary</span></code> (confiserver et shards)</li>
<li>Arrêt de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a></li>
<li>Copie et ajout d’un fichier de description des instances en cours</li>
<li>Compression du dossier db de chaque instance <code class="docutils literal notranslate"><span class="pre">Primary</span></code> (configserver et shards)</li>
<li>Démarrage de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a></li>
<li>Envoi des fichiers zip (via CURL) vers l’offre froide (composant offer sur url d’admin spécifique au traitement du backup) qui seront sauvegardés sur une bande magnétique</li>
</ol>
</div></blockquote>
<p>Pour exécuter le playbook :</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Le playbook ci-dessous est à exécuter uniquement sur un <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ayant une offre froide <code class="docutils literal notranslate"><span class="pre">**tapeLibrary**</span></code></p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">ansible</span><span class="o">-</span><span class="n">vitam</span><span class="o">-</span><span class="n">exploitation</span><span class="o">/</span><span class="n">backup_mongodb_tape_offer</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">i</span> <span class="n">environments</span><span class="o">/</span><span class="n">hosts</span><span class="o">.&lt;</span><span class="n">environnement</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">vault</span><span class="o">-</span><span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="sauvegarde-des-fichiers-backup-dans-l-offre-froide">
<h4>5.9.4.1.2. Sauvegarde des fichiers backup dans l’offre froide<a class="headerlink" href="#sauvegarde-des-fichiers-backup-dans-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Lors de l’envoi des fichiers vers l’offre froide, cette dernière va procéder au traitement suivant:</p>
<ul class="simple">
<li>Réception du fichier zip dans une zone temporaire</li>
<li>Copie du fichier dans une zone d’écriture sur bande magnétique</li>
<li>Création d’un ordre spécifique pour écrire le fichier backup zip sur une bande magnétique ayant un tag <code class="docutils literal notranslate"><span class="pre">backup</span></code></li>
<li>Le worker «&nbsp;TapeDriveWorker&nbsp;» (Thread executé dans la jvm offer) qui va exécuter la tâche consigne son ordre d’écriture dans le fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code>, en détaillant les informations : <code class="docutils literal notranslate"><span class="pre">code</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">bande</span> <span class="pre">magnétique</span></code>, <code class="docutils literal notranslate"><span class="pre">mongoc</span></code> ou <code class="docutils literal notranslate"><span class="pre">mongod</span> <span class="pre">(shard(i)</span></code>, <code class="docutils literal notranslate"><span class="pre">date</span></code>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Lors de la lecture depuis une bande magnétique, on accède aux fichiers sans connaître leur nom et leur type.
Si on perd le cluster mongodb, le fichier de log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> sera l’unique moyen d’accéder rapidement au nom du fichier sauvegardé associé au code de la bande magnétique où il a été enregistré.
Le nom <code class="docutils literal notranslate"><span class="pre">DATE-disk-mongod-shard01_.zip</span></code> que l’on récupère depuis le fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> nous renseigne sur la date et le fait que ce soit un backup du <code class="docutils literal notranslate"><span class="pre">shard01</span></code>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Après chaque sauvegarde, le fichier <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code> doit être copié dans un lieu sûr, pour le besoin de restauration en cas de perte du site.
Dans le cas de la perte du site, si ce fichier n’est pas disponible, la lecture de toutes les bandes magnétiques sera l’unique moyen pour récupérer les fichiers de backup.</p>
</div>
</div>
</div>
<div class="section" id="restauration">
<h3>5.9.4.2. Restauration<a class="headerlink" href="#restauration" title="Lien permanent vers ce titre">¶</a></h3>
<div class="section" id="acces-aux-fichiers-de-l-offre-froide">
<h4>5.9.4.2.1. Accès aux fichiers de l’offre froide<a class="headerlink" href="#acces-aux-fichiers-de-l-offre-froide" title="Lien permanent vers ce titre">¶</a></h4>
<p>Sur l’offre froide, toutes les écritures des fichiers backup du mongodb de l’offre, sont tracées dans le fichier log <code class="docutils literal notranslate"><span class="pre">offer_tape_backup_DATE.log</span></code></p>
<p>Pour récupérer une sauvegarde, il convient donc de consulter les lignes de log ayant comme information:</p>
<blockquote>
<div><ul class="simple">
<li>Le code de la bande magnétique sur laquelle est écrit le fichier</li>
<li>Le nom du fichier de la forme <code class="docutils literal notranslate"><span class="pre">DATE-disk-mongod-shard01_.zip</span></code></li>
</ul>
</div></blockquote>
<p>Pour restaurer une date donnée</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>- Repérer dans le fichier log ``offer_tape_backup_DATE.log`` tous les fichiers backup ``(mongoc et mongod)`` zip correspondant à cette date ainsi que les bandes magnétiques sur lesquelles les fichiers sont stockés
- Manuellement, charger les bandes magnétiques sur une ``tape-library`` pour lire les fichiers
- La lecture des fichiers doit être réalisée en spécifiant les noms avec la nomenclature adéquate (le nom se retrouve aussi à l&#39;intérieur du fichier zip dans un fichier descriptif)
- Copier et décompresser chacun de ces fichiers dans l&#39;instance mongo correspondante. Par exemple le fichier ayant pour nom ``DATE-disk-mongod-shard01_.zip`` est à copier et à décompresser dans tous les membres mongo du shard ``shard01``
</pre></div>
</div>
</div>
<div class="section" id="restaurer-le-cluster-mongodb">
<h4>5.9.4.2.2. Restaurer le cluster mongodb<a class="headerlink" href="#restaurer-le-cluster-mongodb" title="Lien permanent vers ce titre">¶</a></h4>
<p>Une fois tous les fichiers copiés et décompressés dans les instances mongo correspondantes, il faut suivre la procédure de restauration décrite ci-dessus paragraphe <strong>Restauration d’un cluster Mongo shardé</strong>.</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="16-backup_restore.html" class="btn btn-neutral float-left" title="5.8. Sauvegarde / restauration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="18-securityprofile.html" class="btn btn-neutral float-right" title="5.10. Gestion des profils de sécurité" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>