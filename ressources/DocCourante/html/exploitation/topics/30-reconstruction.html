<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.18. Reconstruction &mdash; Documentation VITAM - Documentation d&#39;exploitation 8.1.0</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.19. Plan de Reprise d’Activité (PRA)" href="31-pra.html" />
    <link rel="prev" title="5.17. Griffins" href="24-griffins.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VITAM - Documentation d'exploitation
              <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Exploitation globale</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-accessgrants.html">5.1. Gestion des accès</a></li>
<li class="toctree-l2"><a class="reference internal" href="100-auditDataConsistency.html">5.2. Audit de cohérence de données entre MongoDb et Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="101-objectGroup-blackList-fields-in-search.html">5.3. Configuration des champs ObjectGroup devant être exclus de la recherche</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-adminportals.html">5.4. Portails d’administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-appconfig.html">5.5. Paramétrage &amp; configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-miseajour.html">5.6. Déploiement / mises à jour</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-maintenance.html">5.7. Interruption / maintenance</a></li>
<li class="toctree-l2"><a class="reference internal" href="16-backup_restore.html">5.8. Sauvegarde / restauration</a></li>
<li class="toctree-l2"><a class="reference internal" href="17-backup_restore_gros_volume.html">5.9. Sauvegarde et restauration de mongodb gros volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-securityprofile.html">5.10. Gestion des profils de sécurité</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-certificatpersonae.html">5.11. Certificats personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-grouped_tenants.html">5.12. Gestion des indexes Elasticseach dans un contexte massivement multi-tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-batchs.html">5.13. Batchs et traitements</a></li>
<li class="toctree-l2"><a class="reference internal" href="21-graphstorage.html">5.14. Sauvegarde des données graphe (Log shipping)</a></li>
<li class="toctree-l2"><a class="reference internal" href="22-graphcompute.html">5.15. Recalcul des données graphe</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-siegfried_signature.html">5.16. Montée de version du fichier de signature de Siegfried</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-griffins.html">5.17. Griffins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.18. Reconstruction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#procedure-mono-site">5.18.1. Procédure mono-site</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure-multi-sites">5.18.2. Procédure multi-sites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cas-du-site-primaire">5.18.2.1. Cas du site primaire</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cas-du-site-secondaire">5.18.2.2. Cas du site secondaire</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#controle-des-donnees-reconstruites">5.18.3. Contrôle des données reconstruites</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="31-pra.html">5.19. Plan de Reprise d’Activité (<code class="docutils literal notranslate"><span class="pre">PRA</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="40-resynchronisation.html">5.20. Resynchronisation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="45-offerdiff.html">5.21. Audit comparatif entre 2 offres de stockage miroirs</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html">5.22. Procédure d’exploitation suite à la création ou la modification d’une ontologie</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html#l-ontologie-externe-suite-a-la-montee-de-version-de-vitam">5.23. L’ontologie externe suite à la montée de version de <code class="docutils literal notranslate"><span class="pre">VITAM</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="60-forcedpause.html">5.24. Procédure d’exploitation pour la mise en pause forcée d’une opération</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-reindexation.html">5.25. Réindexation</a></li>
<li class="toctree-l2"><a class="reference internal" href="61-installation_nouveau_analyseur_elasticsearch.html">5.26. Recherche exacte sur des champs texte</a></li>
<li class="toctree-l2"><a class="reference internal" href="65-ingest-cleanup.html">5.27. Nettoyage des ingests incomplets</a></li>
<li class="toctree-l2"><a class="reference internal" href="66-dip-cleanup.html">5.28. Suppression des DIP et des fichiers de transfert</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-certificate-revocation.html">5.29. Procédure d’exploitation pour la révocation des certificats SIA et Personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="80-offer-activation.html">5.30. Activation/désactivation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-environment-cleaning.html">5.31. Nettoyage d’un environnement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composants/_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">12. Annexes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'exploitation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="_toc.html">5. Exploitation globale</a></li>
      <li class="breadcrumb-item active">5.18. Reconstruction</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/topics/30-reconstruction.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="reconstruction">
<span id="id1"></span><h1>5.18. Reconstruction<a class="headerlink" href="#reconstruction" title="Lien permanent vers ce titre">¶</a></h1>
<p>La reconstruction consiste à recréer le contenu des bases de données (MongoDB-data, Elasticsearch-data) en cas de perte de l’une ou l’autre à partir des informations présentes dans les offres de stockage. Elle part du principe que le contenu des offres n’a pas été altéré.</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Dans cette version de la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>, la reconstruction nécessite de couper le service aux utilisateurs.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Une reconstruction complète à partir des offres de stockage peut être extrêmement longue, et ne doit être envisagée qu’en dernier recours.</p>
</div>
<div class="section" id="procedure-mono-site">
<h2>5.18.1. Procédure mono-site<a class="headerlink" href="#procedure-mono-site" title="Lien permanent vers ce titre">¶</a></h2>
<p>La procédure à appliquer est la même que la procédure du site primaire pour une installation multi-sites.</p>
</div>
<div class="section" id="procedure-multi-sites">
<h2>5.18.2. Procédure multi-sites<a class="headerlink" href="#procedure-multi-sites" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="cas-du-site-primaire">
<span id="reconstruction-primary"></span><h3>5.18.2.1. Cas du site primaire<a class="headerlink" href="#cas-du-site-primaire" title="Lien permanent vers ce titre">¶</a></h3>
<p>La reconstruction se réalise de la manière suivante :</p>
<ol class="arabic">
<li><p class="first">Arrêt de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sur le site à reconstruire</p>
<blockquote>
<div><ul class="simple">
<li>Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam.yml</span></code></li>
</ul>
</div></blockquote>
</li>
</ol>
<p>Il est indispensable de valider que tous les services <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> (y compris les <cite>timers</cite> systemd) sont bien arrêtés</p>
<ol class="arabic" start="2">
<li><p class="first">Purge des données (le cas échéant) stockées dans MongoDB-data, excepté les bases <strong>identity</strong>, <strong>config</strong> et <strong>admin</strong> :</p>
<blockquote>
<div><ul class="simple">
<li>Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/start_mongodb.yml</span></code> pour démarrer les bases mongodb</li>
<li><dl class="first docutils">
<dt>Procéder à la purge des données en utilisant l’outil mongo shell ou un outil équivalent :</dt>
<dd><ul class="first last">
<li>Se connecter avec l’utilisateur <code class="docutils literal notranslate"><span class="pre">vitamdb-admin</span></code></li>
<li>Lister les bases via la commande <code class="docutils literal notranslate"><span class="pre">show</span> <span class="pre">dbs</span></code></li>
<li>Pour chacune des bases, excepté les bases <strong>identity</strong>, <strong>config</strong> et <strong>admin</strong>, les vider via la commande <code class="docutils literal notranslate"><span class="pre">db.getCollectionNames().forEach(function(x)</span> <span class="pre">{db[x].remove({})});</span></code></li>
</ul>
</dd>
</dl>
</li>
<li>Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_mongodb.yml</span></code> pour stopper les bases mongodb</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Purge des données (le cas échéant) stockées dans Elasticsearch-data :</p>
<blockquote>
<div><ul>
<li><p class="first">Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/start_elasticsearch_data.yml</span></code> pour démarrer elasticsearch-data</p>
</li>
<li><p class="first">Dans le cas où Cerebro ou un outil équivalent est disponible, lister les indexes et les purger via l’IHM</p>
</li>
<li><dl class="first docutils">
<dt>Sinon :</dt>
<dd><ul class="first simple">
<li>Se connectant en ssh sur un des nœuds elasticsearch-data</li>
<li>Lister les indexes ES via <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">'http://localhost:9200/_cat/indices?v'</span></code></li>
<li>Pour chacun des indexes, vider l’index via : <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-XDELETE</span> <span class="pre">'http://localhost:9200/{index_name}'</span></code></li>
</ul>
<p class="last">(Pour cette action de purge d’elasticsearch-data un playbook équivalent est disponible : <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/clean_indexes_es_data.yml</span></code>)</p>
</dd>
</dl>
</li>
<li><p class="first">Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_elasticsearch_data.yml</span></code> pour stopper elasticsearch-data</p>
</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Reconfiguration et démarrage en tant que site secondaire:</p>
<blockquote>
<div><ul class="simple">
<li>Paramétrer la variable <code class="docutils literal notranslate"><span class="pre">primary_site</span></code> à <code class="docutils literal notranslate"><span class="pre">false</span></code> dans le fichier d’inventaire puis utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam/vitam.yml</span></code></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Dès lors, l’accès utilisateur reste coupé, et l’intégralité des données est reconstruite progressivement</p>
<blockquote>
<div><ul class="simple">
<li>Le suivi de la reconstruction se fait en observant l’évolution de l’offset de reconstruction stocké dans MongoDB-data</li>
<li>Pour la release 8, la procédure est décrite dans la section «&nbsp;Recalcul des données graphe&nbsp;»</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">La collection <code class="docutils literal notranslate"><span class="pre">Offset</span></code> de la base de données <code class="docutils literal notranslate"><span class="pre">metadata</span></code> est créée et permet de suivre l’avancement de la reconstruction.</p>
</li>
<li><p class="first">Une fois la reconstruction terminée (plus de modification dans la collection <code class="docutils literal notranslate"><span class="pre">Offset</span></code>), il convient de reconfigurer en tant que site primaire, puis redémarrer :</p>
<blockquote>
<div><ul class="simple">
<li>Paramétrer la directive <code class="docutils literal notranslate"><span class="pre">primary_site</span></code> à <code class="docutils literal notranslate"><span class="pre">true</span></code> puis utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam/vitam.yml</span></code></li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="cas-du-site-secondaire">
<span id="reconstruction-secondary"></span><h3>5.18.2.2. Cas du site secondaire<a class="headerlink" href="#cas-du-site-secondaire" title="Lien permanent vers ce titre">¶</a></h3>
<p>La reconstruction se réalise de la manière suivante :</p>
<ol class="arabic">
<li><p class="first">Arrêt de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> sur le site à reconstruire</p>
<blockquote>
<div><ul class="simple">
<li>Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam.yml</span></code></li>
</ul>
</div></blockquote>
</li>
</ol>
<p>Il est indispensable de valider que tous les services <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> (y compris les <cite>timers</cite> systemd) sont bien arrêtés.</p>
<ol class="arabic" start="2">
<li><p class="first">Purge des données (le cas échéant) stockées dans MongoDB-data, excepté les bases <strong>identity</strong>, <strong>config</strong> et <strong>admin</strong> (procédure identique au cas du site primaire)</p>
</li>
<li><p class="first">Purge des données (le cas échéant) stockées dans Elasticsearch-data (procédure identique au cas du site primaire)</p>
</li>
<li><p class="first">Redémarrage du site secondaire Vitam</p>
<blockquote>
<div><ul>
<li><p class="first">Utiliser le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/start_vitam.yml</span></code></p>
</li>
<li><p class="first">La prochaine itération de reconstruction au fil de l’eau redémarrera la reconstruction à partir du début</p>
</li>
<li><p class="first">Attendre la fin de la reconstruction au fil de l’eau sur le site secondaire</p>
<blockquote>
<div><ul class="simple">
<li>Le suivi de la reconstruction se fait en observant l’évolution de l’offset de reconstruction stocké dans MongoDB-data</li>
<li>Pour la release 7 (version 1.4.x) il faut lancer le service dédié <code class="docutils literal notranslate"><span class="pre">vitam-metadata-graph-builder.service</span></code> sur le composant metadata pour recalculer le graphe des unités archivistiques et des groupes d’objets techniques n’ayant pas encore reconstruit leurs données graphe</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
</div>
<div class="section" id="controle-des-donnees-reconstruites">
<h2>5.18.3. Contrôle des données reconstruites<a class="headerlink" href="#controle-des-donnees-reconstruites" title="Lien permanent vers ce titre">¶</a></h2>
<p>La reconstruction des objets en base de données que ce soit sur MongoDB-data ou Elasticsearch-data est un processus long. Afin de contrôler si tous les objets ont été reconstruits ou si la reconstruction est toujours en cours il est nécessaire de compter les objets des collections Units et ObjectGroups de la base Metadata.</p>
<p>Un playbook a été réalisé afin de réaliser ce comptage à la fois sur Elasticsearch-data et sur MongoDB-data.</p>
<p>Il s’execute sur chacun des sites à comparer via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/reconstruction_doc_count.yml</span></code>.</p>
<p>À l’issue de l’exécution, le fichier environments/unit_got_docs_count.&lt;site_name&gt; est généré.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="24-griffins.html" class="btn btn-neutral float-left" title="5.17. Griffins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="31-pra.html" class="btn btn-neutral float-right" title="5.19. Plan de Reprise d’Activité (PRA)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>