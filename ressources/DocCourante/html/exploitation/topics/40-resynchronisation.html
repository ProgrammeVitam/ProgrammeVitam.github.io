<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.20. Resynchronisation d’une offre &mdash; Documentation VITAM - Documentation d&#39;exploitation 8.1.0</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.21. Audit comparatif entre 2 offres de stockage miroirs" href="45-offerdiff.html" />
    <link rel="prev" title="5.19. Plan de Reprise d’Activité (PRA)" href="31-pra.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            VITAM - Documentation d'exploitation
              <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Exploitation globale</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-accessgrants.html">5.1. Gestion des accès</a></li>
<li class="toctree-l2"><a class="reference internal" href="100-auditDataConsistency.html">5.2. Audit de cohérence de données entre MongoDb et Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="101-objectGroup-blackList-fields-in-search.html">5.3. Configuration des champs ObjectGroup devant être exclus de la recherche</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-adminportals.html">5.4. Portails d’administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-appconfig.html">5.5. Paramétrage &amp; configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-miseajour.html">5.6. Déploiement / mises à jour</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-maintenance.html">5.7. Interruption / maintenance</a></li>
<li class="toctree-l2"><a class="reference internal" href="16-backup_restore.html">5.8. Sauvegarde / restauration</a></li>
<li class="toctree-l2"><a class="reference internal" href="17-backup_restore_gros_volume.html">5.9. Sauvegarde et restauration de mongodb gros volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-securityprofile.html">5.10. Gestion des profils de sécurité</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-certificatpersonae.html">5.11. Certificats personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-grouped_tenants.html">5.12. Gestion des indexes Elasticseach dans un contexte massivement multi-tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-batchs.html">5.13. Batchs et traitements</a></li>
<li class="toctree-l2"><a class="reference internal" href="21-graphstorage.html">5.14. Sauvegarde des données graphe (Log shipping)</a></li>
<li class="toctree-l2"><a class="reference internal" href="22-graphcompute.html">5.15. Recalcul des données graphe</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-siegfried_signature.html">5.16. Montée de version du fichier de signature de Siegfried</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-griffins.html">5.17. Griffins</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-reconstruction.html">5.18. Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="31-pra.html">5.19. Plan de Reprise d’Activité (<code class="docutils literal notranslate"><span class="pre">PRA</span></code>)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.20. Resynchronisation d’une offre</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cas-de-l-ajout-d-une-nouvelle-offre">5.20.1. Cas de l’ajout d’une nouvelle offre</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure-de-resynchronisation-d-une-offre">5.20.2. Procédure de resynchronisation d’une offre</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure-de-resynchronisation-partielle-d-une-offre">5.20.3. Procédure de resynchronisation partielle d’une offre</a></li>
<li class="toctree-l3"><a class="reference internal" href="#procedure-de-resynchronisation-ciblee-d-une-offre">5.20.4. Procédure de resynchronisation ciblée d’une offre</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="45-offerdiff.html">5.21. Audit comparatif entre 2 offres de stockage miroirs</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html">5.22. Procédure d’exploitation suite à la création ou la modification d’une ontologie</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html#l-ontologie-externe-suite-a-la-montee-de-version-de-vitam">5.23. L’ontologie externe suite à la montée de version de <code class="docutils literal notranslate"><span class="pre">VITAM</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="60-forcedpause.html">5.24. Procédure d’exploitation pour la mise en pause forcée d’une opération</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-reindexation.html">5.25. Réindexation</a></li>
<li class="toctree-l2"><a class="reference internal" href="61-installation_nouveau_analyseur_elasticsearch.html">5.26. Recherche exacte sur des champs texte</a></li>
<li class="toctree-l2"><a class="reference internal" href="65-ingest-cleanup.html">5.27. Nettoyage des ingests incomplets</a></li>
<li class="toctree-l2"><a class="reference internal" href="66-dip-cleanup.html">5.28. Suppression des DIP et des fichiers de transfert</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-certificate-revocation.html">5.29. Procédure d’exploitation pour la révocation des certificats SIA et Personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="80-offer-activation.html">5.30. Activation/désactivation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-environment-cleaning.html">5.31. Nettoyage d’un environnement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composants/_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">12. Annexes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'exploitation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="_toc.html">5. Exploitation globale</a></li>
      <li class="breadcrumb-item active">5.20. Resynchronisation d’une offre</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/topics/40-resynchronisation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="resynchronisation-d-une-offre">
<span id="resynchronisation-offre"></span><h1>5.20. Resynchronisation d’une offre<a class="headerlink" href="#resynchronisation-d-une-offre" title="Lien permanent vers ce titre">¶</a></h1>
<p>Une offre de stockage peut être désynchronisée par rapport à une autre à la suite d’une indisponibilité plus ou moins longue voire totale de l’offre (<cite>crash</cite> majeur du système, panne matérielle etc.) ou bien encore à la suite d’une mise en maintenance programmée.</p>
<p>Le mécanisme de resynchronisation d’une offre par rapport à une autre nécessite une intervention d’exploitation manuelle permettant de remédier à la perte de données dans le système.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">En cas d’indisponibilité d’une offre, le processus d’entrée d’un <a class="reference internal" href="../introduction.html#term-sip"><span class="xref std std-term">SIP</span></a> n’étant réussi que si et seulement si toutes les offres de stockage définies dans la stratégie sont accessibles, et que tous les fichiers sont bien copiés sur la totalité de ces offres, il sera nécessaire de désactiver l’offre (cf. chapitre <a class="reference internal" href="80-offer-activation.html#activation-offre"><span class="std std-ref">Activation/désactivation d’une offre</span></a>) afin de permettre à nouveau les entrées de <a class="reference internal" href="../introduction.html#term-sip"><span class="xref std std-term">SIP</span></a> (ingest/versement).</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Il est recommandé de procéder à un audit d’intégrité dans le cadre d’opérations techniques ciblées, telles que l’évolution de la stratégie de stockage, un changement de stockage.</p>
</div>
<div class="section" id="cas-de-l-ajout-d-une-nouvelle-offre">
<span id="ajout-offre"></span><h2>5.20.1. Cas de l’ajout d’une nouvelle offre<a class="headerlink" href="#cas-de-l-ajout-d-une-nouvelle-offre" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Lors de l’ajout d’une nouvelle offre (portant un nouvel identifiant d’offre), les métadonnées des AU / GOT existants ne seront pas mis à jour avec l’information sur la nouvelle stratégie de stockage utilisée. L’ajout d’un mécanisme de mise à jour / propagation des métadonnées est prévu dans une version ultérieure. Lors de l’ajout d’une offre en remplacement d’une précédente offre, l’intégrité des métadonnées sera garantie en conservant le même identifiant d’offre.</p>
</div>
<p>L’ajout d’une nouvelle offre de stockage requiert le déploiement des applicatifs <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> associés selon la procédure suivante:</p>
<ul>
<li><p class="first">Éditer le fichier de configuration de l’inventaire de déploiement (généralement, fichier <code class="docutils literal notranslate"><span class="pre">hosts</span></code>) afin d’ajouter les nouveaux serveurs portant les composants à déployer (fonction de la topologie de déploiement retenue):</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">[</span><span class="nv">hosts_storage_offer_default</span><span class="p p-Indicator">]</span>
<span class="l l-Scalar l-Scalar-Plain">hostname-new-storage-offer      offer_conf=&lt;offer-z&gt;</span>

<span class="l l-Scalar l-Scalar-Plain">[hosts_mongos_offer]</span>
<span class="l l-Scalar l-Scalar-Plain">hostname-new-mongos-offer       offer_conf=&lt;offer-z&gt;</span>

<span class="l l-Scalar l-Scalar-Plain">[hosts_mongoc_offer]</span>
<span class="l l-Scalar l-Scalar-Plain">hostname-new-mongoc-offer       offer_conf=&lt;offer-z&gt;</span>

<span class="l l-Scalar l-Scalar-Plain">[hosts_mongod_offer]</span>
<span class="l l-Scalar l-Scalar-Plain">hostname-new-mongod-offer       offer_conf=&lt;offer-z&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Éditer le fichier de configuration de la stratégie de stockage <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/offer_opts.yml</span></code> afin d’ajouter la nouvelle offre:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_strategy</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-x&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
    <span class="l l-Scalar l-Scalar-Plain">rank</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="c1"># &lt;offer-z&gt; is the new offer</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-z&gt;</span>
    <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
    <span class="l l-Scalar l-Scalar-Plain">rank</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>

<span class="nt">vitam_offers</span><span class="p">:</span>
    <span class="nt">&lt;offer-x&gt;</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem</span>
    <span class="c1"># &lt;offer-z&gt; is the new offer</span>
    <span class="nt">&lt;offer-z&gt;</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem</span>
</pre></div>
</div>
<p>Si la nouvelle offre est utilisée dans une stratégie additionnelle (<code class="docutils literal notranslate"><span class="pre">other_strategies</span></code>), la modification sera la suivante:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">other_strategies</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-x&gt;</span>
        <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
        <span class="l l-Scalar l-Scalar-Plain">rank</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class="c1"># &lt;offer-z&gt; is the new offer</span>
    <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-z&gt;</span>
        <span class="l l-Scalar l-Scalar-Plain">referent</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
        <span class="l l-Scalar l-Scalar-Plain">rank</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="nt">vitam_offers</span><span class="p">:</span>
    <span class="nt">&lt;offer-x&gt;</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem</span>
    <span class="c1"># &lt;offer-z&gt; is the new offer</span>
    <span class="nt">&lt;offer-z&gt;</span><span class="p">:</span>
        <span class="nt">provider</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">filesystem</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Éditer le fichier de déclaration des secrets généraux <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/vault-vitam.yml</span></code> afin d’y ajouter les secrets associés à la nouvelle offre:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">mongodb</span><span class="p">:</span>
    <span class="nt">&lt;offer-z&gt;</span><span class="p">:</span>
        <span class="nt">passphrase</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;passphrase&gt;</span>
        <span class="nt">admin</span><span class="p">:</span>
          <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;admin-user&gt;</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;admin-password&gt;</span>
        <span class="nt">localadmin</span><span class="p">:</span>
          <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;localadmin-user&gt;</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;localadmin-password&gt;</span>
        <span class="nt">offer</span><span class="p">:</span>
          <span class="nt">user</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-user&gt;</span>
          <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">&lt;offer-password&gt;</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Exécuter la commande suivante afin de déployer les nouveaux composants storage-offer, mongos-offer, mongoc-offer, mongod-offer:</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>On considère que les étapes de génération des <cite>hostvars</cite>, de génération des magasins de certificats et de mise en place des repositories <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ont été réalisées au préalable pour les serveurs concernées (se référer aux sections du <cite>DIN</cite> correspondantes).</p>
<div class="last highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam/vitam.yml -i environments/hosts.&lt;environnement&gt; --ask-vault-pass --limit <span class="s2">&quot;hostname-new-storage-offer,hostname-new-mongos-offer,hostname-new-mongoc-offer,hostname-new-mongod-offer&quot;</span>
</pre></div>
</div>
</div>
<p>La nouvelle offre doit ensuite être déclarée dans la stratégie de stockage par reconfiguration du moteur de stockage selon la procédure suivante:</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Cette opération provoque une indisponibilité temporaire des principaux services <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> (versement, gestion, recherche et consultation)</p>
</div>
<ul>
<li><p class="first">Exécuter la commande suivante afin de reconfigurer le composant storage-engine :</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam/vitam.yml -i environments/hosts.&lt;environnement&gt; --ask-vault-pass --limit hosts_storage_engine --tags update_vitam_configuration
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="procedure-de-resynchronisation-d-une-offre">
<h2>5.20.2. Procédure de resynchronisation d’une offre<a class="headerlink" href="#procedure-de-resynchronisation-d-une-offre" title="Lien permanent vers ce titre">¶</a></h2>
<p>La resynchronisation d’une offre à partir du contenu d’une autre offre s’effectue en suivant la procédure suivante:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Cette procédure n’impacte pas les services <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>. Le mécanisme de reconstruction du contenu des bases de données (MongoDB-data, Elasticsearch-data) à partir des informations présentes dans les offres de stockage fonctionne de manière concurrente au mécanisme de resynchronisation.</p>
</div>
<ul>
<li><p class="first">Exécuter la commande suivante afin de resynchroniser la nouvelle offre vis-à-vis de l’offre (des offres) source(s):</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v -X POST -u adminUser:adminPassword --header <span class="s1">&#39;content-type: application/json&#39;</span> --header <span class="s1">&#39;accept: application/json&#39;</span> http://&lt;storageengine&gt;:29102/storage/v1/offerSync --data <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;sourceOffer&quot;: &quot;&lt;offer-x&gt;.service.consul&quot;,</span>
<span class="s1">    &quot;targetOffer&quot;: &quot;&lt;offer-z&gt;.service.consul&quot;,</span>
<span class="s1">    &quot;strategyId&quot;: &lt;strategyId&gt;,</span>
<span class="s1">    &quot;container&quot;: &lt;datatype&gt;,</span>
<span class="s1">    &quot;tenantId&quot;: &lt;tenantId&gt;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">adminUser</span></code> correspond à la valeur <code class="docutils literal notranslate"><span class="pre">admin_basic_auth_user</span></code> déclarée dans le fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/advanced/vitam_security.yml</span></code></li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">adminPassword</span></code> correspond à la valeur <code class="docutils literal notranslate"><span class="pre">admin_basic_auth_password</span></code> déclarée dans le fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/vault-vitam.yml</span></code></li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">sourceOffer</span></code> correspond à l”<strong>id</strong> de l’offre source utilisée pour la resynchronisation de la nouvelle offre</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">targetOffer</span></code> correspond à l”<strong>id</strong> de l’offre à resynchroniser</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">strategyId</span></code> correspond à la stratégie des offres source et cible</li>
<li>le paramètre <code class="docutils literal notranslate"><span class="pre">tenantId</span></code> correspond au tenant sur lequel appliquer la synchronisation</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">container</span></code> correspond à un élément datatype de la liste suivante :</li>
</ul>
</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&quot;units&quot;
&quot;objects&quot;
&quot;objectgroups&quot;
&quot;logbooks&quot;
&quot;reports&quot;
&quot;manifests&quot;
&quot;profiles&quot;
&quot;storagelog&quot;
&quot;storageaccesslog&quot;
&quot;storagetraceability&quot;
&quot;rules&quot;
&quot;dip&quot;
&quot;agencies&quot;
&quot;backup&quot;
&quot;backupoperations&quot;
&quot;unitgraph&quot;
&quot;objectgroupgraph&quot;
&quot;distributionreports&quot;
&quot;accessionregistersdetail&quot;
&quot;accessionregisterssymbolic&quot;
&quot;tmp&quot;
&quot;archivaltransferreply&quot;
</pre></div>
</div>
<ul>
<li><p class="first">Suivre les journaux de la resynchronisation dans les logs du composant storage offer avec la commande suivante:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>tail -F /vitam/log/storage/storage_offer_sync.<span class="se">\*</span>.log
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Vérifier l’état d’exécution de la synchronisation via la commande (peut être scriptée) :</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v -X HEAD -i -u adminUser:adminPassword http://&lt;storageengine&gt;:29102/storage/v1/offerSync
</pre></div>
</div>
<p>L’entête <code class="docutils literal notranslate"><span class="pre">Running</span></code> indique l’état d’exécution de processus de synchronisation.</p>
</div></blockquote>
</li>
<li><p class="first">Vérifier le détail d’exécution de la synchronisation via la commande :</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v -X GET -u adminUser:adminPassword http://&lt;storageengine&gt;:29102/storage/v1/offerSync
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Exemple de script shell permettant de faire une resynchronisation complète de l’ensemble des containers d’une offre à une autre.
Ce script est à exécuter à partir d’une vm du groupe <cite>hosts_storage_engine</cite>. Il est recommandé de l’exécuter à l’intérieur d’un <cite>screen</cite> car l’exécution peut-être longue en fonction de la volumétrie à transférer.</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># Script permettant de lancer la synchronisation de l&#39;ensemble des containers d&#39;une offre de stockage à une autre.</span>
<span class="c1"># /!\ Ce script est à exécuter à partir d&#39;une vm du groupe hosts_storage_engine</span>

<span class="c1">################################################################################</span>
<span class="c1">## TODO: Paramètres à personnaliser</span>

<span class="c1"># cat environments/group_vars/all/advanced/vitam_security.yml | grep admin_basic_auth_user</span>
<span class="nv">admin_basic_auth_user</span><span class="o">=</span><span class="s1">&#39;adminUser&#39;</span>
<span class="c1"># ansible-vault view environments/group_vars/all/main/vault-vitam.yml --vault-password-file vault_pass.txt | grep admin_basic_auth_password</span>
<span class="nv">admin_basic_auth_password</span><span class="o">=</span><span class="s1">&#39;adminPassword&#39;</span>

<span class="c1"># cat environments/group_vars/all/advanced/vitam_vars.yml | grep consul_domain:</span>
<span class="c1">## consul_domain: consul</span>
<span class="c1"># cat environments/group_vars/all/main/offers_opts.yml</span>
<span class="c1">## vitam_strategy.{name,vitam_site_name}</span>
<span class="c1"># cat environments/hosts.env | grep ^vitam_site_name</span>
<span class="c1">## vitam_site_name=dc1</span>

<span class="c1">## {{ vitam_strategy.name }}.service.{{ vitam_strategy.vitam_site_name }}.{{ consul_domain }}</span>
<span class="c1"># ou l&#39;id de l&#39;offre à synchroniser tel que définit dans environments/group_vars/all/main/offers_opts.yml.</span>
<span class="nv">sourceOffer</span><span class="o">=</span><span class="s2">&quot;offer-fs-1.service.dc1.consul&quot;</span>
<span class="nv">targetOffer</span><span class="o">=</span><span class="s2">&quot;offer-fs-2.service.dc1.consul&quot;</span>

<span class="c1"># cat environments/group_vars/all/advanced/tenants_vars.yml | grep vitam_tenant_ids</span>
<span class="nb">declare</span> -a <span class="nv">tenants</span><span class="o">=</span><span class="s2">&quot;0 1 2&quot;</span>

<span class="c1">################################################################################</span>
<span class="c1">## Récupération de l&#39;ip:port du processus storage-engine local</span>
<span class="nv">service_storage</span><span class="o">=</span><span class="sb">`</span>netstat -ln <span class="p">|</span> awk -F<span class="s2">&quot; &quot;</span> <span class="s1">&#39;{print $4}&#39;</span> <span class="p">|</span> grep <span class="m">29102</span><span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$service_storage</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;ERROR: Could not find service vitam-storage running on port 29102.&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1">## Liste des containers</span>
<span class="nb">declare</span> -a <span class="nv">containers</span><span class="o">=</span><span class="s2">&quot;units objects objectgroups logbooks reports manifests profiles storagelog storageaccesslog storagetraceability rules dip agencies backup backupoperations unitgraph objectgroupgraph distributionreports accessionregistersdetail accessionregisterssymbolic tmp archivaltransferreply&quot;</span>

<span class="c1">## Confirmation du lancement de la synchro</span>
<span class="nb">echo</span> <span class="s2">&quot;Synchronisation de </span><span class="nv">$sourceOffer</span><span class="s2"> =&gt; </span><span class="nv">$targetOffer</span><span class="s2">&quot;</span>
<span class="nb">read</span> -p <span class="s2">&quot;Étes-vous sûr de vouloir lancer la synchronisation ? YES/[NO]&quot;</span> GO
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$GO</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;YES&quot;</span> <span class="o">]]</span>
<span class="k">then</span>
<span class="nb">echo</span> <span class="s2">&quot;Arrêt de la procédure de synchronisation.&quot;</span>
<span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;# Lancement de la procédure de synchronisation de la nouvelle offre&quot;</span>
<span class="k">for</span> tenant in <span class="nv">$tenants</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;********************************************************************************&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;# Synchronisation du tenant </span><span class="nv">$tenant</span><span class="s2">&quot;</span>
    <span class="k">for</span> container in <span class="nv">$containers</span><span class="p">;</span> <span class="k">do</span>
        <span class="nb">echo</span> <span class="s2">&quot;## Synchronisation </span><span class="si">${</span><span class="nv">tenant</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">container</span><span class="si">}</span><span class="s2">&quot;</span>
        curl -X POST -u <span class="nv">$admin_basic_auth_user</span>:<span class="nv">$admin_basic_auth_password</span> --header <span class="s1">&#39;accept: application/json&#39;</span> --header <span class="s1">&#39;content-type: application/json&#39;</span> http://<span class="nv">$service_storage</span>/storage/v1/offerSync <span class="se">\</span>
        --data <span class="s2">&quot;{ \&quot;sourceOffer\&quot;: \&quot;</span><span class="si">${</span><span class="nv">sourceOffer</span><span class="si">}</span><span class="s2">\&quot;, \&quot;targetOffer\&quot;: \&quot;</span><span class="si">${</span><span class="nv">targetOffer</span><span class="si">}</span><span class="s2">\&quot;, \&quot;strategyId\&quot;: \&quot;default\&quot;, \&quot;container\&quot;: \&quot;</span><span class="si">${</span><span class="nv">container</span><span class="si">}</span><span class="s2">\&quot;, \&quot;tenantId\&quot;: </span><span class="si">${</span><span class="nv">tenant</span><span class="si">}</span><span class="s2"> }&#39;&quot;</span>

        <span class="k">while</span> curl --silent -X HEAD -i -u <span class="nv">$admin_basic_auth_user</span>:<span class="nv">$admin_basic_auth_password</span> http://<span class="nv">$service_storage</span>/storage/v1/offerSync <span class="p">|</span> grep <span class="s1">&#39;Running: true&#39;</span><span class="p">;</span> <span class="k">do</span>
            curl -X GET -u <span class="nv">$admin_basic_auth_user</span>:<span class="nv">$admin_basic_auth_password</span> http://<span class="nv">$service_storage</span>/storage/v1/offerSync
            <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
            sleep <span class="m">5</span>
        <span class="k">done</span>
        <span class="nb">echo</span> <span class="s2">&quot;## Fin de la synchronisation du tenant </span><span class="si">${</span><span class="nv">tenant</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">container</span><span class="si">}</span><span class="s2">&quot;</span>
        curl -X GET -u <span class="nv">$admin_basic_auth_user</span>:<span class="nv">$admin_basic_auth_password</span> http://<span class="nv">$service_storage</span>/storage/v1/offerSync
        <span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
    <span class="k">done</span>
<span class="k">done</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="procedure-de-resynchronisation-partielle-d-une-offre">
<h2>5.20.3. Procédure de resynchronisation partielle d’une offre<a class="headerlink" href="#procedure-de-resynchronisation-partielle-d-une-offre" title="Lien permanent vers ce titre">¶</a></h2>
<ul>
<li><p class="first">En cas de resynchronisation partielle d’une offre, il est possible d’exécuter le processus de resynchronisation à partir d’un <code class="docutils literal notranslate"><span class="pre">offset</span></code> :</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v -X POST -u adminUser:adminPassword --header <span class="s1">&#39;content-type: application/json&#39;</span> --header <span class="s1">&#39;accept: application/json&#39;</span> http://&lt;storageengine&gt;:29102/storage/v1/offerSync --data <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;sourceOffer&quot;: &quot;&lt;offer-x&gt;.&lt;consul_domain&gt;&quot;,</span>
<span class="s1">    &quot;targetOffer&quot;: &quot;&lt;offer-z&gt;.&lt;consul_domain&gt;&quot;,</span>
<span class="s1">    &quot;strategyId&quot;: &lt;strategyId&gt;,</span>
<span class="s1">    &quot;offset&quot;: &lt;offset&gt;,</span>
<span class="s1">    &quot;container&quot;: &lt;datatype&gt;,</span>
<span class="s1">    &quot;tenantId&quot;: &lt;tenantId&gt;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>Où &lt;datatype&gt; doit prendre les valeurs suivantes :</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&quot;units&quot;
&quot;objects&quot;
&quot;objectgroups&quot;
&quot;logbooks&quot;
&quot;reports&quot;
&quot;manifests&quot;
&quot;profiles&quot;
&quot;storagelog&quot;
&quot;storageaccesslog&quot;
&quot;storagetraceability&quot;
&quot;rules&quot;
&quot;dip&quot;
&quot;agencies&quot;
&quot;backup&quot;
&quot;backupoperations&quot;
&quot;unitgraph&quot;
&quot;objectgroupgraph&quot;
&quot;distributionreports&quot;
&quot;accessionregistersdetail&quot;
&quot;accessionregisterssymbolic&quot;
&quot;tmp&quot;
&quot;archivaltransferreply&quot;
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">offset</span></code> correspond à la valeur du dernier <code class="docutils literal notranslate"><span class="pre">offset</span></code> observé dans les logs du composant storage offer (cas d’une reprise suite à interruption ou échec de la procédure de resynchronisation). Le paramètre <code class="docutils literal notranslate"><span class="pre">offset</span></code> peut également être déterminé via les enregistrements de la collection <code class="docutils literal notranslate"><span class="pre">OfferLog</span></code> (database <code class="docutils literal notranslate"><span class="pre">offer</span></code>) depuis la base MongoDB associée à l’offre à resynchroniser (cas d’une panne ou d’une mise en maintenance programmée à une date précise).</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="procedure-de-resynchronisation-ciblee-d-une-offre">
<h2>5.20.4. Procédure de resynchronisation ciblée d’une offre<a class="headerlink" href="#procedure-de-resynchronisation-ciblee-d-une-offre" title="Lien permanent vers ce titre">¶</a></h2>
<p>La release R13 permet l’exécution d’une resynchronisation ciblée d’une offre de stockage, à partir d’une liste d’items à resynchroniser.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -v -X POST -u adminUser:adminPassword --header <span class="s1">&#39;content-type: application/json&#39;</span> --header <span class="s1">&#39;accept: application/json&#39;</span> http://&lt;storageengine&gt;:29102/storage/v1/offerPartialSync --data <span class="s1">&#39;</span>
<span class="s1">{</span>
<span class="s1">    &quot;strategyId&quot; : &lt;strategyId&gt;,</span>
<span class="s1">    &quot;sourceOffer&quot; : &quot;&lt;offer-x&gt;.service.consul&quot;,</span>
<span class="s1">    &quot;targetOffer&quot; : &quot;&lt;offer-z&gt;.service.consul&quot;,</span>
<span class="s1">    &quot;itemsToSynchronize&quot; : [ {</span>
<span class="s1">        &quot;container&quot; : &quot;objects&quot;,</span>
<span class="s1">        &quot;tenantId&quot; : 0,</span>
<span class="s1">        &quot;filenames&quot; : [ &quot;ObjectId0&quot;, &quot;ObjectId1&quot;, &quot;ObjectId2&quot;, &quot;ObjectId3&quot;, &quot;ObjectId4&quot; ]</span>
<span class="s1">    },{</span>
<span class="s1">        &quot;container&quot; : &quot;units&quot;,</span>
<span class="s1">        &quot;tenantId&quot; : 0,</span>
<span class="s1">        &quot;filenames&quot; : [ &quot;UnitId0&quot;, &quot;UnitId1&quot;]</span>
<span class="s1">    } ]</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">adminUser</span></code> correspond à la valeur <code class="docutils literal notranslate"><span class="pre">admin_basic_auth_user</span></code> déclarée dans le fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/advanced/vitam_security.yml</span></code></li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">adminPassword</span></code> correspond à la valeur <code class="docutils literal notranslate"><span class="pre">admin_basic_auth_password</span></code> déclarée dans le fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/main/vault-vitam.yml</span></code></li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">sourceOffer</span></code> correspond à l”<strong>id</strong> de l’offre source utilisée pour la resynchronisation de la nouvelle offre</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">targetOffer</span></code> correspond à l”<strong>id</strong> de l’offre à resynchroniser</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">strategyId</span></code> correspond à la stratégie des offres source et cible</li>
<li>le paramètre <code class="docutils literal notranslate"><span class="pre">tenantId</span></code> correspond au tenant sur lequel appliquer la synchronisation</li>
<li>Le paramètre <code class="docutils literal notranslate"><span class="pre">container</span></code> correspond à un élément datatype de la liste suivante :</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&quot;units&quot;
&quot;objects&quot;
&quot;objectgroups&quot;
&quot;logbooks&quot;
&quot;reports&quot;
&quot;manifests&quot;
&quot;profiles&quot;
&quot;storagelog&quot;
&quot;storageaccesslog&quot;
&quot;storagetraceability&quot;
&quot;rules&quot;
&quot;dip&quot;
&quot;agencies&quot;
&quot;backup&quot;
&quot;backupoperations&quot;
&quot;unitgraph&quot;
&quot;objectgroupgraph&quot;
&quot;distributionreports&quot;
&quot;accessionregistersdetail&quot;
&quot;accessionregisterssymbolic&quot;
&quot;tmp&quot;
&quot;archivaltransferreply&quot;
</pre></div>
</div>
<p>Depuis l’offre <code class="docutils literal notranslate"><span class="pre">sourceOffer</span></code>, la procédure récupère les <code class="docutils literal notranslate"><span class="pre">filenames</span></code> pour le <code class="docutils literal notranslate"><span class="pre">tenantId</span></code> et le <code class="docutils literal notranslate"><span class="pre">container</span></code> concerné.
* Si les fichiers sont trouvés, ils sont alors recopiés sur l’offre <code class="docutils literal notranslate"><span class="pre">targetOffer</span></code>
* Si les fichiers ne sont pas trouvés, ils seront supprimés de l’offre <code class="docutils literal notranslate"><span class="pre">targetOffer</span></code></p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="31-pra.html" class="btn btn-neutral float-left" title="5.19. Plan de Reprise d’Activité (PRA)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="45-offerdiff.html" class="btn btn-neutral float-right" title="5.21. Audit comparatif entre 2 offres de stockage miroirs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>