

<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>5.8. Sauvegarde / restauration &mdash; Documentation VITAM - Documentation d&#39;exploitation 5.0</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'5.0',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Recherche" href="../search.html" />
    <link rel="next" title="5.9. Sauvegarde et restauration de mongodb gros volumes" href="17-backup_restore_gros_volume.html" />
    <link rel="prev" title="5.7. Interruption / maintenance" href="15-maintenance.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Documentation d'exploitation
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Exploitation globale</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="10-accessgrants.html">5.1. Gestion des accès</a></li>
<li class="toctree-l2"><a class="reference internal" href="100-auditDataConsistency.html">5.2. Audit de cohérence de données entre MongoDb et Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="101-objectGroup-blackList-fields-in-search.html">5.3. Configuration des champs ObjectGroup devant être exclus de la recherche</a></li>
<li class="toctree-l2"><a class="reference internal" href="11-adminportals.html">5.4. Portails d’administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="12-appconfig.html">5.5. Paramétrage &amp; configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="14-miseajour.html">5.6. Déploiement / mises à jour</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-maintenance.html">5.7. Interruption / maintenance</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.8. Sauvegarde / restauration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde">5.8.1. Sauvegarde</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mongodb">5.8.1.1. mongoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#elasticsearch">5.8.1.2. Elasticsearch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#restauration">5.8.2. Restauration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">5.8.2.1. mongoDB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">5.8.2.2. Elasticsearch</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cas-de-la-base-mongo-certificates">5.8.3. Cas de la base mongo certificates</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="17-backup_restore_gros_volume.html">5.9. Sauvegarde et restauration de mongodb gros volumes</a></li>
<li class="toctree-l2"><a class="reference internal" href="18-securityprofile.html">5.10. Gestion des profils de sécurité</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-certificatpersonae.html">5.11. Certificats personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="19-grouped_tenants.html">5.12. Gestion des indexes Elasticseach dans un contexte massivement multi-tenants</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-batchs.html">5.13. Batchs et traitements</a></li>
<li class="toctree-l2"><a class="reference internal" href="21-graphstorage.html">5.14. Sauvegarde des données graphe (Log shipping)</a></li>
<li class="toctree-l2"><a class="reference internal" href="22-graphcompute.html">5.15. Recalcul des données graphe</a></li>
<li class="toctree-l2"><a class="reference internal" href="23-siegfried_signature.html">5.16. Montée de version du fichier de signature de Siegfried</a></li>
<li class="toctree-l2"><a class="reference internal" href="24-griffins.html">5.17. Griffins</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-reconstruction.html">5.18. Reconstruction</a></li>
<li class="toctree-l2"><a class="reference internal" href="31-pra.html">5.19. Plan de Reprise d’Activité (<code class="docutils literal notranslate"><span class="pre">PRA</span></code>)</a></li>
<li class="toctree-l2"><a class="reference internal" href="40-resynchronisation.html">5.20. Resynchronisation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="45-offerdiff.html">5.21. Audit comparatif entre 2 offres de stockage miroirs</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html">5.22. Procédure d’exploitation suite à la création ou la modification d’une ontologie</a></li>
<li class="toctree-l2"><a class="reference internal" href="50-ontologies.html#l-ontologie-externe-suite-a-la-montee-de-version-de-vitam">5.23. L’ontologie externe suite à la montée de version de <code class="docutils literal notranslate"><span class="pre">VITAM</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="60-forcedpause.html">5.24. Procédure d’exploitation pour la mise en pause forcée d’une opération</a></li>
<li class="toctree-l2"><a class="reference internal" href="60-reindexation.html">5.25. Réindexation</a></li>
<li class="toctree-l2"><a class="reference internal" href="65-ingest-cleanup.html">5.26. Nettoyage des ingests incomplets</a></li>
<li class="toctree-l2"><a class="reference internal" href="66-dip-cleanup.html">5.27. Suppression des DIP et des fichiers de transfert</a></li>
<li class="toctree-l2"><a class="reference internal" href="70-certificate-revocation.html">5.28. Procédure d’exploitation pour la révocation des certificats SIA et Personae</a></li>
<li class="toctree-l2"><a class="reference internal" href="80-offer-activation.html">5.29. Activation/désactivation d’une offre</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-environment-cleaning.html">5.30. Nettoyage d’un environnement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1"><a class="reference internal" href="../composants/_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../annexes/_toc.html">12. Annexes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">VITAM - Documentation d'exploitation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="_toc.html">5. Exploitation globale</a> &raquo;</li>
        
      <li>5.8. Sauvegarde / restauration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/topics/16-backup_restore.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sauvegarde-restauration">
<h1>5.8. Sauvegarde / restauration<a class="headerlink" href="#sauvegarde-restauration" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">La sauvegarde des bases de métadonnées MongoDB et Elasticsearch, ainsi que la restauration de leur contenu en cohérence avec les offres sous-jacentes, est déjà gérée par les mécanismes intrinsèques à la solution <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a>, cf. le <a class="reference internal" href="../introduction.html#term-dat"><span class="xref std std-term">DAT</span></a>, chapitre <strong>reconstruction</strong>. Il est toutefois recommandé de réaliser des sauvegardes lors d’événements d’exploitation, tel que l’upgrade de la plateforme, ou de manière régulière, lorsque le volume de données en base est important, et ce, afin d’éviter un processus de reconstruction trop long.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Cette méthode s’applique uniquement pour des déploiements de petite taille et n’est pas recommandée pour un usage en production dont le volume de données géré est important (plusieurs centaines de millions d’AU).</p>
</div>
<p>Les procédures sont issues des documentations officielles :</p>
<ul class="simple">
<li>mongoDB : <a class="reference external" href="https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/">https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/</a></li>
<li>elasticsearch : <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-snapshots.html</a></li>
</ul>
<div class="section" id="sauvegarde">
<h2>5.8.1. Sauvegarde<a class="headerlink" href="#sauvegarde" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pour que cette sauvegarde soit fonctionnellement correcte, il faut que la solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> soit dans un état stable et cohérent, sans possibilité de réaliser des versements et sans travail de fond (jobs de sécurisation, …). Il est recommandé de l’exécuter lorsque les services client des bases sont éteints. Pour une sauvegarde à chaud, se référer à la documentation officielle afin de disposer de l’ensemble de la procédure sécurisée.</p>
</div>
<div class="section" id="mongodb">
<h3>5.8.1.1. mongoDB<a class="headerlink" href="#mongodb" title="Lien permanent vers ce titre">¶</a></h3>
<p>La commande suivante est à lancer depuis une machine hébergeant le composant <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> dans le cas d’un serveur standalone ou <code class="docutils literal notranslate"><span class="pre">vitam-mongos</span></code> dans le cas d’un cluster shardé. Il est aussi possible de l’exécuter pour chaque shard, en considérant le serveur primary comme un serveur standalone, autrement dit depuis un composant <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> de chaque shard.
La commande est à lancer pour le mongo data ET pour chaque mongo offer de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> :</p>
<blockquote>
<div>mongodump –host mongodb.example.net –port 27017 –out /data/backup/ –username vitamdb-admin –password «&nbsp;pass&nbsp;» –gzip</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Vérifier que l’espace disponible dans le répertoire de sauvegarde (défini par <code class="docutils literal notranslate"><span class="pre">--out</span></code>) est cohérent au volume de données à sauvegarder (compressé)</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Se reporter au fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/vault-vitam.yml</span></code> de l’ansiblerie de déploiement pour le mot de passe <code class="docutils literal notranslate"><span class="pre">vitamdb-admin</span></code></p>
</div>
<p>Rapatrier sur un serveur approprié le produit généré dans la valeur de <code class="docutils literal notranslate"><span class="pre">--out</span></code>.</p>
<p>Pour rappel, il y a un cluster mongo de «&nbsp;data&nbsp;», ainsi qu’un cluster mongo «&nbsp;offer&nbsp;» associé à chaque offre. Pour un système cohérent, il faut effectuer la sauvegarde de chacun de ces <em>clusters</em>.</p>
</div>
<div class="section" id="elasticsearch">
<h3>5.8.1.2. Elasticsearch<a class="headerlink" href="#elasticsearch" title="Lien permanent vers ce titre">¶</a></h3>
<p>La commande suivante est à lancer depuis une machine elasticsearch de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> ayant un espace suffisant dans le répertoire de sauvegarde :</p>
<blockquote>
<div>curl -X PUT <a class="reference external" href="http://elasticsearch-data.service">http://elasticsearch-data.service</a>.${consul_domain}:9200/_snapshot/vitam_backup -d “{ «&nbsp;type&nbsp;»: «&nbsp;fs&nbsp;», «&nbsp;settings&nbsp;»: { «&nbsp;location&nbsp;»: «&nbsp;${output_dir}&nbsp;» } }”</div></blockquote>
<p>Cette étape va créer le <em>repository</em> <strong>vitam_backup</strong> de sauvegarde, l’arborescence étant définie par <code class="docutils literal notranslate"><span class="pre">${output_dir}</span></code>.</p>
<p>Pour vérifier l’état du <em>repository</em> <strong>vitam_backup</strong> sur les noeuds du cluster</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elasticsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/_verify
</pre></div>
</div>
<p>Pour lancer un <em>snapshot</em> (dans l’exemple, appelé snapshot_1)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X PUT http://elasticsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/snapshot_1?wait_for_completion=true
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">la commande ne rendra la main qu’à la fin de la procédure de <em>snapshot</em>.</p>
</div>
<p>A l’issue de la sauvegarde, procéder à une recopie de <code class="docutils literal notranslate"><span class="pre">${output_dir}</span></code> sur un serveur à part.</p>
</div>
</div>
<div class="section" id="restauration">
<h2>5.8.2. Restauration<a class="headerlink" href="#restauration" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Comme pour la sauvegarde, la restauration ne peut s’effectuer que sur un environnement <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> stable et cohérent, sans possibilité de réaliser des versements et sans travail de fond (jobs de sécurisation, …). De plus, le contenu restauré doit être cohérent avec le contenu des offres de stockage sous-jacentes.</p>
</div>
<div class="section" id="id1">
<h3>5.8.2.1. mongoDB<a class="headerlink" href="#id1" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il faut d’abord procéder au rapatriement dans <code class="docutils literal notranslate"><span class="pre">${output_dir}</span></code> de la sauvegarde à appliquer.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">une sauvegarde ne peut se restaurer que sur un environnement dans la même version.</p>
</div>
<p>La commande suivante est à lancer depuis une machine mongo de <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> possédant le répertoire de sauvegarde à restaurer vers le serveur mongod ou mongos (selon le cas sélectionné à l’import et en rapport à la présence d’un serveur standalone ou d’un cluster shardé) :</p>
<blockquote>
<div>mongorestore –host mongodb1.example.net –port 27017 –username vitamdb-admin –password “pass” ${output_dir}/${fichier} –gzip</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Se reporter au fichier <code class="docutils literal notranslate"><span class="pre">deployment/environments/group_vars/all/vault-vitam.yml</span></code> de l’ansiblerie de déploiement pour le mot de passe <code class="docutils literal notranslate"><span class="pre">vitamdb-admin</span></code></p>
</div>
</div>
<div class="section" id="id2">
<h3>5.8.2.2. Elasticsearch<a class="headerlink" href="#id2" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il faut d’abord procéder au rapatriement dans <code class="docutils literal notranslate"><span class="pre">${output_dir}</span></code> de la sauvegarde à appliquer.</p>
<p>Commande pour lister les <em>snapshots</em> de <strong>vitam_backup</strong> (repository)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X GET http://elasticsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/
</pre></div>
</div>
<p>Pour lancer une restauration, placer le nom du <em>snapshot</em> à la place de *snapshot* dans l’URL suivante</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl -X POST http://elasticsearch-data.service.${consul_domain}:9200/_snapshot/vitam_backup/*snapshot*/_restore
</pre></div>
</div>
</div>
</div>
<div class="section" id="cas-de-la-base-mongo-certificates">
<span id="backupidentity"></span><h2>5.8.3. Cas de la base mongo certificates<a class="headerlink" href="#cas-de-la-base-mongo-certificates" title="Lien permanent vers ce titre">¶</a></h2>
<p>La solution logicielle <a class="reference internal" href="../introduction.html#term-vitam"><span class="xref std std-term">VITAM</span></a> fournit un playbook de sauvegarde de la base de données <code class="docutils literal notranslate"><span class="pre">identity</span></code> ; le <cite>backup</cite> réalisé est stocké sur la machine de déploiement.</p>
<p>Pour lancer le playbook de sauvegarde</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ansible</span><span class="o">-</span><span class="n">playbook</span> <span class="n">ansible</span><span class="o">-</span><span class="n">vitam</span><span class="o">-</span><span class="n">exploitation</span><span class="o">/</span><span class="n">backup_database_certificates</span><span class="o">.</span><span class="n">yml</span> <span class="o">-</span><span class="n">i</span> <span class="n">environments</span><span class="o">/</span><span class="n">hosts</span><span class="o">.&lt;</span><span class="n">environnement</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">ask</span><span class="o">-</span><span class="n">vault</span><span class="o">-</span><span class="k">pass</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Il est recommandé de procéder à une sauvegarde régulière de la collection <strong>identity</strong>, ou suite à des modifications sur les certificats (ajout / mise à jour / révocation).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="17-backup_restore_gros_volume.html" class="btn btn-neutral float-right" title="5.9. Sauvegarde et restauration de mongodb gros volumes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="15-maintenance.html" class="btn btn-neutral float-left" title="5.7. Interruption / maintenance" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>