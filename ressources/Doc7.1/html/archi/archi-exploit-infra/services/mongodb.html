<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.11.19. Mongodb &mdash; Documentation VITAM - Architecture 7.0.1</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="5.11.20. Processing" href="processing.html" />
    <link rel="prev" title="5.11.18. Metadata Collect" href="metadata-collect.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Architecture
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                7.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/_toc.html">3. Vue d’ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archi-applicative/_toc.html">4. Architecture applicative</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">5. Architecture technique / exploitation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../principes/_toc.html">5.1. Principes d’architecture technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01-services-techniques.html">5.2. Services techniques fournis par la solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02-dependencies.html">5.3. Composants logiciels utilisés</a></li>
<li class="toctree-l2"><a class="reference internal" href="../03-technical-architecture.html">5.4. Architecture technique détaillée</a></li>
<li class="toctree-l2"><a class="reference internal" href="../04-data-storage.html">5.5. Stockage des données</a></li>
<li class="toctree-l2"><a class="reference internal" href="../05-logs-architecture.html">5.6. Concentration et exploitation des logs applicatifs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../06-metrics-architecture.html">5.7. Métriques applicatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="../07-deployment-tooling.html">5.8. Outillage de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../08-consul.html">5.9. Service registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../10-it-services.html">5.10. Dépendances aux services d’infrastructures</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../15-services.html">5.11. Composants déployés</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="access-external.html">5.11.1. Access-external</a></li>
<li class="toctree-l3"><a class="reference internal" href="access-internal.html">5.11.2. Access-internal</a></li>
<li class="toctree-l3"><a class="reference internal" href="batch-report.html">5.11.3. Batch-report</a></li>
<li class="toctree-l3"><a class="reference internal" href="collect-external.html">5.11.4. Collect-external</a></li>
<li class="toctree-l3"><a class="reference internal" href="collect-internal.html">5.11.5. Collect-internal</a></li>
<li class="toctree-l3"><a class="reference internal" href="consul.html">5.11.6. Consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="curator.html">5.11.7. Curator</a></li>
<li class="toctree-l3"><a class="reference internal" href="elasticsearch-data.html">5.11.8. Elasticsearch-data</a></li>
<li class="toctree-l3"><a class="reference internal" href="elasticsearch-log.html">5.11.9. Elasticsearch-log</a></li>
<li class="toctree-l3"><a class="reference internal" href="functional-administration.html">5.11.10. Functional-administration</a></li>
<li class="toctree-l3"><a class="reference internal" href="grafana.html">5.11.11. Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="ingest-external.html">5.11.12. Ingest-external</a></li>
<li class="toctree-l3"><a class="reference internal" href="ingest-internal.html">5.11.13. Ingest-internal</a></li>
<li class="toctree-l3"><a class="reference internal" href="kibana.html">5.11.14. Kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="logbook.html">5.11.15. Logbook</a></li>
<li class="toctree-l3"><a class="reference internal" href="logstash.html">5.11.16. Logstash</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata.html">5.11.17. Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="metadata-collect.html">5.11.18. Metadata Collect</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5.11.19. Mongodb</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#base-mongo-data">5.11.19.1. Base mongo-data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#base-mongo-offer">5.11.19.2. Base mongo-offer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#architecture-de-deploiement">5.11.19.3. Architecture de déploiement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="processing.html">5.11.20. Processing</a></li>
<li class="toctree-l3"><a class="reference internal" href="prometheus.html">5.11.21. Prometheus server</a></li>
<li class="toctree-l3"><a class="reference internal" href="prometheus.html#prometheus-alertmanager">5.11.22. Prometheus alertmanager</a></li>
<li class="toctree-l3"><a class="reference internal" href="prometheus.html#prometheus-node-exporter">5.11.23. Prometheus node_exporter</a></li>
<li class="toctree-l3"><a class="reference internal" href="prometheus.html#prometheus-elasticsearch-exporter">5.11.24. Prometheus Elasticsearch Exporter</a></li>
<li class="toctree-l3"><a class="reference internal" href="restic.html">5.11.25. restic</a></li>
<li class="toctree-l3"><a class="reference internal" href="scheduler.html">5.11.26. Scheduler</a></li>
<li class="toctree-l3"><a class="reference internal" href="security-internal.html">5.11.27. Security-internal</a></li>
<li class="toctree-l3"><a class="reference internal" href="siegfried.html">5.11.28. Siegfried</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage.html">5.11.29. Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="storage-offer.html">5.11.30. Storage-offer</a></li>
<li class="toctree-l3"><a class="reference internal" href="worker.html">5.11.31. Worker</a></li>
<li class="toctree-l3"><a class="reference internal" href="workspace.html">5.11.32. Workspace</a></li>
<li class="toctree-l3"><a class="reference internal" href="workspace-collect.html">5.11.33. Workspace Collect</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../20-deployment-guidelines.html">5.12. Guidelines de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../25-resources.html">5.13. Eléments de dimensionnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../90-flux-all.html">5.14. Matrice des flux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../securite/_toc.html">6. Sécurité</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../include/_toc.html">7. Architecture détaillée</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Architecture</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">5. Architecture technique / exploitation</a></li>
          <li class="breadcrumb-item"><a href="../15-services.html">5.11. Composants déployés</a></li>
      <li class="breadcrumb-item active">5.11.19. Mongodb</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/archi-exploit-infra/services/mongodb.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="mongodb">
<h1>5.11.19. Mongodb<a class="headerlink" href="#mongodb" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="base-mongo-data">
<h2>5.11.19.1. Base mongo-data<a class="headerlink" href="#base-mongo-data" title="Lien permanent vers ce titre">¶</a></h2>
<p>Base de données dédiée de type documents, utilisée pour le stockage des données métier (un cluster mongodb par site).</p>
<dl class="docutils">
<dt>Type :</dt>
<dd>COTS</dd>
<dt>Données stockées :</dt>
<dd><ul class="first last simple">
<li>Données d’archives</li>
<li>Journaux métier</li>
<li>Référentiels métier</li>
</ul>
</dd>
<dt>Typologie de consommation de ressources :</dt>
<dd><ul class="first last simple">
<li>CPU : moyenne</li>
<li>Mémoire : forte</li>
<li>Réseau : forte</li>
<li>Disque : forte</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="base-mongo-offer">
<h2>5.11.19.2. Base mongo-offer<a class="headerlink" href="#base-mongo-offer" title="Lien permanent vers ce titre">¶</a></h2>
<p>Base de données dédiée à chaque offre de stockage utilisée pour la persistence des données techniques des offres (un cluster mongodb par offre de stockage).</p>
<dl class="docutils">
<dt>Type :</dt>
<dd>COTS</dd>
<dt>Données stockées :</dt>
<dd><ul class="first last simple">
<li>Offset d’écriture dans les offres</li>
<li>Catalogue technique pour les offres froides : Listing des bandes magnétiques, des objets archivés sur bandes…</li>
</ul>
</dd>
<dt>Typologie de consommation de ressources :</dt>
<dd><ul class="first last simple">
<li>CPU : moyenne</li>
<li>Mémoire : forte (en particulier pour une offre froide)</li>
<li>Réseau : forte (en particulier pour une offre froide)</li>
<li>Disque : forte (en particulier pour une offre froide)</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="architecture-de-deploiement">
<h2>5.11.19.3. Architecture de déploiement<a class="headerlink" href="#architecture-de-deploiement" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="architecture-1-noeud">
<h3>5.11.19.3.1. Architecture 1 noeud<a class="headerlink" href="#architecture-1-noeud" title="Lien permanent vers ce titre">¶</a></h3>
<p>L’architecture à 1 noeud est uniquement constituée d’un noeud mongod ; elle n’est pas supportée par VITAM.</p>
</div>
<div class="section" id="architecture-distribuee">
<h3>5.11.19.3.2. Architecture distribuée<a class="headerlink" href="#architecture-distribuee" title="Lien permanent vers ce titre">¶</a></h3>
<p>Une architecture MongoDB distribuée utilise les notions suivantes :</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>Sharding</dt>
<dd><ul class="first last">
<li>Mongodb utilise le sharding pour scaler la base de données (scalabilité horizontale)</li>
<li>Le sharding distribue les données à travers les n partitions physiques (shards) dont le cluster est composé</li>
<li>Bien choisir la clé de sharding est primordial pour une répartition égale des documents insérés dans les différents shards</li>
<li>Chaque shard est composé d’un Replica Set</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Replica Set (RS)</dt>
<dd><ul class="first last">
<li>Les Replica Sets assurent la haute disponibilité de Mongodb</li>
<li>Un Replica Set est (règles Mongodb de production) composé de <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">x</span> <span class="pre">n</span> <span class="pre">+</span> <span class="pre">1</span></code> noeuds, avec <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code> (1 noeud primaire, les autres étant des noeuds secondaires) ; le noeud primaire est choisi de manière arbitraire par MongoDB dans la liste des noeuds du Replica Set</li>
<li>L’écriture se fait obligatoirement sur le noeud primaire</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Replica Set de config</dt>
<dd><ul class="first last">
<li>Un Replica Set est dédié pour le stockage de la configuration du cluster</li>
<li>Comme tous les autres Replica Sets, il est recommandé de le peupler de <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">x</span> <span class="pre">n</span> <span class="pre">+</span> <span class="pre">1</span></code> noeuds, avec <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&gt;=</span> <span class="pre">1</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Routeur de requêtes</dt>
<dd><ul class="first last">
<li>Le routeur mongos permet de rediriger une requête sur le ou les shards requis, en fonction de la clé de sharding ; il agit comme coordinateur de requête</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Une architecture MongoDB distribuée comprend 3 types de noeuds différents :</p>
<ul class="simple">
<li>mongod : stockent les données des Replica Sets métier ;</li>
<li>mongos : routent les requêtes ;</li>
<li>mongoc : stockent les données d’état et de configuration du cluster (ces noeuds utilisent en fait un moteur mongod, mais pour un Replica Set particulier : le Replica Set de configuration).</li>
</ul>
<div class="figure align-center" id="id1">
<img alt="../../_images/mongo-cluster.svg" src="../../_images/mongo-cluster.svg" /><p class="caption"><span class="caption-text">Déploiement d’un cluster Mongo DB avec sharding.</span></p>
</div>
<p>L’architecture proposée dans le cadre de VITAM consiste à séparer les noeuds liés au routage des requêtes et de gestion du cluster d’une part (donc de colocaliser mongos et mongoc), avec les noeuds de stockage des données (mongod) d’autre part.</p>
<p>Ainsi, avec n shards et r noeuds par Replica Set (cluster), on obtient le déploiement suivant :</p>
<ul>
<li><p class="first">au moins 3 serveurs config / service, chacun hébergeant:</p>
<blockquote>
<div><ul class="simple">
<li>1 noeud mongos (service)</li>
<li>1 noeud mongoc (Replica Set de configuration)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">n x r serveurs, chacun hébergeant:</p>
<blockquote>
<div><ul class="simple">
<li>1 noeud mongod</li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Une typologie de cluster complète (mongos, mongoc, mongod) est systématiquement déployée dans le cadre de la solution logicielle VITAM, cela afin de permettre une extension ultérieure du cluster par le rajout d’un nouveau shard et le rééquilibrage du cluster, et ce même si un seul shard est instancié au démarrage.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Une colocalisation des composants (mongos, mongoc &amp; mongod) reste possible dans un déploiement avec un seul shard; cette colocalisation n’est plus possible dans le cas d’un déploiement multi-shardé et il sera nécessaire d’avoir des noeuds dédiées (mongos &amp; mongoc) et des noeuds dédiés pour chacun des shards (mongod) selon les recommandations précédentes.</p>
</div>
</div>
<div class="section" id="ports-utilises">
<h3>5.11.19.3.3. Ports utilisés<a class="headerlink" href="#ports-utilises" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les ports utilisés par mongodb sont les suivants:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">tcp:27017</span></code> : Port de communication pour les noeuds mongos</li>
<li><code class="docutils literal notranslate"><span class="pre">tcp:27018</span></code> : Port d’écoute des noeuds du Replica Set de config (mongoc)</li>
<li><code class="docutils literal notranslate"><span class="pre">tcp:27019</span></code> : Port d’écoute des noeuds du/des Replica Set(s) de données (mongod)</li>
</ul>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="metadata-collect.html" class="btn btn-neutral float-left" title="5.11.18. Metadata Collect" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="processing.html" class="btn btn-neutral float-right" title="5.11.20. Processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>