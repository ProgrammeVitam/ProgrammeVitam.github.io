

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.9. Service registry &mdash; documentation VITAM - Architecture 1.0.0</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Recherche" href="../search.html"/>
    <link rel="top" title="documentation VITAM - Architecture 1.0.0" href="../index.html"/>
        <link rel="up" title="5. Architecture technique / exploitation" href="_toc.html"/>
        <link rel="next" title="5.10. Dépendances aux services d’infrastructures" href="10-it-services.html"/>
        <link rel="prev" title="5.8. Outillage de déploiement" href="07-deployment-tooling.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> VITAM - Architecture
          

          
            
            <img src="../_static/logo_vitam.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/_toc.html">3. Vue d&#8217;ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../archi-applicative/_toc.html">4. Architecture applicative</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.html">5. Architecture technique / exploitation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="principes/_toc.html">5.1. Principes d&#8217;architecture technique</a></li>
<li class="toctree-l2"><a class="reference internal" href="01-services-techniques.html">5.2. Services techniques fournis par la solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="02-dependencies.html">5.3. Composants logiciels utilisés</a></li>
<li class="toctree-l2"><a class="reference internal" href="03-technical-architecture.html">5.4. Architecture technique détaillée</a></li>
<li class="toctree-l2"><a class="reference internal" href="04-data-storage.html">5.5. Stockage des données</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-logs-architecture.html">5.6. Concentration et exploitation des logs applicatifs</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-metrics-architecture.html">5.7. Métriques applicatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="07-deployment-tooling.html">5.8. Outillage de déploiement</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.9. Service registry</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#architecture">5.9.1. Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#resolution-dns">5.9.2. Résolution DNS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#packaging">5.9.3. Packaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monitoring">5.9.4. Monitoring</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="10-it-services.html">5.10. Dépendances aux services d&#8217;infrastructures</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-services.html">5.11. Composants déployés</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-deployment-guidelines.html">5.12. Guidelines de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="25-resources.html">5.13. Eléments de dimensionnement</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-flux-all.html">5.14. Matrice des flux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../securite/_toc.html">6. Securite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../include/_toc.html">7. Architecture détaillée</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">VITAM - Architecture</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="_toc.html">5. Architecture technique / exploitation</a> &raquo;</li>
      
    <li>5.9. Service registry</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/archi-exploit-infra/08-consul.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="service-registry">
<h1>5.9. Service registry<a class="headerlink" href="#service-registry" title="Lien permanent vers ce titre">¶</a></h1>
<p>Le service registry est le composant permettant à chaque service de localiser les services dont il dépend ; par conséquent, son bon fonctionnement est particulièrement critique pour le bon fonctionnement du système VITAM.</p>
<div class="section" id="architecture">
<h2>5.9.1. Architecture<a class="headerlink" href="#architecture" title="Lien permanent vers ce titre">¶</a></h2>
<p>Un déploiement Consul est composé de 2 types de noeuds différents :</p>
<ul class="simple">
<li>Les noeuds serveurs : ils persistent l&#8217;état des données stockées dans Consul ; les données sont répliquées entre eux, et eux seuls participent à l&#8217;élection du maître (ils forment un cluster Raft). Un quorum de ces noeuds doit toujours être déclaré ; dans le cas contraire, on entre dans un cas de désastre de cluster (Cf. <a class="reference external" href="https://www.consul.io/docs/guides/outage.html">la documentation sur l&#8216;&#8220;outage recovery&#8221;</a> ) ; le nombre de serveurs doit être impair, avec un minimum conseillé de 3 noeuds (pour des problématiques de maintien de quorum).</li>
<li>Les noeuds client : ils exposent les API d&#8217;accès aux structures de données Consul, et réalisent les healthchecks des services dont ils ont la définition. Ils communiquent avec les serveurs.</li>
</ul>
<p>Un noeud Consul est également appelé un agent.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les noeuds serveurs sont en fait des noeuds clients réifiés, i.e. ils ont également les capacités des clients.</p>
</div>
<p>Dans le cadre de VITAM, le déploiement des noeuds Consul doit correspondre aux principes suivants :</p>
<ul class="simple">
<li>Un cluster de serveurs Consul sur un nombre impair de noeuds dédiés, chacun d&#8217;entre eux étant configuré pour exposer l&#8217;IHM de suivi ;</li>
<li>1 client par serveur hébergeant un service VITAM.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Préconisation : Le fonctionnement de Consul via trois noeuds master au minimum nous prémunit de la perte d&#8217;un de ces noeuds sans perturbation du service. Un seul noeud Consul est très déconseillé.</p>
</div>
</div>
<div class="section" id="resolution-dns">
<h2>5.9.2. Résolution DNS<a class="headerlink" href="#resolution-dns" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les résolutions de noms de service se font via l&#8217;API dns de Consul ; un resolver externe doit être configuré pour les requêtes externes.</p>
<p>Chaque client agit comme serveur DNS local ; il écoute sur le port udp 53 (sur la boucle locale - <code class="docutils literal"><span class="pre">127.0.0.1</span></code>), et est configuré comme serveur DNS de l&#8217;OS (typiquement dans le fichier <code class="docutils literal"><span class="pre">/etc/resolv.conf</span></code>).</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cela rend Consul incompatible avec d&#8217;autres implémentations de serveur DNS qui seraient lancées sur l&#8217;OS, et en particulier les cache DNS installés par défaut dans certaines distributions linux (ex: dnsmasq). En outre, il faut prendre garde à l&#8217;écrasement de la configuration du resolv.conf, qui doit garder <code class="docutils literal"><span class="pre">127.0.0.1</span></code> comme premier serveur DNS.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Pour pouvoir écouter sur le port 53, Consul nécessite la capacité <code class="docutils literal"><span class="pre">CAP_NET_BIND_SERVICE</span></code> (Cf. la section suivante).</p>
</div>
<p>Lorsque le système fait une requête DNS, cette dernière arrive à l&#8217;agent Consul local et la séquence suivante est exécutée :</p>
<ul class="simple">
<li>Si le nom à résoudre appartient au domaine réservé pour Consul (par défaut <code class="docutils literal"><span class="pre">consul</span></code>), il est résolu en tant que nom de service ou de noeud (Cf. <a class="reference external" href="https://www.consul.io/docs/agent/dns.html">la documentation officielle concernant l&#8217;interface DNS</a>) ;</li>
<li>Dans le cas contraire, la requête est transmise aux serveurs DNS configurés dans la liste des <a class="reference external" href="https://www.consul.io/docs/agent/options.html#recursors">recursors</a>).</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Consul a pour l&#8217;instant été configuré en mode <code class="docutils literal"><span class="pre">allow_stale</span> <span class="pre">=</span> <span class="pre">false</span></code> (cf. <a class="reference external" href="https://www.consul.io/docs/agent/options.html#allow_stale">la directive de configuration</a>), ce qui signifie que chaque requête DNS se traduit par un appel RPC au noeud leader des serveurs Consul. Cela permet d&#8217;assurer la consistance des réponses DNS, mais peut potentiellement poser des problèmes de performance sur des larges déploiements. Il est possible de changer ce comportement (clés de configuration <code class="docutils literal"><span class="pre">allow_stale</span></code> et <code class="docutils literal"><span class="pre">max_stale</span></code> - qui permettent de préciser la durée maximum pendant laquelle le noeud répond aux requêtes DNS sans interroger le leader), et également de changer le TTL des réponses DNS (qui est par défaut gardé à 0).</p>
</div>
</div>
<div class="section" id="packaging">
<h2>5.9.3. Packaging<a class="headerlink" href="#packaging" title="Lien permanent vers ce titre">¶</a></h2>
<p>Vitam intègre des packages OS (rpm &amp; deb) dédiés pour Consul ; ces packages permettent essentiellement :</p>
<ul class="simple">
<li>De configurer Consul en tant que service systemd ;</li>
<li>De permettre le lancement de Consul sous l&#8217;utilisateur <code class="docutils literal"><span class="pre">vitam</span></code> ;</li>
<li>Enfin, ils intègrent une directive <code class="docutils literal"><span class="pre">setcap</span></code> de post-install pour attribuer la capacité <code class="docutils literal"><span class="pre">CAP_NET_BIND_SERVICE</span></code> au binaire <code class="docutils literal"><span class="pre">/vitam/vitam-consul/bin/consul</span></code> afin de permettre à ce dernier d&#8217;exposer une interface DNS sur le port 53 sans pour autant nécessiter les droits root.</li>
</ul>
</div>
<div class="section" id="monitoring">
<h2>5.9.4. Monitoring<a class="headerlink" href="#monitoring" title="Lien permanent vers ce titre">¶</a></h2>
<p>Chaque instance de service doit être déclarée dans Consul ; cette déclaration se fait en déposant un fichier de configuration dans le répertoire de configuration de Consul. Ce fichier contient notamment l&#8217;identifiant du service ainsi que son port d&#8217;écoute, ainsi qu&#8217;une liste de healthchecks qui permettent à Consul de connaître l&#8217;état du service. Pour les services VITAM, ces healthchecks s&#8217;appuient sur les API de supervision qui ont été décrites dans <a class="reference internal" href="principes/40-principles-monitoring.html"><span class="doc">la section dédiée</span></a>.</p>
<p>Consul permet d&#8217;exposer une IHM Web permettant d&#8217;accéder à la topologie des services déployés (i.e. quel service sur quel noeud) et à leur état instantané.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="10-it-services.html" class="btn btn-neutral float-right" title="5.10. Dépendances aux services d’infrastructures" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="07-deployment-tooling.html" class="btn btn-neutral" title="5.8. Outillage de déploiement" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>