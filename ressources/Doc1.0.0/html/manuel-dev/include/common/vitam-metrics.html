

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Métriques dans VITAM &mdash; documentation VITAM - Manuel de développement 1.0.0</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Recherche" href="../../search.html"/>
    <link rel="top" title="documentation VITAM - Manuel de développement 1.0.0" href="../../index.html"/>
        <link rel="up" title="Common" href="_toc.html"/>
        <link rel="next" title="Common-private" href="private/_toc.html"/>
        <link rel="prev" title="Common-storage" href="stockage.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> VITAM - Manuel de développement
          

          
            
            <img src="../../_static/logo_vitam.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">Détails par composant</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../access/_toc.html">Access</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">Common</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="GUID.html">Global Unique Identifier (GUID) pour Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="Digest.html">Digest</a></li>
<li class="toctree-l3"><a class="reference internal" href="Logger.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="JunitHelper.html">JunitHelper</a></li>
<li class="toctree-l3"><a class="reference internal" href="client.html">Client</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html">DirectedCycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="graph.html#graph">Graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="VitamCode.html">Code d&#8217;erreur Vitam</a></li>
<li class="toctree-l3"><a class="reference internal" href="format-identifier.html">Common format identification</a></li>
<li class="toctree-l3"><a class="reference internal" href="stockage.html">Common-storage</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Métriques dans VITAM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#fonctionnement">Fonctionnement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metriques-metier">Métriques métier</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reporters">Reporters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#legacy">Legacy</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="private/_toc.html">Common-private</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../functional-administration/_toc.html">Functional administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-demo/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ihm-recette/_toc.html">IHM demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ingest/_toc.html">Ingest</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internal-security/_toc.html">Security-Internal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../logbook/_toc.html">Logbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../metadata/_toc.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="../processing/_toc.html">Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../storage/_toc.html">Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../technical-administration/_toc.html">Technical administration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../worker/_toc.html">Worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../workspace/_toc.html">Workspace</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallisation_tests.html">Parallélisation des tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugin-icu-elasticsearch.html">Plugin ICU Elasticsearch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gestion-database.html">Gestion des bases de données</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client-ressource-rest.html">Ressources et clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devstack_vm.html">Création d&#8217;une machine de dev contenant swift</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">VITAM - Manuel de développement</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../_toc.html">Détails par composant</a> &raquo;</li>
      
          <li><a href="_toc.html">Common</a> &raquo;</li>
      
    <li>Métriques dans VITAM</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/include/common/vitam-metrics.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="metriques-dans-vitam">
<h1>Métriques dans VITAM<a class="headerlink" href="#metriques-dans-vitam" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="fonctionnement">
<h2>Fonctionnement<a class="headerlink" href="#fonctionnement" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les métriques dans VITAM sont stockées dans le package :</p>
<p><strong>fr.gouv.common.metrics</strong></p>
<p>Les registres de métriques et les reporters de métriques sont tous les deux contenus dans une classe <em>VitamMetrics</em>. Cette classe doit être instanciée avec un <em>VitamMetricsType</em> qui peut être <strong>JERSEY</strong>, <strong>JVM</strong> ou <strong>BUSINESS</strong>. Le type définira les métriques enregistrées dans le registre interne de la classe.</p>
<p>La classe <strong>AbstractVitamApplication</strong> contient une <em>Map</em> statique de <em>VitamMetrics</em> qui est initialisée à chaque configuration d&#8217;une application VITAM. Cette <em>Map</em> contient obligatoirement un <em>VitamMetrics</em> de type BUSINESS et peut accessoirement contenir les <em>VitamMetrics</em> de types JVM et JERSEY. La fonction en question est :</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">protected</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">clearAndconfigureMetrics</span><span class="o">()</span>
</pre></div>
</div>
<p>Cette fonction vide et recharge les métriques à chaque création d&#8217;une application VITAM. Les reporters de métriques quant à eux sont démarrés lors d&#8217;un appel à la fonction :</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">VitamApplicationServerException</span>
</pre></div>
</div>
<p>qui elle même appelle la fonction :</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">startMetrics</span><span class="o">()</span>
</pre></div>
</div>
<p>de la classe <em>AbstractVitamApplication</em>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Les <em>VitamMetrics</em> de type JERSEY ou JVM n&#8217;ont pas à être modifiés pendant l&#8217;execution d&#8217;une application VITAM.</p>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les métriques sont configurées dans le fichier <code class="docutils literal"><span class="pre">/vitam/conf/&lt;service_id&gt;/vitam.metrics.conf</span></code>. Ce fichier contient la documentation nécessaire pour configurer correctement les métriques.</p>
</div>
<div class="section" id="metriques-metier">
<h2>Métriques métier<a class="headerlink" href="#metriques-metier" title="Lien permanent vers ce titre">¶</a></h2>
<p>Les métriques métiers permettent aux développeurs d&#8217;enregistrer des métriques n&#8217;importe où dans le code, pour par exemple suivre une variable ou bien chronométrer une fonction. Pour cela il suffit d&#8217;appeler la fonction statique <em>getBusinessMetricRegistry</em> dans la classe <em>AbstractVitamApplication</em>, puis d&#8217;enregistrer une métrique.</p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="n">AbstractVitamApplication</span><span class="o">.</span><span class="na">getBusinessMetricsRegistry</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="s">&quot;Running workflows&quot;</span><span class="o">,</span>
    <span class="k">new</span> <span class="n">Gauge</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">runningWorkflows</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">});</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Avec la fonction <em>register</em>, si une métrique avec un nom identique est déjà enregistrée, alors l&#8217;ancienne métrique sera ecrasée par la nouvelle avec un avertissement dans les logs. En revanche, avec les fonctions de création de métrique comme <em>timer</em>, <em>meter</em>..., une exception sera soulevée.</p>
</div>
</div>
<div class="section" id="reporters">
<h2>Reporters<a class="headerlink" href="#reporters" title="Lien permanent vers ce titre">¶</a></h2>
<p>2 reporters sont disponibles, un reporter Logback (toutes les métriques sont dumpées dans Logback) ou bien un reporter ElasticSearch (toutes les métriques sont dumpées dans la base ElasticSearch Log). Le reporter est configurable avec un interval de temps entre chaque reporting.</p>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Les index ElasticSearch ne sont pas configurables pour les métriques. Ils se nomment respectivement :
* <code class="docutils literal"><span class="pre">metrics-vitam-jersey-YYYY.MM.dd</span></code> pour les métriques JERSEY
* <code class="docutils literal"><span class="pre">metrics-vitam-jvm-YYYY.MM.dd</span></code> pour les métriques JVM
* <code class="docutils literal"><span class="pre">metrics-vitam-business-YYYY.MM.dd</span></code> pour les métriques métier</p>
</div>
</div>
<div class="section" id="legacy">
<h2>Legacy<a class="headerlink" href="#legacy" title="Lien permanent vers ce titre">¶</a></h2>
<p>Pour celui ou celle qui souhaiterais continuer le développement du système de métriques au sein de VITAM, voici quelques points qui peuvent être intéressants à développer :</p>
<ul class="simple">
<li>Pour un reporter ElasticSearch, vérifier l&#8217;état de la connexion à chaque reporting et augmenter progressivement le temps de reporting si la base de données n&#8217;est pas accessible.</li>
<li>Permettre le chargement de reporters de manière générique, en se passant du <em>switch</em> dans <em>VitamMetrics</em> et abstraire tout ce qui concerne le reporting.</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="private/_toc.html" class="btn btn-neutral float-right" title="Common-private" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="stockage.html" class="btn btn-neutral" title="Common-storage" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>