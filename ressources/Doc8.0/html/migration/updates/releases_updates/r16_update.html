<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.3.2. Notes et procédures spécifiques R16 &mdash; Documentation VITAM - Documentation de montées de version 8.0.0</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="4.3.3. Notes et procédures spécifiques V5RC" href="v5rc_update.html" />
    <link rel="prev" title="4.3.1. Notes et procédures spécifiques R13" href="r13_update.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Documentation de montées de version
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generalites.html">3. Généralités sur les versions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">4. Montées de version</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../principles.html">4.1. Principes généraux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bugfixes_updates/_toc.html">4.2. Montées de version <em>bugfix</em></a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">4.3. Montées de version majeures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="r13_update.html">4.3.1. Notes et procédures spécifiques R13</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.3.2. Notes et procédures spécifiques R16</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#verification-prealable-avant-la-migration">4.3.2.1. Vérification préalable avant la migration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adaptation-des-sources-de-deploiement-ansible">4.3.2.2. Adaptation des sources de déploiement ansible</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-avant-la-montee-de-version">4.3.2.3. Procédures à exécuter AVANT la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-apres-la-montee-de-version">4.3.2.4. Procédures à exécuter APRÈS la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#verification-de-la-bonne-migration-des-donnees">4.3.2.5. Vérification de la bonne migration des données</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="v5rc_update.html">4.3.3. Notes et procédures spécifiques V5RC</a></li>
<li class="toctree-l3"><a class="reference internal" href="v5_update.html">4.3.4. Notes et procédures spécifiques V5</a></li>
<li class="toctree-l3"><a class="reference internal" href="v6rc_update.html">4.3.5. Notes et procédures spécifiques V6RC</a></li>
<li class="toctree-l3"><a class="reference internal" href="v6_update.html">4.3.6. Notes et procédures spécifiques V6</a></li>
<li class="toctree-l3"><a class="reference internal" href="v7_0_update.html">4.3.7. Notes et procédures spécifiques V7</a></li>
<li class="toctree-l3"><a class="reference internal" href="v7_1_update.html">4.3.8. Notes et procédures spécifiques V7.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="v8_0_update.html">4.3.9. Notes et procédures spécifiques V8.0</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Documentation de montées de version</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">4. Montées de version</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">4.3. Montées de version majeures</a></li>
      <li class="breadcrumb-item active">4.3.2. Notes et procédures spécifiques R16</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/updates/releases_updates/r16_update.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="notes-et-procedures-specifiques-r16">
<h1>4.3.2. Notes et procédures spécifiques R16<a class="headerlink" href="#notes-et-procedures-specifiques-r16" title="Lien permanent vers ce titre">¶</a></h1>
<div class="section" id="verification-prealable-avant-la-migration">
<h2>4.3.2.1. Vérification préalable avant la migration<a class="headerlink" href="#verification-prealable-avant-la-migration" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="gestion-des-regles-de-gestion">
<h3>4.3.2.1.1. Gestion des règles de gestion<a class="headerlink" href="#gestion-des-regles-de-gestion" title="Lien permanent vers ce titre">¶</a></h3>
<p>Dans le cadre d’une correctif concernant la validation stricte des types de règles lors de l’import du référentiel des règles de gestion, il faut impérativement, AVANT la montée de version, vérifier tous les types de règles de gestion existants sur Mongo et ES et les modifier manuellement en cas d’incohérence.</p>
<p>Pour ce faire, il faut s’assurer que tous les types de règles de gestion (<code class="docutils literal notranslate"><span class="pre">RuleType</span></code>) respectent la casse (les majuscules et les minuscules).</p>
<p>Ci-après la liste des valeurs valides autorisées :</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">AppraisalRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">AccessRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">StorageRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">DisseminationRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ClassificationRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">ReuseRule</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">HoldRule</span></code></li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>Exemple :</dt>
<dd><code class="docutils literal notranslate"><span class="pre">APPRAISALRULE</span></code> devrait être <code class="docutils literal notranslate"><span class="pre">AppraisalRule</span></code></dd>
</dl>
</div>
</div>
<div class="section" id="adaptation-des-sources-de-deploiement-ansible">
<h2>4.3.2.2. Adaptation des sources de déploiement ansible<a class="headerlink" href="#adaptation-des-sources-de-deploiement-ansible" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="deplacement-des-parametres-relatif-a-la-gestion-des-tenants">
<h3>4.3.2.2.1. Déplacement des paramètres relatif à la gestion des tenants<a class="headerlink" href="#deplacement-des-parametres-relatif-a-la-gestion-des-tenants" title="Lien permanent vers ce titre">¶</a></h3>
<p>Dans le cadre de la fonctionnalité introduite en R15 permettant de regrouper les tenants, les paramètres suivants ont étés déplacés du fichier d’inventaire au fichier <code class="docutils literal notranslate"><span class="pre">group_vars/all/advanced/tenants_vars.yml</span></code></p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">vitam_tenant_ids</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">vitam_tenant_admin</span></code></li>
</ul>
</div></blockquote>
<p>Si la montée de version s’effectue à partir d’une R13, il faut supprimer les valeurs précédentes de votre fichier d’inventaire et les reporter dans le fichier <code class="docutils literal notranslate"><span class="pre">tenants_vars.yml</span></code> en respectant la syntaxe YML adéquate.</p>
<div class="admonition seealso">
<p class="first admonition-title">Voir aussi</p>
<p class="last">Se référer à la documentation d’installation pour plus d’informations concernant le fichier <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/advanced/tenants_vars.yml</span></code></p>
</div>
</div>
</div>
<div class="section" id="procedures-a-executer-avant-la-montee-de-version">
<h2>4.3.2.3. Procédures à exécuter AVANT la montée de version<a class="headerlink" href="#procedures-a-executer-avant-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="supprimer-les-indexes-de-configuration-kibana">
<h3>4.3.2.3.1. Supprimer les indexes de configuration kibana<a class="headerlink" href="#supprimer-les-indexes-de-configuration-kibana" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la R16.5 ou supérieur (4.0.5+).</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Sans cette opération, l’installation kibana est bloquée et arrête l’installation de Vitam</p>
</div>
<p>Lors de la montée de version ELK, les indices de configuration kibana : .kibana et .kibana_task_manager persistent avec une version et des informations incorrectes (celles de la version d’avant). Il est nécessaire des les effacer; autrement la montée de version est bloquée.</p>
<p>Exécutez le playbook suivant:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/remove_old_kibana_indexes.yml --ask-vault-pass
</pre></div>
</div>
<p>Ce playbook clone les indices de configuration (.kibana et .kibana_task_manager) et efface les originaux. Les clones d’indice sont conservés.</p>
<p>La montée de version va recréer ces indices avec les nouvelles configurations relatives au nouvel ELK.</p>
</div>
<div class="section" id="reinitialisation-de-la-reconstruction-des-registres-de-fond-des-sites-secondaires">
<h3>4.3.2.3.2. Réinitialisation de la reconstruction des registres de fond des sites secondaires<a class="headerlink" href="#reinitialisation-de-la-reconstruction-des-registres-de-fond-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette procédure doit être exécutée uniquement en cas de migration majeure vers une version R16.7+ (4.0.7 ou supérieure). Elle permet la réinitialisation de la reconstruction des registre de fonds sur les sites secondaires.</p>
</div>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam AVANT l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que les timers de Vitam aient bien été préalablement arrêtés (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam_timers.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_accession_register_reconstruction.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="controle-et-nettoyage-de-journaux-du-storage-engine-des-sites-secondaires">
<h3>4.3.2.3.3. Contrôle et nettoyage de journaux du storage engine des sites secondaires<a class="headerlink" href="#controle-et-nettoyage-de-journaux-du-storage-engine-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette procédure doit être exécutée uniquement en cas de migration majeure vers une version R16.7+ (4.0.7 ou supérieure). Elle permet le contrôle et la purge des journaux d’accès et des journaux d’écriture du storage engine des sites secondaires.</p>
</div>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam AVANT l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que Vitam soit bien préalablement arrêté (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_purge_storage_logs_secondary_sites.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="procedures-a-executer-apres-la-montee-de-version">
<h2>4.3.2.4. Procédures à exécuter APRÈS la montée de version<a class="headerlink" href="#procedures-a-executer-apres-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="arret-des-timers-et-des-acces-externes-a-vitam">
<h3>4.3.2.4.1. Arrêt des timers et des accès externes à Vitam<a class="headerlink" href="#arret-des-timers-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<p>Les timers et les externals de Vitam doivent être arrêtés sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_timers.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="recalcul-du-graph-des-metadonnees-des-sites-secondaires">
<h3>4.3.2.4.2. Recalcul du graph des métadonnées des sites secondaires<a class="headerlink" href="#recalcul-du-graph-des-metadonnees-des-sites-secondaires" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette procédure doit être exécutée uniquement en cas de migration majeure vers une version R16.7+ (4.0.7 ou supérieure). Elle permet le recalcul du graphe des métadonnées sur les sites secondaires</p>
</div>
<p>La procédure est à réaliser sur tous les <strong>sites secondaires</strong> de Vitam APRÈS l’installation de la nouvelle version :</p>
<ul>
<li><p class="first">S’assurer que Vitam soit bien préalablement arrêté (via le playbook <code class="docutils literal notranslate"><span class="pre">ansible-vitam-exploitation/stop_vitam_timers.yml</span></code>)</p>
</li>
<li><p class="first">Exécuter le playbook :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook ansible-vitam-migration/migration_metadata_graph_reconstruction.yml -i environments/hosts.<span class="o">{</span>env<span class="o">}</span> --ask-vault-pass
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="redemarrage-des-timers-et-des-acces-externes-a-vitam">
<h3>4.3.2.4.3. Redémarrage des timers et des accès externes à Vitam<a class="headerlink" href="#redemarrage-des-timers-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<p>La montée de version est maintenant terminée, vous pouvez réactiver les services externals ainsi que les timers sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_vitam_timers.yml --ask-vault-pass
</pre></div>
</div>
</div>
</div>
<div class="section" id="verification-de-la-bonne-migration-des-donnees">
<h2>4.3.2.5. Vérification de la bonne migration des données<a class="headerlink" href="#verification-de-la-bonne-migration-des-donnees" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="audit-coherence">
<h3>4.3.2.5.1. Audit coherence<a class="headerlink" href="#audit-coherence" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il est recommandé de procéder à un audit de cohérence aléatoire suite à une procédure de montée de version VITAM ou de migration de données.
Pour ce faire, se référer au dossier d’exploitation (DEX) de la solution VITAM, section <code class="docutils literal notranslate"><span class="pre">Audit</span> <span class="pre">de</span> <span class="pre">cohérence</span></code>.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="r13_update.html" class="btn btn-neutral float-left" title="4.3.1. Notes et procédures spécifiques R13" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="v5rc_update.html" class="btn btn-neutral float-right" title="4.3.3. Notes et procédures spécifiques V5RC" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>