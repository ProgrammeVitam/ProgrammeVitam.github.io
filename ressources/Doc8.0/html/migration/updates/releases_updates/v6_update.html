<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.3.6. Notes et procédures spécifiques V6 &mdash; Documentation VITAM - Documentation de montées de version 8.0.0</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Recherche" href="../../search.html" />
    <link rel="next" title="4.3.7. Notes et procédures spécifiques V7" href="v7_0_update.html" />
    <link rel="prev" title="4.3.5. Notes et procédures spécifiques V6RC" href="v6rc_update.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            VITAM - Documentation de montées de version
              <img src="../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                8.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../generalites.html">3. Généralités sur les versions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../_toc.html">4. Montées de version</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../principles.html">4.1. Principes généraux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bugfixes_updates/_toc.html">4.2. Montées de version <em>bugfix</em></a></li>
<li class="toctree-l2 current"><a class="reference internal" href="_toc.html">4.3. Montées de version majeures</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="r13_update.html">4.3.1. Notes et procédures spécifiques R13</a></li>
<li class="toctree-l3"><a class="reference internal" href="r16_update.html">4.3.2. Notes et procédures spécifiques R16</a></li>
<li class="toctree-l3"><a class="reference internal" href="v5rc_update.html">4.3.3. Notes et procédures spécifiques V5RC</a></li>
<li class="toctree-l3"><a class="reference internal" href="v5_update.html">4.3.4. Notes et procédures spécifiques V5</a></li>
<li class="toctree-l3"><a class="reference internal" href="v6rc_update.html">4.3.5. Notes et procédures spécifiques V6RC</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.3.6. Notes et procédures spécifiques V6</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adaptation-des-sources-de-deploiement-ansible">4.3.6.1. Adaptation des sources de déploiement ansible</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-avant-la-montee-de-version">4.3.6.2. Procédures à exécuter AVANT la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-de-la-montee-de-version">4.3.6.3. Application de la montée de version</a></li>
<li class="toctree-l4"><a class="reference internal" href="#procedures-a-executer-apres-la-montee-de-version">4.3.6.4. Procédures à exécuter APRÈS la montée de version</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="v7_0_update.html">4.3.7. Notes et procédures spécifiques V7</a></li>
<li class="toctree-l3"><a class="reference internal" href="v7_1_update.html">4.3.8. Notes et procédures spécifiques V7.1</a></li>
<li class="toctree-l3"><a class="reference internal" href="v8_0_update.html">4.3.9. Notes et procédures spécifiques V8.0</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">VITAM - Documentation de montées de version</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">4. Montées de version</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">4.3. Montées de version majeures</a></li>
      <li class="breadcrumb-item active">4.3.6. Notes et procédures spécifiques V6</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/updates/releases_updates/v6_update.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="notes-et-procedures-specifiques-v6">
<h1>4.3.6. Notes et procédures spécifiques V6<a class="headerlink" href="#notes-et-procedures-specifiques-v6" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Veuillez appliquer les procédures spécifiques à chacune des versions précédentes en fonction de la version de départ selon la suite suivante: R16 -&gt; V5RC -&gt; V5 -&gt; V6RC.</p>
</div>
<div class="section" id="adaptation-des-sources-de-deploiement-ansible">
<h2>4.3.6.1. Adaptation des sources de déploiement ansible<a class="headerlink" href="#adaptation-des-sources-de-deploiement-ansible" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="mise-a-jour-de-l-architecture-du-module-de-collecte">
<h3>4.3.6.1.1. Mise à jour de l’architecture du module de collecte<a class="headerlink" href="#mise-a-jour-de-l-architecture-du-module-de-collecte" title="Lien permanent vers ce titre">¶</a></h3>
<ul>
<li><p class="first">Ajouter les composants suivants à votre fichier d’inventaire
* <code class="docutils literal notranslate"><span class="pre">[hosts_collect_external]</span></code> dans la <code class="docutils literal notranslate"><span class="pre">[zone_access:children]</span></code>
* <code class="docutils literal notranslate"><span class="pre">[hosts_collect_internal]</span></code> dans la <code class="docutils literal notranslate"><span class="pre">[zone_applicative:children]</span></code></p>
</li>
<li><p class="first">Modifier le fichier <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/vault-keystores.yml</span></code></p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span>keystores:
  server:
</pre></div>
</div>
<ul class="simple">
<li>collect: changeit6kQ16eyDYAoPS9fy</li>
</ul>
<ul class="simple">
<li>collect_external: changeit6kQ16eyDYAoPS9fy</li>
</ul>
<blockquote>
<div><p>client_external:</p>
</div></blockquote>
<ul class="simple">
<li>collect: changeitz6xZe5gDu7nhDZA12</li>
</ul>
<ul class="simple">
<li>collect_external: changeitz6xZe5gDu7nhDZA12</li>
</ul>
</li>
<li><p class="first">Création de certificats dédiés au module de collecte</p>
<ul>
<li><p class="first">Supprimer, si ils existent, les certificats de l’ancien module de collecte <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">environments/certs/client-external/clients/collect/</span> <span class="pre">environments/certs/server/hosts/*/collect.{crt,key}</span></code>.</p>
</li>
<li><p class="first">Créer un certificat client et un certificat serveur dédiés au module de collecte à l’aide de votre <code class="docutils literal notranslate"><span class="pre">PKI</span></code> et le mettre dans les chemins attendus (<code class="docutils literal notranslate"><span class="pre">environments/certs/client-external/clients/collect-external/</span></code> et <code class="docutils literal notranslate"><span class="pre">environments/certs/server/hosts/{hosts}</span></code>).</p>
</li>
<li><p class="first">Dans le cas de l’utilisation de la PKI de test de Vitam, vous pouvez simplement re-générer de nouveaux certificats à l’aide de la commande: <code class="docutils literal notranslate"><span class="pre">./pki/scripts/generate_certs.sh</span> <span class="pre">&lt;fichier_inventaire&gt;</span></code></p>
</li>
<li><p class="first">Re-générer les stores: <code class="docutils literal notranslate"><span class="pre">./generate_stores.sh</span></code></p>
</li>
<li><p class="first">Ajouter le contexte de sécurité pour le module de collecte dans le fichier <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/advanced/vitam_security.yml</span></code>:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span>admin_context_certs:
</pre></div>
</div>
<ul class="simple">
<li><ul class="first">
<li>«&nbsp;collect/collect.crt&nbsp;»</li>
</ul>
</li>
</ul>
<ul class="simple">
<li><ul class="first">
<li>«&nbsp;collect-external/collect-external.crt&nbsp;»</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">Ne pas oublier les paramètres de configuration associés aux jvms de ces nouveaux composants dans le fichier <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/jvm_opts.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">collect_internal</span><span class="p">:</span>
    <span class="nt">jvm_opts</span><span class="p">:</span>
        <span class="c1"># memory: &quot;-Xms512m -Xmx512m&quot;</span>
        <span class="c1"># gc: &quot;&quot;</span>
        <span class="c1"># java: &quot;&quot;</span>
<span class="nt">collect_external</span><span class="p">:</span>
    <span class="nt">jvm_opts</span><span class="p">:</span>
        <span class="c1"># memory: &quot;-Xms512m -Xmx512m&quot;</span>
        <span class="c1"># gc: &quot;&quot;</span>
        <span class="c1"># java: &quot;&quot;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="modification-de-l-indexation-par-defaut-dans-elasticsearch-des-indexes-de-collecte">
<h3>4.3.6.1.2. Modification de l’indexation par défaut dans elasticsearch des indexes de collecte<a class="headerlink" href="#modification-de-l-indexation-par-defaut-dans-elasticsearch-des-indexes-de-collecte" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Attention, ce changement d’indexation vous fera perdre les données en cours dans le module de collecte. Il est conseillé de terminer et de purger les transactions en cours avant de procéder à la montée de version. Si malgré tout, vous souhaitez conserver l’indexation actuelle, il vous faudra supprimer les lignes de la variable <code class="docutils literal notranslate"><span class="pre">collect_grouped_tenants</span></code>.</p>
</div>
<p>Initialement, il n’était pas possible de définir une configuration spécifique lié à l’indexation des unit &amp; objectgroup pour le module de collecte.</p>
<p>Ainsi, la mécanique de personnalisation des indexes Vitam a été mise en oeuvre pour les indexes du module de collecte. Par défaut, la configuration ainsi proposée regroupe l’ensemble des tenants dans un indexe unique pour chacun des index unit &amp; objectgroup.</p>
<p>Le module de collecte a pour vocation de sas tampon de transfert, il n’est donc pas nécessaire d’allouer un shard par tenant.</p>
<p>La configuration par défaut permet de limiter l’empreinte mémoire et l’utilisation du cluster elasticsearch-data. En fonction de votre besoin, vous pouvez rajouter des shards ou bien découper sur des indexes dédiés certains tenants de Vitam.</p>
<p>Dans le fichier de configuration suivant: <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/main.yml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">vitam_elasticsearch_tenant_indexation</span><span class="p">:</span>
  <span class="nt">default_config</span><span class="p">:</span>
    <span class="c1"># Default settings for collect_unit indexes</span>
    <span class="nt">collect_unit</span><span class="p">:</span>
      <span class="nt">number_of_shards</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">number_of_replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="c1"># Default settings for collect_objectgroup indexes</span>
    <span class="nt">collect_objectgroup</span><span class="p">:</span>
      <span class="nt">number_of_shards</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="nt">number_of_replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>

  <span class="nt">collect_grouped_tenants</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="s">&#39;all&#39;</span>
    <span class="c1"># Group all tenants for collect&#39;s indexes (collect_unit &amp; collect_objectgroup)</span>
    <span class="nt">tenants</span><span class="p">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vitam_tenant_ids</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">join(&#39;,&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="procedures-a-executer-avant-la-montee-de-version">
<h2>4.3.6.2. Procédures à exécuter AVANT la montée de version<a class="headerlink" href="#procedures-a-executer-avant-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="arret-des-timers-et-des-acces-externes-a-vitam">
<h3>4.3.6.2.1. Arrêt des timers et des accès externes à Vitam<a class="headerlink" href="#arret-des-timers-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée avec les sources de déploiements de l’ancienne version.</p>
</div>
<p>Les timers et les externals de Vitam doivent être arrêtés sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_external.yml --ask-vault-pass

<span class="c1"># Si Version &lt; V6RC:</span>
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_timers.yml --ask-vault-pass

<span class="c1"># Si Version &gt;= V6RC:</span>
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_scheduling.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="mise-a-jour-des-depots-yum-apt">
<h3>4.3.6.2.2. Mise à jour des dépôts (YUM/APT)<a class="headerlink" href="#mise-a-jour-des-depots-yum-apt" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version</p>
</div>
<p>Afin de pouvoir déployer la nouvelle version, vous devez mettre à jour la variable <code class="docutils literal notranslate"><span class="pre">vitam_repositories</span></code> sous <code class="docutils literal notranslate"><span class="pre">environments/group_vars/all/main/repositories.yml</span></code> afin de renseigner les dépôts à la version cible.</p>
<p>Puis exécutez le playbook suivant <strong>sur tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-extra/bootstrap.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="nettoyage-des-anciens-fichiers-du-module-de-collecte-suite-au-changement-d-architecture">
<h3>4.3.6.2.3. Nettoyage des anciens fichiers du module de collecte suite au changement d’architecture<a class="headerlink" href="#nettoyage-des-anciens-fichiers-du-module-de-collecte-suite-au-changement-d-architecture" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette étape doit être effectuée AVANT la montée de version V6 de vitam et seulement si la V6RC ou V5 a été déployée avec le module de collecte.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Attention, cette procédure va supprimer l’ensemble des éléments stockés dans la partie externe du module de collecte. Veuillez vous assurer que les transactions en cours sont bien purgées avant de procéder à la montée de version.</p>
</div>
<p>Exécutez le playbook suivant à partir de l’ansiblerie de la V6 <strong>sur le site primaire</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/remove_old_collect.yml --ask-vault-pass
</pre></div>
</div>
<p>Ce playbook supprime les anciens éléments suite aux modifications de l’architecture du module de collecte sur les machines <code class="docutils literal notranslate"><span class="pre">[hosts_collect]</span></code>.</p>
<p>Après exécution de ce playbook, vous pouvez supprimer de votre inventaire le groupe <code class="docutils literal notranslate"><span class="pre">[hosts_collect]</span></code>.</p>
</div>
<div class="section" id="montee-de-version-mineure-de-mongo-5-0-13-5-0-14">
<h3>4.3.6.2.4. Montée de version mineure de mongo 5.0.13 -&gt; 5.0.14<a class="headerlink" href="#montee-de-version-mineure-de-mongo-5-0-13-5-0-14" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette montée de version doit être effectuée AVANT la montée de version V6 de Vitam et après l’arrêt des Timers et des externals.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée après avoir mis à jour les dépôts en V6.</p>
</div>
<p>Exécutez le playbook suivant à partir de l’ansiblerie de la V6 <strong>sur tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Mise à jour mongo</span>
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_mongodb_50.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="arret-complet-de-vitam">
<h3>4.3.6.2.5. Arrêt complet de Vitam<a class="headerlink" href="#arret-complet-de-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée avec les sources de déploiements de l’ancienne version.</p>
</div>
<p>Vitam doit être arrêté sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="duplication-des-packages-lors-de-la-mise-a-jour">
<h3>4.3.6.2.6. Duplication des packages lors de la mise à jour<a class="headerlink" href="#duplication-des-packages-lors-de-la-mise-a-jour" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée AVANT la montée de version vers la V6</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée uniquement pour les systèmes d’exploitation à base de RPM (CentOS 7 &amp; AlmaLinux 9) sur un vitam éteint.</p>
</div>
<p>Un bug a été introduit dans la construction des packages RPM à partir de la V6RC. Si vous effectuez une montée de version depuis la V6RC (v6.rc.1 ou inférieure), vous devrez appliquer la commande suivante pour supprimer les précédents packages. Sinon lors de de la mise à jour, le package précédent ne sera pas désinstallé conduisant à la présence de plusieurs versions du même package.</p>
<p>Exemple d’erreur:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/var/tmp/rpm-tmp.fGwZMk: ligne <span class="m">1</span> : fg: pas de contrôle de tâche
erreur : %preun<span class="o">(</span>vitam-offer-6.2-1.noarch<span class="o">)</span> scriptlet échoué, état de sortie <span class="m">1</span>
Error in PREUN scriptlet in rpm package vitam-offer
erreur : vitam-offer-6.2-1.noarch: effacer échoué
</pre></div>
</div>
<p>Voici la commande à exécuter pour permettre la désinstallation des packages de la version précédente:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible vitam --ask-vault-pass -v -a <span class="s2">&quot;yum --setopt=tsflags=noscripts remove -y vitam-*.noarch&quot;</span> -i environments/&lt;inventaire&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="application-de-la-montee-de-version">
<h2>4.3.6.3. Application de la montée de version<a class="headerlink" href="#application-de-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">L’application de la montée de version s’effectue d’abord sur les sites secondaires puis sur le site primaire.</p>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Sous Debian, si vous appliquez la montée de version depuis la V6.RC, vous devrez rajouter le paramètre <code class="docutils literal notranslate"><span class="pre">-e</span> <span class="pre">force_vitam_version=6.x</span></code> (exemple: <code class="docutils literal notranslate"><span class="pre">-e</span> <span class="pre">force_vitam_version=6.2</span></code>) aux commandes suivantes. Sinon les packages vitam ne seront pas correctement mis à jour. En effet, Debian considère que 6.rc.X &gt; 6.X.</p>
</div>
<div class="section" id="lancement-du-master-playbook-vitam">
<h3>4.3.6.3.1. Lancement du master playbook vitam<a class="headerlink" href="#lancement-du-master-playbook-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam/vitam.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="lancement-du-master-playbook-extra">
<h3>4.3.6.3.2. Lancement du master playbook extra<a class="headerlink" href="#lancement-du-master-playbook-extra" title="Lien permanent vers ce titre">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-extra/extra.yml --ask-vault-pass
</pre></div>
</div>
</div>
</div>
<div class="section" id="procedures-a-executer-apres-la-montee-de-version">
<h2>4.3.6.4. Procédures à exécuter APRÈS la montée de version<a class="headerlink" href="#procedures-a-executer-apres-la-montee-de-version" title="Lien permanent vers ce titre">¶</a></h2>
<div class="section" id="arret-des-jobs-vitam-et-des-acces-externes-a-vitam">
<h3>4.3.6.4.1. Arrêt des jobs Vitam et des accès externes à Vitam<a class="headerlink" href="#arret-des-jobs-vitam-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Cette opération doit être effectuée IMMÉDIATEMENT APRÈS la montée de version vers la V6</p>
</div>
<p>Les jobs Vitam et les services externals de Vitam doivent être arrêtés sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_scheduling.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/stop_vitam_scheduler.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="reindexation-des-referentiels-sur-elasticsearch">
<h3>4.3.6.4.2. Réindexation des référentiels sur elasticsearch<a class="headerlink" href="#reindexation-des-referentiels-sur-elasticsearch" title="Lien permanent vers ce titre">¶</a></h3>
<p>Cette migration de données consiste à mettre à jour le modèle d’indexation des référentiels sur elasticsearch-data.</p>
<p>Elle est réalisée en exécutant la procédure suivante sur <strong>tous les sites</strong> (primaire et secondaire(s)) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/reindex_es_data.yml --ask-vault-pass --tags <span class="s2">&quot;securityprofile, context, ontology, ingestcontract, agencies, accessionregisterdetail, archiveunitprofile, accessionregistersummary, accesscontract, fileformat, filerules, profile, griffin, preservationscenario, managementcontract&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="migration-des-mappings-elasticsearch-pour-les-metadonnees">
<h3>4.3.6.4.3. Migration des mappings elasticsearch pour les métadonnées<a class="headerlink" href="#migration-des-mappings-elasticsearch-pour-les-metadonnees" title="Lien permanent vers ce titre">¶</a></h3>
<p>Cette migration de données consiste à mettre à jour le modèle d’indexation des métadonnées sur elasticsearch-data.</p>
<p>Elle est réalisée en exécutant la procédure suivante sur <strong>tous les sites</strong> (primaire et secondaire(s)) :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-migration/migration_elasticsearch_mapping.yml --ask-vault-pass
</pre></div>
</div>
</div>
<div class="section" id="redemarrage-des-jobs-vitam-et-des-acces-externes-a-vitam">
<h3>4.3.6.4.4. Redémarrage des Jobs Vitam et des accès externes à Vitam<a class="headerlink" href="#redemarrage-des-jobs-vitam-et-des-acces-externes-a-vitam" title="Lien permanent vers ce titre">¶</a></h3>
<p>La montée de version est maintenant terminée, vous pouvez réactiver les services externals ainsi que les jobs Vitam sur <strong>tous les sites</strong> :</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_external.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_vitam_scheduler.yml --ask-vault-pass
ansible-playbook -i environments/&lt;inventaire&gt; ansible-vitam-exploitation/start_vitam_scheduling.yml --ask-vault-pass
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="v6rc_update.html" class="btn btn-neutral float-left" title="4.3.5. Notes et procédures spécifiques V6RC" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="v7_0_update.html" class="btn btn-neutral float-right" title="4.3.7. Notes et procédures spécifiques V7" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>