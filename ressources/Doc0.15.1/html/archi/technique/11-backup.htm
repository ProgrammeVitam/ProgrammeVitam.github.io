

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.7. Sauvegarde &mdash; documentation VITAM - Architecture 0.15.1</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="..\_static\css\theme.css" type="text/css">
  

  

  
        <link rel="index" title="Index" href="..\genindex.htm">
        <link rel="search" title="Recherche" href="..\search.htm">
    <link rel="top" title="documentation VITAM - Architecture 0.15.1" href="..\index.htm">
        <link rel="up" title="5. Architecture technique" href="_toc.htm">
        <link rel="next" title="5.8. Restoration" href="12-restore.htm">
        <link rel="prev" title="5.6. Dépendances aux services d’infrastructures" href="10-it-services.htm"> 

  
  <script src="..\_static\js\modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="..\index.htm" class="icon icon-home"> VITAM - Architecture
          

          
            
            <img src="..\_static\LogoVitamGrand2.png" class="logo">
          
          </a>

          
            
            
              <div class="version">
                0.15.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs">
    <input type="hidden" name="check_keywords" value="yes">
    <input type="hidden" name="area" value="default">
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="..\introduction.htm">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="..\introduction.htm#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="..\fonctionnelle-archivistes\_toc.htm">3. Architecture fonctionnelle</a></li>
<li class="toctree-l1"><a class="reference internal" href="..\fonctionnelle-exploitation\_toc.htm">4. Architecture d&#8217;exploitation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="_toc.htm">5. Architecture technique</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01-technical-architecture.htm">5.1. Architecture technique détaillée</a></li>
<li class="toctree-l2"><a class="reference internal" href="05-logs-architecture.htm">5.2. Concentration et exploitation des logs applicatifs</a></li>
<li class="toctree-l2"><a class="reference internal" href="06-metrics-architecture.htm">5.3. Métriques applicatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="07-deployment-tooling.htm">5.4. Outillage de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="08-consul.htm">5.5. Service registry</a></li>
<li class="toctree-l2"><a class="reference internal" href="10-it-services.htm">5.6. Dépendances aux services d&#8217;infrastructures</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.7. Sauvegarde</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#sauvegarde-mongodb-de-base-dite-shardee">5.7.1. Sauvegarde MongoDB de base dite &#8220;Shardée&#8221;</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="12-restore.htm">5.8. Restoration</a></li>
<li class="toctree-l2"><a class="reference internal" href="15-services.htm">5.9. Composants déployés</a></li>
<li class="toctree-l2"><a class="reference internal" href="20-resources.htm">5.10. Utilisation des resources informatiques</a></li>
<li class="toctree-l2"><a class="reference internal" href="30-deployment-guidelines.htm">5.11. Guidelines de déploiement</a></li>
<li class="toctree-l2"><a class="reference internal" href="90-flux-all.htm">5.12. Matrice des flux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="..\securite\_toc.htm">6. Securite</a></li>
<li class="toctree-l1"><a class="reference internal" href="..\include\_toc.htm">7. Architecture détaillée</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..\index.htm">VITAM - Architecture</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..\index.htm">Docs</a> &raquo;</li>
      
          <li><a href="_toc.htm">5. Architecture technique</a> &raquo;</li>
      
    <li>5.7. Sauvegarde</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="..\_sources\technique\11-backup.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sauvegarde">
<h1>5.7. Sauvegarde<a class="headerlink" href="#sauvegarde" title="Lien permanent vers ce titre">¶</a></h1>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">actuellement, la procédure de sauvegarde s&#8217;applique &#8220;à froid&#8221; durant la phase de bêta.</p>
</div>
<p>Cette procédure devrait être effectuée durant la nuit.
Les horaires indicatifs de cette procédure sont compris entre 20h et 8h.</p>
<p>20h : arrêt des services, dans l&#8217;ordre suivant :</p>
<ul class="simple">
<li>ingest-internal</li>
<li>ingest-external</li>
<li>access-internal</li>
<li>access-external</li>
</ul>
<p>Minuit: cron logbook (sécrurisation des ...)
En parallèle, check du nombre de workflow sur le processing.
Quand il n&#8217;y a plus de workflow actif, arrêt dans l&#8217;ordre des composants suivants :</p>
<ul class="simple">
<li>worker</li>
<li>workspace</li>
</ul>
<p>Quand le cron logbook est terminé ET quand les services (worker et workspace) sont arrêtés, arrêt des services :</p>
<ul class="simple">
<li>functional-administration</li>
<li>logbook</li>
<li>metadata</li>
<li>storage</li>
<li>storage-default-offer</li>
</ul>
<p>Ensuite, arêt des clusters ElasticSearch et MongoDB.</p>
<div class="section" id="sauvegarde-mongodb-de-base-dite-shardee">
<h2>5.7.1. Sauvegarde MongoDB de base dite &#8220;Shardée&#8221;<a class="headerlink" href="#sauvegarde-mongodb-de-base-dite-shardee" title="Lien permanent vers ce titre">¶</a></h2>
<ol class="arabic simple">
<li>Désactiver la répartition de charge <strong>mongos</strong>.</li>
<li>S&#8217;assurer que les répartiteurs ont terminé leurs transactions.</li>
<li>Pour chaque nœud (&#8220;Shard&#8221;) constitué d&#8217;un lot de réplicats <strong>mongod</strong> DB.</li>
<li><ol class="first arabic">
<li>Déterminer le service de donnée <strong>mongod</strong> <em>élu principal</em> du lot.</li>
<li>Stopper ce service.</li>
</ol>
</li>
<li><strong>Continuer lorsque tous les serveurs principaux de tous les nœuds ont été arrêtés.</strong></li>
<li>Déterminer le service de configuration <strong>mongoc</strong> <em>élu principal</em> du lot.</li>
<li>Stopper ce service.</li>
<li>Lancer les sauvegardes les données sur chaque service <strong>mongod</strong> précédemment arrêtés.</li>
<li>Lancer la sauvegarde des données du service <strong>mongoc</strong> arrêté.</li>
<li><strong>Continuer lorsque toutes les sauvegardes se sont terminées.</strong></li>
<li>Relancer chaque service de donnée <strong>mongod</strong>.</li>
<li>Relancer le service de configuration <strong>mongoc</strong>.</li>
<li>Ré-activer la répartition de charge <strong>mongos</strong>.</li>
<li>S&#8217;assurer que la répartition de charge est bien active.</li>
</ol>
<p>A 8h du matin, redémarrage de tous les services.</p>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="..\_images\backup-vitam-full-process.svg"><img alt="../_images/backup-vitam-full-process.svg" height="20cm" src="..\_images\backup-vitam-full-process.svg"></a>
<p class="caption"><span class="caption-text">Procédure de sauvegarde complète</span></p>
</div>
<p>Ci-dessous un script shell reprenant la procédure de sauvegarde décrite ci-dessus.
Ce dernier peut servir de démonstration dans un environnement Vitam &#8220;tout-en-un&#8221;.</p>
<p>Ce script est disponible sous <code class="docutils literal"><span class="pre">deployment/demo_backup_vitam.sh</span></code></p>
<div class="highlight-shell"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#*******************************************************************************</span>
<span class="c1"># Copyright French Prime minister Office/SGMAP/DINSIC/Vitam Program (2015-2019)</span>
<span class="c1">#</span>
<span class="c1"># contact.vitam@culture.gouv.fr</span>
<span class="c1">#</span>
<span class="c1"># This software is a computer program whose purpose is to implement a digital archiving back-office system managing</span>
<span class="c1"># high volumetry securely and efficiently.</span>
<span class="c1">#</span>
<span class="c1"># This software is governed by the CeCILL 2.1 license under French law and abiding by the rules of distribution of free</span>
<span class="c1"># software. You can use, modify and/ or redistribute the software under the terms of the CeCILL 2.1 license as</span>
<span class="c1"># circulated by CEA, CNRS and INRIA at the following URL &quot;http://www.cecill.info&quot;.</span>
<span class="c1">#</span>
<span class="c1"># As a counterpart to the access to the source code and rights to copy, modify and redistribute granted by the license,</span>
<span class="c1"># users are provided only with a limited warranty and the software&#39;s author, the holder of the economic rights, and the</span>
<span class="c1"># successive licensors have only limited liability.</span>
<span class="c1">#</span>
<span class="c1"># In this respect, the user&#39;s attention is drawn to the risks associated with loading, using, modifying and/or</span>
<span class="c1"># developing or reproducing the software by the user in light of its specific status of free software, that may mean</span>
<span class="c1"># that it is complicated to manipulate, and that also therefore means that it is reserved for developers and</span>
<span class="c1"># experienced professionals having in-depth computer knowledge. Users are therefore encouraged to load and test the</span>
<span class="c1"># software&#39;s suitability as regards their requirements in conditions enabling the security of their systems and/or data</span>
<span class="c1"># to be ensured and, more generally, to use and operate it in the same conditions as regards security.</span>
<span class="c1">#</span>
<span class="c1"># The fact that you are presently reading this means that you have had knowledge of the CeCILL 2.1 license and that you</span>
<span class="c1"># accept its terms.</span>
<span class="c1">#*******************************************************************************</span>

<span class="c1"># Demo script for Vitam Backup process in an &quot;all in one server&quot; Vitam environment.</span>
<span class="c1"># Not designed multi host environment.</span>

<span class="o">[</span> <span class="nv">$UID</span> -ne <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;must be run as root&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">exit</span> 1

<span class="nb">unset</span> REPLY
<span class="nb">read</span> -ers -p <span class="s2">&quot;MongoDB admin password: &quot;</span>
<span class="nv">mongodbPwd</span><span class="o">=</span><span class="nv">$REPLY</span>
<span class="nb">unset</span> REPLY

<span class="nb">set</span> -ex
<span class="nv">timestamp</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%Y-%m-%d&quot;</span><span class="k">)</span>

<span class="nb">echo</span> <span class="s2">&quot;stopping Vitam...&quot;</span>

systemctl stop vitam-ingest-external
! systemctl is-active vitam-ingest-external

systemctl stop vitam-ingest-internal
! systemctl is-active vitam-ingest-internal

systemctl stop vitam-access-external
! systemctl is-active vitam-access-external

systemctl stop vitam-access-internal
! systemctl is-active vitam-access-internal

<span class="c1">## TODO test des Running Workflow</span>

systemctl stop vitam-worker
! systemctl is-active vitam-worker

systemctl stop vitam-processing
! systemctl is-active vitam-processing

systemctl stop vitam-workspace
! systemctl is-active vitam-workspace

systemctl stop vitam-functional-administration
! systemctl is-active vitam-functional-administration

systemctl stop vitam-logbook
! systemctl is-active vitam-logbook

systemctl stop vitam-metadata
! systemctl is-active vitam-metadata

systemctl stop vitam-storage
! systemctl is-active vitam-storage

systemctl stop vitam-storage-offer-default
! systemctl is-active vitam-storage-offer-default

systemctl stop vitam-elasticsearch-data
! systemctl is-active vitam-elasticsearch-data

systemctl stop logstash
! systemctl is-active logstash

systemctl stop kibana
! systemctl is-active kibana

systemctl stop vitam-elasticsearch-log
! systemctl is-active stop vitam-elasticsearch-log

mongo admin -u vitamdb-admin -p <span class="si">${</span><span class="nv">mongodbPwd</span><span class="si">}</span> --quiet --eval <span class="s2">&quot;sh.stopBalancer()&quot;</span>
<span class="o">[</span> <span class="k">$(</span>mongo admin -u vitamdb-admin -p <span class="si">${</span><span class="nv">mongodbPwd</span><span class="si">}</span> --quiet --eval <span class="s2">&quot;sh.isBalancerRunning()&quot;</span><span class="k">)</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> 1

mongo  --port <span class="m">27019</span> --quiet --eval <span class="s2">&quot;db.isMaster()&quot;</span>

systemctl stop vitam-mongod
! systemctl is-active vitam-mongod

mongo admin --port <span class="m">27018</span> -u vitamdb-admin -p <span class="si">${</span><span class="nv">mongodbPwd</span><span class="si">}</span> --quiet --eval <span class="s2">&quot;db.isMaster()&quot;</span>

systemctl stop vitam-mongoc
! systemctl is-active vitam-mongoc

<span class="nb">echo</span> <span class="s2">&quot;saving /vitam/data&quot;</span>
tar --directory<span class="o">=</span>/vitam -Pz -cf <span class="si">${</span><span class="nv">timestamp</span><span class="si">}</span>_demobackup_vitam_data.tar.gz data

<span class="nb">echo</span> <span class="s2">&quot;saving /vitam/conf&quot;</span>
tar --directory<span class="o">=</span>/vitam -Pz -cf <span class="si">${</span><span class="nv">timestamp</span><span class="si">}</span>_demobackup_vitam_conf.tar.gz conf

<span class="nb">echo</span> <span class="s2">&quot;restarting Vitam...&quot;</span>
systemctl start vitam-mongod
systemctl is-active vitam-mongod

systemctl start vitam-mongoc
systemctl is-active vitam-mongoc

systemctl stop vitam-mongos
systemctl start vitam-mongos

sleep 7
mongo admin -u vitamdb-admin -p <span class="si">${</span><span class="nv">mongodbPwd</span><span class="si">}</span> --quiet --eval <span class="s2">&quot;sh.setBalancerState(true)&quot;</span>
<span class="o">[</span> <span class="k">$(</span>mongo admin -u vitamdb-admin -p <span class="si">${</span><span class="nv">mongodbPwd</span><span class="si">}</span> --quiet --eval <span class="s2">&quot;sh.getBalancerState()&quot;</span><span class="k">)</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> 1

systemctl start vitam-elasticsearch-log
sleep 3
systemctl is-active vitam-elasticsearch-log

systemctl start kibana
sleep 3
systemctl is-active kibana

systemctl start logstash
sleep 3
systemctl is-active logstash

systemctl start vitam-elasticsearch-data
sleep 3
systemctl is-active vitam-elasticsearch-data

systemctl start vitam-storage-offer-default
sleep 3
systemctl is-active vitam-storage-offer-default

systemctl start vitam-storage
sleep 3
systemctl is-active vitam-storage

systemctl start vitam-metadata
sleep 3
systemctl is-active vitam-metadata

systemctl start vitam-logbook
sleep 3
systemctl is-active vitam-logbook

systemctl start vitam-functional-administration
sleep 3
systemctl is-active vitam-functional-administration

systemctl start vitam-workspace
sleep 3
systemctl is-active vitam-workspace

systemctl start vitam-processing
sleep 3
systemctl is-active vitam-processing

systemctl start vitam-worker
sleep 3
systemctl is-active vitam-worker

systemctl start vitam-access-internal
sleep 3
systemctl is-active vitam-access-internal

systemctl start vitam-access-external
sleep 5
systemctl is-active vitam-access-external

systemctl start vitam-ingest-internal
sleep 3
systemctl is-active vitam-ingest-internal

systemctl start vitam-ingest-external
sleep 3
systemctl is-active vitam-ingest-external
sleep 3
<span class="nb">echo</span> <span class="s2">&quot;Vitam backup demo ended&quot;</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="12-restore.htm" class="btn btn-neutral float-right" title="5.8. Restoration" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="10-it-services.htm" class="btn btn-neutral" title="5.6. Dépendances aux services d’infrastructures" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr>

  <div role="contentinfo">
    <p>
        &copy; Copyright Ce document est distribué sous les termes de la licence Creative Commons Attribution - Partage dans les Mêmes Conditions 3.0 France (CC BY-SA 3.0 FR).

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.15.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="..\_static\jquery.js"></script>
      <script type="text/javascript" src="..\_static\underscore.js"></script>
      <script type="text/javascript" src="..\_static\doctools.js"></script>
      <script type="text/javascript" src="..\_static\translations.js"></script>

  

  
  
    <script type="text/javascript" src="..\_static\js\theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>