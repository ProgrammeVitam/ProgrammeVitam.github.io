<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>7.2.9.3.1. Présentation &mdash; Documentation VITAM - Documentation d&#39;exploitation 6.rc.1</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
      <script>
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'6.rc.1',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/translations.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
    <link rel="next" title="7.2.9.3.2. Configuration / fichiers utiles" href="configuration.html" />
    <link rel="prev" title="7.2.9.3. Service vitam-mongod" href="_toc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> VITAM - Documentation d'exploitation<img src="../../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                6.rc.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/_toc.html">5. Exploitation globale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../_toc.html#generalites">7.1. Généralités</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../_toc.html#cots">7.2. COTS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../cerebro/_toc.html">7.2.1. Cerebro</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../consul/_toc.html">7.2.2. Consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_interceptor/_toc.html">7.2.3. Kibana interceptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_log/_toc.html">7.2.4. Elasticsearch chaîne de log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_vitam/_toc.html">7.2.5. Elasticsearch Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana/_toc.html">7.2.6. Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kibana/_toc.html">7.2.7. Kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../log_server/_toc.html">7.2.8. Log server</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../_toc.html">7.2.9. MongoDB</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../0mongos/_toc.html">7.2.9.1. Service vitam-mongos</a></li>
<li class="toctree-l4"><a class="reference internal" href="../1mongoc/_toc.html">7.2.9.2. Service vitam-mongoc</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="_toc.html">7.2.9.3. Service vitam-mongod</a></li>
<li class="toctree-l4"><a class="reference internal" href="../3deployment/_toc.html">7.2.9.4. Topologies de déploiement et tolérance aux pannes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../4exploitation/_toc.html">7.2.9.5. Exploitation d’un cluster MongoDB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../prometheus/_toc.html">7.2.10. Prometheus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../restic/_toc.html">7.2.11. Restic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../siegfried/_toc.html">7.2.12. Siegfried</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../annexes/_toc.html">12. Annexes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VITAM - Documentation d'exploitation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a></li>
          <li class="breadcrumb-item"><a href="../_toc.html">7.2.9. MongoDB</a></li>
          <li class="breadcrumb-item"><a href="_toc.html">7.2.9.3. Service vitam-mongod</a></li>
      <li class="breadcrumb-item active">7.2.9.3.1. Présentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/composants/mongo/2mongod/presentation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="presentation">
<h1>7.2.9.3.1. Présentation<a class="headerlink" href="#presentation" title="Lien permanent vers ce titre">¶</a></h1>
<p>Le composant <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> représente le service de données du cluster MongoDB déployé. Techniquement, il s’agit d’une instance du serveur de la base de données MongoDB (processus mongod) qui détient les bases et collections Vitam. Des bases et collections de configuration sont aussi présentes pour le fonctionnement de la solution MongoDB.</p>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">Il est fortement recommandé de ne pas modifier ces collections, excepté lorsqu’un mode opératoire Vitam le mentionne ou à la demande explicite de l’éditeur de la base MongoDB.</p>
</div>
<p>Ce service est déployé, comme le service <code class="docutils literal notranslate"><span class="pre">vitam-mongoc</span></code>, sous forme de <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> (voir le paragraphe précédent pour plus d’explication).</p>
<p>Pour gérer de grosses volumétries, les services <code class="docutils literal notranslate"><span class="pre">mongod</span></code> sont déployés de manière à pouvoir gérer un sous ensemble de données, afin de répartir la charge d’utilisation. Ce concept est nommé <code class="docutils literal notranslate"><span class="pre">Sharding</span></code> et le <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> représente alors un sous-ensemble des données gérées par le cluster (pour les collections dites <code class="docutils literal notranslate"><span class="pre">shardées</span></code>). Ce sous-ensemble est nommé <code class="docutils literal notranslate"><span class="pre">Shard</span></code> et ce concept est utilisé dans la configuration du cluster. Une collection non <code class="docutils literal notranslate"><span class="pre">shardée</span></code> sera disponible sur un unique <code class="docutils literal notranslate"><span class="pre">Shard</span></code>.</p>
<p>Dans Vitam, les collections des bases metadata et logbook de mongodb-data (exceptée la collection Operation) sont <code class="docutils literal notranslate"><span class="pre">shardées</span></code>, car la dimension de leur volume est estimée importante (plusieurs millions ou milliards). Les collections des bases identity, masterdata et report ne sont pas <code class="docutils literal notranslate"><span class="pre">shardées</span></code>.</p>
<p>Dans le cadre d’une offre «&nbsp;froide&nbsp;», la collection TapeAccessRequestReferential de la base offer de mongodb-offer est également <code class="docutils literal notranslate"><span class="pre">shardée</span></code>. Les autres collections ne sont pas <code class="docutils literal notranslate"><span class="pre">shardées</span></code>.</p>
<p>Dans le cas de mongodb-data, les ressources machines allouées à ce service doivent être relativement importantes en fonction de :</p>
<blockquote>
<div><ul>
<li><p class="first">la volumétrie et du débit des versements d’archives dans le système :</p>
<p>Plus le système est sollicité, notamment dans le cas du versement, plus les clusters MongoDB, et donc les services <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code>, sont sollicités. Les composants Vitam qui éméttent les requêtes vers le cluster <code class="docutils literal notranslate"><span class="pre">mongodb-data</span></code> sont <code class="docutils literal notranslate"><span class="pre">metadata</span></code>, <code class="docutils literal notranslate"><span class="pre">logbook</span></code> et <code class="docutils literal notranslate"><span class="pre">functional-administration</span></code>. Vers le cluster <code class="docutils literal notranslate"><span class="pre">mongodb-offer</span></code>, seul le composant <code class="docutils literal notranslate"><span class="pre">offer</span></code> émet les requêtes.</p>
<p>Le nombre de requêtes émises vers un cluster est dépendant du nombre de composant <code class="docutils literal notranslate"><span class="pre">vitam-worker</span></code> déployé dans le système ainsi que du paramètre qui spécifie le nombre de worker exécutant une tâche Vitam au sein d’un composant (Thread dans la jvm).</p>
<p>En fonction de la distribution des tâches, opérée dans le composant <code class="docutils literal notranslate"><span class="pre">vitam-processing</span></code>, du nombre de versement en parallèle et du nombre d’unité archivistique par SIP, un certain nombre de worker vont émettre des requêtes en parallèle.</p>
<p>Différentes optimisations ont été réalisées dans les tâches Vitam, pour notamment, diminuer le nombre de requêtes vers les clusters MongoDB, en privilégiant une requête en mode <code class="docutils literal notranslate"><span class="pre">bulk</span></code>. Aussi, avec ces optimisations, les services <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> sont bien plus sollicités. Toutefois, si le nombre d’unité archivistique positionnées dans les SIP est trop faible, le nombre de requête par bulk est réduit. Les recommendations des paramètres et de l’utilisation du système de manière efficiente sont détaillées dans un autre document.</p>
<p>Le nombre de vCPU disponible pour le service <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> influe sur les performances d’exécution en parallèle des requêtes MongoDB. Dans le cas des versements, la sollicitation des clusters MongoDB est essentiellement liée à des requêtes d’écriture. Dans ce mode, l’utilisation des index MongoDB ainsi que la lecture des documents en base sont limitées. Et donc dans ce contexte, la quantité de RAM disponible pour les index et pour les caches de document (<code class="docutils literal notranslate"><span class="pre">workingSet</span></code> MongoDB) ne doit pas être nécessairement importante.</p>
</li>
<li><p class="first">des fonctionnalités Vitam utilisées :</p>
<p>Le versement d’archive est une fonctionnalité importante du système pour laquelle la sollicitation des clusters MongoDB est majoritairement liée à des requêtes d’écriture. D’autres fonctionnalités Vitam, comme la consultation d’archives ou la réalisation de <code class="docutils literal notranslate"><span class="pre">DIP</span></code>, la sécurisation des opérations et données ingérées par le système, ou tout autre traitement en masse qui nécessite un accès aux documents, sollicitent le cluster <code class="docutils literal notranslate"><span class="pre">mongodb-data</span></code> avec des requêtes de lecture.</p>
<p>Dans Vitam, un paradigme d’architecture est posé et est respecté par l’ensemble des composants (sauf exceptions cités ci-après) : toute requête sur les données qui nécessite un filtre sur les métadonnées, est executée dans le moteur de recherche ElasticSearch, afin de récuperer une liste d’identifiants de documents à requêter dans MongoDB. Ce pattern permet en outre de limiter le nombre d’index à créer dans MongoDB.</p>
<p>Aussi, dans le cas des accès aux documents, les performances seront réduites lorsque les identifiants des documents requêtés ne seront plus indexés en RAM (cas ou la quantité de RAM nécessaire pour contenir l’ensemble des index en mémoire est insuffisante) et surtout lorsque le document ne sera plus disponible dans le cache. Si les données ne sont plus disponibles en mémoire, le moteur MongoDB doit procéder à des lectures sur disque en remplaçant les données les plus anciennes par les nouvellement lues. Ce mécasnime (<code class="docutils literal notranslate"><span class="pre">evictions</span> <span class="pre">page</span></code>) est utilisé pour les index et les documents.</p>
<p>Le cas particulier des sécurisations, sollicitent les clusters MongoDB en lecture, sans passer par le moteur de recherche (pour des raisons de sécurité et d’intégrité de la donnée). Elles utilisent un index supplémentaire directement dans MongoDB. Aussi, dans ce contexte, pour assurer de bonnes performances à ces opérations, il faut veiller à dimensionner le cache des documents suffisament important pour conserver les documents, et index liés aux documents, qui ont été ingérés par le système et qui n’ont pas encore été sécurisés.</p>
<p>Par défaut, les sécurisations des cycles de vie des métadonnées archivistiques et des opérations Vitam sont executées toutes les 2 ou 3 heures. Durant cette période, un versement d’un million d’AU nécessitera l’utilisation d’un million de clé (identifiant Mongo et identifiant de sharding) dans les index, soit une centaine de Mo, et nécessitera l’utilisation d’un million de documents dans le cache, soit 5,7 Go.</p>
<p>La quantité de RAM disponible pour le service <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> influe sur les performances d’exécution des requêtes MongoDB. Dans le contexte des fonctionnalités citées, la quantité de RAM doit être importante. La recommendation Vitam est d’allouer la quantité de RAM nécessaire pour traiter au minimum les sécurisations des documents versées dans les dernières heures, afin de ne pas ralentir le système avec ces opérations. Par exemple, pour des versements à 450.000 AU/h, les sécurisations LFC AU et GOT, et Opérations, nécessiteront environ 12 Go de RAM (quantité répartie sur l’ensemble des <code class="docutils literal notranslate"><span class="pre">Shards</span></code>).</p>
</li>
</ul>
</div></blockquote>
<p>Dans le cas de mongodb-offer, les ressources machines allouées à ce service sont modérément élevés, excepté le cas des offres froides où l’utilisation des ressources peut être plus conséquente, en fonction des traitements en cours.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Par défaut, 50% de la RAM disponible est allouée au processus mongod pour gérer les index et caches de document, de manière à laisser disponible en cache OS les données lues sur disque (blocs des fichiers de données MongoDB).</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Avertissement</p>
<p class="last">Les performances du cluster MongoDB, en écriture ou lecture, restent dépendantes de la performance des disques. Il est recommandé de privilégier une infrastructure avec des disques physiques attachés aux machines qui déploient les services <code class="docutils literal notranslate"><span class="pre">mongod</span></code>. A défaut d’une telle configuration, il est recommandé d’octroyer la meilleure qualité de service de l’offre disque utilisée (débit ou priorité d’accès).</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="_toc.html" class="btn btn-neutral float-left" title="7.2.9.3. Service vitam-mongod" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="configuration.html" class="btn btn-neutral float-right" title="7.2.9.3.2. Configuration / fichiers utiles" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>