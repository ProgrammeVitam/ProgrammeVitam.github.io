

<!DOCTYPE html>
<html class="writer-html4" lang="fr" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>7.2.9.4.3. Déploiement d’un cluster de production &mdash; Documentation VITAM - Documentation d&#39;exploitation 4.0.3</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'4.0.3',
              LANGUAGE:'fr',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Recherche" href="../../../search.html" />
    <link rel="next" title="7.2.9.4.4. Déploiement d’un cluster de production avec réduction de la RAM" href="deployProdMin.html" />
    <link rel="prev" title="7.2.9.4.2. Déploiement d’un cluster de développement" href="deployDev.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> VITAM - Documentation d'exploitation
          

          
            
            <img src="../../../_static/logo_vitam.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                4.0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html#rappels">2. Rappels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../prerequis-competences.html">3. Expertises requises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">4. Architecture de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../topics/_toc.html">5. Exploitation globale</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../monitoring/_toc.html">6. Suivi de l’état du système</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../_toc.html#generalites">7.1. Généralités</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../_toc.html#cots">7.2. COTS</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../cerebro/_toc.html">7.2.1. Cerebro</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../consul/_toc.html">7.2.2. Consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_interceptor/_toc.html">7.2.3. Kibana interceptor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_log/_toc.html">7.2.4. Elasticsearch chaîne de log</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../elasticsearch_vitam/_toc.html">7.2.5. Elasticsearch Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../grafana/_toc.html">7.2.6. Grafana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../kibana/_toc.html">7.2.7. Kibana</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../log_server/_toc.html">7.2.8. Log server</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../_toc.html">7.2.9. MongoDB</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../0mongos/_toc.html">7.2.9.1. Service vitam-mongos</a></li>
<li class="toctree-l4"><a class="reference internal" href="../1mongoc/_toc.html">7.2.9.2. Service vitam-mongoc</a></li>
<li class="toctree-l4"><a class="reference internal" href="../2mongod/_toc.html">7.2.9.3. Service vitam-mongod</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="_toc.html">7.2.9.4. Topologies de déploiement et tolérance aux pannes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../4exploitation/_toc.html">7.2.9.5. Exploitation d’un cluster MongoDB</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../prometheus/_toc.html">7.2.10. Prometheus</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../siegfried/_toc.html">7.2.11. Siegfried</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../include/_toc.html">8. Exploitation des composants de la solution logicielle VITAM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../external_app.html">9. Intégration d’une application externe dans Vitam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshoot/_toc.html">10. Aide à l’exploitation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQ/_toc.html">11. Questions Fréquemment Posées</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../annexes/_toc.html">12. Annexes</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">VITAM - Documentation d'exploitation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../_toc.html">7. Exploitation des COTS de la solution logicielle VITAM</a> &raquo;</li>
        
          <li><a href="../_toc.html">7.2.9. MongoDB</a> &raquo;</li>
        
          <li><a href="_toc.html">7.2.9.4. Topologies de déploiement et tolérance aux pannes</a> &raquo;</li>
        
      <li>7.2.9.4.3. Déploiement d’un cluster de production</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/composants/mongo/3deployment/deployProd.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deploiement-d-un-cluster-de-production">
<h1>7.2.9.4.3. Déploiement d’un cluster de production<a class="headerlink" href="#deploiement-d-un-cluster-de-production" title="Lien permanent vers ce titre">¶</a></h1>
<p>En environnement de production, la tolérance aux pannes doit être prévue. Avec trois membres par <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code>, le niveau de tolérance aux pannes est satisfaisant : si le noeud primaire n’est plus disponible, le système provoque une élection au sein du <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code>, permettant alors à un noeud secondaire de devenir noeud primaire. Dans cette situation, si le nouveau noeud primaire devient indisponible, il ne restera plus qu’un seul noeud disponible pour disposer d’un noeud primaire et la situation devient alors critique (par rapport à la disponibilité de la donnée).
Pour autant, dans le cas ou un noeud primaire et un seul noeud secondaire sont disponibles, la consistance de la donnée n’est potentiellement plus assurée, puisque les mécanismes configurés avec la valeur <code class="docutils literal notranslate"><span class="pre">Majority</span></code> ne permettent plus une vérification de la réplication : la majorité correspond à un membre, et donc uniquement le membre <code class="docutils literal notranslate"><span class="pre">Primary</span></code> acquitera l’écriture. Aussi, dans ce cas, si le membre primaire devient indisponible après une écriture et avant la réplication, lorsque le dernier membre disponible devient primaire, l’écriture n’a pas été répliquée. Dans le cas nominal ou les deux membres secondaires étaient disponibles, c’est le membre qui a réalisé l’acquitement de la replication qui devient primaire (dans les faits, le membre secondaire le plus à jour vis à vis de la réplication) et alors l’écriture a bien été prise en compte.</p>
<p>Une tolérance aux pannes plus importante peut être mise en place en déployant un quatrième membre. Et afin de respecter un nombre impair de membres déployés, il est possible de déployer un cinquième membre qui ne consomme pas autant de ressources matérielles qu’un membre actif et dont la responsabilité n’est d’intervenir que dans l’élection d’un noeud primaire. Ce type de membre est nommé membre <code class="docutils literal notranslate"><span class="pre">Arbiter</span></code>. La topologie de déploiement du <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> est alors nommée <code class="docutils literal notranslate"><span class="pre">PSSSA</span></code>, pour illustrer le déploiement d’un membre <code class="docutils literal notranslate"><span class="pre">Primary</span></code>, de 3 membres <code class="docutils literal notranslate"><span class="pre">Secondary</span></code> et d’un membre <code class="docutils literal notranslate"><span class="pre">Arbiter</span></code>.</p>
<p>L’indisponibilité d’un noeud peut être liée à différentes causes : un problème matériel provoquant un <code class="docutils literal notranslate"><span class="pre">crash</span></code> du processus, mais pour lequel le service sera redémarré automatiquement suite à l’incident (faute de mémoire, faute d’accès disque durant l’écriture, …); ou un problème matériel important provoquant la perte de la machine physique et pour lequel le service ne pourra pas redémarrer (provisionning virtuel, coupure éléctrique, …). Aussi, il est important de déployer les membres d’un <code class="docutils literal notranslate"><span class="pre">replicaSet</span></code> dans des zones matérielles différentes. Dans le cas, d’un environnement virtuel opéré physiquement par différentes machines, il est opportun de spécifier un provisionning physique afin d’assurer une répartition physique des machines.</p>
<p>Pour augmenter véritablement la tolérance aux pannes, en plus d’augmenter le nombre de membre d’un <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> correctement réparti physiquement, il est recommandé de déployer un environnement de production constitué de deux salles physiquement indépendantes (alimentation éléctrique, droits d’accès, …) et pour lesquelles les communications réseaux sont autorisées et resteront performantes.
Il s’agit bien la, de discerner le cas du site secondaire prévu dans le système Vitam, notamment pour gérer la criticité de la perte d’une offre de stockage. Dans ce scénario, il est recommandé que ce second site soit géographiquement distant du premier, de plusieurs dizaines de kilomètres. Aussi, les performances réseaux entre les deux sites pourraient être insuffisante au regard des performances attendues dans le cluster MongoDB.</p>
<p>Pour réaliser le déploiement du cluster <code class="docutils literal notranslate"><span class="pre">mongodb-data</span></code>, en mode <code class="docutils literal notranslate"><span class="pre">PSS</span></code>, composé de 3 machines hebergeant les services <code class="docutils literal notranslate"><span class="pre">vitam-mongos</span></code> et <code class="docutils literal notranslate"><span class="pre">vitam-mongoc</span></code> et de 6 machines hebergeant le service <code class="docutils literal notranslate"><span class="pre">vitam-mongod</span></code> (pour disposer de 2 <code class="docutils literal notranslate"><span class="pre">Shards</span></code>), l’inventaire ansible doit référencer les 3 premières machines pour les groupes <code class="docutils literal notranslate"><span class="pre">hosts-mongos-data</span></code> et <code class="docutils literal notranslate"><span class="pre">hosts-mongoc-data</span></code> et les 6 autres machines pour le groupe <code class="docutils literal notranslate"><span class="pre">hosts-mongod-data</span></code>.
Le paramètre <code class="docutils literal notranslate"><span class="pre">mongo_shard_id</span></code> spécifie le regroupement des machines dans le même <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> et identifie un numéro de <code class="docutils literal notranslate"><span class="pre">Shard</span></code>.
Le paramètre <code class="docutils literal notranslate"><span class="pre">mongo_rs_bootstrap</span></code> spécifie la machine sur laquelle l’initialisation du <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> sera réalisée (voir command rs.initiate()). Les autres machines du <code class="docutils literal notranslate"><span class="pre">ReplicaSet</span></code> y seront alors ajoutées (voir commande rs.add()).</p>
<p>Exemple</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">hosts</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="n">children</span><span class="p">]</span>
<span class="n">hosts</span><span class="o">-</span><span class="n">mongos</span><span class="o">-</span><span class="n">data</span>
<span class="n">hosts</span><span class="o">-</span><span class="n">mongoc</span><span class="o">-</span><span class="n">data</span>
<span class="n">hosts</span><span class="o">-</span><span class="n">mongod</span><span class="o">-</span><span class="n">data</span>

<span class="p">[</span><span class="n">hosts</span><span class="o">-</span><span class="n">mongos</span><span class="o">-</span><span class="n">data</span><span class="p">]</span>
<span class="n">host1</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>
<span class="n">host2</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>
<span class="n">host3</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>                    <span class="n">mongo_rs_bootstrap</span><span class="o">=</span><span class="n">true</span>

<span class="p">[</span><span class="n">hosts</span><span class="o">-</span><span class="n">mongoc</span><span class="o">-</span><span class="n">data</span><span class="p">]</span>
<span class="n">host1</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>
<span class="n">host2</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>
<span class="n">host3</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>                    <span class="n">mongo_rs_bootstrap</span><span class="o">=</span><span class="n">true</span>

<span class="p">[</span><span class="n">hosts</span><span class="o">-</span><span class="n">mongod</span><span class="o">-</span><span class="n">data</span><span class="p">]</span>
<span class="n">host4</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">0</span>
<span class="n">host5</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">0</span>
<span class="n">host6</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">0</span>  <span class="n">mongo_rs_bootstrap</span><span class="o">=</span><span class="n">true</span>
<span class="n">host7</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">host8</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">1</span>
<span class="n">host9</span><span class="o">.</span><span class="n">vm</span>    <span class="n">mongo_cluster_name</span><span class="o">=</span><span class="n">mongodb</span><span class="o">-</span><span class="n">data</span>  <span class="n">mongo_shard_id</span><span class="o">=</span><span class="mi">1</span>  <span class="n">mongo_rs_bootstrap</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
<p>Le déploiement d’un cluster <code class="docutils literal notranslate"><span class="pre">mongodb-offer</span></code> en mode <code class="docutils literal notranslate"><span class="pre">PSS</span></code> suit les mêmes règles que l’exemple illustré ci-dessus (les groupes ansible ne sont pas les mêmes).</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="deployProdMin.html" class="btn btn-neutral float-right" title="7.2.9.4.4. Déploiement d’un cluster de production avec réduction de la RAM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="deployDev.html" class="btn btn-neutral float-left" title="7.2.9.4.2. Déploiement d’un cluster de développement" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Ce document est distribué sous les termes de la Licence Ouverte V2.0.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>